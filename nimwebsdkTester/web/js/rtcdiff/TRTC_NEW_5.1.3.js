!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).TRTC=t()}(this,(function(){function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n=function(e){try{return!!e()}catch(t){return!0}},r=!n((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),o=r,s=Function.prototype,a=s.call,c=o&&s.bind.bind(a,a),l=o?c:function(e){return function(){return a.apply(e,arguments)}},d=l,u=d({}.toString),h=d("".slice),p=function(e){return h(u(e),8,-1)},_=n,m=p,f=Object,g=l("".split),T=_((function(){return!f("z").propertyIsEnumerable(0)}))?function(e){return"String"===m(e)?g(e,""):f(e)}:f,E=function(e){return null==e},I=E,S=TypeError,A=function(e){if(I(e))throw S("Can't call method on "+e);return e},y=T,v=A,R=function(e){return y(v(e))},C=function(e){return e&&e.Math===Math&&e},b=C("object"==typeof globalThis&&globalThis)||C("object"==typeof window&&window)||C("object"==typeof self&&self)||C("object"==typeof t&&t)||function(){return this}()||t||Function("return this")(),k={exports:{}},D=b,N=Object.defineProperty,O=function(e,t){try{N(D,e,{value:t,configurable:!0,writable:!0})}catch(i){D[e]=t}return t},P=O,L="__core-js_shared__",w=b[L]||P(L,{}),M=w;(k.exports=function(e,t){return M[e]||(M[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.32.2",mode:"global",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.32.2/LICENSE",source:"https://github.com/zloirock/core-js"});var V,U,x=k.exports,F=A,B=Object,H=function(e){return B(F(e))},j=H,G=l({}.hasOwnProperty),W=Object.hasOwn||function(e,t){return G(j(e),t)},J=l,K=0,Y=Math.random(),z=J(1..toString),q=function(e){return"Symbol("+(void 0===e?"":e)+")_"+z(++K+Y,36)},Q="undefined"!=typeof navigator&&String(navigator.userAgent)||"",X=b,Z=Q,$=X.process,ee=X.Deno,te=$&&$.versions||ee&&ee.version,ie=te&&te.v8;ie&&(U=(V=ie.split("."))[0]>0&&V[0]<4?1:+(V[0]+V[1])),!U&&Z&&(!(V=Z.match(/Edge\/(\d+)/))||V[1]>=74)&&(V=Z.match(/Chrome\/(\d+)/))&&(U=+V[1]);var ne=U,re=ne,oe=n,se=b.String,ae=!!Object.getOwnPropertySymbols&&!oe((function(){var e=Symbol("symbol detection");return!se(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&re&&re<41})),ce=ae&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,le=x,de=W,ue=q,he=ae,pe=ce,_e=b.Symbol,me=le("wks"),fe=pe?_e.for||_e:_e&&_e.withoutSetter||ue,ge=function(e){return de(me,e)||(me[e]=he&&de(_e,e)?_e[e]:fe("Symbol."+e)),me[e]},Te="object"==typeof document&&document.all,Ee={all:Te,IS_HTMLDDA:void 0===Te&&void 0!==Te},Ie=Ee.all,Se=Ee.IS_HTMLDDA?function(e){return"function"==typeof e||e===Ie}:function(e){return"function"==typeof e},Ae=Se,ye=Ee.all,ve=Ee.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:Ae(e)||e===ye}:function(e){return"object"==typeof e?null!==e:Ae(e)},Re=ve,Ce=String,be=TypeError,ke=function(e){if(Re(e))return e;throw be(Ce(e)+" is not an object")},De={},Ne=!n((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]})),Oe=Ne&&n((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),Pe={},Le=ve,we=b.document,Me=Le(we)&&Le(we.createElement),Ve=function(e){return Me?we.createElement(e):{}},Ue=Ve,xe=!Ne&&!n((function(){return 7!==Object.defineProperty(Ue("div"),"a",{get:function(){return 7}}).a})),Fe=r,Be=Function.prototype.call,He=Fe?Be.bind(Be):function(){return Be.apply(Be,arguments)},je=b,Ge=Se,We=function(e,t){return arguments.length<2?(i=je[e],Ge(i)?i:void 0):je[e]&&je[e][t];var i},Je=l({}.isPrototypeOf),Ke=We,Ye=Se,ze=Je,qe=Object,Qe=ce?function(e){return"symbol"==typeof e}:function(e){var t=Ke("Symbol");return Ye(t)&&ze(t.prototype,qe(e))},Xe=String,Ze=function(e){try{return Xe(e)}catch(t){return"Object"}},$e=Se,et=Ze,tt=TypeError,it=function(e){if($e(e))return e;throw tt(et(e)+" is not a function")},nt=it,rt=E,ot=function(e,t){var i=e[t];return rt(i)?void 0:nt(i)},st=He,at=Se,ct=ve,lt=TypeError,dt=He,ut=ve,ht=Qe,pt=ot,_t=function(e,t){var i,n;if("string"===t&&at(i=e.toString)&&!ct(n=st(i,e)))return n;if(at(i=e.valueOf)&&!ct(n=st(i,e)))return n;if("string"!==t&&at(i=e.toString)&&!ct(n=st(i,e)))return n;throw lt("Can't convert object to primitive value")},mt=TypeError,ft=ge("toPrimitive"),gt=function(e,t){if(!ut(e)||ht(e))return e;var i,n=pt(e,ft);if(n){if(void 0===t&&(t="default"),i=dt(n,e,t),!ut(i)||ht(i))return i;throw mt("Can't convert object to primitive value")}return void 0===t&&(t="number"),_t(e,t)},Tt=gt,Et=Qe,It=function(e){var t=Tt(e,"string");return Et(t)?t:t+""},St=Ne,At=xe,yt=Oe,vt=ke,Rt=It,Ct=TypeError,bt=Object.defineProperty,kt=Object.getOwnPropertyDescriptor,Dt="enumerable",Nt="configurable",Ot="writable";Pe.f=St?yt?function(e,t,i){if(vt(e),t=Rt(t),vt(i),"function"==typeof e&&"prototype"===t&&"value"in i&&Ot in i&&!i[Ot]){var n=kt(e,t);n&&n[Ot]&&(e[t]=i.value,i={configurable:Nt in i?i[Nt]:n[Nt],enumerable:Dt in i?i[Dt]:n[Dt],writable:!1})}return bt(e,t,i)}:bt:function(e,t,i){if(vt(e),t=Rt(t),vt(i),At)try{return bt(e,t,i)}catch(n){}if("get"in i||"set"in i)throw Ct("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var Pt=Math.ceil,Lt=Math.floor,wt=Math.trunc||function(e){var t=+e;return(t>0?Lt:Pt)(t)},Mt=wt,Vt=function(e){var t=+e;return t!=t||0===t?0:Mt(t)},Ut=Vt,xt=Math.max,Ft=Math.min,Bt=function(e,t){var i=Ut(e);return i<0?xt(i+t,0):Ft(i,t)},Ht=Vt,jt=Math.min,Gt=function(e){return e>0?jt(Ht(e),9007199254740991):0},Wt=Gt,Jt=function(e){return Wt(e.length)},Kt=R,Yt=Bt,zt=Jt,qt=function(e){return function(t,i,n){var r,o=Kt(t),s=zt(o),a=Yt(n,s);if(e&&i!=i){for(;s>a;)if((r=o[a++])!=r)return!0}else for(;s>a;a++)if((e||a in o)&&o[a]===i)return e||a||0;return!e&&-1}},Qt={includes:qt(!0),indexOf:qt(!1)},Xt={},Zt=W,$t=R,ei=Qt.indexOf,ti=Xt,ii=l([].push),ni=function(e,t){var i,n=$t(e),r=0,o=[];for(i in n)!Zt(ti,i)&&Zt(n,i)&&ii(o,i);for(;t.length>r;)Zt(n,i=t[r++])&&(~ei(o,i)||ii(o,i));return o},ri=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],oi=ni,si=ri,ai=Object.keys||function(e){return oi(e,si)},ci=Ne,li=Oe,di=Pe,ui=ke,hi=R,pi=ai;De.f=ci&&!li?Object.defineProperties:function(e,t){ui(e);for(var i,n=hi(t),r=pi(t),o=r.length,s=0;o>s;)di.f(e,i=r[s++],n[i]);return e};var _i,mi=We("document","documentElement"),fi=q,gi=x("keys"),Ti=function(e){return gi[e]||(gi[e]=fi(e))},Ei=ke,Ii=De,Si=ri,Ai=Xt,yi=mi,vi=Ve,Ri="prototype",Ci="script",bi=Ti("IE_PROTO"),ki=function(){},Di=function(e){return"<"+Ci+">"+e+"</"+Ci+">"},Ni=function(e){e.write(Di("")),e.close();var t=e.parentWindow.Object;return e=null,t},Oi=function(){try{_i=new ActiveXObject("htmlfile")}catch(r){}var e,t,i;Oi="undefined"!=typeof document?document.domain&&_i?Ni(_i):(t=vi("iframe"),i="java"+Ci+":",t.style.display="none",yi.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(Di("document.F=Object")),e.close(),e.F):Ni(_i);for(var n=Si.length;n--;)delete Oi[Ri][Si[n]];return Oi()};Ai[bi]=!0;var Pi=Object.create||function(e,t){var i;return null!==e?(ki[Ri]=Ei(e),i=new ki,ki[Ri]=null,i[bi]=e):i=Oi(),void 0===t?i:Ii.f(i,t)},Li=ge,wi=Pi,Mi=Pe.f,Vi=Li("unscopables"),Ui=Array.prototype;void 0===Ui[Vi]&&Mi(Ui,Vi,{configurable:!0,value:wi(null)});var xi,Fi,Bi,Hi=function(e){Ui[Vi][e]=!0},ji={},Gi=Se,Wi=b.WeakMap,Ji=Gi(Wi)&&/native code/.test(String(Wi)),Ki=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Yi=Pe,zi=Ki,qi=Ne?function(e,t,i){return Yi.f(e,t,zi(1,i))}:function(e,t,i){return e[t]=i,e},Qi=Ji,Xi=b,Zi=ve,$i=qi,en=W,tn=w,nn=Ti,rn=Xt,on="Object already initialized",sn=Xi.TypeError,an=Xi.WeakMap;if(Qi||tn.state){var cn=tn.state||(tn.state=new an);cn.get=cn.get,cn.has=cn.has,cn.set=cn.set,xi=function(e,t){if(cn.has(e))throw sn(on);return t.facade=e,cn.set(e,t),t},Fi=function(e){return cn.get(e)||{}},Bi=function(e){return cn.has(e)}}else{var ln=nn("state");rn[ln]=!0,xi=function(e,t){if(en(e,ln))throw sn(on);return t.facade=e,$i(e,ln,t),t},Fi=function(e){return en(e,ln)?e[ln]:{}},Bi=function(e){return en(e,ln)}}var dn={set:xi,get:Fi,has:Bi,enforce:function(e){return Bi(e)?Fi(e):xi(e,{})},getterFor:function(e){return function(t){var i;if(!Zi(t)||(i=Fi(t)).type!==e)throw sn("Incompatible receiver, "+e+" required");return i}}},un={},hn={},pn={}.propertyIsEnumerable,_n=Object.getOwnPropertyDescriptor,mn=_n&&!pn.call({1:2},1);hn.f=mn?function(e){var t=_n(this,e);return!!t&&t.enumerable}:pn;var fn=Ne,gn=He,Tn=hn,En=Ki,In=R,Sn=It,An=W,yn=xe,vn=Object.getOwnPropertyDescriptor;un.f=fn?vn:function(e,t){if(e=In(e),t=Sn(t),yn)try{return vn(e,t)}catch(i){}if(An(e,t))return En(!gn(Tn.f,e,t),e[t])};var Rn={exports:{}},Cn=Ne,bn=W,kn=Function.prototype,Dn=Cn&&Object.getOwnPropertyDescriptor,Nn=bn(kn,"name"),On={EXISTS:Nn,PROPER:Nn&&"something"===function(){}.name,CONFIGURABLE:Nn&&(!Cn||Cn&&Dn(kn,"name").configurable)},Pn=Se,Ln=w,wn=l(Function.toString);Pn(Ln.inspectSource)||(Ln.inspectSource=function(e){return wn(e)});var Mn=Ln.inspectSource,Vn=l,Un=n,xn=Se,Fn=W,Bn=Ne,Hn=On.CONFIGURABLE,jn=Mn,Gn=dn.enforce,Wn=dn.get,Jn=String,Kn=Object.defineProperty,Yn=Vn("".slice),zn=Vn("".replace),qn=Vn([].join),Qn=Bn&&!Un((function(){return 8!==Kn((function(){}),"length",{value:8}).length})),Xn=String(String).split("String"),Zn=Rn.exports=function(e,t,i){"Symbol("===Yn(Jn(t),0,7)&&(t="["+zn(Jn(t),/^Symbol\(([^)]*)\)/,"$1")+"]"),i&&i.getter&&(t="get "+t),i&&i.setter&&(t="set "+t),(!Fn(e,"name")||Hn&&e.name!==t)&&(Bn?Kn(e,"name",{value:t,configurable:!0}):e.name=t),Qn&&i&&Fn(i,"arity")&&e.length!==i.arity&&Kn(e,"length",{value:i.arity});try{i&&Fn(i,"constructor")&&i.constructor?Bn&&Kn(e,"prototype",{writable:!1}):e.prototype&&(e.prototype=void 0)}catch(r){}var n=Gn(e);return Fn(n,"source")||(n.source=qn(Xn,"string"==typeof t?t:"")),e};Function.prototype.toString=Zn((function(){return xn(this)&&Wn(this).source||jn(this)}),"toString");var $n=Rn.exports,er=Se,tr=Pe,ir=$n,nr=O,rr=function(e,t,i,n){n||(n={});var r=n.enumerable,o=void 0!==n.name?n.name:t;if(er(i)&&ir(i,o,n),n.global)r?e[t]=i:nr(t,i);else{try{n.unsafe?e[t]&&(r=!0):delete e[t]}catch(s){}r?e[t]=i:tr.f(e,t,{value:i,enumerable:!1,configurable:!n.nonConfigurable,writable:!n.nonWritable})}return e},or={},sr=ni,ar=ri.concat("length","prototype");or.f=Object.getOwnPropertyNames||function(e){return sr(e,ar)};var cr={};cr.f=Object.getOwnPropertySymbols;var lr,dr,ur,hr=We,pr=or,_r=cr,mr=ke,fr=l([].concat),gr=hr("Reflect","ownKeys")||function(e){var t=pr.f(mr(e)),i=_r.f;return i?fr(t,i(e)):t},Tr=W,Er=gr,Ir=un,Sr=Pe,Ar=function(e,t,i){for(var n=Er(t),r=Sr.f,o=Ir.f,s=0;s<n.length;s++){var a=n[s];Tr(e,a)||i&&Tr(i,a)||r(e,a,o(t,a))}},yr=n,vr=Se,Rr=/#|\.prototype\./,Cr=function(e,t){var i=kr[br(e)];return i===Nr||i!==Dr&&(vr(t)?yr(t):!!t)},br=Cr.normalize=function(e){return String(e).replace(Rr,".").toLowerCase()},kr=Cr.data={},Dr=Cr.NATIVE="N",Nr=Cr.POLYFILL="P",Or=Cr,Pr=b,Lr=un.f,wr=qi,Mr=rr,Vr=O,Ur=Ar,xr=Or,Fr=function(e,t){var i,n,r,o,s,a=e.target,c=e.global,l=e.stat;if(i=c?Pr:l?Pr[a]||Vr(a,{}):(Pr[a]||{}).prototype)for(n in t){if(o=t[n],r=e.dontCallGetSet?(s=Lr(i,n))&&s.value:i[n],!xr(c?n:a+(l?".":"#")+n,e.forced)&&void 0!==r){if(typeof o==typeof r)continue;Ur(o,r)}(e.sham||r&&r.sham)&&wr(o,"sham",!0),Mr(i,n,o,e)}},Br=!n((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Hr=W,jr=Se,Gr=H,Wr=Br,Jr=Ti("IE_PROTO"),Kr=Object,Yr=Kr.prototype,zr=Wr?Kr.getPrototypeOf:function(e){var t=Gr(e);if(Hr(t,Jr))return t[Jr];var i=t.constructor;return jr(i)&&t instanceof i?i.prototype:t instanceof Kr?Yr:null},qr=n,Qr=Se,Xr=ve,Zr=zr,$r=rr,eo=ge("iterator"),to=!1;[].keys&&("next"in(ur=[].keys())?(dr=Zr(Zr(ur)))!==Object.prototype&&(lr=dr):to=!0);var io=!Xr(lr)||qr((function(){var e={};return lr[eo].call(e)!==e}));io&&(lr={}),Qr(lr[eo])||$r(lr,eo,(function(){return this}));var no={IteratorPrototype:lr,BUGGY_SAFARI_ITERATORS:to},ro=Pe.f,oo=W,so=ge("toStringTag"),ao=function(e,t,i){e&&!i&&(e=e.prototype),e&&!oo(e,so)&&ro(e,so,{configurable:!0,value:t})},co=no.IteratorPrototype,lo=Pi,uo=Ki,ho=ao,po=ji,_o=function(){return this},mo=function(e,t,i,n){var r=t+" Iterator";return e.prototype=lo(co,{next:uo(+!n,i)}),ho(e,r,!1),po[r]=_o,e},fo=l,go=it,To=Se,Eo=String,Io=TypeError,So=function(e,t,i){try{return fo(go(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(n){}},Ao=ke,yo=function(e){if("object"==typeof e||To(e))return e;throw Io("Can't set "+Eo(e)+" as a prototype")},vo=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=So(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(n){}return function(i,n){return Ao(i),yo(n),t?e(i,n):i.__proto__=n,i}}():void 0),Ro=Fr,Co=He,bo=Se,ko=mo,Do=zr,No=vo,Oo=ao,Po=qi,Lo=rr,wo=ji,Mo=On.PROPER,Vo=On.CONFIGURABLE,Uo=no.IteratorPrototype,xo=no.BUGGY_SAFARI_ITERATORS,Fo=ge("iterator"),Bo="keys",Ho="values",jo="entries",Go=function(){return this},Wo=function(e,t,i,n,r,o,s){ko(i,t,n);var a,c,l,d=function(e){if(e===r&&m)return m;if(!xo&&e&&e in p)return p[e];switch(e){case Bo:case Ho:case jo:return function(){return new i(this,e)}}return function(){return new i(this)}},u=t+" Iterator",h=!1,p=e.prototype,_=p[Fo]||p["@@iterator"]||r&&p[r],m=!xo&&_||d(r),f="Array"===t&&p.entries||_;if(f&&(a=Do(f.call(new e)))!==Object.prototype&&a.next&&(Do(a)!==Uo&&(No?No(a,Uo):bo(a[Fo])||Lo(a,Fo,Go)),Oo(a,u,!0)),Mo&&r===Ho&&_&&_.name!==Ho&&(Vo?Po(p,"name",Ho):(h=!0,m=function(){return Co(_,this)})),r)if(c={values:d(Ho),keys:o?m:d(Bo),entries:d(jo)},s)for(l in c)(xo||h||!(l in p))&&Lo(p,l,c[l]);else Ro({target:t,proto:!0,forced:xo||h},c);return p[Fo]!==m&&Lo(p,Fo,m,{name:r}),wo[t]=m,c},Jo=function(e,t){return{value:e,done:t}},Ko=R,Yo=Hi,zo=ji,qo=dn,Qo=Pe.f,Xo=Wo,Zo=Jo,$o=Ne,es="Array Iterator",ts=qo.set,is=qo.getterFor(es),ns=Xo(Array,"Array",(function(e,t){ts(this,{type:es,target:Ko(e),index:0,kind:t})}),(function(){var e=is(this),t=e.target,i=e.kind,n=e.index++;if(!t||n>=t.length)return e.target=void 0,Zo(void 0,!0);switch(i){case"keys":return Zo(n,!1);case"values":return Zo(t[n],!1)}return Zo([n,t[n]],!1)}),"values"),rs=zo.Arguments=zo.Array;if(Yo("keys"),Yo("values"),Yo("entries"),$o&&"values"!==rs.name)try{Qo(rs,"name",{value:"values"})}catch(ux){}var os={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ss=Ve("span").classList,as=ss&&ss.constructor&&ss.constructor.prototype,cs=as===Object.prototype?void 0:as,ls=b,ds=os,us=cs,hs=ns,ps=qi,_s=ge,ms=_s("iterator"),fs=_s("toStringTag"),gs=hs.values,Ts=function(e,t){if(e){if(e[ms]!==gs)try{ps(e,ms,gs)}catch(ux){e[ms]=gs}if(e[fs]||ps(e,fs,t),ds[t])for(var i in hs)if(e[i]!==hs[i])try{ps(e,i,hs[i])}catch(ux){e[i]=hs[i]}}};for(var Es in ds)Ts(ls[Es]&&ls[Es].prototype,Es);Ts(us,"DOMTokenList");var Is="process"===p(b.process),Ss=$n,As=Pe,ys=function(e,t,i){return i.get&&Ss(i.get,t,{getter:!0}),i.set&&Ss(i.set,t,{setter:!0}),As.f(e,t,i)},vs=We,Rs=ys,Cs=Ne,bs=ge("species"),ks=function(e){var t=vs(e);Cs&&t&&!t[bs]&&Rs(t,bs,{configurable:!0,get:function(){return this}})},Ds=Je,Ns=TypeError,Os=function(e,t){if(Ds(t,e))return e;throw Ns("Incorrect invocation")},Ps={};Ps[ge("toStringTag")]="z";var Ls="[object z]"===String(Ps),ws=Se,Ms=p,Vs=ge("toStringTag"),Us=Object,xs="Arguments"===Ms(function(){return arguments}()),Fs=Ls?Ms:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(ux){}}(t=Us(e),Vs))?i:xs?Ms(t):"Object"===(n=Ms(t))&&ws(t.callee)?"Arguments":n},Bs=l,Hs=n,js=Se,Gs=Fs,Ws=Mn,Js=function(){},Ks=[],Ys=We("Reflect","construct"),zs=/^\s*(?:class|function)\b/,qs=Bs(zs.exec),Qs=!zs.exec(Js),Xs=function(e){if(!js(e))return!1;try{return Ys(Js,Ks,e),!0}catch(ux){return!1}},Zs=function(e){if(!js(e))return!1;switch(Gs(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Qs||!!qs(zs,Ws(e))}catch(ux){return!0}};Zs.sham=!0;var $s,ea,ta,ia,na=!Ys||Hs((function(){var e;return Xs(Xs.call)||!Xs(Object)||!Xs((function(){e=!0}))||e}))?Zs:Xs,ra=na,oa=Ze,sa=TypeError,aa=function(e){if(ra(e))return e;throw sa(oa(e)+" is not a constructor")},ca=ke,la=aa,da=E,ua=ge("species"),ha=function(e,t){var i,n=ca(e).constructor;return void 0===n||da(i=ca(n)[ua])?t:la(i)},pa=r,_a=Function.prototype,ma=_a.apply,fa=_a.call,ga="object"==typeof Reflect&&Reflect.apply||(pa?fa.bind(ma):function(){return fa.apply(ma,arguments)}),Ta=p,Ea=l,Ia=function(e){if("Function"===Ta(e))return Ea(e)},Sa=it,Aa=r,ya=Ia(Ia.bind),va=function(e,t){return Sa(e),void 0===t?e:Aa?ya(e,t):function(){return e.apply(t,arguments)}},Ra=l([].slice),Ca=TypeError,ba=function(e,t){if(e<t)throw Ca("Not enough arguments");return e},ka=/(?:ipad|iphone|ipod).*applewebkit/i.test(Q),Da=b,Na=ga,Oa=va,Pa=Se,La=W,wa=n,Ma=mi,Va=Ra,Ua=Ve,xa=ba,Fa=ka,Ba=Is,Ha=Da.setImmediate,ja=Da.clearImmediate,Ga=Da.process,Wa=Da.Dispatch,Ja=Da.Function,Ka=Da.MessageChannel,Ya=Da.String,za=0,qa={},Qa="onreadystatechange";wa((function(){$s=Da.location}));var Xa=function(e){if(La(qa,e)){var t=qa[e];delete qa[e],t()}},Za=function(e){return function(){Xa(e)}},$a=function(e){Xa(e.data)},ec=function(e){Da.postMessage(Ya(e),$s.protocol+"//"+$s.host)};Ha&&ja||(Ha=function(e){xa(arguments.length,1);var t=Pa(e)?e:Ja(e),i=Va(arguments,1);return qa[++za]=function(){Na(t,void 0,i)},ea(za),za},ja=function(e){delete qa[e]},Ba?ea=function(e){Ga.nextTick(Za(e))}:Wa&&Wa.now?ea=function(e){Wa.now(Za(e))}:Ka&&!Fa?(ia=(ta=new Ka).port2,ta.port1.onmessage=$a,ea=Oa(ia.postMessage,ia)):Da.addEventListener&&Pa(Da.postMessage)&&!Da.importScripts&&$s&&"file:"!==$s.protocol&&!wa(ec)?(ea=ec,Da.addEventListener("message",$a,!1)):ea=Qa in Ua("script")?function(e){Ma.appendChild(Ua("script"))[Qa]=function(){Ma.removeChild(this),Xa(e)}}:function(e){setTimeout(Za(e),0)});var tc={set:Ha,clear:ja},ic=function(){this.head=null,this.tail=null};ic.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var nc,rc,oc,sc,ac,cc=ic,lc=/ipad|iphone|ipod/i.test(Q)&&"undefined"!=typeof Pebble,dc=/web0s(?!.*chrome)/i.test(Q),uc=b,hc=va,pc=un.f,_c=tc.set,mc=cc,fc=ka,gc=lc,Tc=dc,Ec=Is,Ic=uc.MutationObserver||uc.WebKitMutationObserver,Sc=uc.document,Ac=uc.process,yc=uc.Promise,vc=pc(uc,"queueMicrotask"),Rc=vc&&vc.value;if(!Rc){var Cc=new mc,bc=function(){var e,t;for(Ec&&(e=Ac.domain)&&e.exit();t=Cc.get();)try{t()}catch(ux){throw Cc.head&&nc(),ux}e&&e.enter()};fc||Ec||Tc||!Ic||!Sc?!gc&&yc&&yc.resolve?((sc=yc.resolve(void 0)).constructor=yc,ac=hc(sc.then,sc),nc=function(){ac(bc)}):Ec?nc=function(){Ac.nextTick(bc)}:(_c=hc(_c,uc),nc=function(){_c(bc)}):(rc=!0,oc=Sc.createTextNode(""),new Ic(bc).observe(oc,{characterData:!0}),nc=function(){oc.data=rc=!rc}),Rc=function(e){Cc.head||nc(),Cc.add(e)}}var kc=Rc,Dc=function(e){try{return{error:!1,value:e()}}catch(ux){return{error:!0,value:ux}}},Nc=b.Promise,Oc="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,Pc=!Oc&&!Is&&"object"==typeof window&&"object"==typeof document,Lc=b,wc=Nc,Mc=Se,Vc=Or,Uc=Mn,xc=ge,Fc=Pc,Bc=Oc,Hc=ne;wc&&wc.prototype;var jc=xc("species"),Gc=!1,Wc=Mc(Lc.PromiseRejectionEvent),Jc=Vc("Promise",(function(){var e=Uc(wc),t=e!==String(wc);if(!t&&66===Hc)return!0;if(!Hc||Hc<51||!/native code/.test(e)){var i=new wc((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};if((i.constructor={})[jc]=n,!(Gc=i.then((function(){}))instanceof n))return!0}return!t&&(Fc||Bc)&&!Wc})),Kc={CONSTRUCTOR:Jc,REJECTION_EVENT:Wc,SUBCLASSING:Gc},Yc={},zc=it,qc=TypeError,Qc=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw qc("Bad Promise constructor");t=e,i=n})),this.resolve=zc(t),this.reject=zc(i)};Yc.f=function(e){return new Qc(e)};var Xc,Zc,$c,el=Fr,tl=Is,il=b,nl=He,rl=rr,ol=vo,sl=ao,al=ks,cl=it,ll=Se,dl=ve,ul=Os,hl=ha,pl=tc.set,_l=kc,ml=function(e,t){try{1===arguments.length?console.error(e):console.error(e,t)}catch(ux){}},fl=Dc,gl=cc,Tl=dn,El=Nc,Il=Yc,Sl="Promise",Al=Kc.CONSTRUCTOR,yl=Kc.REJECTION_EVENT,vl=Kc.SUBCLASSING,Rl=Tl.getterFor(Sl),Cl=Tl.set,bl=El&&El.prototype,kl=El,Dl=bl,Nl=il.TypeError,Ol=il.document,Pl=il.process,Ll=Il.f,wl=Ll,Ml=!!(Ol&&Ol.createEvent&&il.dispatchEvent),Vl="unhandledrejection",Ul=function(e){var t;return!(!dl(e)||!ll(t=e.then))&&t},xl=function(e,t){var i,n,r,o=t.value,s=1===t.state,a=s?e.ok:e.fail,c=e.resolve,l=e.reject,d=e.domain;try{a?(s||(2===t.rejection&&Gl(t),t.rejection=1),!0===a?i=o:(d&&d.enter(),i=a(o),d&&(d.exit(),r=!0)),i===e.promise?l(Nl("Promise-chain cycle")):(n=Ul(i))?nl(n,i,c,l):c(i)):l(o)}catch(ux){d&&!r&&d.exit(),l(ux)}},Fl=function(e,t){e.notified||(e.notified=!0,_l((function(){for(var i,n=e.reactions;i=n.get();)xl(i,e);e.notified=!1,t&&!e.rejection&&Hl(e)})))},Bl=function(e,t,i){var n,r;Ml?((n=Ol.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),il.dispatchEvent(n)):n={promise:t,reason:i},!yl&&(r=il["on"+e])?r(n):e===Vl&&ml("Unhandled promise rejection",i)},Hl=function(e){nl(pl,il,(function(){var t,i=e.facade,n=e.value;if(jl(e)&&(t=fl((function(){tl?Pl.emit("unhandledRejection",n,i):Bl(Vl,i,n)})),e.rejection=tl||jl(e)?2:1,t.error))throw t.value}))},jl=function(e){return 1!==e.rejection&&!e.parent},Gl=function(e){nl(pl,il,(function(){var t=e.facade;tl?Pl.emit("rejectionHandled",t):Bl("rejectionhandled",t,e.value)}))},Wl=function(e,t,i){return function(n){e(t,n,i)}},Jl=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,Fl(e,!0))},Kl=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw Nl("Promise can't be resolved itself");var n=Ul(t);n?_l((function(){var i={done:!1};try{nl(n,t,Wl(Kl,i,e),Wl(Jl,i,e))}catch(ux){Jl(i,ux,e)}})):(e.value=t,e.state=1,Fl(e,!1))}catch(ux){Jl({done:!1},ux,e)}}};if(Al&&(Dl=(kl=function(e){ul(this,Dl),cl(e),nl(Xc,this);var t=Rl(this);try{e(Wl(Kl,t),Wl(Jl,t))}catch(ux){Jl(t,ux)}}).prototype,(Xc=function(e){Cl(this,{type:Sl,done:!1,notified:!1,parent:!1,reactions:new gl,rejection:!1,state:0,value:void 0})}).prototype=rl(Dl,"then",(function(e,t){var i=Rl(this),n=Ll(hl(this,kl));return i.parent=!0,n.ok=!ll(e)||e,n.fail=ll(t)&&t,n.domain=tl?Pl.domain:void 0,0===i.state?i.reactions.add(n):_l((function(){xl(n,i)})),n.promise})),Zc=function(){var e=new Xc,t=Rl(e);this.promise=e,this.resolve=Wl(Kl,t),this.reject=Wl(Jl,t)},Il.f=Ll=function(e){return e===kl||undefined===e?new Zc(e):wl(e)},ll(El)&&bl!==Object.prototype)){$c=bl.then,vl||rl(bl,"then",(function(e,t){var i=this;return new kl((function(e,t){nl($c,i,e,t)})).then(e,t)}),{unsafe:!0});try{delete bl.constructor}catch(ux){}ol&&ol(bl,Dl)}el({global:!0,constructor:!0,wrap:!0,forced:Al},{Promise:kl}),sl(kl,Sl,!1),al(Sl);var Yl=ji,zl=ge("iterator"),ql=Array.prototype,Ql=function(e){return void 0!==e&&(Yl.Array===e||ql[zl]===e)},Xl=Fs,Zl=ot,$l=E,ed=ji,td=ge("iterator"),id=function(e){if(!$l(e))return Zl(e,td)||Zl(e,"@@iterator")||ed[Xl(e)]},nd=He,rd=it,od=ke,sd=Ze,ad=id,cd=TypeError,ld=function(e,t){var i=arguments.length<2?ad(e):t;if(rd(i))return od(nd(i,e));throw cd(sd(e)+" is not iterable")},dd=He,ud=ke,hd=ot,pd=function(e,t,i){var n,r;ud(e);try{if(!(n=hd(e,"return"))){if("throw"===t)throw i;return i}n=dd(n,e)}catch(ux){r=!0,n=ux}if("throw"===t)throw i;if(r)throw n;return ud(n),i},_d=va,md=He,fd=ke,gd=Ze,Td=Ql,Ed=Jt,Id=Je,Sd=ld,Ad=id,yd=pd,vd=TypeError,Rd=function(e,t){this.stopped=e,this.result=t},Cd=Rd.prototype,bd=function(e,t,i){var n,r,o,s,a,c,l,d=i&&i.that,u=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),_=!(!i||!i.INTERRUPTED),m=_d(t,d),f=function(e){return n&&yd(n,"normal",e),new Rd(!0,e)},g=function(e){return u?(fd(e),_?m(e[0],e[1],f):m(e[0],e[1])):_?m(e,f):m(e)};if(h)n=e.iterator;else if(p)n=e;else{if(!(r=Ad(e)))throw vd(gd(e)+" is not iterable");if(Td(r)){for(o=0,s=Ed(e);s>o;o++)if((a=g(e[o]))&&Id(Cd,a))return a;return new Rd(!1)}n=Sd(e,r)}for(c=h?e.next:n.next;!(l=md(c,n)).done;){try{a=g(l.value)}catch(ux){yd(n,"throw",ux)}if("object"==typeof a&&a&&Id(Cd,a))return a}return new Rd(!1)},kd=ge("iterator"),Dd=!1;try{var Nd=0,Od={next:function(){return{done:!!Nd++}},return:function(){Dd=!0}};Od[kd]=function(){return this},Array.from(Od,(function(){throw 2}))}catch(ux){}var Pd=function(e,t){try{if(!t&&!Dd)return!1}catch(ux){return!1}var i=!1;try{var n={};n[kd]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(ux){}return i},Ld=Nc,wd=Kc.CONSTRUCTOR||!Pd((function(e){Ld.all(e).then(void 0,(function(){}))})),Md=He,Vd=it,Ud=Yc,xd=Dc,Fd=bd;Fr({target:"Promise",stat:!0,forced:wd},{all:function(e){var t=this,i=Ud.f(t),n=i.resolve,r=i.reject,o=xd((function(){var i=Vd(t.resolve),o=[],s=0,a=1;Fd(e,(function(e){var c=s++,l=!1;a++,Md(i,t,e).then((function(e){l||(l=!0,o[c]=e,--a||n(o))}),r)})),--a||n(o)}));return o.error&&r(o.value),i.promise}});var Bd=Fr,Hd=Kc.CONSTRUCTOR,jd=Nc,Gd=We,Wd=Se,Jd=rr,Kd=jd&&jd.prototype;if(Bd({target:"Promise",proto:!0,forced:Hd,real:!0},{catch:function(e){return this.then(void 0,e)}}),Wd(jd)){var Yd=Gd("Promise").prototype.catch;Kd.catch!==Yd&&Jd(Kd,"catch",Yd,{unsafe:!0})}var zd=He,qd=it,Qd=Yc,Xd=Dc,Zd=bd;Fr({target:"Promise",stat:!0,forced:wd},{race:function(e){var t=this,i=Qd.f(t),n=i.reject,r=Xd((function(){var r=qd(t.resolve);Zd(e,(function(e){zd(r,t,e).then(i.resolve,n)}))}));return r.error&&n(r.value),i.promise}});var $d=He,eu=Yc;Fr({target:"Promise",stat:!0,forced:Kc.CONSTRUCTOR},{reject:function(e){var t=eu.f(this);return $d(t.reject,void 0,e),t.promise}});var tu=ke,iu=ve,nu=Yc,ru=function(e,t){if(tu(e),iu(t)&&t.constructor===e)return t;var i=nu.f(e);return(0,i.resolve)(t),i.promise},ou=Fr,su=Kc.CONSTRUCTOR,au=ru;We("Promise"),ou({target:"Promise",stat:!0,forced:su},{resolve:function(e){return au(this,e)}});var cu=Se,lu=ve,du=vo,uu=function(e,t,i){var n,r;return du&&cu(n=t.constructor)&&n!==i&&lu(r=n.prototype)&&r!==i.prototype&&du(e,r),e},hu=ve,pu=p,_u=ge("match"),mu=function(e){var t;return hu(e)&&(void 0!==(t=e[_u])?!!t:"RegExp"===pu(e))},fu=Fs,gu=String,Tu=function(e){if("Symbol"===fu(e))throw TypeError("Cannot convert a Symbol value to a string");return gu(e)},Eu=ke,Iu=function(){var e=Eu(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},Su=He,Au=W,yu=Je,vu=Iu,Ru=RegExp.prototype,Cu=function(e){var t=e.flags;return void 0!==t||"flags"in Ru||Au(e,"flags")||!yu(Ru,e)?t:Su(vu,e)},bu=n,ku=b.RegExp,Du=bu((function(){var e=ku("a","y");return e.lastIndex=2,null!==e.exec("abcd")})),Nu=Du||bu((function(){return!ku("a","y").sticky})),Ou=Du||bu((function(){var e=ku("^r","gy");return e.lastIndex=2,null!==e.exec("str")})),Pu={BROKEN_CARET:Ou,MISSED_STICKY:Nu,UNSUPPORTED_Y:Du},Lu=Pe.f,wu=n,Mu=b.RegExp,Vu=wu((function(){var e=Mu(".","s");return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),Uu=n,xu=b.RegExp,Fu=Uu((function(){var e=xu("(?<a>b)","g");return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),Bu=Ne,Hu=b,ju=l,Gu=Or,Wu=uu,Ju=qi,Ku=or.f,Yu=Je,zu=mu,qu=Tu,Qu=Cu,Xu=Pu,Zu=function(e,t,i){i in e||Lu(e,i,{configurable:!0,get:function(){return t[i]},set:function(e){t[i]=e}})},$u=rr,eh=n,th=W,ih=dn.enforce,nh=ks,rh=Vu,oh=Fu,sh=ge("match"),ah=Hu.RegExp,ch=ah.prototype,lh=Hu.SyntaxError,dh=ju(ch.exec),uh=ju("".charAt),hh=ju("".replace),ph=ju("".indexOf),_h=ju("".slice),mh=/^\?<[^\s\d!#%&*+<=>@^][^\s!#%&*+<=>@^]*>/,fh=/a/g,gh=/a/g,Th=new ah(fh)!==fh,Eh=Xu.MISSED_STICKY,Ih=Xu.UNSUPPORTED_Y,Sh=Bu&&(!Th||Eh||rh||oh||eh((function(){return gh[sh]=!1,ah(fh)!==fh||ah(gh)===gh||"/a/i"!==String(ah(fh,"i"))})));if(Gu("RegExp",Sh)){for(var Ah=function(e,t){var i,n,r,o,s,a,c=Yu(ch,this),l=zu(e),d=void 0===t,u=[],h=e;if(!c&&l&&d&&e.constructor===Ah)return e;if((l||Yu(ch,e))&&(e=e.source,d&&(t=Qu(h))),e=void 0===e?"":qu(e),t=void 0===t?"":qu(t),h=e,rh&&"dotAll"in fh&&(n=!!t&&ph(t,"s")>-1)&&(t=hh(t,/s/g,"")),i=t,Eh&&"sticky"in fh&&(r=!!t&&ph(t,"y")>-1)&&Ih&&(t=hh(t,/y/g,"")),oh&&(o=function(e){for(var t,i=e.length,n=0,r="",o=[],s={},a=!1,c=!1,l=0,d="";n<=i;n++){if("\\"===(t=uh(e,n)))t+=uh(e,++n);else if("]"===t)a=!1;else if(!a)switch(!0){case"["===t:a=!0;break;case"("===t:dh(mh,_h(e,n+1))&&(n+=2,c=!0),r+=t,l++;continue;case">"===t&&c:if(""===d||th(s,d))throw new lh("Invalid capture group name");s[d]=!0,o[o.length]=[d,l],c=!1,d="";continue}c?d+=t:r+=t}return[r,o]}(e),e=o[0],u=o[1]),s=Wu(ah(e,t),c?this:ch,Ah),(n||r||u.length)&&(a=ih(s),n&&(a.dotAll=!0,a.raw=Ah(function(e){for(var t,i=e.length,n=0,r="",o=!1;n<=i;n++)"\\"!==(t=uh(e,n))?o||"."!==t?("["===t?o=!0:"]"===t&&(o=!1),r+=t):r+="[\\s\\S]":r+=t+uh(e,++n);return r}(e),i)),r&&(a.sticky=!0),u.length&&(a.groups=u)),e!==h)try{Ju(s,"source",""===h?"(?:)":h)}catch(ux){}return s},yh=Ku(ah),vh=0;yh.length>vh;)Zu(Ah,ah,yh[vh++]);ch.constructor=Ah,Ah.prototype=ch,$u(Hu,"RegExp",Ah,{constructor:!0})}nh("RegExp");var Rh=He,Ch=l,bh=Tu,kh=Iu,Dh=Pu,Nh=Pi,Oh=dn.get,Ph=Vu,Lh=Fu,wh=x("native-string-replace",String.prototype.replace),Mh=RegExp.prototype.exec,Vh=Mh,Uh=Ch("".charAt),xh=Ch("".indexOf),Fh=Ch("".replace),Bh=Ch("".slice),Hh=function(){var e=/a/,t=/b*/g;return Rh(Mh,e,"a"),Rh(Mh,t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),jh=Dh.BROKEN_CARET,Gh=void 0!==/()??/.exec("")[1];(Hh||Gh||jh||Ph||Lh)&&(Vh=function(e){var t,i,n,r,o,s,a,c=this,l=Oh(c),d=bh(e),u=l.raw;if(u)return u.lastIndex=c.lastIndex,t=Rh(Vh,u,d),c.lastIndex=u.lastIndex,t;var h=l.groups,p=jh&&c.sticky,_=Rh(kh,c),m=c.source,f=0,g=d;if(p&&(_=Fh(_,"y",""),-1===xh(_,"g")&&(_+="g"),g=Bh(d,c.lastIndex),c.lastIndex>0&&(!c.multiline||c.multiline&&"\n"!==Uh(d,c.lastIndex-1))&&(m="(?: "+m+")",g=" "+g,f++),i=new RegExp("^(?:"+m+")",_)),Gh&&(i=new RegExp("^"+m+"$(?!\\s)",_)),Hh&&(n=c.lastIndex),r=Rh(Mh,p?i:c,g),p?r?(r.input=Bh(r.input,f),r[0]=Bh(r[0],f),r.index=c.lastIndex,c.lastIndex+=r[0].length):c.lastIndex=0:Hh&&r&&(c.lastIndex=c.global?r.index+r[0].length:n),Gh&&r&&r.length>1&&Rh(wh,r[0],i,(function(){for(o=1;o<arguments.length-2;o++)void 0===arguments[o]&&(r[o]=void 0)})),r&&h)for(r.groups=s=Nh(null),o=0;o<h.length;o++)s[(a=h[o])[0]]=r[a[1]];return r});var Wh=Vh;Fr({target:"RegExp",proto:!0,forced:/./.exec!==Wh},{exec:Wh});var Jh=p,Kh=Array.isArray||function(e){return"Array"===Jh(e)},Yh=Kh,zh=na,qh=ve,Qh=ge("species"),Xh=Array,Zh=function(e){var t;return Yh(e)&&(t=e.constructor,(zh(t)&&(t===Xh||Yh(t.prototype))||qh(t)&&null===(t=t[Qh]))&&(t=void 0)),void 0===t?Xh:t},$h=va,ep=T,tp=H,ip=Jt,np=function(e,t){return new(Zh(e))(0===t?0:t)},rp=l([].push),op=function(e){var t=1===e,i=2===e,n=3===e,r=4===e,o=6===e,s=7===e,a=5===e||o;return function(c,l,d,u){for(var h,p,_=tp(c),m=ep(_),f=$h(l,d),g=ip(m),T=0,E=u||np,I=t?E(c,g):i||s?E(c,0):void 0;g>T;T++)if((a||T in m)&&(p=f(h=m[T],T,_),e))if(t)I[T]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return T;case 2:rp(I,h)}else switch(e){case 4:return!1;case 7:rp(I,h)}return o?-1:n||r?r:I}},sp={forEach:op(0),map:op(1),filter:op(2),some:op(3),every:op(4),find:op(5),findIndex:op(6),filterReject:op(7)},ap=n,cp=function(e,t){var i=[][e];return!!i&&ap((function(){i.call(null,t||function(){return 1},1)}))},lp=sp.forEach,dp=cp("forEach")?[].forEach:function(e){return lp(this,e,arguments.length>1?arguments[1]:void 0)},up=b,hp=os,pp=cs,_p=dp,mp=qi,fp=function(e){if(e&&e.forEach!==_p)try{mp(e,"forEach",_p)}catch(ux){e.forEach=_p}};for(var gp in hp)hp[gp]&&fp(up[gp]&&up[gp].prototype);fp(pp);var Tp=it,Ep=H,Ip=T,Sp=Jt,Ap=TypeError,yp=function(e){return function(t,i,n,r){Tp(i);var o=Ep(t),s=Ip(o),a=Sp(o),c=e?a-1:0,l=e?-1:1;if(n<2)for(;;){if(c in s){r=s[c],c+=l;break}if(c+=l,e?c<0:a<=c)throw Ap("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=l)c in s&&(r=i(r,s[c],c,o));return r}},vp={left:yp(!1),right:yp(!0)}.left;Fr({target:"Array",proto:!0,forced:!Is&&ne>79&&ne<83||!cp("reduce")},{reduce:function(e){var t=arguments.length;return vp(this,e,t,t>1?arguments[1]:void 0)}});var Rp=Ia,Cp=rr,bp=Wh,kp=n,Dp=ge,Np=qi,Op=Dp("species"),Pp=RegExp.prototype,Lp=l,wp=Vt,Mp=Tu,Vp=A,Up=Lp("".charAt),xp=Lp("".charCodeAt),Fp=Lp("".slice),Bp=function(e){return function(t,i){var n,r,o=Mp(Vp(t)),s=wp(i),a=o.length;return s<0||s>=a?e?"":void 0:(n=xp(o,s))<55296||n>56319||s+1===a||(r=xp(o,s+1))<56320||r>57343?e?Up(o,s):n:e?Fp(o,s,s+2):r-56320+(n-55296<<10)+65536}},Hp={codeAt:Bp(!1),charAt:Bp(!0)},jp=Hp.charAt,Gp=l,Wp=H,Jp=Math.floor,Kp=Gp("".charAt),Yp=Gp("".replace),zp=Gp("".slice),qp=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,Qp=/\$([$&'`]|\d{1,2})/g,Xp=function(e,t,i,n,r,o){var s=i+e.length,a=n.length,c=Qp;return void 0!==r&&(r=Wp(r),c=qp),Yp(o,c,(function(o,c){var l;switch(Kp(c,0)){case"$":return"$";case"&":return e;case"`":return zp(t,0,i);case"'":return zp(t,s);case"<":l=r[zp(c,1,-1)];break;default:var d=+c;if(0===d)return o;if(d>a){var u=Jp(d/10);return 0===u?o:u<=a?void 0===n[u-1]?Kp(c,1):n[u-1]+Kp(c,1):o}l=n[d-1]}return void 0===l?"":l}))},Zp=He,$p=ke,e_=Se,t_=p,i_=Wh,n_=TypeError,r_=ga,o_=He,s_=l,a_=function(e,t,i,n){var r=Dp(e),o=!kp((function(){var t={};return t[r]=function(){return 7},7!==""[e](t)})),s=o&&!kp((function(){var t=!1,i=/a/;return"split"===e&&((i={}).constructor={},i.constructor[Op]=function(){return i},i.flags="",i[r]=/./[r]),i.exec=function(){return t=!0,null},i[r](""),!t}));if(!o||!s||i){var a=Rp(/./[r]),c=t(r,""[e],(function(e,t,i,n,r){var s=Rp(e),c=t.exec;return c===bp||c===Pp.exec?o&&!r?{done:!0,value:a(t,i,n)}:{done:!0,value:s(i,t,n)}:{done:!1}}));Cp(String.prototype,e,c[0]),Cp(Pp,r,c[1])}n&&Np(Pp[r],"sham",!0)},c_=n,l_=ke,d_=Se,u_=E,h_=Vt,p_=Gt,__=Tu,m_=A,f_=function(e,t,i){return t+(i?jp(e,t).length:1)},g_=ot,T_=Xp,E_=function(e,t){var i=e.exec;if(e_(i)){var n=Zp(i,e,t);return null!==n&&$p(n),n}if("RegExp"===t_(e))return Zp(i_,e,t);throw n_("RegExp#exec called on incompatible receiver")},I_=ge("replace"),S_=Math.max,A_=Math.min,y_=s_([].concat),v_=s_([].push),R_=s_("".indexOf),C_=s_("".slice),b_=function(e){return void 0===e?e:String(e)},k_="$0"==="a".replace(/./,"$0"),D_=!!/./[I_]&&""===/./[I_]("a","$0"),N_=!c_((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}));a_("replace",(function(e,t,i){var n=D_?"$":"$0";return[function(e,i){var n=m_(this),r=u_(e)?void 0:g_(e,I_);return r?o_(r,e,n,i):o_(t,__(n),e,i)},function(e,r){var o=l_(this),s=__(e);if("string"==typeof r&&-1===R_(r,n)&&-1===R_(r,"$<")){var a=i(t,o,s,r);if(a.done)return a.value}var c=d_(r);c||(r=__(r));var l,d=o.global;d&&(l=o.unicode,o.lastIndex=0);for(var u,h=[];null!==(u=E_(o,s))&&(v_(h,u),d);){""===__(u[0])&&(o.lastIndex=f_(s,p_(o.lastIndex),l))}for(var p="",_=0,m=0;m<h.length;m++){for(var f,g=__((u=h[m])[0]),T=S_(A_(h_(u.index),s.length),0),E=[],I=1;I<u.length;I++)v_(E,b_(u[I]));var S=u.groups;if(c){var A=y_([g],E,T,s);void 0!==S&&v_(A,S),f=__(r_(r,void 0,A))}else f=T_(g,s,T,E,S,r);T>=_&&(p+=C_(s,_,T)+f,_=T+g.length)}return p+C_(s,_)}]}),!N_||!k_||D_);var O_=Qt.includes,P_=Hi;Fr({target:"Array",proto:!0,forced:n((function(){return!Array(1).includes()}))},{includes:function(e){return O_(this,e,arguments.length>1?arguments[1]:void 0)}}),P_("includes");var L_=Vt,w_=Tu,M_=A,V_=RangeError,U_=l,x_=Gt,F_=Tu,B_=function(e){var t=w_(M_(this)),i="",n=L_(e);if(n<0||Infinity===n)throw V_("Wrong number of repetitions");for(;n>0;(n>>>=1)&&(t+=t))1&n&&(i+=t);return i},H_=A,j_=U_(B_),G_=U_("".slice),W_=Math.ceil,J_=function(e){return function(t,i,n){var r,o,s=F_(H_(t)),a=x_(i),c=s.length,l=void 0===n?" ":F_(n);return a<=c||""===l?s:((o=j_(l,W_((r=a-c)/l.length))).length>r&&(o=G_(o,0,r)),e?s+o:o+s)}},K_={start:J_(!1),end:J_(!0)},Y_=/Version\/10(?:\.\d+){1,2}(?: [\w./]+)?(?: Mobile\/\w+)? Safari\//.test(Q),z_=K_.start;Fr({target:"String",proto:!0,forced:Y_},{padStart:function(e){return z_(this,e,arguments.length>1?arguments[1]:void 0)}});var q_=n,Q_=Ne,X_=ge("iterator"),Z_=!q_((function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,i=new URLSearchParams("a=1&a=2&b=3"),n="";return e.pathname="c%20d",t.forEach((function(e,i){t.delete("b"),n+=i+e})),i.delete("a",2),i.delete("b",void 0),!t.size&&!Q_||!t.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[X_]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://ÑÐµÑÑ").host||"#%D0%B1"!==new URL("http://a#Ð±").hash||"a1c3"!==n||"x"!==new URL("http://x",void 0).host})),$_=rr,em=function(e,t,i){for(var n in t)$_(e,n,t[n],i);return e},tm=It,im=Pe,nm=Ki,rm=function(e,t,i){var n=tm(t);n in e?im.f(e,n,nm(0,i)):e[n]=i},om=Bt,sm=Jt,am=rm,cm=Array,lm=Math.max,dm=function(e,t,i){for(var n=sm(e),r=om(t,n),o=om(void 0===i?n:i,n),s=cm(lm(o-r,0)),a=0;r<o;r++,a++)am(s,a,e[r]);return s.length=a,s},um=dm,hm=Math.floor,pm=function(e,t){var i=e.length,n=hm(i/2);return i<8?_m(e,t):mm(e,pm(um(e,0,n),t),pm(um(e,n),t),t)},_m=function(e,t){for(var i,n,r=e.length,o=1;o<r;){for(n=o,i=e[o];n&&t(e[n-1],i)>0;)e[n]=e[--n];n!==o++&&(e[n]=i)}return e},mm=function(e,t,i,n){for(var r=t.length,o=i.length,s=0,a=0;s<r||a<o;)e[s+a]=s<r&&a<o?n(t[s],i[a])<=0?t[s++]:i[a++]:s<r?t[s++]:i[a++];return e},fm=pm,gm=Fr,Tm=b,Em=He,Im=l,Sm=Ne,Am=Z_,ym=rr,vm=ys,Rm=em,Cm=ao,bm=mo,km=dn,Dm=Os,Nm=Se,Om=W,Pm=va,Lm=Fs,wm=ke,Mm=ve,Vm=Tu,Um=Pi,xm=Ki,Fm=ld,Bm=id,Hm=ba,jm=fm,Gm=ge("iterator"),Wm="URLSearchParams",Jm=Wm+"Iterator",Km=km.set,Ym=km.getterFor(Wm),zm=km.getterFor(Jm),qm=Object.getOwnPropertyDescriptor,Qm=function(e){if(!Sm)return Tm[e];var t=qm(Tm,e);return t&&t.value},Xm=Qm("fetch"),Zm=Qm("Request"),$m=Qm("Headers"),ef=Zm&&Zm.prototype,tf=$m&&$m.prototype,nf=Tm.RegExp,rf=Tm.TypeError,of=Tm.decodeURIComponent,sf=Tm.encodeURIComponent,af=Im("".charAt),cf=Im([].join),lf=Im([].push),df=Im("".replace),uf=Im([].shift),hf=Im([].splice),pf=Im("".split),_f=Im("".slice),mf=/\+/g,ff=Array(4),gf=function(e){return ff[e-1]||(ff[e-1]=nf("((?:%[\\da-f]{2}){"+e+"})","gi"))},Tf=function(e){try{return of(e)}catch(ux){return e}},Ef=function(e){var t=df(e,mf," "),i=4;try{return of(t)}catch(ux){for(;i;)t=df(t,gf(i--),Tf);return t}},If=/[!'()~]|%20/g,Sf={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},Af=function(e){return Sf[e]},yf=function(e){return df(sf(e),If,Af)},vf=bm((function(e,t){Km(this,{type:Jm,iterator:Fm(Ym(e).entries),kind:t})}),"Iterator",(function(){var e=zm(this),t=e.kind,i=e.iterator.next(),n=i.value;return i.done||(i.value="keys"===t?n.key:"values"===t?n.value:[n.key,n.value]),i}),!0),Rf=function(e){this.entries=[],this.url=null,void 0!==e&&(Mm(e)?this.parseObject(e):this.parseQuery("string"==typeof e?"?"===af(e,0)?_f(e,1):e:Vm(e)))};Rf.prototype={type:Wm,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,i,n,r,o,s,a,c=Bm(e);if(c)for(i=(t=Fm(e,c)).next;!(n=Em(i,t)).done;){if(o=(r=Fm(wm(n.value))).next,(s=Em(o,r)).done||(a=Em(o,r)).done||!Em(o,r).done)throw rf("Expected sequence with length 2");lf(this.entries,{key:Vm(s.value),value:Vm(a.value)})}else for(var l in e)Om(e,l)&&lf(this.entries,{key:l,value:Vm(e[l])})},parseQuery:function(e){if(e)for(var t,i,n=pf(e,"&"),r=0;r<n.length;)(t=n[r++]).length&&(i=pf(t,"="),lf(this.entries,{key:Ef(uf(i)),value:Ef(cf(i,"="))}))},serialize:function(){for(var e,t=this.entries,i=[],n=0;n<t.length;)e=t[n++],lf(i,yf(e.key)+"="+yf(e.value));return cf(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Cf=function(){Dm(this,bf);var e=Km(this,new Rf(arguments.length>0?arguments[0]:void 0));Sm||(this.size=e.entries.length)},bf=Cf.prototype;if(Rm(bf,{append:function(e,t){var i=Ym(this);Hm(arguments.length,2),lf(i.entries,{key:Vm(e),value:Vm(t)}),Sm||this.length++,i.updateURL()},delete:function(e){for(var t=Ym(this),i=Hm(arguments.length,1),n=t.entries,r=Vm(e),o=i<2?void 0:arguments[1],s=void 0===o?o:Vm(o),a=0;a<n.length;){var c=n[a];if(c.key!==r||void 0!==s&&c.value!==s)a++;else if(hf(n,a,1),void 0!==s)break}Sm||(this.size=n.length),t.updateURL()},get:function(e){var t=Ym(this).entries;Hm(arguments.length,1);for(var i=Vm(e),n=0;n<t.length;n++)if(t[n].key===i)return t[n].value;return null},getAll:function(e){var t=Ym(this).entries;Hm(arguments.length,1);for(var i=Vm(e),n=[],r=0;r<t.length;r++)t[r].key===i&&lf(n,t[r].value);return n},has:function(e){for(var t=Ym(this).entries,i=Hm(arguments.length,1),n=Vm(e),r=i<2?void 0:arguments[1],o=void 0===r?r:Vm(r),s=0;s<t.length;){var a=t[s++];if(a.key===n&&(void 0===o||a.value===o))return!0}return!1},set:function(e,t){var i=Ym(this);Hm(arguments.length,1);for(var n,r=i.entries,o=!1,s=Vm(e),a=Vm(t),c=0;c<r.length;c++)(n=r[c]).key===s&&(o?hf(r,c--,1):(o=!0,n.value=a));o||lf(r,{key:s,value:a}),Sm||(this.size=r.length),i.updateURL()},sort:function(){var e=Ym(this);jm(e.entries,(function(e,t){return e.key>t.key?1:-1})),e.updateURL()},forEach:function(e){for(var t,i=Ym(this).entries,n=Pm(e,arguments.length>1?arguments[1]:void 0),r=0;r<i.length;)n((t=i[r++]).value,t.key,this)},keys:function(){return new vf(this,"keys")},values:function(){return new vf(this,"values")},entries:function(){return new vf(this,"entries")}},{enumerable:!0}),ym(bf,Gm,bf.entries,{name:"entries"}),ym(bf,"toString",(function(){return Ym(this).serialize()}),{enumerable:!0}),Sm&&vm(bf,"size",{get:function(){return Ym(this).entries.length},configurable:!0,enumerable:!0}),Cm(Cf,Wm),gm({global:!0,constructor:!0,forced:!Am},{URLSearchParams:Cf}),!Am&&Nm($m)){var kf=Im(tf.has),Df=Im(tf.set),Nf=function(e){if(Mm(e)){var t,i=e.body;if(Lm(i)===Wm)return t=e.headers?new $m(e.headers):new $m,kf(t,"content-type")||Df(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),Um(e,{body:xm(0,Vm(i)),headers:xm(0,t)})}return e};if(Nm(Xm)&&gm({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return Xm(e,arguments.length>1?Nf(arguments[1]):{})}}),Nm(Zm)){var Of=function(e){return Dm(this,ef),new Zm(e,arguments.length>1?Nf(arguments[1]):{})};ef.constructor=Of,Of.prototype=ef,gm({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:Of})}}var Pf={URLSearchParams:Cf,getState:Ym},Lf="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",wf=A,Mf=Tu,Vf=Lf,Uf=l("".replace),xf=RegExp("^["+Vf+"]+"),Ff=RegExp("(^|[^"+Vf+"])["+Vf+"]+$"),Bf=function(e){return function(t){var i=Mf(wf(t));return 1&e&&(i=Uf(i,xf,"")),2&e&&(i=Uf(i,Ff,"$1")),i}},Hf={start:Bf(1),end:Bf(2),trim:Bf(3)},jf=On.PROPER,Gf=n,Wf=Lf,Jf=Hf.trim;Fr({target:"String",proto:!0,forced:function(e){return Gf((function(){return!!Wf[e]()||"âÂá "!=="âÂá "[e]()||jf&&Wf[e].name!==e}))}("trim")},{trim:function(){return Jf(this)}});var Kf=Fr,Yf=Ne,zf=l,qf=W,Qf=Se,Xf=Je,Zf=Tu,$f=ys,eg=Ar,tg=b.Symbol,ig=tg&&tg.prototype;if(Yf&&Qf(tg)&&(!("description"in ig)||void 0!==tg().description)){var ng={},rg=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:Zf(arguments[0]),t=Xf(ig,this)?new tg(e):void 0===e?tg():tg(e);return""===e&&(ng[t]=!0),t};eg(rg,tg),rg.prototype=ig,ig.constructor=rg;var og="Symbol(description detection)"===String(tg("description detection")),sg=zf(ig.valueOf),ag=zf(ig.toString),cg=/^Symbol\((.*)\)[^)]+$/,lg=zf("".replace),dg=zf("".slice);$f(ig,"description",{configurable:!0,get:function(){var e=sg(this);if(qf(ng,e))return"";var t=ag(e),i=og?dg(t,7,-1):lg(t,cg,"$1");return""===i?void 0:i}}),Kf({global:!0,constructor:!0,forced:!0},{Symbol:rg})}var ug=Hp.charAt,hg=Tu,pg=dn,_g=Wo,mg=Jo,fg="String Iterator",gg=pg.set,Tg=pg.getterFor(fg);_g(String,"String",(function(e){gg(this,{type:fg,string:hg(e),index:0})}),(function(){var e,t=Tg(this),i=t.string,n=t.index;return n>=i.length?mg(void 0,!0):(e=ug(i,n),t.index+=e.length,mg(e,!1))}));var Eg,Ig=Ne,Sg=l,Ag=He,yg=n,vg=ai,Rg=cr,Cg=hn,bg=H,kg=T,Dg=Object.assign,Ng=Object.defineProperty,Og=Sg([].concat),Pg=!Dg||yg((function(){if(Ig&&1!==Dg({b:1},Dg(Ng({},"a",{enumerable:!0,get:function(){Ng(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},i=Symbol("assign detection"),n="abcdefghijklmnopqrst";return e[i]=7,n.split("").forEach((function(e){t[e]=e})),7!==Dg({},e)[i]||vg(Dg({},t)).join("")!==n}))?function(e,t){for(var i=bg(e),n=arguments.length,r=1,o=Rg.f,s=Cg.f;n>r;)for(var a,c=kg(arguments[r++]),l=o?Og(vg(c),o(c)):vg(c),d=l.length,u=0;d>u;)a=l[u++],Ig&&!Ag(s,c,a)||(i[a]=c[a]);return i}:Dg,Lg=ke,wg=pd,Mg=va,Vg=He,Ug=H,xg=function(e,t,i,n){try{return n?t(Lg(i)[0],i[1]):t(i)}catch(ux){wg(e,"throw",ux)}},Fg=Ql,Bg=na,Hg=Jt,jg=rm,Gg=ld,Wg=id,Jg=Array,Kg=l,Yg=2147483647,zg=/[^\0-\u007E]/,qg=/[.\u3002\uFF0E\uFF61]/g,Qg="Overflow: input needs wider integers to process",Xg=RangeError,Zg=Kg(qg.exec),$g=Math.floor,eT=String.fromCharCode,tT=Kg("".charCodeAt),iT=Kg([].join),nT=Kg([].push),rT=Kg("".replace),oT=Kg("".split),sT=Kg("".toLowerCase),aT=function(e){return e+22+75*(e<26)},cT=function(e,t,i){var n=0;for(e=i?$g(e/700):e>>1,e+=$g(e/t);e>455;)e=$g(e/35),n+=36;return $g(n+36*e/(e+38))},lT=function(e){var t=[];e=function(e){for(var t=[],i=0,n=e.length;i<n;){var r=tT(e,i++);if(r>=55296&&r<=56319&&i<n){var o=tT(e,i++);56320==(64512&o)?nT(t,((1023&r)<<10)+(1023&o)+65536):(nT(t,r),i--)}else nT(t,r)}return t}(e);var i,n,r=e.length,o=128,s=0,a=72;for(i=0;i<e.length;i++)(n=e[i])<128&&nT(t,eT(n));var c=t.length,l=c;for(c&&nT(t,"-");l<r;){var d=Yg;for(i=0;i<e.length;i++)(n=e[i])>=o&&n<d&&(d=n);var u=l+1;if(d-o>$g((Yg-s)/u))throw Xg(Qg);for(s+=(d-o)*u,o=d,i=0;i<e.length;i++){if((n=e[i])<o&&++s>Yg)throw Xg(Qg);if(n===o){for(var h=s,p=36;;){var _=p<=a?1:p>=a+26?26:p-a;if(h<_)break;var m=h-_,f=36-_;nT(t,eT(aT(_+m%f))),h=$g(m/f),p+=36}nT(t,eT(aT(h))),a=cT(s,u,l===c),s=0,l++}}s++,o++}return iT(t,"")},dT=Fr,uT=Ne,hT=Z_,pT=b,_T=va,mT=l,fT=rr,gT=ys,TT=Os,ET=W,IT=Pg,ST=function(e){var t=Ug(e),i=Bg(this),n=arguments.length,r=n>1?arguments[1]:void 0,o=void 0!==r;o&&(r=Mg(r,n>2?arguments[2]:void 0));var s,a,c,l,d,u,h=Wg(t),p=0;if(!h||this===Jg&&Fg(h))for(s=Hg(t),a=i?new this(s):Jg(s);s>p;p++)u=o?r(t[p],p):t[p],jg(a,p,u);else for(d=(l=Gg(t,h)).next,a=i?new this:[];!(c=Vg(d,l)).done;p++)u=o?xg(l,r,[c.value,p],!0):c.value,jg(a,p,u);return a.length=p,a},AT=dm,yT=Hp.codeAt,vT=function(e){var t,i,n=[],r=oT(rT(sT(e),qg,"."),".");for(t=0;t<r.length;t++)i=r[t],nT(n,Zg(zg,i)?"xn--"+lT(i):i);return iT(n,".")},RT=Tu,CT=ao,bT=ba,kT=Pf,DT=dn,NT=DT.set,OT=DT.getterFor("URL"),PT=kT.URLSearchParams,LT=kT.getState,wT=pT.URL,MT=pT.TypeError,VT=pT.parseInt,UT=Math.floor,xT=Math.pow,FT=mT("".charAt),BT=mT(/./.exec),HT=mT([].join),jT=mT(1..toString),GT=mT([].pop),WT=mT([].push),JT=mT("".replace),KT=mT([].shift),YT=mT("".split),zT=mT("".slice),qT=mT("".toLowerCase),QT=mT([].unshift),XT="Invalid scheme",ZT="Invalid host",$T="Invalid port",eE=/[a-z]/i,tE=/[\d+-.a-z]/i,iE=/\d/,nE=/^0x/i,rE=/^[0-7]+$/,oE=/^\d+$/,sE=/^[\da-f]+$/i,aE=/[\0\t\n\r #%/:<>?@[\\\]^|]/,cE=/[\0\t\n\r #/:<>?@[\\\]^|]/,lE=/^[\u0000-\u0020]+/,dE=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,uE=/[\t\n\r]/g,hE=function(e){var t,i,n,r;if("number"==typeof e){for(t=[],i=0;i<4;i++)QT(t,e%256),e=UT(e/256);return HT(t,".")}if("object"==typeof e){for(t="",n=function(e){for(var t=null,i=1,n=null,r=0,o=0;o<8;o++)0!==e[o]?(r>i&&(t=n,i=r),n=null,r=0):(null===n&&(n=o),++r);return r>i&&(t=n,i=r),t}(e),i=0;i<8;i++)r&&0===e[i]||(r&&(r=!1),n===i?(t+=i?":":"::",r=!0):(t+=jT(e[i],16),i<7&&(t+=":")));return"["+t+"]"}return e},pE={},_E=IT({},pE,{" ":1,'"':1,"<":1,">":1,"`":1}),mE=IT({},_E,{"#":1,"?":1,"{":1,"}":1}),fE=IT({},mE,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),gE=function(e,t){var i=yT(e,0);return i>32&&i<127&&!ET(t,e)?e:encodeURIComponent(e)},TE={ftp:21,file:null,http:80,https:443,ws:80,wss:443},EE=function(e,t){var i;return 2===e.length&&BT(eE,FT(e,0))&&(":"===(i=FT(e,1))||!t&&"|"===i)},IE=function(e){var t;return e.length>1&&EE(zT(e,0,2))&&(2===e.length||"/"===(t=FT(e,2))||"\\"===t||"?"===t||"#"===t)},SE=function(e){return"."===e||"%2e"===qT(e)},AE={},yE={},vE={},RE={},CE={},bE={},kE={},DE={},NE={},OE={},PE={},LE={},wE={},ME={},VE={},UE={},xE={},FE={},BE={},HE={},jE={},GE=function(e,t,i){var n,r,o,s=RT(e);if(t){if(r=this.parse(s))throw MT(r);this.searchParams=null}else{if(void 0!==i&&(n=new GE(i,!0)),r=this.parse(s,null,n))throw MT(r);(o=LT(new PT)).bindURL(this),this.searchParams=o}};GE.prototype={type:"URL",parse:function(e,t,i){var n,r,o,s,a,c=this,l=t||AE,d=0,u="",h=!1,p=!1,_=!1;for(e=RT(e),t||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,e=JT(e,lE,""),e=JT(e,dE,"$1")),e=JT(e,uE,""),n=ST(e);d<=n.length;){switch(r=n[d],l){case AE:if(!r||!BT(eE,r)){if(t)return XT;l=vE;continue}u+=qT(r),l=yE;break;case yE:if(r&&(BT(tE,r)||"+"===r||"-"===r||"."===r))u+=qT(r);else{if(":"!==r){if(t)return XT;u="",l=vE,d=0;continue}if(t&&(c.isSpecial()!==ET(TE,u)||"file"===u&&(c.includesCredentials()||null!==c.port)||"file"===c.scheme&&!c.host))return;if(c.scheme=u,t)return void(c.isSpecial()&&TE[c.scheme]===c.port&&(c.port=null));u="","file"===c.scheme?l=ME:c.isSpecial()&&i&&i.scheme===c.scheme?l=RE:c.isSpecial()?l=DE:"/"===n[d+1]?(l=CE,d++):(c.cannotBeABaseURL=!0,WT(c.path,""),l=BE)}break;case vE:if(!i||i.cannotBeABaseURL&&"#"!==r)return XT;if(i.cannotBeABaseURL&&"#"===r){c.scheme=i.scheme,c.path=AT(i.path),c.query=i.query,c.fragment="",c.cannotBeABaseURL=!0,l=jE;break}l="file"===i.scheme?ME:bE;continue;case RE:if("/"!==r||"/"!==n[d+1]){l=bE;continue}l=NE,d++;break;case CE:if("/"===r){l=OE;break}l=FE;continue;case bE:if(c.scheme=i.scheme,r===Eg)c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=AT(i.path),c.query=i.query;else if("/"===r||"\\"===r&&c.isSpecial())l=kE;else if("?"===r)c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=AT(i.path),c.query="",l=HE;else{if("#"!==r){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=AT(i.path),c.path.length--,l=FE;continue}c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=AT(i.path),c.query=i.query,c.fragment="",l=jE}break;case kE:if(!c.isSpecial()||"/"!==r&&"\\"!==r){if("/"!==r){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,l=FE;continue}l=OE}else l=NE;break;case DE:if(l=NE,"/"!==r||"/"!==FT(u,d+1))continue;d++;break;case NE:if("/"!==r&&"\\"!==r){l=OE;continue}break;case OE:if("@"===r){h&&(u="%40"+u),h=!0,o=ST(u);for(var m=0;m<o.length;m++){var f=o[m];if(":"!==f||_){var g=gE(f,fE);_?c.password+=g:c.username+=g}else _=!0}u=""}else if(r===Eg||"/"===r||"?"===r||"#"===r||"\\"===r&&c.isSpecial()){if(h&&""===u)return"Invalid authority";d-=ST(u).length+1,u="",l=PE}else u+=r;break;case PE:case LE:if(t&&"file"===c.scheme){l=UE;continue}if(":"!==r||p){if(r===Eg||"/"===r||"?"===r||"#"===r||"\\"===r&&c.isSpecial()){if(c.isSpecial()&&""===u)return ZT;if(t&&""===u&&(c.includesCredentials()||null!==c.port))return;if(s=c.parseHost(u))return s;if(u="",l=xE,t)return;continue}"["===r?p=!0:"]"===r&&(p=!1),u+=r}else{if(""===u)return ZT;if(s=c.parseHost(u))return s;if(u="",l=wE,t===LE)return}break;case wE:if(!BT(iE,r)){if(r===Eg||"/"===r||"?"===r||"#"===r||"\\"===r&&c.isSpecial()||t){if(""!==u){var T=VT(u,10);if(T>65535)return $T;c.port=c.isSpecial()&&T===TE[c.scheme]?null:T,u=""}if(t)return;l=xE;continue}return $T}u+=r;break;case ME:if(c.scheme="file","/"===r||"\\"===r)l=VE;else{if(!i||"file"!==i.scheme){l=FE;continue}switch(r){case Eg:c.host=i.host,c.path=AT(i.path),c.query=i.query;break;case"?":c.host=i.host,c.path=AT(i.path),c.query="",l=HE;break;case"#":c.host=i.host,c.path=AT(i.path),c.query=i.query,c.fragment="",l=jE;break;default:IE(HT(AT(n,d),""))||(c.host=i.host,c.path=AT(i.path),c.shortenPath()),l=FE;continue}}break;case VE:if("/"===r||"\\"===r){l=UE;break}i&&"file"===i.scheme&&!IE(HT(AT(n,d),""))&&(EE(i.path[0],!0)?WT(c.path,i.path[0]):c.host=i.host),l=FE;continue;case UE:if(r===Eg||"/"===r||"\\"===r||"?"===r||"#"===r){if(!t&&EE(u))l=FE;else if(""===u){if(c.host="",t)return;l=xE}else{if(s=c.parseHost(u))return s;if("localhost"===c.host&&(c.host=""),t)return;u="",l=xE}continue}u+=r;break;case xE:if(c.isSpecial()){if(l=FE,"/"!==r&&"\\"!==r)continue}else if(t||"?"!==r)if(t||"#"!==r){if(r!==Eg&&(l=FE,"/"!==r))continue}else c.fragment="",l=jE;else c.query="",l=HE;break;case FE:if(r===Eg||"/"===r||"\\"===r&&c.isSpecial()||!t&&("?"===r||"#"===r)){if(".."===(a=qT(a=u))||"%2e."===a||".%2e"===a||"%2e%2e"===a?(c.shortenPath(),"/"===r||"\\"===r&&c.isSpecial()||WT(c.path,"")):SE(u)?"/"===r||"\\"===r&&c.isSpecial()||WT(c.path,""):("file"===c.scheme&&!c.path.length&&EE(u)&&(c.host&&(c.host=""),u=FT(u,0)+":"),WT(c.path,u)),u="","file"===c.scheme&&(r===Eg||"?"===r||"#"===r))for(;c.path.length>1&&""===c.path[0];)KT(c.path);"?"===r?(c.query="",l=HE):"#"===r&&(c.fragment="",l=jE)}else u+=gE(r,mE);break;case BE:"?"===r?(c.query="",l=HE):"#"===r?(c.fragment="",l=jE):r!==Eg&&(c.path[0]+=gE(r,pE));break;case HE:t||"#"!==r?r!==Eg&&("'"===r&&c.isSpecial()?c.query+="%27":c.query+="#"===r?"%23":gE(r,pE)):(c.fragment="",l=jE);break;case jE:r!==Eg&&(c.fragment+=gE(r,_E))}d++}},parseHost:function(e){var t,i,n;if("["===FT(e,0)){if("]"!==FT(e,e.length-1))return ZT;if(t=function(e){var t,i,n,r,o,s,a,c=[0,0,0,0,0,0,0,0],l=0,d=null,u=0,h=function(){return FT(e,u)};if(":"===h()){if(":"!==FT(e,1))return;u+=2,d=++l}for(;h();){if(8===l)return;if(":"!==h()){for(t=i=0;i<4&&BT(sE,h());)t=16*t+VT(h(),16),u++,i++;if("."===h()){if(0===i)return;if(u-=i,l>6)return;for(n=0;h();){if(r=null,n>0){if(!("."===h()&&n<4))return;u++}if(!BT(iE,h()))return;for(;BT(iE,h());){if(o=VT(h(),10),null===r)r=o;else{if(0===r)return;r=10*r+o}if(r>255)return;u++}c[l]=256*c[l]+r,2!=++n&&4!==n||l++}if(4!==n)return;break}if(":"===h()){if(u++,!h())return}else if(h())return;c[l++]=t}else{if(null!==d)return;u++,d=++l}}if(null!==d)for(s=l-d,l=7;0!==l&&s>0;)a=c[l],c[l--]=c[d+s-1],c[d+--s]=a;else if(8!==l)return;return c}(zT(e,1,-1)),!t)return ZT;this.host=t}else if(this.isSpecial()){if(e=vT(e),BT(aE,e))return ZT;if(t=function(e){var t,i,n,r,o,s,a,c=YT(e,".");if(c.length&&""===c[c.length-1]&&c.length--,(t=c.length)>4)return e;for(i=[],n=0;n<t;n++){if(""===(r=c[n]))return e;if(o=10,r.length>1&&"0"===FT(r,0)&&(o=BT(nE,r)?16:8,r=zT(r,8===o?1:2)),""===r)s=0;else{if(!BT(10===o?oE:8===o?rE:sE,r))return e;s=VT(r,o)}WT(i,s)}for(n=0;n<t;n++)if(s=i[n],n===t-1){if(s>=xT(256,5-t))return null}else if(s>255)return null;for(a=GT(i),n=0;n<i.length;n++)a+=i[n]*xT(256,3-n);return a}(e),null===t)return ZT;this.host=t}else{if(BT(cE,e))return ZT;for(t="",i=ST(e),n=0;n<i.length;n++)t+=gE(i[n],pE);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"===this.scheme},includesCredentials:function(){return""!==this.username||""!==this.password},isSpecial:function(){return ET(TE,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||"file"===this.scheme&&1===t&&EE(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,i=e.username,n=e.password,r=e.host,o=e.port,s=e.path,a=e.query,c=e.fragment,l=t+":";return null!==r?(l+="//",e.includesCredentials()&&(l+=i+(n?":"+n:"")+"@"),l+=hE(r),null!==o&&(l+=":"+o)):"file"===t&&(l+="//"),l+=e.cannotBeABaseURL?s[0]:s.length?"/"+HT(s,"/"):"",null!==a&&(l+="?"+a),null!==c&&(l+="#"+c),l},setHref:function(e){var t=this.parse(e);if(t)throw MT(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if("blob"===e)try{return new WE(e.path[0]).origin}catch(ux){return"null"}return"file"!==e&&this.isSpecial()?e+"://"+hE(this.host)+(null!==t?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(RT(e)+":",AE)},getUsername:function(){return this.username},setUsername:function(e){var t=ST(RT(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<t.length;i++)this.username+=gE(t[i],fE)}},getPassword:function(){return this.password},setPassword:function(e){var t=ST(RT(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<t.length;i++)this.password+=gE(t[i],fE)}},getHost:function(){var e=this.host,t=this.port;return null===e?"":null===t?hE(e):hE(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,PE)},getHostname:function(){var e=this.host;return null===e?"":hE(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,LE)},getPort:function(){var e=this.port;return null===e?"":RT(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||(""===(e=RT(e))?this.port=null:this.parse(e,wE))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+HT(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,xE))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){""===(e=RT(e))?this.query=null:("?"===FT(e,0)&&(e=zT(e,1)),this.query="",this.parse(e,HE)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){""!==(e=RT(e))?("#"===FT(e,0)&&(e=zT(e,1)),this.fragment="",this.parse(e,jE)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var WE=function(e){var t=TT(this,JE),i=bT(arguments.length,1)>1?arguments[1]:void 0,n=NT(t,new GE(e,!1,i));uT||(t.href=n.serialize(),t.origin=n.getOrigin(),t.protocol=n.getProtocol(),t.username=n.getUsername(),t.password=n.getPassword(),t.host=n.getHost(),t.hostname=n.getHostname(),t.port=n.getPort(),t.pathname=n.getPathname(),t.search=n.getSearch(),t.searchParams=n.getSearchParams(),t.hash=n.getHash())},JE=WE.prototype,KE=function(e,t){return{get:function(){return OT(this)[e]()},set:t&&function(e){return OT(this)[t](e)},configurable:!0,enumerable:!0}};if(uT&&(gT(JE,"href",KE("serialize","setHref")),gT(JE,"origin",KE("getOrigin")),gT(JE,"protocol",KE("getProtocol","setProtocol")),gT(JE,"username",KE("getUsername","setUsername")),gT(JE,"password",KE("getPassword","setPassword")),gT(JE,"host",KE("getHost","setHost")),gT(JE,"hostname",KE("getHostname","setHostname")),gT(JE,"port",KE("getPort","setPort")),gT(JE,"pathname",KE("getPathname","setPathname")),gT(JE,"search",KE("getSearch","setSearch")),gT(JE,"searchParams",KE("getSearchParams")),gT(JE,"hash",KE("getHash","setHash"))),fT(JE,"toJSON",(function(){return OT(this).serialize()}),{enumerable:!0}),fT(JE,"toString",(function(){return OT(this).serialize()}),{enumerable:!0}),wT){var YE=wT.createObjectURL,zE=wT.revokeObjectURL;YE&&fT(WE,"createObjectURL",_T(YE,wT)),zE&&fT(WE,"revokeObjectURL",_T(zE,wT))}CT(WE,"URL"),dT({global:!0,constructor:!0,forced:!hT,sham:!uT},{URL:WE});var qE="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,QE=Vt,XE=Gt,ZE=RangeError,$E=function(e){if(void 0===e)return 0;var t=QE(e),i=XE(t);if(t!==i)throw ZE("Wrong length or index");return i},eI=Math.sign||function(e){var t=+e;return 0===t||t!=t?t:t<0?-1:1},tI=eI,iI=wt,nI=Array,rI=Math.abs,oI=Math.pow,sI=Math.floor,aI=Math.log,cI=Math.LN2,lI=function(e){var t=iI(e),i=rI(e-t);return i>.5||.5===i&&t%2!=0?t+tI(e):t},dI={pack:function(e,t,i){var n,r,o,s=nI(i),a=8*i-t-1,c=(1<<a)-1,l=c>>1,d=23===t?oI(2,-24)-oI(2,-77):0,u=e<0||0===e&&1/e<0?1:0,h=0;for((e=rI(e))!=e||Infinity===e?(r=e!=e?1:0,n=c):(n=sI(aI(e)/cI),e*(o=oI(2,-n))<1&&(n--,o*=2),(e+=n+l>=1?d/o:d*oI(2,1-l))*o>=2&&(n++,o/=2),n+l>=c?(r=0,n=c):n+l>=1?(r=lI((e*o-1)*oI(2,t)),n+=l):(r=lI(e*oI(2,l-1)*oI(2,t)),n=0));t>=8;)s[h++]=255&r,r/=256,t-=8;for(n=n<<t|r,a+=t;a>0;)s[h++]=255&n,n/=256,a-=8;return s[--h]|=128*u,s},unpack:function(e,t){var i,n=e.length,r=8*n-t-1,o=(1<<r)-1,s=o>>1,a=r-7,c=n-1,l=e[c--],d=127&l;for(l>>=7;a>0;)d=256*d+e[c--],a-=8;for(i=d&(1<<-a)-1,d>>=-a,a+=t;a>0;)i=256*i+e[c--],a-=8;if(0===d)d=1-s;else{if(d===o)return i?NaN:l?-Infinity:Infinity;i+=oI(2,t),d-=s}return(l?-1:1)*i*oI(2,d-t)}},uI=H,hI=Bt,pI=Jt,_I=function(e){for(var t=uI(this),i=pI(t),n=arguments.length,r=hI(n>1?arguments[1]:void 0,i),o=n>2?arguments[2]:void 0,s=void 0===o?i:hI(o,i);s>r;)t[r++]=e;return t},mI=b,fI=l,gI=Ne,TI=qE,EI=On,II=qi,SI=ys,AI=em,yI=n,vI=Os,RI=Vt,CI=Gt,bI=$E,kI=dI,DI=zr,NI=vo,OI=or.f,PI=_I,LI=dm,wI=ao,MI=dn,VI=EI.PROPER,UI=EI.CONFIGURABLE,xI="ArrayBuffer",FI="DataView",BI="prototype",HI="Wrong index",jI=MI.getterFor(xI),GI=MI.getterFor(FI),WI=MI.set,JI=mI[xI],KI=JI,YI=KI&&KI[BI],zI=mI[FI],qI=zI&&zI[BI],QI=Object.prototype,XI=mI.Array,ZI=mI.RangeError,$I=fI(PI),eS=fI([].reverse),tS=kI.pack,iS=kI.unpack,nS=function(e){return[255&e]},rS=function(e){return[255&e,e>>8&255]},oS=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},sS=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},aS=function(e){return tS(e,23,4)},cS=function(e){return tS(e,52,8)},lS=function(e,t,i){SI(e[BI],t,{configurable:!0,get:function(){return i(this)[t]}})},dS=function(e,t,i,n){var r=GI(e),o=bI(i),s=!!n;if(o+t>r.byteLength)throw ZI(HI);var a=r.bytes,c=o+r.byteOffset,l=LI(a,c,c+t);return s?l:eS(l)},uS=function(e,t,i,n,r,o){var s=GI(e),a=bI(i),c=n(+r),l=!!o;if(a+t>s.byteLength)throw ZI(HI);for(var d=s.bytes,u=a+s.byteOffset,h=0;h<t;h++)d[u+h]=c[l?h:t-h-1]};if(TI){var hS=VI&&JI.name!==xI;if(yI((function(){JI(1)}))&&yI((function(){new JI(-1)}))&&!yI((function(){return new JI,new JI(1.5),new JI(NaN),1!==JI.length||hS&&!UI})))hS&&UI&&II(JI,"name",xI);else{(KI=function(e){return vI(this,YI),new JI(bI(e))})[BI]=YI;for(var pS,_S=OI(JI),mS=0;_S.length>mS;)(pS=_S[mS++])in KI||II(KI,pS,JI[pS]);YI.constructor=KI}NI&&DI(qI)!==QI&&NI(qI,QI);var fS=new zI(new KI(2)),gS=fI(qI.setInt8);fS.setInt8(0,2147483648),fS.setInt8(1,2147483649),!fS.getInt8(0)&&fS.getInt8(1)||AI(qI,{setInt8:function(e,t){gS(this,e,t<<24>>24)},setUint8:function(e,t){gS(this,e,t<<24>>24)}},{unsafe:!0})}else YI=(KI=function(e){vI(this,YI);var t=bI(e);WI(this,{type:xI,bytes:$I(XI(t),0),byteLength:t}),gI||(this.byteLength=t,this.detached=!1)})[BI],qI=(zI=function(e,t,i){vI(this,qI),vI(e,YI);var n=jI(e),r=n.byteLength,o=RI(t);if(o<0||o>r)throw ZI("Wrong offset");if(o+(i=void 0===i?r-o:CI(i))>r)throw ZI("Wrong length");WI(this,{type:FI,buffer:e,byteLength:i,byteOffset:o,bytes:n.bytes}),gI||(this.buffer=e,this.byteLength=i,this.byteOffset=o)})[BI],gI&&(lS(KI,"byteLength",jI),lS(zI,"buffer",GI),lS(zI,"byteLength",GI),lS(zI,"byteOffset",GI)),AI(qI,{getInt8:function(e){return dS(this,1,e)[0]<<24>>24},getUint8:function(e){return dS(this,1,e)[0]},getInt16:function(e){var t=dS(this,2,e,arguments.length>1&&arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=dS(this,2,e,arguments.length>1&&arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return sS(dS(this,4,e,arguments.length>1&&arguments[1]))},getUint32:function(e){return sS(dS(this,4,e,arguments.length>1&&arguments[1]))>>>0},getFloat32:function(e){return iS(dS(this,4,e,arguments.length>1&&arguments[1]),23)},getFloat64:function(e){return iS(dS(this,8,e,arguments.length>1&&arguments[1]),52)},setInt8:function(e,t){uS(this,1,e,nS,t)},setUint8:function(e,t){uS(this,1,e,nS,t)},setInt16:function(e,t){uS(this,2,e,rS,t,arguments.length>2&&arguments[2])},setUint16:function(e,t){uS(this,2,e,rS,t,arguments.length>2&&arguments[2])},setInt32:function(e,t){uS(this,4,e,oS,t,arguments.length>2&&arguments[2])},setUint32:function(e,t){uS(this,4,e,oS,t,arguments.length>2&&arguments[2])},setFloat32:function(e,t){uS(this,4,e,aS,t,arguments.length>2&&arguments[2])},setFloat64:function(e,t){uS(this,8,e,cS,t,arguments.length>2&&arguments[2])}});wI(KI,xI),wI(zI,FI);var TS={ArrayBuffer:KI,DataView:zI},ES=ks,IS="ArrayBuffer",SS=TS[IS];Fr({global:!0,constructor:!0,forced:b[IS]!==SS},{ArrayBuffer:SS}),ES(IS);var AS=Fr,yS=Ia,vS=n,RS=ke,CS=Bt,bS=Gt,kS=ha,DS=TS.ArrayBuffer,NS=TS.DataView,OS=NS.prototype,PS=yS(DS.prototype.slice),LS=yS(OS.getUint8),wS=yS(OS.setUint8);AS({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:vS((function(){return!new DS(2).slice(1,void 0).byteLength}))},{slice:function(e,t){if(PS&&void 0===t)return PS(RS(this),e);for(var i=RS(this).byteLength,n=CS(e,i),r=CS(void 0===t?i:t,i),o=new(kS(this,DS))(bS(r-n)),s=new NS(this),a=new NS(o),c=0;n<r;)wS(a,c++,LS(s,n++));return o}});var MS,VS,US,xS={exports:{}},FS=qE,BS=Ne,HS=b,jS=Se,GS=ve,WS=W,JS=Fs,KS=Ze,YS=qi,zS=rr,qS=ys,QS=Je,XS=zr,ZS=vo,$S=ge,eA=q,tA=dn.enforce,iA=dn.get,nA=HS.Int8Array,rA=nA&&nA.prototype,oA=HS.Uint8ClampedArray,sA=oA&&oA.prototype,aA=nA&&XS(nA),cA=rA&&XS(rA),lA=Object.prototype,dA=HS.TypeError,uA=$S("toStringTag"),hA=eA("TYPED_ARRAY_TAG"),pA="TypedArrayConstructor",_A=FS&&!!ZS&&"Opera"!==JS(HS.opera),mA=!1,fA={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},gA={BigInt64Array:8,BigUint64Array:8},TA=function(e){var t=XS(e);if(GS(t)){var i=iA(t);return i&&WS(i,pA)?i[pA]:TA(t)}},EA=function(e){if(!GS(e))return!1;var t=JS(e);return WS(fA,t)||WS(gA,t)};for(MS in fA)(US=(VS=HS[MS])&&VS.prototype)?tA(US)[pA]=VS:_A=!1;for(MS in gA)(US=(VS=HS[MS])&&VS.prototype)&&(tA(US)[pA]=VS);if((!_A||!jS(aA)||aA===Function.prototype)&&(aA=function(){throw dA("Incorrect invocation")},_A))for(MS in fA)HS[MS]&&ZS(HS[MS],aA);if((!_A||!cA||cA===lA)&&(cA=aA.prototype,_A))for(MS in fA)HS[MS]&&ZS(HS[MS].prototype,cA);if(_A&&XS(sA)!==cA&&ZS(sA,cA),BS&&!WS(cA,uA))for(MS in mA=!0,qS(cA,uA,{configurable:!0,get:function(){return GS(this)?this[hA]:void 0}}),fA)HS[MS]&&YS(HS[MS],hA,MS);var IA={NATIVE_ARRAY_BUFFER_VIEWS:_A,TYPED_ARRAY_TAG:mA&&hA,aTypedArray:function(e){if(EA(e))return e;throw dA("Target is not a typed array")},aTypedArrayConstructor:function(e){if(jS(e)&&(!ZS||QS(aA,e)))return e;throw dA(KS(e)+" is not a typed array constructor")},exportTypedArrayMethod:function(e,t,i,n){if(BS){if(i)for(var r in fA){var o=HS[r];if(o&&WS(o.prototype,e))try{delete o.prototype[e]}catch(ux){try{o.prototype[e]=t}catch(s){}}}cA[e]&&!i||zS(cA,e,i?t:_A&&rA[e]||t,n)}},exportTypedArrayStaticMethod:function(e,t,i){var n,r;if(BS){if(ZS){if(i)for(n in fA)if((r=HS[n])&&WS(r,e))try{delete r[e]}catch(ux){}if(aA[e]&&!i)return;try{return zS(aA,e,i?t:_A&&aA[e]||t)}catch(ux){}}for(n in fA)!(r=HS[n])||r[e]&&!i||zS(r,e,t)}},getTypedArrayConstructor:TA,isView:function(e){if(!GS(e))return!1;var t=JS(e);return"DataView"===t||WS(fA,t)||WS(gA,t)},isTypedArray:EA,TypedArray:aA,TypedArrayPrototype:cA},SA=b,AA=n,yA=Pd,vA=IA.NATIVE_ARRAY_BUFFER_VIEWS,RA=SA.ArrayBuffer,CA=SA.Int8Array,bA=!vA||!AA((function(){CA(1)}))||!AA((function(){new CA(-1)}))||!yA((function(e){new CA,new CA(null),new CA(1.5),new CA(e)}),!0)||AA((function(){return 1!==new CA(new RA(2),1,void 0).length})),kA=ve,DA=Math.floor,NA=Number.isInteger||function(e){return!kA(e)&&isFinite(e)&&DA(e)===e},OA=Vt,PA=RangeError,LA=function(e){var t=OA(e);if(t<0)throw PA("The argument can't be less than 0");return t},wA=RangeError,MA=function(e,t){var i=LA(e);if(i%t)throw wA("Wrong offset");return i},VA=Math.round,UA=Fs,xA=gt,FA=TypeError,BA=function(e){var t=xA(e,"number");if("number"==typeof t)throw FA("Can't convert number to bigint");return BigInt(t)},HA=va,jA=He,GA=aa,WA=H,JA=Jt,KA=ld,YA=id,zA=Ql,qA=function(e){var t=UA(e);return"BigInt64Array"===t||"BigUint64Array"===t},QA=IA.aTypedArrayConstructor,XA=BA,ZA=Fr,$A=b,ey=He,ty=Ne,iy=bA,ny=IA,ry=TS,oy=Os,sy=Ki,ay=qi,cy=NA,ly=Gt,dy=$E,uy=MA,hy=function(e){var t=VA(e);return t<0?0:t>255?255:255&t},py=It,_y=W,my=Fs,fy=ve,gy=Qe,Ty=Pi,Ey=Je,Iy=vo,Sy=or.f,Ay=function(e){var t,i,n,r,o,s,a,c,l=GA(this),d=WA(e),u=arguments.length,h=u>1?arguments[1]:void 0,p=void 0!==h,_=YA(d);if(_&&!zA(_))for(c=(a=KA(d,_)).next,d=[];!(s=jA(c,a)).done;)d.push(s.value);for(p&&u>2&&(h=HA(h,arguments[2])),i=JA(d),n=new(QA(l))(i),r=qA(n),t=0;i>t;t++)o=p?h(d[t],t):d[t],n[t]=r?XA(o):+o;return n},yy=sp.forEach,vy=ks,Ry=ys,Cy=Pe,by=un,ky=uu,Dy=dn.get,Ny=dn.set,Oy=dn.enforce,Py=Cy.f,Ly=by.f,wy=$A.RangeError,My=ry.ArrayBuffer,Vy=My.prototype,Uy=ry.DataView,xy=ny.NATIVE_ARRAY_BUFFER_VIEWS,Fy=ny.TYPED_ARRAY_TAG,By=ny.TypedArray,Hy=ny.TypedArrayPrototype,jy=ny.aTypedArrayConstructor,Gy=ny.isTypedArray,Wy="BYTES_PER_ELEMENT",Jy="Wrong length",Ky=function(e,t){jy(e);for(var i=0,n=t.length,r=new e(n);n>i;)r[i]=t[i++];return r},Yy=function(e,t){Ry(e,t,{configurable:!0,get:function(){return Dy(this)[t]}})},zy=function(e){var t;return Ey(Vy,e)||"ArrayBuffer"===(t=my(e))||"SharedArrayBuffer"===t},qy=function(e,t){return Gy(e)&&!gy(t)&&t in e&&cy(+t)&&t>=0},Qy=function(e,t){return t=py(t),qy(e,t)?sy(2,e[t]):Ly(e,t)},Xy=function(e,t,i){return t=py(t),!(qy(e,t)&&fy(i)&&_y(i,"value"))||_y(i,"get")||_y(i,"set")||i.configurable||_y(i,"writable")&&!i.writable||_y(i,"enumerable")&&!i.enumerable?Py(e,t,i):(e[t]=i.value,e)};ty?(xy||(by.f=Qy,Cy.f=Xy,Yy(Hy,"buffer"),Yy(Hy,"byteOffset"),Yy(Hy,"byteLength"),Yy(Hy,"length")),ZA({target:"Object",stat:!0,forced:!xy},{getOwnPropertyDescriptor:Qy,defineProperty:Xy}),xS.exports=function(e,t,i){var n=e.match(/\d+/)[0]/8,r=e+(i?"Clamped":"")+"Array",o="get"+e,s="set"+e,a=$A[r],c=a,l=c&&c.prototype,d={},u=function(e,t){Py(e,t,{get:function(){return function(e,t){var i=Dy(e);return i.view[o](t*n+i.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,r){var o=Dy(e);o.view[s](t*n+o.byteOffset,i?hy(r):r,!0)}(this,t,e)},enumerable:!0})};xy?iy&&(c=t((function(e,t,i,r){return oy(e,l),ky(fy(t)?zy(t)?void 0!==r?new a(t,uy(i,n),r):void 0!==i?new a(t,uy(i,n)):new a(t):Gy(t)?Ky(c,t):ey(Ay,c,t):new a(dy(t)),e,c)})),Iy&&Iy(c,By),yy(Sy(a),(function(e){e in c||ay(c,e,a[e])})),c.prototype=l):(c=t((function(e,t,i,r){oy(e,l);var o,s,a,d=0,h=0;if(fy(t)){if(!zy(t))return Gy(t)?Ky(c,t):ey(Ay,c,t);o=t,h=uy(i,n);var p=t.byteLength;if(void 0===r){if(p%n)throw wy(Jy);if((s=p-h)<0)throw wy(Jy)}else if((s=ly(r)*n)+h>p)throw wy(Jy);a=s/n}else a=dy(t),o=new My(s=a*n);for(Ny(e,{buffer:o,byteOffset:h,byteLength:s,length:a,view:new Uy(o)});d<a;)u(e,d++)})),Iy&&Iy(c,By),l=c.prototype=Ty(Hy)),l.constructor!==c&&ay(l,"constructor",c),Oy(l).TypedArrayConstructor=c,Fy&&ay(l,Fy,r);var h=c!==a;d[r]=c,ZA({global:!0,constructor:!0,forced:h,sham:!xy},d),Wy in c||ay(c,Wy,n),Wy in l||ay(l,Wy,n),vy(r)}):xS.exports=function(){};var Zy=xS.exports;Zy("Float32",(function(e){return function(t,i,n){return e(this,t,i,n)}}));var $y=_I,ev=BA,tv=Fs,iv=He,nv=n,rv=IA.aTypedArray,ov=IA.exportTypedArrayMethod,sv=l("".slice);ov("fill",(function(e){var t=arguments.length;rv(this);var i="Big"===sv(tv(this),0,3)?ev(e):+e;return iv($y,this,i,t>1?arguments[1]:void 0,t>2?arguments[2]:void 0)}),nv((function(){var e=0;return new Int8Array(2).fill({valueOf:function(){return e++}}),1!==e})));var av=b,cv=He,lv=IA,dv=Jt,uv=MA,hv=H,pv=n,_v=av.RangeError,mv=av.Int8Array,fv=mv&&mv.prototype,gv=fv&&fv.set,Tv=lv.aTypedArray,Ev=lv.exportTypedArrayMethod,Iv=!pv((function(){var e=new Uint8ClampedArray(2);return cv(gv,e,{length:1,0:3},1),3!==e[1]})),Sv=Iv&&lv.NATIVE_ARRAY_BUFFER_VIEWS&&pv((function(){var e=new mv(2);return e.set(1),e.set("2",1),0!==e[0]||2!==e[1]}));Ev("set",(function(e){Tv(this);var t=uv(arguments.length>1?arguments[1]:void 0,1),i=hv(e);if(Iv)return cv(gv,this,i,t);var n=this.length,r=dv(i),o=0;if(r+t>n)throw _v("Wrong length");for(;o<r;)this[t+o]=i[o++]}),!Iv||Sv);var Av=Q.match(/firefox\/(\d+)/i),yv=!!Av&&+Av[1],vv=/MSIE|Trident/.test(Q),Rv=Q.match(/AppleWebKit\/(\d+)\./),Cv=!!Rv&&+Rv[1],bv=Ia,kv=n,Dv=it,Nv=fm,Ov=yv,Pv=vv,Lv=ne,wv=Cv,Mv=IA.aTypedArray,Vv=IA.exportTypedArrayMethod,Uv=b.Uint16Array,xv=Uv&&bv(Uv.prototype.sort),Fv=!(!xv||kv((function(){xv(new Uv(2),null)}))&&kv((function(){xv(new Uv(2),{})}))),Bv=!!xv&&!kv((function(){if(Lv)return Lv<74;if(Ov)return Ov<67;if(Pv)return!0;if(wv)return wv<602;var e,t,i=new Uv(516),n=Array(516);for(e=0;e<516;e++)t=e%4,i[e]=515-e,n[e]=e-2*t+3;for(xv(i,(function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(i[e]!==n[e])return!0}));Vv("sort",(function(e){return void 0!==e&&Dv(e),Bv?xv(this,e):Nv(Mv(this),function(e){return function(t,i){return void 0!==e?+e(t,i)||0:i!=i?-1:t!=t?1:0===t&&0===i?1/t>0&&1/i<0?1:-1:t>i}}(e))}),!Bv||Fv);var Hv=Ze,jv=TypeError,Gv=Fr,Wv=l,Jv=it,Kv=H,Yv=Jt,zv=function(e,t){if(!delete e[t])throw jv("Cannot delete property "+Hv(t)+" of "+Hv(e))},qv=Tu,Qv=n,Xv=fm,Zv=cp,$v=yv,eR=vv,tR=ne,iR=Cv,nR=[],rR=Wv(nR.sort),oR=Wv(nR.push),sR=Qv((function(){nR.sort(void 0)})),aR=Qv((function(){nR.sort(null)})),cR=Zv("sort"),lR=!Qv((function(){if(tR)return tR<70;if(!($v&&$v>3)){if(eR)return!0;if(iR)return iR<603;var e,t,i,n,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)nR.push({k:t+n,v:i})}for(nR.sort((function(e,t){return t.v-e.v})),n=0;n<nR.length;n++)t=nR[n].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return"DGBEFHACIJK"!==r}}));Gv({target:"Array",proto:!0,forced:sR||!aR||!cR||!lR},{sort:function(e){void 0!==e&&Jv(e);var t=Kv(this);if(lR)return void 0===e?rR(t):rR(t,e);var i,n,r=[],o=Yv(t);for(n=0;n<o;n++)n in t&&oR(r,t[n]);for(Xv(r,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:qv(t)>qv(i)?1:-1}}(e)),i=Yv(r),n=0;n<i;)t[n]=r[n++];for(;n<o;)zv(t,n++);return t}}),Zy("Uint8",(function(e){return function(t,i,n){return e(this,t,i,n)}}));var dR=Fr,uR=Kh,hR=l([].reverse),pR=[1,2];dR({target:"Array",proto:!0,forced:String(pR)===String(pR.reverse())},{reverse:function(){return uR(this)&&(this.length=this.length),hR(this)}});var _R=Fr,mR=Nc,fR=n,gR=We,TR=Se,ER=ha,IR=ru,SR=rr,AR=mR&&mR.prototype;if(_R({target:"Promise",proto:!0,real:!0,forced:!!mR&&fR((function(){AR.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=ER(this,gR("Promise")),i=TR(e);return this.then(i?function(i){return IR(t,e()).then((function(){return i}))}:e,i?function(i){return IR(t,e()).then((function(){throw i}))}:e)}}),TR(mR)){var yR=gR("Promise").prototype.finally;AR.finally!==yR&&SR(AR,"finally",yR,{unsafe:!0})}var vR=Fr,RR=He,CR=l,bR=A,kR=Se,DR=E,NR=mu,OR=Tu,PR=ot,LR=Cu,wR=Xp,MR=ge("replace"),VR=TypeError,UR=CR("".indexOf);CR("".replace);var xR=CR("".slice),FR=Math.max,BR=function(e,t,i){return i>e.length?-1:""===t?i:UR(e,t,i)};vR({target:"String",proto:!0},{replaceAll:function(e,t){var i,n,r,o,s,a,c,l,d=bR(this),u=0,h=0,p="";if(!DR(e)){if(NR(e)&&(i=OR(bR(LR(e))),!~UR(i,"g")))throw VR("`.replaceAll` does not allow non-global regexes");if(n=PR(e,MR))return RR(n,e,d,t)}for(r=OR(d),o=OR(e),(s=kR(t))||(t=OR(t)),a=o.length,c=FR(1,a),u=BR(r,o,0);-1!==u;)l=s?OR(t(o,u,r)):wR(o,r,u,[],void 0,t),p+=xR(r,h,u)+l,h=u+a,u=BR(r,o,u+c);return h<r.length&&(p+=xR(r,h)),p}});let HR=!0,jR=!0;function GR(e,t,i){const n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}function WR(e,t,i){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return r.apply(this,arguments);const o=e=>{const t=i(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,o),r.apply(this,[e,o])};const o=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(i))return o.apply(this,arguments);const n=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function JR(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(HR=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function KR(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(jR=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function YR(){if("object"==typeof window){if(HR)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function zR(e,t){jR&&console.warn(e+" is deprecated, please use "+t+" instead.")}function qR(e){return"[object Object]"===Object.prototype.toString.call(e)}function QR(e){return qR(e)?Object.keys(e).reduce((function(t,i){const n=qR(e[i]),r=n?QR(e[i]):e[i],o=n&&!Object.keys(r).length;return void 0===r||o?t:Object.assign(t,{[i]:r})}),{}):e}function XR(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((n=>{n.endsWith("Id")?XR(e,e.get(t[n]),i):n.endsWith("Ids")&&t[n].forEach((t=>{XR(e,e.get(t),i)}))})))}function ZR(e,t,i){const n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((i=>{i.type===n&&i.trackId===t.id&&XR(e,i,r)}))})),r}const $R=YR;function eC(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[r("min",i)]=n.ideal,t.optional.push(e),e={},e[r("max",i)]=n.ideal,t.optional.push(e)):(e[r("",i)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",i)]=n.exact):["min","max"].forEach((e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,i)]=n[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{i=i.filter((e=>"videoinput"===e.kind));let s=i.find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!s&&i.length&&t.includes("back")&&(s=i[i.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=n(e.video),$R("chrome: "+JSON.stringify(e)),r(e)}))}e.video=n(e.video)}return $R("chrome: "+JSON.stringify(e)),r(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,n){r(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{n&&n(o(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function tC(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function iC(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const r=new Event("track");r.track=i.track,r.receiver=n,r.transceiver={receiver:n},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const r=new Event("track");r.track=i,r.receiver=n,r.transceiver={receiver:n},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else WR(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function nC(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let r=i.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function rC(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const n=function(e){i(o(r(e)))};return t.apply(this,[n,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(o(r(t)))},i])})).then(i,n)}}function oC(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ZR(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),WR(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ZR(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,n;return this.getSenders().forEach((i=>{i.track===e&&(t?n=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?n=!0:i=t),t.track===e))),n||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function sC(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function aC(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return sC(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],r=e._streams[n.id];i=i.replace(new RegExp(r.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new e.MediaStream([t]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=o(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=n[t]}));const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],r=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function cC(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}))}function lC(e,t){WR(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var dC=Object.freeze({__proto__:null,shimMediaStream:tC,shimOnTrack:iC,shimGetSendersWithDtmf:nC,shimGetStats:rC,shimSenderReceiverGetStats:oC,shimAddTrackRemoveTrackWithNative:sC,shimAddTrackRemoveTrack:aC,shimPeerConnection:cC,fixNegotiationNeeded:lC,shimGetUserMedia:eC,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const n=i.video&&i.video.width,r=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},n&&(i.video.mandatory.maxWidth=n),r&&(i.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function uC(e,t){const i=e&&e.navigator,n=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,n){zR("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function hC(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function pC(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,o]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(pD){if("TypeError"!==pD.name)throw pD;e.forEach(((t,n)=>{e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(r,o)}}function _C(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function mC(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),WR(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function fC(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){zR("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function gC(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function TC(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=t.apply(this,arguments);if(i){const{sender:t}=n,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return n})}function EC(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function IC(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function SC(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var AC=Object.freeze({__proto__:null,shimOnTrack:hC,shimPeerConnection:pC,shimSenderGetStats:_C,shimReceiverGetStats:mC,shimRemoveStream:fC,shimRTCDataChannel:gC,shimAddTransceiver:TC,shimGetParameters:EC,shimCreateOffer:IC,shimCreateAnswer:SC,shimGetUserMedia:uC,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}});function yC(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function vC(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function RC(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,n=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r};let a=function(e,t,i){const n=r.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,i){const n=o.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,i){const n=s.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.addIceCandidate=a}function CC(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(bC(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t))}function bC(e){return e&&void 0!==e.video?Object.assign({},e,{video:QR(e.video)}):e}function kC(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];void 0===n.urls&&n.url?(zR("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function DC(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function NC(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function OC(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var PC=Object.freeze({__proto__:null,shimLocalStreamsAPI:yC,shimRemoteStreamsAPI:vC,shimCallbacksAPI:RC,shimGetUserMedia:CC,shimConstraints:bC,shimRTCIceServerUrls:kC,shimTrackEventTransceiver:DC,shimCreateOfferLegacy:NC,shimAudioContext:OC}),LC={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let n=8;n<t.length;n+=2)switch(t[n]){case"raddr":i.relatedAddress=t[n+1];break;case"rport":i.relatedPort=parseInt(t[n+1],10);break;case"tcptype":i.tcpType=t[n+1];break;case"ufrag":i.ufrag=t[n+1],i.usernameFragment=t[n+1];break;default:void 0===i[t[n]]&&(i[t[n]]=t[n+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let i;const n=e.substring(e.indexOf(" ")+1).split(";");for(let r=0;r<n.length;r++)i=n[r].trim().split("="),t[i[0].trim()]=i[1];return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substring(t+1,n),i.value=e.substring(n+1)):i.attribute=e.substring(t+1),i},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],r=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&r?{usernameFragment:n.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" ");i.profile=n[2];for(let o=3;o<n.length;o++){const r=n[o],s=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(s){const n=t.parseRtpMap(s),o=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(n.parameters=o.length?t.parseFmtp(o[0]):{},n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),i.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))}));const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((e=>{r.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),i},t.writeRtpDescription=function(e,i){let n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));let r=0;return i.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(n+="a=maxptime:"+r+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){const i=[],n=t.parseRtpParameters(e),r=-1!==n.fecMechanisms.indexOf("RED"),o=-1!==n.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const l=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));l.length>0&&l[0].length>1&&l[0][0]===a&&(c=l[0][1]),n.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),i.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&a&&i.push({ssrc:a});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substring(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=d}))),i},t.parseRtcpParameters=function(e){const i={},n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=r.length>0,i.compound=0===r.length;const o=t.matchPrefix(e,"a=rtcp-mux");return i.mux=o.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const n=t.matchPrefix(e,"a=msid:");if(1===n.length)return i=n[0].substring(7).split(" "),{stream:i[0],track:i[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(i=r[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");let r;n.length>0&&(r=parseInt(n[0].substring(19),10)),isNaN(r)&&(r=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:r};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,n){let r;const o=void 0!==i?i:2;r=e||t.generateSessionId();return"v=0\r\no="+(n||"thisisadapterortc")+" "+r+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const n=t.splitLines(e);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},e.exports=t}(LC);var wC=LC.exports,MC=i(wC),VC=e({__proto__:null,default:MC},[wC]);function UC(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const i=new t(e),n=MC.parseCandidate(e.candidate);for(const e in n)e in i||Object.defineProperty(i,e,{value:n[e]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,WR(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function xC(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||WR(e,"icecandidate",(e=>{if(e.candidate){const t=MC.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function FC(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=MC.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=MC.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),i=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(e),n=function(e,i){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const r=MC.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?n=parseInt(r[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(n=2147483637),n}(arguments[0],e);let r;r=0===i&&0===n?Number.POSITIVE_INFINITY:0===i||0===n?Math.max(i,n):Math.min(i,n);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>r}),this._sctp=o}return i.apply(this,arguments)}}function BC(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const n=arguments[0],r=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},WR(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function HC(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function jC(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function GC(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function WC(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>i.apply(this,[e])))})}var JC=Object.freeze({__proto__:null,shimRTCIceCandidate:UC,shimRTCIceCandidateRelayProtocol:xC,shimMaxMessageSize:FC,shimSendThrowTypeError:BC,shimConnectionState:HC,removeExtmapAllowMixed:jC,shimAddIceCandidateNullOrEmpty:GC,shimParameterlessSetLocalDescription:WC});!function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const i=YR,n=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=GR(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=GR(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=GR(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),r={browserDetails:n,commonShim:JC,extractVersion:GR,disableLog:JR,disableWarnings:KR,sdp:VC};switch(n.browser){case"chrome":if(!dC||!cC||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=dC,GC(e,n),WC(e),eC(e,n),tC(e),cC(e,n),iC(e),aC(e,n),nC(e),rC(e),oC(e),lC(e,n),UC(e),xC(e),HC(e),FC(e,n),BC(e),jC(e,n);break;case"firefox":if(!AC||!pC||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=AC,GC(e,n),WC(e),uC(e,n),pC(e,n),hC(e),fC(e),_C(e),mC(e),gC(e),TC(e),EC(e),IC(e),SC(e),UC(e),HC(e),FC(e,n),BC(e);break;case"safari":if(!PC||!t.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=PC,GC(e,n),WC(e),kC(e),NC(e),RC(e),yC(e),vC(e),DC(e),CC(e),OC(e),UC(e),xC(e),FC(e,n),BC(e),jC(e,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});var KC,YC=Object.create,zC=Object.defineProperty,qC=Object.defineProperties,QC=Object.getOwnPropertyDescriptor,XC=Object.getOwnPropertyDescriptors,ZC=Object.getOwnPropertyNames,$C=Object.getOwnPropertySymbols,eb=Object.getPrototypeOf,tb=Object.prototype.hasOwnProperty,ib=Object.prototype.propertyIsEnumerable,nb=Reflect.get,rb=Math.pow,ob=(e,t,i)=>t in e?zC(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,sb=(e,t)=>{for(var i in t||(t={}))tb.call(t,i)&&ob(e,i,t[i]);if($C)for(var i of $C(t))ib.call(t,i)&&ob(e,i,t[i]);return e},ab=(e,t)=>qC(e,XC(t)),cb=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),lb=(e,t)=>{for(var i in t)zC(e,i,{get:t[i],enumerable:!0})},db=(e,t,i)=>(i=null!=e?YC(eb(e)):{},((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of ZC(t))!tb.call(e,r)&&r!==i&&zC(e,r,{get:()=>t[r],enumerable:!(n=QC(t,r))||n.enumerable});return e})(!t&&e&&e.__esModule?i:zC(i,"default",{value:e,enumerable:!0}),e)),ub=(e,t,i,n)=>{for(var r,o=n>1?void 0:n?QC(t,i):t,s=e.length-1;s>=0;s--)(r=e[s])&&(o=(n?r(t,i,o):r(o))||o);return n&&o&&zC(t,i,o),o},hb=(e,t,i)=>(ob(e,"symbol"!=typeof t?t+"":t,i),i),pb=(e,t,i)=>nb(eb(e),i,t),_b=(e,t,i)=>new Promise(((n,r)=>{var o=e=>{try{a(i.next(e))}catch(t){r(t)}},s=e=>{try{a(i.throw(e))}catch(t){r(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,s);a((i=i.apply(e,t)).next())})),mb=cb(((e,t)=>{var i=Object.prototype.hasOwnProperty,n="~";function r(){}function o(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function s(e,t,i,r,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new o(i,r||e,s),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function c(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),c.prototype.eventNames=function(){var e,t,r=[];if(0===this._eventsCount)return r;for(t in e=this._events)i.call(e,t)&&r.push(n?t.slice(1):t);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},c.prototype.listeners=function(e){var t=n?n+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,o=i.length,s=new Array(o);r<o;r++)s[r]=i[r].fn;return s},c.prototype.listenerCount=function(e){var t=n?n+e:e,i=this._events[t];return i?i.fn?1:i.length:0},c.prototype.emit=function(e,t,i,r,o,s){var a=n?n+e:e;if(!this._events[a])return!1;var c,l,d=this._events[a],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,i),!0;case 4:return d.fn.call(d.context,t,i,r),!0;case 5:return d.fn.call(d.context,t,i,r,o),!0;case 6:return d.fn.call(d.context,t,i,r,o,s),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var h,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,i);break;case 4:d[l].fn.call(d[l].context,t,i,r);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];d[l].fn.apply(d[l].context,c)}}return!0},c.prototype.on=function(e,t,i){return s(this,e,t,i,!1)},c.prototype.once=function(e,t,i){return s(this,e,t,i,!0)},c.prototype.removeListener=function(e,t,i,r){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return a(this,o),this;var s=this._events[o];if(s.fn)s.fn===t&&(!r||s.once)&&(!i||s.context===i)&&a(this,o);else{for(var c=0,l=[],d=s.length;c<d;c++)(s[c].fn!==t||r&&!s[c].once||i&&s[c].context!==i)&&l.push(s[c]);l.length?this._events[o]=1===l.length?l[0]:l:a(this,o)}return this},c.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=n,c.EventEmitter=c,void 0!==t&&(t.exports=c)})),fb=cb(((e,t)=>{var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))})),gb=cb((e=>{var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,n){var r=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:r&&!i[e.name]&&(i[e.name]={});var o=e.push?{}:r?i[e.name]:i;(function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var o=0;o<n.length;o+=1)null!=e[o+1]&&(i[n[o]]=t(e[o+1]))})(n.match(e.reg),o,e.names,e.name),e.push&&i[e.push].push(o)},n=fb(),r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},o=[],s=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(o.push({rtp:[],fmtp:[]}),s=o[o.length-1]);for(var a=0;a<(n[t]||[]).length;a+=1){var c=n[t][a];if(c.reg.test(r))return i(c,s,r)}})),t.media=o,t};var o=function(e,i){var n=i.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&i.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],n=e.split(" ").map(t),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),n=!0),{scid:i,paused:n}}))}))}})),Tb=cb(((e,t)=>{var i=fb(),n=/%[sdv%]/g,r=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},o=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var o=0;o<t.names.length;o+=1){var s=t.names[o];t.name?n.push(i[t.name][s]):n.push(i[t.names[o]])}else n.push(i[t.name]);return r.apply(null,n)},s=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||s,r=t.innerOrder||a,c=[];return n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(o(t,i,e))}))}))})),e.media.forEach((function(e){c.push(o("m",i.m[0],e)),r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?c.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){c.push(o(t,i,e))}))}))}))})),c.join("\r\n")+"\r\n"}})),Eb=cb((e=>{var t=gb(),i=Tb();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList})),Ib=db(mb()),Sb=((KC=Sb||{})[KC.INVALID_PARAMETER=4096]="INVALID_PARAMETER",KC[KC.INVALID_OPERATION=4097]="INVALID_OPERATION",KC[KC.NOT_SUPPORTED=4098]="NOT_SUPPORTED",KC[KC.DEVICE_NOT_FOUND=4099]="DEVICE_NOT_FOUND",KC[KC.INITIALIZE_FAILED=4100]="INITIALIZE_FAILED",KC[KC.SIGNAL_CHANNEL_SETUP_FAILED=16385]="SIGNAL_CHANNEL_SETUP_FAILED",KC[KC.SIGNAL_CHANNEL_ERROR=16386]="SIGNAL_CHANNEL_ERROR",KC[KC.ICE_TRANSPORT_ERROR=16387]="ICE_TRANSPORT_ERROR",KC[KC.JOIN_ROOM_FAILED=16388]="JOIN_ROOM_FAILED",KC[KC.CREATE_OFFER_FAILED=16389]="CREATE_OFFER_FAILED",KC[KC.SIGNAL_CHANNEL_RECONNECTION_FAILED=16390]="SIGNAL_CHANNEL_RECONNECTION_FAILED",KC[KC.UPLINK_RECONNECTION_FAILED=16391]="UPLINK_RECONNECTION_FAILED",KC[KC.DOWNLINK_RECONNECTION_FAILED=16392]="DOWNLINK_RECONNECTION_FAILED",KC[KC.REMOTE_STREAM_NOT_EXIST=16400]="REMOTE_STREAM_NOT_EXIST",KC[KC.CLIENT_BANNED=16448]="CLIENT_BANNED",KC[KC.SERVER_TIMEOUT=16449]="SERVER_TIMEOUT",KC[KC.SUBSCRIPTION_TIMEOUT=16450]="SUBSCRIPTION_TIMEOUT",KC[KC.PLAY_NOT_ALLOWED=16451]="PLAY_NOT_ALLOWED",KC[KC.DEVICE_AUTO_RECOVER_FAILED=16452]="DEVICE_AUTO_RECOVER_FAILED",KC[KC.START_PUBLISH_CDN_FAILED=16453]="START_PUBLISH_CDN_FAILED",KC[KC.STOP_PUBLISH_CDN_FAILED=16454]="STOP_PUBLISH_CDN_FAILED",KC[KC.START_MIX_TRANSCODE_FAILED=16455]="START_MIX_TRANSCODE_FAILED",KC[KC.STOP_MIX_TRANSCODE_FAILED=16456]="STOP_MIX_TRANSCODE_FAILED",KC[KC.NOT_SUPPORTED_H264=16457]="NOT_SUPPORTED_H264",KC[KC.SWITCH_ROLE_FAILED=16458]="SWITCH_ROLE_FAILED",KC[KC.API_CALL_TIMEOUT=16459]="API_CALL_TIMEOUT",KC[KC.SCHEDULE_FAILED=16460]="SCHEDULE_FAILED",KC[KC.API_CALL_ABORTED=16461]="API_CALL_ABORTED",KC[KC.UNKNOWN=65535]="UNKNOWN",KC),Ab=Sb,yb=class extends Error{constructor(e){let{name:t="RtcError",message:i,code:n=Ab.UNKNOWN,extraCode:r=0,constraint:o}=e,s="<".concat(function(e){for(let t in Ab)if(Ab[t]===e)return t;return"UNKNOWN"}(n)," 0x").concat(n.toString(16),">"),a="".concat(i).concat(o?" constraint: ".concat(o):"").concat(null!=i&&i.includes(s)?"":" ".concat(s));super(a),hb(this,"code"),hb(this,"extraCode"),hb(this,"message"),hb(this,"originMessage"),hb(this,"name"),hb(this,"constraint"),this.code=n,this.extraCode=r,this.name=t,this.message=a,this.constraint=o,this.originMessage=i}getCode(){return this.code}getExtraCode(){return this.extraCode}toString(){return this.originMessage}},vb=yb,Rb=((new Date).getTime(),0),Cb=function(){return(new Date).getTime()+Rb},bb=function(){let e=new Date;return e.setTime(Cb()),e.toLocaleString()},kb={};lb(kb,{bytes2ms:()=>$N,copyProperties:()=>ZN,deepMerge:()=>LO,fibonacci:()=>sO,formatedTime:()=>VO,getConstructorName:()=>IO,getContainerFromElement:()=>wO,getEnv:()=>JN,getInternalVersion:()=>RO,getLoggerUrl:()=>YN,getMuteStateFromFlag:()=>kO,getNetworkQuality:()=>DO,getNetworkType:()=>QN,getOSType:()=>qN,getReconnectionTimeout:()=>aO,getSysInfo:()=>XN,getTerminalType:()=>zN,getTurnServer:()=>NO,getValueType:()=>cO,glog:()=>nO,ipv4ToUint32:()=>OO,isArray:()=>mO,isArrayOrObject:()=>PO,isAudioWorkletSupported:()=>SO,isBoolean:()=>pO,isConstructor:()=>EO,isEmpty:()=>bO,isFunction:()=>lO,isLangChinese:()=>rO,isMediaStreamTrack:()=>fO,isNumber:()=>hO,isObject:()=>_O,isOverseaSdkAppId:()=>KN,isPlainObject:()=>oO,isPromise:()=>TO,isRemoteTrack:()=>gO,isString:()=>uO,isUndefined:()=>dO,ms2bytes:()=>tO,ms2samples:()=>iO,performanceNow:()=>yO,promiseAny:()=>AO,samples2ms:()=>eO,stringify:()=>UO,stringifyIncludeValue:()=>xO});var Db={};lb(Db,{ANDROID_VERSION:()=>jb,CHROME_MAJOR_VERSION:()=>Gk,CHROME_VERSION:()=>Wk,EDGE_VERSION:()=>qb,EDG_MAJOR_VERSION:()=>Zb,EDG_VERSION:()=>Xb,FIREFOX_MAJOR_VERSION:()=>Yb,FIREFOX_VERSION:()=>Kb,HUAWEI_VERSION:()=>Pk,IE_VERSION:()=>lk,IOS_MAIN_VERSION:()=>Qk,IOS_VERSION:()=>qk,IPADQQB_VERSION:()=>Ik,IS_ANDROID:()=>Hb,IS_ANDROID_WEBVIEW:()=>zk,IS_ANY_SAFARI:()=>Kk,IS_CHROME:()=>Hk,IS_CHROME_ONLY:()=>Bk,IS_CHROME_OS:()=>vk,IS_EDG:()=>Qb,IS_EDGE:()=>zb,IS_ELECTRON:()=>bk,IS_FIREFOX:()=>Jb,IS_HEADLESS_CHROME:()=>jk,IS_HUAWEI:()=>Ok,IS_HUAWEIBROWSER:()=>Nk,IS_IE:()=>ck,IS_IE8:()=>ak,IS_IOS:()=>Bb,IS_IOS_13_OR_14:()=>$k,IS_IOS_15_1:()=>Zk,IS_IPAD:()=>Vb,IS_IPADQQB:()=>Ek,IS_IPAD_PRO:()=>Ub,IS_IPHONE:()=>xb,IS_IPOD:()=>Fb,IS_LINUX:()=>yk,IS_LOCAL:()=>eD,IS_MAC:()=>Ak,IS_MACQQB:()=>gk,IS_MIBROWSER:()=>kk,IS_MQQB:()=>pk,IS_NATIVE_ANDROID:()=>Wb,IS_OLD_ANDROID:()=>Gb,IS_OPPOBROWSER:()=>Mk,IS_SAFARI:()=>Jk,IS_SAFARI_15_1:()=>Xk,IS_SAMSUNGBROWSER:()=>Lk,IS_SOGOU:()=>tk,IS_SOGOUM:()=>$b,IS_TBS:()=>nk,IS_UCBROWSER:()=>Ck,IS_VIVOBROWSER:()=>Uk,IS_WECHAT:()=>dk,IS_WIN:()=>Sk,IS_WQQB:()=>mk,IS_WX:()=>Rk,IS_X5MQQB:()=>hk,IS_XWEB:()=>ok,MACQQB_VERSION:()=>Tk,MI_VERSION:()=>Dk,MQQB_VERSION:()=>_k,OPPO_VERSION:()=>Vk,SAFARI_VERSION:()=>Yk,SAMSUNG_VERSION:()=>wk,SOGOUM_VERSION:()=>ek,SOGOU_VERSION:()=>ik,TBS_VERSION:()=>rk,USER_AGENT:()=>Nb,VIVO_VERSION:()=>xk,WECHAT_VERSION:()=>uk,WQQB_VERSION:()=>fk,XWEB_VERSION:()=>sk,browserInfo:()=>iD,getBrowserInfo:()=>nD,getChromeMajorVersion:()=>Fk,getOSName:()=>aD,getOSString:()=>cD,getUserAgentData:()=>oD,isLocalStorageEnabled:()=>tD});var Nb="undefined"==typeof navigator?"":navigator.userAgent,Ob=e=>new RegExp(e,"i").test(Nb),Pb=e=>{if(Ob(e)){let t=new RegExp("".concat(e,"\\/([\\d.]+)")),i=Nb.match(t);if(i&&i[1])return i[1]}return""},Lb=e=>{if(Ob(e)){let t=new RegExp("".concat(e,"\\/(\\d+)")),i=Nb.match(t);if(i&&i[1])return parseFloat(i[1])}return NaN},wb=/AppleWebKit\/([\d.]+)/i.exec(Nb),Mb=wb?parseFloat(wb[1]):NaN,Vb=Ob("iPad"),Ub="undefined"!=typeof navigator&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&Ob("Macintosh"),xb=Ob("iPhone")&&!Vb,Fb=Ob("iPod"),Bb=xb||Vb||Fb||Ub,Hb=Ob("Android"),jb=function(){if(Hb){let e=Nb.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(e){let t=e[1]&&parseFloat(e[1]),i=e[2]&&parseFloat(e[2]);if(t&&i)return parseFloat("".concat(e[1],".").concat(e[2]));if(t)return t}}return NaN}(),Gb=Hb&&Ob("webkit")&&jb<2.3,Wb=Hb&&jb<5&&Mb<537,Jb=Ob("Firefox"),Kb=Pb("Firefox"),Yb=Lb("Firefox"),zb=Ob("Edge"),qb=Pb("Edge"),Qb=Ob("Edg"),Xb=Pb("Edg"),Zb=Lb("Edg"),$b=Ob("SogouMobileBrowser"),ek=Pb("SogouMobileBrowser"),tk=Ob("MetaSr\\s"),ik=Pb("MetaSr\\s"),nk=Ob("TBS"),rk=Pb("TBS"),ok=Ob("XWEB"),sk=Pb("XWEB"),ak=Ob("MSIE\\s8\\.0"),ck=Ob("MSIE\\/\\d+"),lk=function(){if(ck){let e=/MSIE\s(\d+)\.\d/.exec(Nb),t=e&&parseFloat(e[1]);return!t&&/Trident\/7.0/i.test(Nb)&&/rv:11.0/.test(Nb)&&(t=11),t}return NaN}(),dk=Ob("(micromessenger|webbrowser)"),uk=Pb("MicroMessenger"),hk=!nk&&Ob("MQQBrowser")&&Ob("COVC"),pk=!nk&&Ob("MQQBrowser")&&!Ob("COVC"),_k=pk||hk?Pb("MQQBrowser"):"",mk=!nk&&Ob(" QQBrowser"),fk=Pb(" QQBrowser"),gk=!nk&&Ob("QQBrowserLite"),Tk=Pb("QQBrowserLite"),Ek=!nk&&Ob("MQBHD"),Ik=Pb("MQBHD"),Sk=Ob("Windows"),Ak=!Bb&&Ob("MAC OS X"),yk=!Hb&&Ob("Linux"),vk=Ob("CrOS"),Rk=Ob("MicroMessenger"),Ck=Ob("UCBrowser"),bk=Ob("Electron"),kk=Ob("MiuiBrowser"),Dk=Pb("MiuiBrowser"),Nk=Ob("HuaweiBrowser"),Ok=Ob("Huawei"),Pk=Pb("HuaweiBrowser"),Lk=Ob("SamsungBrowser"),wk=Pb("SamsungBrowser"),Mk=Ob("HeyTapBrowser"),Vk=Pb("HeyTapBrowser"),Uk=Ob("VivoBrowser"),xk=Pb("VivoBrowser"),Fk=()=>Lb("Chrome"),Bk=Ob("Chrome"),Hk=!zb&&!tk&&!$b&&!nk&&!ok&&!Qb&&!mk&&!kk&&!Nk&&!Lk&&!Mk&&!Uk&&Bk,jk=Ob("HeadlessChrome"),Gk=Fk(),Wk=Pb("Chrome"),Jk=!Bk&&!pk&&!hk&&!gk&&!Ek&&Ob("Safari"),Kk=Jk||Bb,Yk=Pb("Version"),zk=/Android.*(wv|.0.0.0)/.test(Nb),qk=(()=>{if(Ub)return Yk;if(Bb){let e=Nb.match(/OS (\d+)_(\d+)/i);if(e&&e[1]){let t=e[1];return e[2]&&(t+=".".concat(e[2])),t}}return""})(),Qk=Number(qk.split(".")[0]),Xk="15.1"===Yk,Zk="15.1"===qk,$k=(()=>{let e=Number(qk.split(".")[0]);return 14===e||13===e})(),eD="undefined"!=typeof location&&("file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname),tD=(()=>{let e;return()=>{if(dO(e))try{e=!!window.localStorage}catch(Xw){e=!1}return e}})(),iD=nD();function nD(){let e=new Map([[Jb,["Firefox",Kb]],[Qb,["Edg",Xb]],[Hk,["Chrome",Wk]],[Jk,["Safari",Yk]],[nk,["TBS",rk]],[ok,["XWEB",sk]],[dk&&xb,["WeChat",uk]],[mk,["QQ(Win)",fk]],[pk,["QQ(Mobile)",_k]],[hk,["QQ(Mobile X5)",_k]],[gk,["QQ(Mac)",Tk]],[Ek,["QQ(iPad)",Ik]],[kk,["MI",Dk]],[Nk,["HW",Pk]],[Lk,["Samsung",wk]],[Mk,["OPPO",Vk]],[Uk,["VIVO",xk]],[zb,["EDGE",qb]],[$b,["SogouMobile",ek]],[tk,["Sogou",ik]]]),t="unknown",i="unknown";return e.has(!0)&&([t,i]=e.get(!0)),{name:t,version:i}}var rD=null;function oD(){return _b(this,null,(function*(){if(rD)return rD;if(!navigator.userAgentData||!lO(navigator.userAgentData.getHighEntropyValues))return null;try{return rD=yield navigator.userAgentData.getHighEntropyValues(["architecture","bitness","model","platformVersion","fullVersionList"])}catch(Qw){return null}}))}var sD=new Map([[Hb,"Android"],[Bb,"iOS"],[Sk,"Windows"],[Ak,"MacOS"],[yk,"Linux"],[vk,"ChromeOS"]]),aD=function(){return sD.get(!0)?sD.get(!0):rD?rD.platform:"unknown"},cD=()=>{let e=aD();return e+="/".concat(iD.name,"/").concat(Jk?iD.version:iD.version.split(".")[0]),null!=rD&&rD.platformVersion&&(e+="/".concat(rD.platformVersion)),null!=rD&&rD.architecture&&(e+="/".concat(rD.architecture)),e},lD={};lb(lD,{AUDIO_MUTE_BIT:()=>qD,AUDIO_STAT_BIT:()=>zD,AUX_STAT_BIT:()=>YD,AUX_STREAM_MSID:()=>ZD,BACKEND_ENV:()=>GD,BASE_DOC_URL:()=>RD,BASE_HOST:()=>SD,CAPABILITIES_KEYS:()=>GN,CLASS_NAME:()=>NN,CLOUD_CONSOLE_URL:()=>vD,DATA_FREEZE_TIMING:()=>yN,DOC_URL:()=>CD,DTLS_STATE_UNKNOWN:()=>cN,ENV_NAME:()=>OD,EXCHANGE_SDP_TIMEOUT:()=>TN,INTERVAL:()=>HN,IS_WORKER:()=>fD,IS_WORKLET:()=>gD,KIBANA_EVENT:()=>mN,LOCAL_STREAM_PUBLISH_STATE:()=>AN,LOGGER_CMD_TYPE:()=>ND,LOGGER_DOMAIN:()=>bD,LOGGER_DOMAIN_OVERSEA:()=>kD,LOG_LEVEL:()=>PD,LOG_LEVEL_NAME:()=>MN,MAIN_STREAM_MSID:()=>XD,MICROPHONE_COMMUNICATIONS:()=>wN,MICROPHONE_DEFAULT:()=>PN,NAME:()=>HD,NETWORK_TYPE:()=>MD,NOT_SUPPORTED_H264:()=>SN,PAUSED_RETRY_COUNT:()=>ON,PEERCONNECTION_CONNECTING_TIMEOUT:()=>bN,PEER_CONNECTION_STATE:()=>lN,PEER_LEAVE_REASON:()=>VN,RAF:()=>BN,RECOVER_CAPTURE_INTERVAL:()=>xN,REMOTE_STREAM_TYPE_AUX:()=>eN,REMOTE_STREAM_TYPE_MAIN:()=>$D,RENDER_FREEZE_TIMING:()=>vN,RIC:()=>FN,SCHEDULE_DOMAIN:()=>kN,SCHEDULE_TIMEOUT:()=>DN,SDP_SEMANTICS_PLAN_B:()=>IN,SDP_SEMANTICS_UNIFIED_PLAN:()=>EN,SECOND_HOST:()=>AD,SIGNAL_PING_PONG_INTERVAL:()=>wD,SIGNAL_PING_TIMEOUT:()=>LD,SIGNAL_RECONNECTION_COUNT:()=>_N,SMALL_STAT_BIT:()=>KD,SPEAKER_DEFAULT:()=>LN,STORAGE_EXPIRES_TIME:()=>VD,STREAM_TYPE_BIG:()=>RN,STREAM_TYPE_SMALL:()=>CN,SUBSCRIBE_SMALL_RETRY_COUNT:()=>UN,SYNC_USER_LIST_INTERVAL:()=>fN,Scene:()=>WD,Switch:()=>UD,THIRD_HOST:()=>yD,TIMEOUT:()=>jN,TRANSPORT_DIRECTION:()=>jD,TRTC_ERROR_ASSISTANCE:()=>DD,TRTC_QUALITY_BAD:()=>oN,TRTC_QUALITY_DISCONNECTED:()=>aN,TRTC_QUALITY_EXCELLENT:()=>iN,TRTC_QUALITY_GOOD:()=>nN,TRTC_QUALITY_POOR:()=>rN,TRTC_QUALITY_UNKNOWN:()=>tN,TRTC_QUALITY_VERY_BAD:()=>sN,UPDATE_OFFER_TIMEOUT:()=>gN,VIDEO_MUTE_BIT:()=>QD,VIDEO_STAT_BIT:()=>JD,audioProfileMap:()=>xD,getRetryCount:()=>hN,getScriptDir:()=>TD,innerVersion:()=>dD,loggerProxy:()=>ED,screenProfileMap:()=>BD,setLoggerProxy:()=>ID,setRetryCount:()=>uN,setVersion:()=>hD,version:()=>uD,videoProfileMap:()=>FD});var dD="4.15.00.1600",uD="5.0.0";function hD(e){uD=e;let[t,i,n]=e.split(".").map((e=>parseInt(e,10)));dD="".concat(t,".").concat(Math.min(15,i),".").concat(Math.min(15,n),".").concat(i.toString().padStart(2,"0")).concat(n.toString().padStart(2,"0"))}var pD,_D,mD,fD="undefined"!=typeof importScripts,gD="undefined"!=typeof registerProcessor,TD=()=>{let e=fD?self.location.href:document.currentScript.src;return e.substring(0,e.lastIndexOf("/")+1)},ED="",ID=e=>ED=e,SD="web.sdk.qcloud.com",AD="web.sdk.tencent.cn",yD="web.sdk.cloud.tencent.cn",vD="https://console.cloud.tencent.com/trtc",RD="https://".concat(SD,"/trtc/webrtc/v5/doc"),CD="".concat(RD,"/zh-cn/"),bD="https://yun.tim.qq.com",kD="https://videoapi-sgp.im.qcloud.com",DD="trtc_error_assistance",ND={LOG:"jssdk_log",EVENT:"jssdk_event",KEY_POINT:"jssdk_new_endreport"},OD={QCLOUD:"qcloud",OLD_CLOUD_LADDER:"trtc",WEBRTC:"webrtc"},PD=((mD=PD||{})[mD.TRACE=0]="TRACE",mD[mD.DEBUG=1]="DEBUG",mD[mD.INFO=2]="INFO",mD[mD.WARN=3]="WARN",mD[mD.ERROR=4]="ERROR",mD[mD.NONE=5]="NONE",mD),LD=18e3,wD=2e3,MD={unknown:0,wifi:1,"3g":2,"2g":3,"4g":4,wired:5},VD=6048e5,UD=((_D=UD||{}).USEAINS="useAINS",_D.ENABLEDEBUG="enableDebug",_D.USEV2="useV2",_D.USEWT="useWt",_D),xD={standard:{sampleRate:48e3,channelCount:1,bitrate:40},"standard-stereo":{sampleRate:48e3,channelCount:2,bitrate:64},high:{sampleRate:48e3,channelCount:1,bitrate:192},"high-stereo":{sampleRate:48e3,channelCount:2,bitrate:192}},FD={"120p":{width:160,height:120,frameRate:15,bitrate:200},"120p_2":{width:160,height:120,frameRate:15,bitrate:100},"180p":{width:320,height:180,frameRate:15,bitrate:350},"180p_2":{width:320,height:180,frameRate:15,bitrate:150},"240p":{width:320,height:240,frameRate:15,bitrate:400},"240p_2":{width:320,height:240,frameRate:15,bitrate:200},"360p":{width:640,height:360,frameRate:15,bitrate:800},"360p_2":{width:640,height:360,frameRate:15,bitrate:400},"480p":{width:640,height:480,frameRate:15,bitrate:900},"480p_2":{width:640,height:480,frameRate:15,bitrate:500},"720p":{width:1280,height:720,frameRate:15,bitrate:1500},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"1440p":{width:2560,height:1440,frameRate:30,bitrate:4860},"4K":{width:3840,height:2160,frameRate:30,bitrate:9e3}},BD={"480p":{width:640,height:480,frameRate:5,bitrate:900},"480p_2":{width:640,height:480,frameRate:30,bitrate:1e3},"720p":{width:1280,height:720,frameRate:5,bitrate:1200},"720p_2":{width:1280,height:720,frameRate:30,bitrate:3e3},"1080p":{width:1920,height:1080,frameRate:5,bitrate:1600},"1080p_2":{width:1920,height:1080,frameRate:30,bitrate:4e3}},HD={CANVAS:"canvas",AUDIO:"audio",VIDEO:"video",SCREEN:"screen",SMALL:"small",BIG:"big",AUXILIARY:"auxiliary",SMALL_VIDEO:"smallVideo",FACING_MODE_USER:"user",FACING_MODE_ENVIRONMENT:"environment",MUTE:"mute",UNMUTE:"unmute",ENDED:"ended",PLAYING:"playing",PAUSE:"pause",ERROR:"error",LOADEDDATA:"loadeddata",AUDIO_INPUT:"audioinput",VIDEO_INPUT:"videoinput",DETAIL:"detail",TEXT:"text",MAIN:"main",BACKUP:"backup",BANNED:"banned",KICK:"kick",USER_TIME_OUT:"user_time_out",ROOM_DISBAND:"room_disband",SEI_MESSAGE:"sei-message",ADD:"add",REMOVE:"remove",REPLACE:"replace",TRACK:"track",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",TRANSCEIVER_DIRECTION_SENDONLY:"sendonly",TRANSCEIVER_DIRECTION_RECVONLY:"recvonly"},jD={INACTIVE:"inactive",SENDONLY:"sendonly",RECVONLY:"recvonly"},GD={OLD_CLOUD_LADDER:"wss://trtc.rtc.qq.com",WEBRTC:"wss://webrtc.qq.com"},WD=((pD=WD||{}).LIVE="live",pD.RTC="rtc",pD),JD=1,KD=2,YD=4,zD=8,qD=64,QD=16,XD="5Y2wZK8nANNAoVw6dSAHVjNxrD1ObBM2kBPV",ZD="224d130c-7b5c-415b-aaa2-79c2eb5a6df2",$D=HD.MAIN,eN=HD.AUXILIARY,tN=0,iN=1,nN=2,rN=3,oN=4,sN=5,aN=6,cN="unknown",lN={NEW:"new",CONNECTING:"connecting",FAILED:"failed",CLOSED:"closed",DISCONNECTED:"disconnected",CONNECTED:"connected",COMPLETED:"completed"},dN=1/0;function uN(e){dN=e}function hN(){return dN}var pN,_N=30,mN={JOIN:"join",DELTA_JOIN:"delta-join",REJOIN:"rejoin",LEAVE:"leave",DELTA_LEAVE:"delta-leave",PUBLISH:"publish",DELTA_PUBLISH:"delta-publish",UNPUBLISH:"unpublish",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",UPLINK_CONNECTION:"uplink-connection",UPLINK_RECONNECTION:"uplink-reconnection",DOWNLINK_CONNECTION:"downlink-connection",DOWNLINK_RECONNECTION:"downlink-reconnection",ON_TRACK:"ontrack",ICE_CONNECTION_STATE:"iceConnectionState",LOCAL_STREAM_INITIALIZE:"stream-initialize",SIGNAL_CONNECTION:"websocketConnectionState",SIGNAL_RECONNECTION:"websocketReconnectionState",UPDATE_STREAM:"update-stream",RECOVER_LOCAL_AUDIO_TRACK:"recover-local-audio-track",RECOVER_LOCAL_VIDEO_TRACK:"recover-local-video-track",RECOVER_SUBSCRIPTION:"recover-subscription",START_MIX_TRANSCODE:"start-mix-transcode",STOP_MIX_TRANSCODE:"stop-mix-transcode",PLAYER_ERROR:"player-error",SCHEDULE:"schedule",LOAD_WORKLET:"load-worklet",VIDEO_FROZEN_COUNT:"videoFrozenCount"},fN=1e4,gN=1e4,TN=1e4,EN="unified-plan",IN="plan-b",SN=1028,AN=((pN=AN||{})[pN.UNPUBLISH=-1]="UNPUBLISH",pN[pN.PUBLISHING=0]="PUBLISHING",pN[pN.PUBLISHED=1]="PUBLISHED",pN),yN=500,vN=1e3,RN=HD.BIG,CN=HD.SMALL,bN=1e4,kN={MAIN:"schedule.rtc.qq.com",BACKUP:"schedule.rtc.qcloud.com",MAIN_OVERSEA:"schedule.rtc.tencentcloud.com",BACKUP_OVERSEA:"schedule-ecdn.rtc.tencentcloud.com"},DN=2e3,NN={TRTC:"TRTC",CLIENT:"Client",LOCAL_STREAM:"LocalStream",REMOTE_STREAM:"RemoteStream",STREAM:"Stream"},ON=5,PN="default",LN=PN,wN="communications",MN=Object.keys(PD),VN=["normal leave","timeout leave","kick","role change"],UN=10,xN=2e3,FN="ric",BN="raf",HN="interval",jN="timeout",GN=["width","height","frameRate","facingMode","sampleRate","sampleSize","channelCount","deviceId"],WN=1e8,JN=function(){return new URLSearchParams(location.search).get("trtc_env")||""},KN=e=>Number(e)<14e8,YN=function(e,t){let i;i=ED||(KN(e)?kD:bD);let n=Math.floor(Math.random()*rb(2,31));return"".concat(i,"/v5/AVQualityReportSvc/C2S?random=").concat(n,"&sdkappid=").concat(e,"&cmdtype=").concat(t)};function zN(){return Hb?4:xb?2:Vb?3:Ak?12:Sk?5:yk?13:1}function qN(){return Hb?"Android":xb?"iPhone":Vb?"iPad":Ak?"Mac":Sk?"Windows":yk?"Linux":"unknown"}function QN(){let{userAgent:e,connection:t}=navigator,i=(e.match(/NetType\/\S+/)||[])[0]||"";i=i.toLowerCase().replace("nettype/",""),"3gnet"===i&&(i="3g");let n=t&&t.type&&t.type.toLowerCase(),r=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===r&&(r="2g");let o=i||"unknown";if(n)switch(n){case"cellular":case"wimax":o=r||"unknown";break;case"wifi":o="wifi";break;case"ethernet":o="wired";break;default:o="unknown"}return o}var XN=function(e){return{AbilityOption:{AVLimit:e,GeneralLimit:{CPULimit:{uint32_CPU_num:navigator.hardwareConcurrency||0,str_CPU_name:String(navigator.platform),uint32_CPU_maxfreq:0,model:"",uint32_total_memory:0},uint32_terminal_type:zN(),uint32_device_type:0,str_os_verion:qN(),uint32_link_type:1,str_client_version:dD,uint32_net_type:MD[QN()],ua:navigator.userAgent,version:""}}}};function ZN(e,t){for(let i of Reflect.ownKeys(t))if("constructor"!==i&&"prototype"!==i&&"name"!==i){let n=Object.getOwnPropertyDescriptor(t,i)||"";Object.defineProperty(e,i,n)}return e}function $N(e){return eO(e/4,arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)}function eO(e){return 1e3*e/(arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)}function tO(e){return 4*iO(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)}function iO(e){return e*(arguments.length>1&&void 0!==arguments[1]?arguments[1]:48e3)/1e3}var nO="undefined"!=typeof window&&"function"==typeof window.glog?window.glog:()=>{},rO=()=>{let e=navigator.language;return e=e.substring(0,2),"zh"===e},oO=function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;let t=Object.getPrototypeOf(e);if(null===t)return!0;let i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)};function sO(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return e<=1?t:sO(e-1,t,(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1)+t)}function aO(e){return e>8?3e4:1e3*sO(e)}function cO(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var lO=e=>"function"==typeof e,dO=e=>void 0===e,uO=e=>"string"==typeof e,hO=e=>"number"==typeof e,pO=e=>"boolean"==typeof e,_O=e=>"object"===cO(e),mO=e=>"array"===cO(e),fO=e=>cO(e)==="MediaStreamTrack".toLowerCase(),gO=e=>e.isRemote,TO=e=>"promise"===cO(e),EO=e=>lO(e)&&e.prototype.constructor===e,IO=e=>EO(e)?e.prototype.constructor.name:"",SO="undefined"!=typeof AudioWorkletNode;function AO(e){return new Promise(((t,i)=>{let n=[];e.forEach((r=>{r.then(t).catch((t=>{n.push(t),n.length===e.length&&i(n)}))}))}))}function yO(){return performance&&performance.now?Math.floor(performance.now()):Date.now()}var vO=e=>+e<10?"0".concat(e):e,RO=e=>{let t=e.match(/^\d+\.\d+\.\d+/)[0];if(!t)return e;let i=t.split("."),n=vO(i[1])+vO(i[2]);return i[1]-15>0&&(i[1]="15"),i[2]-15>0&&(i[2]="15"),"".concat(i.join("."),".").concat(n)},CO=Object.prototype.hasOwnProperty;function bO(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e||"function"==typeof e||Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(oO(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(let t in e)if(CO.call(e,t))return!1;return!0}return!1}function kO(e,t){return{userId:t,hasAudio:!!(e&zD),hasVideo:!!(e&JD),hasAuxiliary:!!(e&YD),hasSmall:!!(e&KD),audioMuted:!!(e&qD),videoMuted:!!(e&QD),audioAvailable:!(!(e&zD)||e&qD),videoAvailable:!(!(e&JD)||e&QD)}}function DO(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}function NO(e){let t={urls:"turn:".concat(e.url)};return!dO(e.username)&&!dO(e.credential)&&(t.username=e.username,t.credential=e.credential,t.credentialType="password",dO(e.credentialType)||(t.credentialType=e.credentialType)),t}function OO(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!uO(e))return 0;let i=e.split(".");return t?(Number(i[0])<<24|Number(i[1])<<16|Number(i[2])<<8|Number(i[3]))>>>0:(Number(i[3])<<24|Number(i[2])<<16|Number(i[1])<<8|Number(i[0]))>>>0}var PO=function(e){return mO(e)||_O(e)},LO=function(e,t,i,n){if(!PO(e)||!PO(t))return 0;let r,o=0,s=Object.keys(t);for(let a=0,c=s.length;a<c;a++)if(r=s[a],!(dO(t[r])||i&&i.includes(r)))if(PO(e[r])&&PO(t[r]))o+=LO(e[r],t[r],i,n);else{if(n&&n.includes(t[r]))continue;e[r]!==t[r]&&(e[r]=t[r],o+=1)}return o},wO=e=>uO(e)?document.getElementById(e):e,MO=new Intl.DateTimeFormat("zh-CN",{dateStyle:"short",timeStyle:"medium"}),VO=()=>MO.format(new Date);function UO(e,t){try{if(mO(e))return"[".concat(e.map((e=>UO(e,t))).join(","),"]");if(!oO(e)||!mO(t))return JSON.stringify(e);let i={},n=new Set(t);return Object.keys(e).forEach((t=>{n.has(t)&&(i[t]=e[t])})),JSON.stringify(i)}catch(pD){return"{}"}}function xO(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=[];return Object.keys(e).forEach((n=>{t===e[n]&&i.push(n)})),UO(e,i)}function FO(e){let{url:t,body:i,method:n,timeout:r}=e,o=new XMLHttpRequest;return new Promise(((e,s)=>{o.onreadystatechange=()=>{if(4===o.readyState)if(o.status>=200&&o.status<300)try{let t=JSON.parse(o.response);e({data:t})}catch(BU){e({data:o.response})}else s({status:o.status,statusText:o.statusText||"request failed!"})},o.timeout=r||5e3,o.open(n||"POST",t,!0),o.send(i)}))}var BO,HO=function(e){let{retryFunction:t,settings:i,onError:n,onRetrying:r,onRetryFailed:o,context:s}=e;return function(){for(var e=arguments.length,a=new Array(e),c=0;c<e;c++)a[c]=arguments[c];let{retries:l=5,timeout:d=1e3}=i,u=0,h=-1,p=0,_=(e,i)=>_b(this,null,(function*(){let c=s||this;try{let i=yield t.apply(c,a);u=0,e(i)}catch(m){let t=()=>{clearTimeout(h),u=0,p=2,i(m)},s=()=>{2!==p&&u<(lO(l)?l():l)?(u++,p=1,lO(r)&&r.call(this,u,t),h=window.setTimeout((()=>{h=-1,_(e,i)}),lO(d)?d(u):d)):(t(),lO(o)&&o.call(this,m))};lO(n)?n.call(c,m,s,i,a):s()}}));return new Promise(_)}},jO=class{constructor(e){hb(this,"userId"),hb(this,"remoteUserId"),hb(this,"id"),hb(this,"sdkAppId"),hb(this,"type"),hb(this,"isLocal"),this.id=e.id,this.userId=e.userId,this.sdkAppId=e.sdkAppId,this.remoteUserId=e.remoteUserId,this.isLocal=!pO(e.isLocal)||e.isLocal,this.type=this.isLocal?"":e.type}createChild(e){return Object.setPrototypeOf(e,this)}setUserId(e){this.userId=e}setSdkAppId(e){this.sdkAppId=e}log(e,t){let i=this.isLocal?this.userId:this.remoteUserId;t.unshift("[".concat(this.isLocal?"â":"â").concat(this.type&&"main"!==this.type?"*":"").concat(this.id).concat(i?"|".concat(i):"","]")),YO.log(e,t,dO(this.userId)||bO(this.userId),this.userId,this.sdkAppId)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(2,t)}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(1,t)}warn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(3,t)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(4,t)}},GO=new(db(mb(),1).default),WO=((BO=WO||{}).ROOM_DESTROY="1",BO.JOIN_START="21",BO.JOIN_SCHEDULE_SUCCESS="22",BO.JOIN_SIGNAL_CONNECTION_START="23",BO.JOIN_SIGNAL_CONNECTION_END="24",BO.JOIN_SEND_CMD="25",BO.JOIN_RECEIVED_CMD_RES="26",BO.JOIN_SUCCESS="27",BO.JOIN_FAILED="28",BO.LEAVE_START="51",BO.LEAVE_SEND_CMD="52",BO.LEAVE_SUCCESS="53",BO.PUBLISH_START="61",BO.SEND_FIRST_VIDEO_FRAME="62",BO.PUBLISH_FAILED="63",BO.SUBSCRIBE_START="81",BO.SUBSCRIBE_SUCCESS="82",BO.SUBSCRIBE_FAILED="84",BO.UNSUBSCRIBE_SUCCESS="83",BO.LOCAL_TRACK_CAPTURE_START="101",BO.LOCAL_TRACK_CAPTURE_SUCCESS="102",BO.LOCAL_TRACK_CAPTURE_FAILED="103",BO.LOCAL_TRACK_PUBLISHED="104",BO.LOCAL_TRACK_UNPUBLISHED="105",BO.LOCAL_TRACK_REPLACED="106",BO.SWITCH_DEVICE_SUCCESS="107",BO.TRACK_MUTED="108",BO.TRACK_UNMUTED="109",BO.REMOTE_TRACK_SUBSCRIBED="110",BO.REMOTE_TRACK_UNSUBSCRIBED="111",BO.PLAY_TRACK_START="151",BO.PLAYER_STATE_CHANGED="152",BO.VIDEO_LOADED_DATA="153",BO.AUTOPLAY_DIALOG_CLICK_CONFIRM="154",BO.WORKLET_LOADED_SUCCESS="155",BO.WORKLET_LOADED_FAILED="156",BO.SIGNAL_CONNECTION_STATE_CHANGED="201",BO.PEER_CONNECTION_STATE_CHANGED="202",BO.HEARTBEAT_REPORT="251",BO.RECEIVED_PUBLISHED_USER_LIST="252",BO.REMOTE_PUBLISH_STATE_CHANGED="253",BO.AUDIO_LEVEL_INTERVAL="260",BO.NETWORK_QUALITY="261",BO.API_SUCCESS_RATE="262",BO),JO=WO,KO=!(Bb||Hb||jk),YO=new class{constructor(){hb(this,"_isEnableUploadLog",!0),hb(this,"_localJoinedUser",new Map),hb(this,"_queue",[]),hb(this,"_timeoutId",-1),hb(this,"_logLevel",1),hb(this,"_logLevelToUpload",2),!fD&&!gD&&(this.checkURLParam(),this.installEvents())}get isAbleToUpload(){return this._isEnableUploadLog&&-1!==this._timeoutId}installEvents(){GO.on(JO.JOIN_SCHEDULE_SUCCESS,(e=>{let{schedule:t}=e;var i;(null==(i=null==t?void 0:t.config)?void 0:i.logLevelToUpload)&&PD[t.config.logLevelToUpload]&&(this._logLevelToUpload=t.config.logLevelToUpload)})),GO.on(JO.JOIN_SUCCESS,(e=>{let{room:t}=e;this.addJoinedUser({userId:t.userId,sdkAppId:t.sdkAppId}),this.startUpload()})),GO.once(JO.JOIN_FAILED,(()=>{this.startUpload()})),GO.on(JO.LEAVE_SUCCESS,(e=>{let{room:t}=e;this.deleteJoinedUser(t.userId)}))}startUpload(){-1===this._timeoutId&&this.uploadInterval()}addJoinedUser(e){this._localJoinedUser.set(e.userId,e),this.startUpload()}deleteJoinedUser(e){this._localJoinedUser.delete(e)}uploadInterval(){this.upload().catch((()=>{})),this._timeoutId=window.setTimeout((()=>this.uploadInterval()),2e3)}getLogsToUpload(){let e={map:new Map,splicedQueue:[]};if(this._queue[0].forAllJoinedClients&&0===this._localJoinedUser.size)return e;let t=0;for(;t<this._queue.length&&50!==t;t++){let i=this._queue[t];if(i.forAllJoinedClients)this._localJoinedUser.forEach((t=>{let{userId:n,sdkAppId:r}=t;e.map.has(n)?e.map.get(n).logs.push(i):e.map.set(n,{userId:n,sdkAppId:r,logs:[i]})}));else if(uO(i.userId)&&hO(i.sdkAppId)){let{userId:t,sdkAppId:n}=i;e.map.has(t)?e.map.get(t).logs.push(i):e.map.set(t,{userId:t,sdkAppId:n,logs:[i]})}}return e.map.size>0&&(e.splicedQueue=this._queue.splice(0,t)),e}upload(){return _b(this,null,(function*(){if(0===this._queue.length||!this._isEnableUploadLog)return;let{map:e,splicedQueue:t}=this.getLogsToUpload();if(0===e.size)return;try{let t=[...e.values()];for(let e=0;e<t.length;e++){let{userId:i,sdkAppId:n,logs:r}=t[e];yield this.uploadLogWithRetry(JSON.stringify({timestamp:bb(),sdkAppId:String(n),userId:i,version:uD,log:r.map((e=>e.log)).join("\n")}),n),r.forEach((e=>e.uploaded=!0))}}catch(_D){}let i=t.filter((e=>!e.uploaded));i.length>0&&(this._queue=i.concat(this._queue))}))}uploadLogWithRetry(e,t){return HO({retryFunction:()=>FO({url:YN(t,ND.LOG),body:e,timeout:5e3}),settings:{retries:3,timeout:1e3},onError:(e,t)=>{t()}})()}getPrefix(e){let t=new Date;t.setTime(Cb());let i=String(t.getMilliseconds());return"padStart"in String.prototype&&(i=i.toString().padStart(3,"0")),"[".concat(t.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1"),":").concat(i,"] <").concat(PD[e],">")}getLogLevel(){return this._logLevel}setLogLevel(e){dO(PD[e])||(this._logLevel!==e&&this.info("setLogLevel",e),this._logLevel=e)}enableUploadLog(){this._isEnableUploadLog=!0}disableUploadLog(){this.warn("disableUploadLog"),this._isEnableUploadLog=!1}logChunkToString(e){if(uO(e))return e;try{return JSON.stringify(e)}catch(pD){return""}}log(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;var o;if(t.unshift(this.getPrefix(e)),this._isEnableUploadLog&&e>=this._logLevelToUpload&&this._queue.push({log:t.reduce(((e,t)=>"".concat(e," ").concat(this.logChunkToString(t)).trim()),""),level:e,userId:n,sdkAppId:r,forAllJoinedClients:i}),e<this._logLevel)return;let s=(null==(o=PD[e])?void 0:o.toLowerCase())||"info";KO?console[s]("%cTRTC%c%s","padding: 1px 4px;border-radius: 3px;color: #fff;background: #1E88E5;","display: inline",...t):console[s](...t)}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(1,t)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(2,t)}warn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(3,t)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.log(4,t)}createLogger(e){return new jO(e)}checkURLParam(){let e=new URLSearchParams(location.search).get("logLevelToUpload"),t=e?Number(e):-1;PD[t]&&(this._logLevelToUpload=t)}},zO=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},qO=new class{constructor(){hb(this,"_prefix","TRTC"),hb(this,"_queue",new Map),this.checkStorage()}getRealKey(e){return"".concat(this._prefix,"_").concat(e)}checkStorage(){tD()&&(setInterval(this.doFlush.bind(this),2e4),Object.keys(localStorage).filter((e=>{if(e.startsWith(this._prefix)){let t=JSON.parse(localStorage.getItem(e));if(t&&t.expiresIn<Date.now())return!0}return!1})).forEach((e=>localStorage.removeItem(e))))}doFlush(){if(tD())try{for(let[e,t]of this._queue)localStorage.setItem(e,JSON.stringify(t))}catch(Xw){YO.warn(Xw)}}getItem(e){if(!tD())return null;try{let t=JSON.parse(localStorage.getItem(this.getRealKey(e)));return t&&t.expiresIn>=Date.now()?t.value:null}catch(pD){YO.warn(pD)}}setItem(e,t){if(tD())try{let i={expiresIn:Date.now()+VD,value:t};this._queue.set(this.getRealKey(e),i)}catch(pN){YO.warn(pN)}}deleteItem(e){if(!tD())return!1;try{return e=this.getRealKey(e),this._queue.delete(e),localStorage.removeItem(e),!0}catch(pD){return YO.warn(pD),!1}}clear(){if(tD())try{localStorage.clear()}catch(Xw){YO.warn(Xw)}}},QO={};lb(QO,{HTTPS_API:()=>EP,IS_GET_CAPABILITIES_SUPPORTED:()=>VP,IS_GET_SETTINGS_SUPPORTED:()=>MP,IS_SEI_SUPPORTED:()=>UP,IS_SPC_SUPPORTED:()=>OP,basis:()=>jP,checkSystemRequirementsInternal:()=>fP,decodeSupportStatus:()=>mP,encodeSupportStatus:()=>_P,getBrowserInfo:()=>aP,getDisplayResolution:()=>SP,isAddTransceiverSupported:()=>NP,isBrowserSupported:()=>cP,isGetReceiversSupported:()=>bP,isGetSendersSupported:()=>kP,isGetTransceiversSupported:()=>DP,isGetUserMediaSupported:()=>AP,isMediaDevicesSupported:()=>dP,isMediaSessionSupported:()=>BP,isMediaStreamTrackProcessorSupported:()=>pP,isReplaceTrackSupported:()=>LP,isScreenCaptureApiAvailable:()=>TP,isSelectedCandidatePair:()=>IP,isSetParametersSupported:()=>wP,isSmallStreamAPISupported:()=>vP,isSmallStreamSupported:()=>RP,isStopTransceiverSupported:()=>PP,isTRTCSupported:()=>gP,isUnifiedPlanDefault:()=>CP,isUsedInHttpProtocol:()=>hP,isWebAudioSupported:()=>yP,isWebCodecSupported:()=>FP,isWebCodecsSupported:()=>lP,isWebRTCSupported:()=>xP,isWebTransportSupported:()=>HP});var XO={AVOID_REPEATED_CALL:"AVOID_REPEATED_CALL",INVALID_PARAMETER_REQUIRED:"INVALID_PARAMETER_REQUIRED",INVALID_PARAMETER_TYPE:"INVALID_PARAMETER_TYPE",INVALID_PARAMETER_EMPTY:"INVALID_PARAMETER_EMPTY",INVALID_PARAMETER_INSTANCE:"INVALID_PARAMETER_INSTANCE",INVALID_PARAMETER_RANGE:"INVALID_PARAMETER_RANGE",INVALID_PARAMETER_MIN:"INVALID_PARAMETER_MIN",INVALID_PARAMETER_MAX:"INVALID_PARAMETER_MAX",INVALID_PARAMETER_STREAMTYPE:"INVALID_PARAMETER_STREAMTYPE",API_CALL_TIMEOUT:"API_CALL_TIMEOUT",SIGNAL_CHANNEL_RECONNECTION_FAILED:"SIGNAL_CHANNEL_RECONNECTION_FAILED",SIGNAL_CHANNEL_SETUP_FAILED:"SIGNAL_CHANNEL_SETUP_FAILED",ERROR_MESSAGE:"ERROR_MESSAGE",EXCHANGE_SDP_TIMEOUT:"EXCHANGE_SDP_TIMEOUT",DOWNLINK_RECONNECTION_FAILED:"DOWNLINK_RECONNECTION_FAILED",EXCHANGE_SDP_FAILED:"EXCHANGE_SDP_FAILED",UPDATE_OFFER_TIMEOUT:"UPDATE_OFFER_TIMEOUT",UPLINK_RECONNECTION_FAILED:"UPLINK_RECONNECTION_FAILED",INVALID_RECORDID:"INVALID_RECORDID",INVALID_PURE_AUDIO:"INVALID_PURE_AUDIO",INVALID_STREAMID:"INVALID_STREAMID",INVALID_USER_DEFINE_RECORDID:"INVALID_USER_DEFINE_RECORDID",INVALID_USER_DEFINE_PUSH_ARGS:"INVALID_USER_DEFINE_PUSH_ARGS",INVALID_PROXY:"INVALID_PROXY",INVALID_JOIN:"INVALID_JOIN",INVALID_ROOMID_STRING:"INVALID_ROOMID_STRING",INVALID_ROOMID_INTEGER:"INVALID_ROOMID_INTEGER",INVALID_SIGNAL_CHANNEL:"INVALID_SIGNAL_CHANNEL",JOIN_ROOM_TIMEOUT:"JOIN_ROOM_TIMEOUT",JOIN_ROOM_FAILED:"JOIN_ROOM_FAILED",REJOIN_ROOM_FAILED:"REJOIN_ROOM_FAILED",INVALID_DESTROY:"INVALID_DESTROY",INVALID_PUBLISH:"INVALID_PUBLISH",INVALID_UNPUBLISH:"INVALID_UNPUBLISH",INVALID_AUDIENCE:"INVALID_AUDIENCE",INVALID_INITIALIZE:"INVALID_INITIALIZE",INVALID_DUPLICATE_PUBLISHING:"INVALID_DUPLICATE_PUBLISHING",INVALID_SUBSCRIBE_UNDEFINED:"INVALID_SUBSCRIBE_UNDEFINED",INVALID_SUBSCRIBE_LOCAL:"INVALID_SUBSCRIBE_LOCAL",INVALID_REMOTE_STREAM:"INVALID_REMOTE_STREAM",SUBSCRIBE_FAILED:"SUBSCRIBE_FAILED",INVALID_ROLE:"INVALID_ROLE",INVALID_PARAMETER_SWITCH_ROLE:"INVALID_PARAMETER_SWITCH_ROLE",INVALID_OPERATION_SWITCH_ROLE:"INVALID_OPERATION_SWITCH_ROLE",SWITCH_ROLE_TIMEOUT:"SWITCH_ROLE_TIMEOUT",SWITCH_ROLE_FAILED:"SWITCH_ROLE_FAILED",CLIENT_BANNED:"CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"INVALID_OPERATION_START_PUBLISH_CDN",INVALID_OPERATION_STOP_PUBLISH_CDN:"INVALID_OPERATION_STOP_PUBLISH_CDN",INVALID_STREAM_ID:"INVALID_STREAM_ID",START_PUBLISH_CDN_FAILED:"START_PUBLISH_CDN_FAILED",STOP_PUBLISH_CDN_FAILED:"STOP_PUBLISH_CDN_FAILED",START_MIX_TRANSCODE:"START_MIX_TRANSCODE",STOP_MIX_TRANSCODE:"STOP_MIX_TRANSCODE",INVALID_AUDIO_VOLUME:"INVALID_AUDIO_VOLUME",ENABLE_SMALL_STREAM_PUBLISHED:"ENABLE_SMALL_STREAM_PUBLISHED",DISABLE_SMALL_STREAM_PUBLISHED:"DISABLE_SMALL_STREAM_PUBLISHED",NOT_SUPPORTED_SMALL_STREAM:"NOT_SUPPORTED_SMALL_STREAM",INVALID_SMALL_STREAM_PROFILE:"INVALID_SMALL_STREAM_PROFILE",INVALID_PARAMETER_REMOTE_STREAM:"INVALID_PARAMETER_REMOTE_STREAM",INVALID_OPERATION_CHANGE_SMALL:"INVALID_OPERATION_CHANGE_SMALL",REMOTE_NOT_PUBLISH_SMALL_STREAM:"REMOTE_NOT_PUBLISH_SMALL_STREAM",INVALID_SWITCH_DEVICE:"INVALID_SWITCH_DEVICE",INVALID_SWITCH_DEVICE_PUBLISHING:"INVALID_SWITCH_DEVICE_PUBLISHING",INVALID_REPLACE_TRACK:"INVALID_REPLACE_TRACK",INVALID_INITIALIZE_LOCAL_STREAM:"INVALID_INITIALIZE_LOCAL_STREAM",INVALID_ADD_TRACK_REPETITIVE:"INVALID_ADD_TRACK_REPETITIVE",INVALID_ADD_TRACK_REMOVING:"INVALID_ADD_TRACK_REMOVING",INVALID_ADD_TRACK_PUBLISHING:"INVALID_ADD_TRACK_PUBLISHING",INVALID_STREAM_INITIALIZED:"INVALID_STREAM_INITIALIZED",INVALID_ADD_TRACK_NUMBER:"INVALID_ADD_TRACK_NUMBER",INVALID_REMOVE_AUDIO_TRACK:"INVALID_REMOVE_AUDIO_TRACK",INVALID_REMOVE_AUDIO_ADDING:"INVALID_REMOVE_AUDIO_ADDING",INVALID_REMOVE_AUDIO_ON:"INVALID_REMOVE_AUDIO_ON",INVALID_REMOVE_TRACK_PUBLISHING:"INVALID_REMOVE_TRACK_PUBLISHING",INVALID_REMOVE_TRACK_NOT_TRACK:"INVALID_REMOVE_TRACK_NOT_TRACK",INVALID_REMOVE_TRACK_NUMBER:"INVALID_REMOVE_TRACK_NUMBER",INVALID_REPLACE_TRACK_NO_TRACK:"INVALID_REPLACE_TRACK_NO_TRACK",REPEAT_JOIN:"REPEAT_JOIN",CLIENT_DESTROYED:"CLIENT_DESTROYED",NOT_BUG_PACKAGE:"NOT_BUG_PACKAGE",START_MIX_TRANSCODE_FAILED:"START_MIX_TRANSCODE_FAILED",STOP_MIX_TRANSCODE_FAILED:"STOP_MIX_TRANSCODE_FAILED",MIX_TRANSCODE_NOT_STARTED:"MIX_TRANSCODE_NOT_STARTED",CANNOT_LESS_THAN_ZERO:"CANNOT_LESS_THAN_ZERO",MIX_PARAMS_VIDEO_FRAMERATE:"MIX_PARAMS_VIDEO_FRAMERATE",MIX_PARAMS_VIDEO_GOP:"MIX_PARAMS_VIDEO_GOP",MIX_PARAMS_AUDIO_BITRATE:"MIX_PARAMS_AUDIO_BITRATE",MIX_PARAMS_USER_Z_ORDER:"MIX_PARAMS_USER_Z_ORDER",MIX_PARAMS_NOT_SELF:"MIX_PARAMS_NOT_SELF",MIX_PARAMS_USER_STREAM:"MIX_PARAMS_USER_STREAM",INVALID_PLAY:"INVALID_PLAY",INVALID_ELEMENT_ID:"INVALID_ELEMENT_ID",INVALID_ELEMENT_ID_TYPE:"INVALID_ELEMENT_ID_TYPE",PLAY_FAILED:"PLAY_FAILED",INVALID_USERID:"INVALID_USERID",INVALID_CREATE_STREAM_SOURCE:"INVALID_CREATE_STREAM_SOURCE",INVALID_CREATE_STREAM_SCREEN:"INVALID_CREATE_STREAM_SCREEN",INVALID_CREATE_STREAM_AUDIO:"INVALID_CREATE_STREAM_AUDIO",INVALID_CREATE_STREAM_SCREEN_AUDIO:"INVALID_CREATE_STREAM_SCREEN_AUDIO",NOT_SUPPORTED_HTTP:"NOT_SUPPORTED_HTTP",NOT_SUPPORTED_WEBRTC:"NOT_SUPPORTED_WEBRTC",NOT_SUPPORTED_PROFILE:"NOT_SUPPORTED_PROFILE",NOT_SUPPORTED_MEDIA:"NOT_SUPPORTED_MEDIA",NOT_SUPPORTED_H264ENCODE:"NOT_SUPPORTED_H264ENCODE",NOT_SUPPORTED_H264DECODE:"NOT_SUPPORTED_H264DECODE",NOT_SUPPORTED_TRACK:"NOT_SUPPORTED_TRACK",NOT_SUPPORTED_SWITCH_DEVICE:"NOT_SUPPORTED_SWITCH_DEVICE",NOT_SUPPORTED_CAPTURE:"NOT_SUPPORTED_CAPTURE",NOT_SUPPORTED_AUX:"NOT_SUPPORTED_AUX",MICROPHONE_NOT_FOUND:"MICROPHONE_NOT_FOUND",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",SIGNAL_RESPONSE_FAILED:"SIGNAL_RESPONSE_FAILED",CATCH_HANDLER_ERROR:"CATCH_HANDLER_ERROR",API_NOT_EXIST:"API_NOT_EXIST",CONNECTION_CLOSED:"CONNECTION_CLOSED",SUBSCRIBE_ALL_FALSE:"SUBSCRIBE_ALL_FALSE",SEI_NOT_SUPPORT:"SEI_NOT_SUPPORT",SEI_DISABLED:"SEI_DISABLED",SEI_EMPTY:"SEI_EMPTY",SEI_OVERSIZE:"SEI_OVERSIZE",SEI_BEFORE_PUBLISH:"SEI_BEFORE_PUBLISH",SEI_NOT_VIDEO:"SEI_NOT_VIDEO",CALL_FREQUENCY_LIMIT:"CALL_FREQUENCY_LIMIT",CONNECTION_ABORTED:"CONNECTION_ABORTED",API_CALL_ABORTED:"API_CALL_ABORTED",DUPLICATE_AUX:"DUPLICATE_AUX"},ZO={AVOID_REPEATED_CALL:e=>"previous ".concat(e.name,"() is ongoing, please avoid repeated calls."),INVALID_PARAMETER_REQUIRED(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' is a required param when calling ").concat(n,"(), received: ").concat(r,".")},INVALID_PARAMETER_TYPE(e){let{key:t,rule:i,fnName:n,value:r}=e,o="".concat(t||i.name),s="";return s=Array.isArray(i.type)?i.type.join("|"):i.type,"'".concat(o,"' must be type of ").concat(s," when calling ").concat(n,"(), received type: ").concat(cO(r),".")},INVALID_PARAMETER_EMPTY(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' cannot be '").concat(r,"' when calling ").concat(n,"().")},INVALID_PARAMETER_INSTANCE(e){let{key:t,rule:i,fnName:n,value:r}=e,o="".concat(t||i.name),s="".concat(i.instanceOf.name||i.instanceOf);return"'".concat(o,"' must be instanceof ").concat(s," when calling ").concat(n,"(), received type: ").concat(cO(r),".")},INVALID_PARAMETER_RANGE(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' must be one of ").concat(i.values.join("|")," when calling ").concat(n,"(), received: ").concat(r,".")},INVALID_PARAMETER_MIN(e){let{key:t,rule:i,fnName:n,value:r}=e;return"the min value of ".concat(t||i.name," is ").concat(i.min,", received: ").concat(r,".")},INVALID_PARAMETER_MAX(e){let{key:t,rule:i,fnName:n,value:r}=e;return"the max value of ".concat(t||i.name," is ").concat(i.max,", received: ").concat(r,".")},API_CALL_TIMEOUT:e=>"".concat(e.commandDesc||e.command," timeout observed."),SIGNAL_CHANNEL_RECONNECTION_FAILED:"signal channel reconnection failed, please check your network.",SIGNAL_CHANNEL_SETUP_FAILED:e=>"SignalChannel setup failure: (errorCode: ".concat(e.errorCode,", errorMsg: ").concat(e.errorMsg," })."),ERROR_MESSAGE(e){let t="".concat(e.type," failed");return e.message&&(t="".concat(t,": ").concat(e.message,".")),t},EXCHANGE_SDP_TIMEOUT:"exchange sdp timeout.",DOWNLINK_RECONNECTION_FAILED:"downlink reconnection failed, please check your network and re-join room.",EXCHANGE_SDP_FAILED:e=>"exchange sdp failed ".concat(e.errMsg,"."),UPDATE_OFFER_TIMEOUT:"update offer timeout observed.",UPLINK_RECONNECTION_FAILED:"uplink reconnection failed, please check your network and publish again.",INVALID_RECORDID:"recordId must be an integer number.",INVALID_PURE_AUDIO:"pureAudioPushMode must be 1 or 2.",INVALID_STREAMID:"streamId must be a sting literal within 64 bytes, and not be empty.",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId must be a sting literal contains (a-zA-Z),(0-9), underline and hyphen, within 64 bytes, and not be empty.",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs must be a sting literal within 256 bytes, and not be empty.",INVALID_PROXY:'proxy server url must start with "wss://".',INVALID_JOIN:"duplicate join() called.",INVALID_ROOMID_STRING:e=>"'".concat(e,"' must be validate string when useStringRoomId is true."),INVALID_ROOMID_INTEGER:e=>"'".concat(e,"' must be an integer between [1, 4294967294] when useStringRoomId is false."),INVALID_SIGNAL_CHANNEL:"SignalChannel is not ready yet.",JOIN_ROOM_TIMEOUT:"join room timeout.",JOIN_ROOM_FAILED(e){let{error:t,code:i}=e;return"Failed to join room - ".concat(t," code: ").concat(i)},REJOIN_ROOM_FAILED:e=>"reJoin room: ".concat(e.roomId," failed, please check your network."),INVALID_DESTROY:"please call leave() before destroy().",INVALID_PUBLISH:"please call join() before publish().",INVALID_UNPUBLISH:"stream has not been published yet.",INVALID_AUDIENCE:"no permission to publish() under live/".concat("audience",', please call switchRole("',"anchor",'") firstly before publish().'),INVALID_INITIALIZE:"cannot publish stream because stream is not initialized, is switching device, or has been closed.",INVALID_DUPLICATE_PUBLISHING:e=>"duplicate ".concat(e," stream publishing, please unpublish your prev ").concat(e," stream and then re-publish."),INVALID_SUBSCRIBE_UNDEFINED:"stream is undefined or null.",INVALID_SUBSCRIBE_LOCAL:"stream cannot be LocalStream.",INVALID_REMOTE_STREAM:"remoteStream does not exist because it has been unpublished by remote peer.",SUBSCRIBE_FAILED(e){let{message:t,userId:i,streamType:n}=e;return"failed to subscribe ".concat(i," ").concat(n," stream, reason: ").concat(t,".")},INVALID_ROLE:"switchRole can only be called in live mode.",INVALID_PARAMETER_SWITCH_ROLE:"role could only be set to a value as ".concat("anchor"," or ","audience","."),INVALID_OPERATION_SWITCH_ROLE:"please call join() before switchRole().",SWITCH_ROLE_TIMEOUT:"switchRole timeout.",SWITCH_ROLE_FAILED:e=>"switchRole failed, errCode: ".concat(e.code," errMsg: ").concat(e.message,"."),CLIENT_BANNED:e=>"client was banned because of ".concat(e.message,"."),INVALID_OPERATION_START_PUBLISH_CDN:"please call startPublishCDNStream() after join room and publish the local stream.",INVALID_OPERATION_STOP_PUBLISH_CDN:"please call startPublishCDNStream() before stopPublishCDNStream().",START_PUBLISH_CDN_FAILED:e=>"startPublishCDNStream failed, errMsg: ".concat(e.message,"."),STOP_PUBLISH_CDN_FAILED:e=>"stopPublishCDNStream failed, errMsg: ".concat(e.message,"."),INVALID_STREAM_ID:e=>"'".concat(e,"' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores."),START_MIX_TRANSCODE:"please call startMixTranscode() after join().",STOP_MIX_TRANSCODE:"please call stopMixTranscode() after startMixTranscode().",INVALID_AUDIO_VOLUME:"interval must be a number.",ENABLE_SMALL_STREAM_PUBLISHED:"Cannot enable small stream after localStream published.",DISABLE_SMALL_STREAM_PUBLISHED:"Cannot disable small stream after localStream published.",NOT_SUPPORTED_SMALL_STREAM:"your browser does not support opening small stream.",INVALID_SMALL_STREAM_PROFILE:"small stream profile is invalid.",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream is invalid.",INVALID_OPERATION_CHANGE_SMALL:"cannot switch to the small stream without subscribing to the video of remoteStream.",REMOTE_NOT_PUBLISH_SMALL_STREAM:"remote peer does not publish small stream.",INVALID_SWITCH_DEVICE:"cannot switch device on current stream.",INVALID_SWITCH_DEVICE_PUBLISHING:"cannot switch device when publishing localStream.",INVALID_REPLACE_TRACK:"cannot replace track when publishing localStream.",INVALID_INITIALIZE_LOCAL_STREAM:"local stream has not initialized yet.",INVALID_ADD_TRACK_REPETITIVE:"previous addTrack is ongoing, please avoid repetitive execution.",INVALID_ADD_TRACK_REMOVING:"cannot add track when a track is removing.",INVALID_ADD_TRACK_PUBLISHING:"cannot add track when publishing localStream.",INVALID_STREAM_INITIALIZED:"your local stream haven't been initialized yet.",INVALID_ADD_TRACK_NUMBER:"a Stream has at most one audio track and one video track.",INVALID_REMOVE_AUDIO_TRACK:"remove audio track is not supported on your browser.",INVALID_REMOVE_AUDIO_ADDING:"cannot remove track when a track is adding.",INVALID_REMOVE_AUDIO_ON:"previous removeTrack is ongoing, please avoid repetitive execution.",INVALID_REMOVE_TRACK_PUBLISHING:"cannot remove track when publishing localStream.",INVALID_REMOVE_TRACK_NOT_TRACK:"localStream has not this track.",INVALID_REMOVE_TRACK_NUMBER:"remove the only video track is not supported, please use replaceTrack or muteVideo.",INVALID_REPLACE_TRACK_NO_TRACK:e=>"cannot replace ".concat(e.kind," track because stream has not ").concat(e.kind," track"),NOT_BUG_PACKAGE:"You need to buy packages, refer to tencent console.",START_MIX_TRANSCODE_FAILED:e=>"startMixTranscode failed, errMsg: ".concat(e.message,"."),STOP_MIX_TRANSCODE_FAILED:e=>"stopMixTranscode failed, errMsg: ".concat(e.message,"."),MIX_TRANSCODE_NOT_STARTED:"mixTranscode has not been started.",CANNOT_LESS_THAN_ZERO(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' cannot be less than 0 when calling ").concat(n,"().")},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_USER_Z_ORDER:e=>"'".concat(e,"' is required and must be between 1 and 15."),MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_PLAY:"duplicate play() call observed, please stop() firstly.",INVALID_ELEMENT_ID:e=>{let{key:t,fnName:i}=e;return"'".concat(t,"' is not found in the document object when calling ").concat(i,"().")},INVALID_ELEMENT_ID_TYPE:e=>{let{key:t,fnName:i,type:n}=e;return"the element corresponding to '".concat(t,"' must be instanceof HTMLElement when calling ").concat(i,"(), received: ").concat(n,".")},PLAY_FAILED:e=>"".concat(e.media," play failedï¼browser exception: ").concat(e.error.toString()),INVALID_USERID:"userId cannot be all spaces.",INVALID_CREATE_STREAM_SOURCE:"LocalStream must be created by createStream() with either audio/video or audioSource/videoSource, but can not be mixed with audio/video and audioSource/videoSource.",INVALID_CREATE_STREAM_SCREEN:"screen/video cannot be both true.",INVALID_CREATE_STREAM_AUDIO:"audio/screenAudio cannot be both true.",INVALID_CREATE_STREAM_SCREEN_AUDIO:"when screen is true, screenAudio can be configured.",NOT_SUPPORTED_HTTP:"http protocol does not support the ability to capture microphone, camera and screen. please use https to deploy your page.",NOT_SUPPORTED_WEBRTC:"your browser or environment does not support full WebRTC capabilities.",NOT_SUPPORTED_PROFILE:"your browser does not support setVideoProfile.",NOT_SUPPORTED_MEDIA:"your browser or environment does not support navigator.mediaDevices.",NOT_SUPPORTED_H264ENCODE:"your device does not support H.264 encoding.",NOT_SUPPORTED_H264DECODE:"your device does not support H.264 decoding.",NOT_SUPPORTED_TRACK:e=>"".concat(e,"Track is not supported on your browser."),NOT_SUPPORTED_SWITCH_DEVICE:"switchDevice is not supported on your browser.",NOT_SUPPORTED_CAPTURE:"Your browser or environment does not support screen sharing, please check whether the browser version.",MICROPHONE_NOT_FOUND:"no microphone detected, please check your microphone.",CAMERA_NOT_FOUND:"no camera detected, please check your camera.",SIGNAL_RESPONSE_FAILED:e=>"".concat(e.signalResponse," failed, response code is ").concat(e.code," , errMsg: ").concat(e.message,"."),CATCH_HANDLER_ERROR(e){let{name:t,event:i}=e;return"an error was caught on ".concat(t,".on('").concat(i,"', handler), please check your code on 'handler'.")},API_NOT_EXIST(e){let{name:t}=e;return"experimental api ".concat(t," does not exist.")},REPEAT_JOIN:e=>"[".concat(e,"] is calling client.join api or has already joined room, please avoid repeated join."),CONNECTION_CLOSED:"remoteStream has been unsubscribed or unpublished by remote user.",SUBSCRIBE_ALL_FALSE:"cannot subscribe when both audio & video are false, use client.unsubscribe() instead",CLIENT_DESTROYED(e){let{funName:t}=e;return"failed to call ".concat(t,"() because client was destroyed.")},SEI_NOT_SUPPORT:e=>"not support to sendSEIMessage".concat(!1===e?" without using h264 codec":""),SEI_DISABLED:"SEI is disabled",SEI_EMPTY:"buffer cannot be empty",SEI_OVERSIZE:e=>"buffer size(".concat(e,") is over 1000 Bytes"),SEI_BEFORE_PUBLISH:"please call sendSEIMessage() after publish() success",SEI_NOT_VIDEO:"cannot send sei when localStream has not video.",CALL_FREQUENCY_LIMIT:e=>{let{isSize:t,name:i,timesInSecond:n,maxSizeInSecond:r}=e;return"api ".concat(i," call ").concat(t?"size":"times"," is over ").concat(t?"".concat(r," bytes"):n," in a second.")},CONNECTION_ABORTED:e=>"connection aborted due to: ".concat(e),API_CALL_ABORTED(e){let t;return t=e.message.includes("REMOTE_STREAM_NOT_EXIST")?"Subscribe ".concat(e.userId," ").concat(e.streamType," stream aborted, reason: remote user ").concat(e.userId," unpublished stream."):"API aborted, reason: ".concat(e.message),t},DUPLICATE_AUX:"only one auxiliary stream can be published in a room.",NOT_SUPPORTED_AUX:"publish auxiliary stream is not supported on your browser.",INVALID_PARAMETER_STREAMTYPE:e=>"'streamType' is required when 'userId' is not '*', calling ".concat(e,"()")};function $O(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}var eP={AVOID_REPEATED_CALL:e=>"åä¸ä¸ª ".concat(e.name,"() è°ç¨æ­£å¨è¿è¡ä¸­, è¯·é¿åéå¤è°ç¨ã"),INVALID_PARAMETER_REQUIRED(e){let{key:t,rule:i,fnName:n,value:r}=e;return"è°ç¨ ".concat(n,"() æ¹æ³çæ¶å '").concat(t||i.name,"' æ¯å¿é¡»çåæ°, æ¶å°çå¼ä¸º: ").concat(r,"ã")},INVALID_PARAMETER_TYPE(e){let{key:t,rule:i,fnName:n,value:r}=e,o="".concat(t||i.name),s="";return s=Array.isArray(i.type)?i.type.join("|"):i.type,"è°ç¨ ".concat(n,"() æ¹æ³çæ¶å '").concat(o,"' å¿é¡»æ¯ ").concat(s," ç±»å, æ¶å°çç±»åæ¯: ").concat($O(r),"ã")},INVALID_PARAMETER_EMPTY(e){let{key:t,rule:i,fnName:n,value:r}=e;return"è°ç¨ ".concat(n,"() çæ¶å '").concat(t||i.name,"' ä¸è½æ¯ '").concat(r,"'ã")},INVALID_PARAMETER_INSTANCE(e){let{key:t,rule:i,fnName:n,value:r}=e,o="".concat(t||i.name),s="".concat(i.instanceOf.name||i.instanceOf);return"è°ç¨ ".concat(n,"() çæ¶å '").concat(o,"' ååå¿é¡»æ¯ ").concat(s," , æ¶å°çæ¯: ").concat($O(r),"ã")},INVALID_PARAMETER_RANGE(e){let{key:t,rule:i,fnName:n,value:r}=e;return"è°ç¨ ".concat(n,"() çæ¶å '").concat(t||i.name,"' å¿é¡»æ¯ ").concat(i.values.join("|")," çå¶ä¸­ä¸ç§, æ¶å°çæ¯: ").concat(r,"ã")},API_CALL_TIMEOUT:e=>"".concat(e.commandDesc||e.command," è¶æ¶ã"),SIGNAL_CHANNEL_RECONNECTION_FAILED:"ä¿¡ä»¤éééè¿å¤±è´¥ï¼è¯·æ£æ¥ä½ çç½ç»ã",SIGNAL_CHANNEL_SETUP_FAILED:e=>"ä¿¡ä»¤ééå»ºç«å¤±è´¥: (éè¯¯ç : ".concat(e.errorCode,", éè¯¯ä¿¡æ¯: ").concat(e.errorMsg," })ã"),ERROR_MESSAGE(e){let t="".concat(e.type," å¤±è´¥ã");return e.message&&(t="".concat(t,": ").concat(e.message,"ã")),t},SUBSCRIPTION_TIMEOUT:"è¿ç¨æå¡å¨ä¸ååºè®¢éè¡ä¸ºã",EXCHANGE_SDP_TIMEOUT:"äº¤æ¢ sdp è¶æ¶ï¼è¯·å·æ°ç½ç»éè¯ã",DOWNLINK_RECONNECTION_FAILED:"ä¸è¡éè¿å¤±è´¥ï¼è¯·æ£æ¥æ¨çç½ç»å¹¶éæ°å å¥æ¿é´ã",EXCHANGE_SDP_FAILED:e=>"äº¤æ¢ SDP å¤±è´¥ï¼åå  ".concat(e.errMsg,"ã"),REPLACE_TRACK_INVALID:"LocalStream åå¸ä¹åæå¯ä»¥è°ç¨ replaceTrackã",UPDATE_OFFER_TIMEOUT:"æ´æ° offer è¶æ¶ï¼è¯·å·æ°ç½ç»éè¯ã",UPLINK_RECONNECTION_FAILED:"ä¸è¡éè¿å¤±è´¥ï¼è¯·æ£æ¥æ¨çç½ç»å¹¶éæ°æ¨æµã",INVALID_RECORDID:"recordId å¿é¡»æ¯æ°å­ã",INVALID_PURE_AUDIO:"pureAudioPushMode å¿é¡»æ¯æ°å­1æ2ã",INVALID_STREAMID:"streamId å¿é¡»æ¯ 64 å­èä»¥åçå­ç¬¦ä¸²ï¼å¹¶ä¸ä¸è½ä¸ºç©ºã",INVALID_USER_DEFINE_RECORDID:"userDefineRecordId å¿é¡»æ¯åå« (a-zA-Z)ã(0-9)ãä¸åçº¿åè¿å­ç¬¦çå­ç¬¦ä¸²å­é¢éï¼64 ä¸ªå­èä»¥åï¼ä¸ä¸ä¸ºç©ºã",INVALID_USER_DEFINE_PUSH_ARGS:"userDefinePushArgs å¿é¡»æ¯ 256 å­èä»¥åçå­ç¬¦ä¸²æå­ï¼å¹¶ä¸ä¸è½ä¸ºç©ºã",INVALID_PROXY:"ä»£çæå¡å¨ url å¿é¡»ä»¥âwss://âå¼å¤´ã",INVALID_JOIN:"join() æ¹æ³ä¸è½è¢«éå¤è°ç¨ã",INVALID_ROOMID_STRING:e=>"å½ useStringRoomId ä¸º true æ¶ï¼'".concat(e,"' å¿é¡»æ¯åæ³å­ç¬¦ä¸²ã"),INVALID_ROOMID_INTEGER:e=>"å½ useStringRoomId ä¸º false æ¶ï¼'".concat(e,"' å¿é¡»æ¯åæ³æ´æ°å¨åºé´[1, 4294967294]ã"),INVALID_SIGNAL_CHANNEL:"SignalChannel è¿æªåå§åå¥½ã",JOIN_ROOM_TIMEOUT:"è¿æ¿è¶æ¶ã",JOIN_ROOM_FAILED:e=>"è¿æ¿å¤±è´¥ï¼åå ï¼".concat(e.error,"ã"),REJOIN_ROOM_FAILED:e=>"éè¿æ¿: ".concat(e.roomId," å¤±è´¥ï¼è¯·æ£æ¥ç½ç»ç¶åµã"),INVALID_LEAVE:"è¯·å¨è°ç¨ destroy() æ¹æ³ä¹åè°ç¨ leave()ã",INVALID_PUBLISH:"è¯·å¨è°ç¨ publish() æ¹æ³ä¹åè°ç¨ join()ã",INVALID_UNPUBLISH:"è¿æ²¡æè¢« publishã",INVALID_AUDIENCE:"å¨è§ä¼æ¨¡å¼ä¸ä¸åè®¸è°ç¨ publish()ï¼è¯·ååæ¢æä¸»æ­æ¨¡å¼ã",INVALID_INITIALIZE:"æ æ³åå¸ streamï¼åå ï¼localStream æªåå§åãæ­£å¨åæ¢è®¾å¤ãå·²ç»è°ç¨ localStream.close() å³é­éé",INVALID_DUPLICATE_PUBLISHING:"éå¤åå¸ï¼è¯·å unpublish ä¹åï¼åéæ° publishã",INVALID_SUBSCRIBE_UNDEFINED:"stream åæ°æ¯ undefined æè nullã",INVALID_SUBSCRIBE_LOCAL:"stream åæ°ä¸è½ä¸ºæ¬å°æµã",INVALID_REMOTE_STREAM:"remoteStream ä¸å­å¨ï¼å·²è¢«è¿ç«¯ client åæ¶åå¸ã",SUBSCRIBE_FAILED(e){let t="è®¢éæµå¤±è´¥ï¼åå : ";return e.message.includes("REMOTE_STREAM_NOT_EXIST")?t+="è¿ç«¯ç¨æ·å·²åæ¶æ¨æµï¼æ æ³è®¢éè¯¥è¿ç«¯æµã":t+="".concat(e.message,"ã"),t},INVALID_ROLE:"åªæç´æ­æ¨¡å¼æå¯ä»¥è¿è¡è§è²åæ¢ã",INVALID_PARAMETER_SWITCH_ROLE:"role åªè½è®¾ç½®ä¸º anchor æè audienceã",INVALID_OPERATION_SWITCH_ROLE:"è¯·å¨ä½¿ç¨ switchRole() æ¹æ³ååè¿æ¿ã",SWITCH_ROLE_TIMEOUT:"åæ¢è§è²è¶æ¶ã",SWITCH_ROLE_FAILED:e=>"åæ¢è§è²å¤±è´¥ãéè¯¯ç : ".concat(e.code," éè¯¯ä¿¡æ¯: ").concat(e.message,"ã"),CLIENT_BANNED:e=>"æ¨è¢«å¨éæ¿äºï¼åå ä¸ºï¼".concat(e.reason,"ã"),INVALID_OPERATION_START_PUBLISH_CDN:"è¯·å¨è¿æ¿åæèè¿æ¿å¹¶æååå¸æ¬å°æµåè°ç¨ startPublishCDNStream() æ¹æ³ã",INVALID_OPERATION_STOP_PUBLISH_CDN:"å¨è°ç¨ stopPublishCDNStream() æ¹æ³åéè¦å startPublishCDNStream()ã",INVALID_STREAM_ID:e=>"'".concat(e,"' åªè½ç±å¤§å°åå­æ¯ï¼a-zA-zï¼, æ°å­ï¼0-9ï¼, è¿å­ç¬¦åä¸åçº¿ç»æ"),START_PUBLISH_CDN_FAILED:e=>"startPublishCDNStream è°ç¨å¤±è´¥ï¼éè¯¯ä¿¡æ¯: ".concat(e.message,"ã"),STOP_PUBLISH_CDN_FAILED:e=>"stopPublishCDNStream è°ç¨å¤±è´¥ï¼éè¯¯ä¿¡æ¯: ".concat(e.message,"ã"),START_MIX_TRANSCODE:"è°ç¨ startMixTranscode() æ¹æ³åéè¦åè°ç¨ join()ã",STOP_MIX_TRANSCODE:"è°ç¨ stopMixTranscode ä¹åéè¦è°ç¨ startMixTranscodeã",INVALID_AUDIO_VOLUME:"interval å¿é¡»æ¯æ°å­ã",ENABLE_SMALL_STREAM_PUBLISHED:"åå¸ localStream ä¹åä¸åè®¸å¼å¯å°æµã",DISABLE_SMALL_STREAM_PUBLISHED:"åå¸ localStream ä¹åä¸åè®¸å³é­å°æµã",NOT_SUPPORTED_SMALL_STREAM:"æ¨çæµè§å¨ä¸æ¯æå¼å¯å°æµã",INVALID_SMALL_STREAM_PROFILE:"å°æµåæ°ä¸åæ³ã",INVALID_PARAMETER_REMOTE_STREAM:"remoteStream ä¸åæ³ã",REMOTE_NOT_PUBLISH_SMALL_STREAM:"è¿ç«¯ç¨æ·æ²¡æåå¸å°æµã",INVALID_SWITCH_DEVICE:"å½åçæµä¸å¯ä»¥è°ç¨ switchDeviceã",INVALID_SWITCH_DEVICE_PUBLISHING:"åå¸æ¬å°æµæ¶ä¸è½åæ¢è®¾å¤ã",INVALID_REPLACE_TRACK:"client.publish æ¥å£å°æªè°ç¨å®æï¼è¯·ç­å¶è°ç¨å®æååè°ç¨ replaceTrack æ¥å£ã",INVALID_INITIALIZE_LOCAL_STREAM:"æ¬å°æµè¿æ²¡æåå§åã",INVALID_ADD_TRACK_REPETITIVE:"åä¸ä¸ª addTrack æ­£å¨è¿è¡ï¼è¯·é¿åéå¤è°ç¨ã",INVALID_ADD_TRACK_REMOVING:"track å¨ç§»å¨çæ¶åä¸è½æ·»å æ°ç trackã",INVALID_ADD_TRACK_PUBLISHING:"å¨åå¸æ¬å°æµçæ¶åä¸è½æ·»å æ°ç trackã",INVALID_STREAM_INITIALIZED:"æ¨çæ¬å°æµè¿æ²¡æåå§åã",INVALID_ADD_TRACK_NUMBER:"ä¸æ¡æµæå¤æä¸ä¸ªé³é¢è½¨éåä¸ä¸ªè§é¢è½¨éã",INVALID_REMOVE_AUDIO_TRACK:"remove audio track æ¯ä¸åè®¸çã",INVALID_REMOVE_AUDIO_ADDING:"å½ä¸ä¸ª track è¢« addTrack çæ¶åä¸è½å¯¹æµè¿è¡ removeTrack æä½ã",INVALID_REMOVE_AUDIO_ON:"åä¸æ¬¡è°ç¨ç removeTrack æ­£å¨è¿è¡ä¸­ï¼è¯·é¿åéå¤æä½ã",INVALID_REMOVE_TRACK_PUBLISHING:"åå¸æµçè¿ç¨ä¸­ä¸è½è¿è¡ removeTrack æä½ã",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"è¢« remove ç track æ²¡æè¢«åå¸ã",INVALID_REMOVE_TRACK_NUMBER:"ä¸æ¯æç§»é¤å¯ä¸çè§é¢è½¨éï¼è¯·ä½¿ç¨ replaceTrack æè muteVideo æ¹æ³ã",INVALID_REPLACE_TRACK_NO_TRACK:e=>"LocalStream æ²¡æ ".concat(e.kind," trackï¼æ æ³è¿è¡æ¿æ¢ã"),START_MIX_TRANSCODE_FAILED:e=>"startMixTranscode è°ç¨å¤±è´¥ï¼éè¯¯ä¿¡æ¯: ".concat(e.message,"ã"),STOP_MIX_TRANSCODE_FAILED:e=>"stopMixTranscode è°ç¨å¤±è´¥ï¼éè¯¯ä¿¡æ¯:  ".concat(e.message,"ã"),MIX_TRANSCODE_NOT_STARTED:"è¿æ²¡æå¼å§ mixTranscodeã",CANNOT_LESS_THAN_ZERO(e){let{key:t,rule:i,fnName:n}=e;return"'å½è°ç¨ ".concat(n,"() å½æ°æ¶ï¼è¦æ±åæ° ").concat(t||i.name,"' å¿é¡»å¤§äºç­äº0")},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' åºè¯¥æ¯ (0, 30] åºé´åçæ´æ°ã",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' åºè¯¥æ¯ [1, 8] åºé´åçæ´æ°ã",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' åºè¯¥æ¯ [32, 192] åºé´åçæ´æ°ã",MIX_PARAMS_USER_Z_ORDER:e=>"'".concat(e,"' æ¯å¿ä¼ çï¼ä¸è¦æ±ä¸º [1 ,15] ä¹é´çæ´æ°ã"),MIX_PARAMS_NOT_SELF:"'config.mixUsers' å¿é¡»åå«åèµ·æ··æµçç¨æ·ä¿¡æ¯ã",MIX_PARAMS_USER_STREAM:"è¾åºæµç 'config.videoWidth' å 'config.videoHeight' åºè¯¥å®¹çº³æææ··å¥æµã",INVALID_PLAY:"play() è¢«éå¤è°ç¨ï¼è¯·å stop()ï¼ç¶ååéæ°è°ç¨ playã",INVALID_ELEMENT_ID:e=>{let{key:t,fnName:i}=e;return"å¨è°ç¨ ".concat(i,"() æ¶ï¼document å¯¹è±¡ä¸­æ¾ä¸å° ").concat(t," å¯¹åºçåç´ ï¼è¯·æ£æ¥ã")},INVALID_ELEMENT_ID_TYPE:e=>{let{key:t,type:i,fnName:n}=e;return"å¨è°ç¨ ".concat(n,"() æ¹æ³æ¶ï¼").concat(t," åæ°å¯¹åºç HTML æ ç­¾åç´ å¿é¡»æ¯ HTMLElement å®ä¾ï¼æ¨ä¼ å¥çæ¯ï¼").concat(i,"ã")},PLAY_FAILED:e=>"".concat(e.media," æ­æ¾è¢«ä¸­æ­ï¼æµè§å¨å¼å¸¸åå ï¼").concat(e.error.toString()),INVALID_USERID:"userId ä¸è½ä¸ºç©ºæ ¼ã",INVALID_CREATE_STREAM_SOURCE:"createStream() çæ LocalStream å¯ä»¥ä½¿ç¨ audio & video æ audioSource & videoSource åå»ºï¼ä½ä¸è½æ··åä½¿ç¨ã",INVALID_CREATE_STREAM_SCREEN:"screen å video ä¸è½åæ¶ä¸º trueã",INVALID_CREATE_STREAM_AUDIO:"audio å screenAudio ä¸è½åæ¶ä¸º trueã",INVALID_CREATE_STREAM_SCREEN_AUDIO:"screen ä¸º true æ¶ï¼ä¸è½è®¾ç½® screenAudioã",NOT_SUPPORTED_HTTP:"ç±äºæµè§å¨å®å¨ç­ç¥éå¶ï¼ä¸æ¯æå¨ http åè®®ä¸ä½¿ç¨ééãæ¨æµç­è½åï¼è¯·ä½¿ç¨ https åè®®ã",NOT_SUPPORTED_WEBRTC:"å½åæµè§å¨æç¯å¢ä¸å®å¨æ¯æ WebRTC è½åï¼è¯·æ£æ¥æµè§å¨çæ¬åé¡µé¢è®¿é®åè®®æ¯å¦æ»¡è¶³æ¡ä»¶ã",NOT_SUPPORTED_PROFILE:"æ¨çæµè§å¨ä¸æ¯æ setVideoProfile æ¹æ³ãè¯·æ£æ¥æµè§å¨çæ¬æ¯å¦æ»¡è¶³æ¡ä»¶ã",NOT_SUPPORTED_MEDIA:"å½åæµè§å¨æç¯å¢ä¸æ¯æ navigator.mediaDevicesï¼è¯·æ£æ¥æµè§å¨çæ¬åé¡µé¢è®¿é®åè®®æ¯å¦æ»¡è¶³æ¡ä»¶ã",NOT_SUPPORTED_H264ENCODE:"å½åçè®¾å¤æç¯å¢ä¸æ¯æ H264 ç¼ç ï¼ä¸æ¯æ H264 æ ¼å¼è¿è¡æ¨æµã",NOT_SUPPORTED_H264DECODE:"å½åçè®¾å¤æç¯å¢ä¸æ¯æ H264 è§£ç ï¼ä¸æ¯æ H264 æ ¼å¼è¿è¡ææµã",NOT_SUPPORTED_TRACK:e=>"æ¨çæµè§å¨ä¸æ¯æ ".concat(e,"Track æ¹æ³ã"),NOT_SUPPORTED_REPLACE_TRACK:"æ¨çæµè§å¨ä¸æ¯æ replaceTrack æ¹æ³ï¼è¯·ä½¿ç¨ switchDevice æè addTrackã",NOT_SUPPORTED_CAPTURE:"æ¨å½åçæµè§å¨ä¸æ¯æå±å¹åäº«ï¼è¯·æ£æ¥æµè§å¨çæ¬åé¡µé¢è®¿é®åè®®æ¯å¦æ»¡è¶³æ¡ä»¶ã",NOT_SUPPORTED_AUX:"æ¨å½åçæµè§å¨ä¸æ¯ææ¨è¾æµï¼è¯·æ£æ¥æµè§å¨çæ¬æ¯å¦æ»¡è¶³æ¡ä»¶ï¼Chrome 69+, Safari 11+, Firefox 59+ï¼ã",MICROPHONE_NOT_FOUND:"æªæ£æµå°éº¦åé£ï¼è¯·æ£æ¥æ¨çéº¦åé£å TRTC.createStream ä¸çéç½®ã",CAMERA_NOT_FOUND:"æªæ£æµå°æåå¤´ï¼è¯·æ£æ¥æ¨çæåå¤´å TRTC.createStream ä¸çéç½®ã",CATCH_HANDLER_ERROR:e=>{let{name:t,event:i}=e;return" å¨ ".concat(t,".on('").concat(i,"', handler) äºä»¶ä¸­æè·å°ä¸å¡ä¾§éè¯¯ï¼è¯·æ ¹æ®ä¸è¿°éè¯¯ä¿¡æ¯ï¼æ£æ¥æ¨å¨ handler ä¸­çä¸å¡ä»£ç ã")},REPEAT_JOIN:e=>"ç¨æ· [".concat(e,"] æ­£å¨è°ç¨è¿æ¿æ¥å£æèå·²ç»å¨æ¿é´åï¼è¯·å¿éå¤åå»ºç¸å userId ç client è¿å¥åä¸ä¸ªæ¿é´ã"),CLIENT_DESTROYED:e=>{let{funName:t}=e;return"client å·²ç»è¢«éæ¯ï¼è°ç¨ ".concat(t,"() æ¹æ³å¤±è´¥ã")},API_CALL_ABORTED(e){let t;return t=e.message.includes("REMOTE_STREAM_NOT_EXIST")?"ä¸­æ­è®¢éç¨æ· ".concat(e.userId," ç ").concat(e.streamType," stream, åå : å¨æ¨è®¢éè¿ç¨ä¸­ï¼è¿ç«¯ç¨æ· ").concat(e.userId," åæ¶äºæ¨æµï¼æ¨å¯ä»¥å¨ä¸æ¬¡è¿ç«¯æ¨æµæ¶åè¿è¡è®¢éã"):"ä¸­æ­æ¥å£è°ç¨, åå : ".concat(e.message,"ã"),t},SEI_BEFORE_PUBLISH:"å½å client æ²¡ææ¨ localStream(ä¸»æµï¼éå±å¹åäº«æµ)ï¼æ æ³è°ç¨ client.sendSEIMessage() æ¥å£ã"},tP={INVALID_USER_DEFINE_RECORDID:"TRTC.html#createClient",INVALID_PROXY:"Client.html#setProxyServer",INVALID_JOIN:"Client.html#join",INVALID_ROOMID_STRING:"Client.html#join",INVALID_ROOMID_INTEGER:"Client.html#join",INVALID_PUBLISH:"Client.html#publish",INVALID_UNPUBLISH:"Client.html#unpublish",INVALID_AUDIENCE:"Client.html#switchRole",INVALID_INITIALIZE:"Client.html#publish",INVALID_DUPLICATE_PUBLISHING:"Client.html#publish",INVALID_SUBSCRIBE_UNDEFINED:"Client.html#subscribe",INVALID_SUBSCRIBE_LOCAL:"Client.html#subscribe",INVALID_REMOTE_STREAM:"Client.html#subscribe",INVALID_ROLE:"Client.html#switchRole",INVALID_PARAMETER_SWITCH_ROLE:"Client.html#switchRole",INVALID_OPERATION_SWITCH_ROLE:"Client.html#switchRole",CLIENT_BANNED:"module-ClientEvent.html#.CLIENT_BANNED",INVALID_OPERATION_START_PUBLISH_CDN:"Client.html#startPublishCDNStream",INVALID_OPERATION_STOP_PUBLISH_CDN:"Client.html#stopPublishCDNStream",START_MIX_TRANSCODE:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE:"Client.html#stopMixTranscode",INVALID_AUDIO_VOLUME:"Client.html#enableAudioVolumeEvaluation",ENABLE_SMALL_STREAM_PUBLISHED:"Client.html#enableSmallStream",DISABLE_SMALL_STREAM_PUBLISHED:"Client.html#disableSmallStream",NOT_SUPPORTED_SMALL_STREAM:"tutorial-27-advanced-small-stream.html#h2-4",INVALID_SMALL_STREAM_PROFILE:"Client.html#setSmallStreamProfile",REMOTE_NOT_PUBLISH_SMALL_STREAM:"Client.html#setRemoteVideoStreamType",INVALID_SWITCH_DEVICE:"LocalStream.html#switchDevice",INVALID_SWITCH_DEVICE_PUBLISHING:"LocalStream.html#switchDevice",INVALID_REPLACE_TRACK:"LocalStream.html#replaceTrack",INVALID_INITIALIZE_LOCAL_STREAM:"LocalStream.html#replaceTrack",INVALID_ADD_TRACK_REPETITIVE:"LocalStream.html#addTrack",INVALID_ADD_TRACK_REMOVING:"LocalStream.html#addTrack",INVALID_ADD_TRACK_PUBLISHING:"LocalStream.html#addTrack",INVALID_STREAM_INITIALIZED:"LocalStream.html#addTrack",INVALID_ADD_TRACK_NUMBER:"LocalStream.html#addTrack",INVALID_REMOVE_AUDIO_TRACK:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ADDING:"LocalStream.html#removeTrack",INVALID_REMOVE_AUDIO_ON:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHING:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NUMBER:"LocalStream.html#removeTrack",INVALID_REMOVE_TRACK_NOT_PUBLISHED:"LocalStream.html#removeTrack",START_MIX_TRANSCODE_TIMEOUT:"Client.html#startMixTranscode",START_MIX_TRANSCODE_FAILED:"Client.html#startMixTranscode",STOP_MIX_TRANSCODE_FAILED:"Client.html#stopMixTranscode",MIX_TRANSCODE_NOT_STARTED:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_FRAMERATE:"Client.html#startMixTranscode",MIX_PARAMS_VIDEO_GOP:"Client.html#startMixTranscode",MIX_PARAMS_AUDIO_BITRATE:"Client.html#startMixTranscode",MIX_PARAMS_USER_Z_ORDER:"Client.html#startMixTranscode",MIX_PARAMS_NOT_SELF:"Client.html#startMixTranscode",MIX_PARAMS_USER_STREAM:"Client.html#startMixTranscode",INVALID_PLAY:"Stream.html#play",PLAY_FAILED:"Stream.html#play",INVALID_USERID:"TRTC.html#createClient",INVALID_CREATE_STREAM_SOURCE:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN:"TRTC.html#createStream",INVALID_CREATE_STREAM_AUDIO:"TRTC.html#createStream",INVALID_CREATE_STREAM_SCREEN_AUDIO:"TRTC.html#createStream",NOT_SUPPORTED_HTTP:"tutorial-05-info-browser.html#h2-2",NOT_SUPPORTED_WEBRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_TRTC:"tutorial-05-info-browser.html",NOT_SUPPORTED_PROFILE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_MEDIA:"tutorial-05-info-browser.html",NOT_SUPPORTED_H264ENCODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_H264DECODE:"tutorial-23-advanced-support-detection.html",NOT_SUPPORTED_TRACK:"LocalStream.html#addTrack",NOT_SUPPORTED_REPLACE_TRACK:"LocalStream.html#replaceTrack",NOT_SUPPORTED_CAPTURE:"tutorial-05-info-browser.html",MICROPHONE_NOT_FOUND:"TRTC.html#createStream",CAMERA_NOT_FOUND:"TRTC.html#createStream",SUBSCRIBE_FAILED:"Client.html#subscribe",API_CALL_ABORTED(e){let t;return t=e.message.includes("REMOTE_STREAM_NOT_EXIST")?"Client.html#subscribe":"module-ErrorCode.html#.API_CALL_ABORTED",t}};"undefined"!=typeof window&&(window.TRTC_ERROR_INFO=eP,window.TRTC_ERROR_LINK=tP);var iP=(e,t)=>t?"".concat(RD,"/").concat(e,"/").concat(t):"".concat(RD,"/").concat(e,"/index.html"),nP=()=>{if(window.TRTC_ERROR_INFO&&window.TRTC_ERROR_LINK)return{TRTC_ERROR_INFO:window.TRTC_ERROR_INFO,TRTC_ERROR_LINK:window.TRTC_ERROR_LINK};let e=localStorage.getItem(DD);if(e){e=JSON.parse(e);let t=document.createElement("script");t.type="text/javascript",t.text=e.message,document.body.appendChild(t);let i=window.TRTC_ERROR_INFO,n=window.TRTC_ERROR_LINK;return document.body.removeChild(t),{TRTC_ERROR_INFO:i,TRTC_ERROR_LINK:n}}return{}};function rP(e){let{key:t,data:i,link:n,addDocLink:r=!0}=e,o="",s="",a="";lO(ZO[t])?o=ZO[t](i):uO(ZO[t])&&(o=ZO[t]);let{TRTC_ERROR_INFO:c,TRTC_ERROR_LINK:l}=nP();n?a="".concat(n.className,".html#").concat(n.fnName):l&&l[t]&&(lO(l[t])?a=l[t](i):uO(l[t])&&(a=l[t]));let d=o;return rO()&&(c&&c[t]&&(lO(c[t])?s=c[t](i):uO(c[t])&&(s=c[t])),s&&(d=r?"".concat(s,"\nè¯·æ¥çææ¡£: ").concat(iP("zh-cn",a),"\n\n"):"".concat(s,"\n\n"),d+=o)),r&&(d+=" \nRefer to: ".concat(iP("en",a),"\n")),d}var oP={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isWebCodecsSupported:!1,isMediaDevicesSupported:!1,isScreenShareSupported:!1,isSmallStreamSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}},sP=new Map([[Jb,["Firefox",Kb]],[Qb,["Edg",Xb]],[Hk,["Chrome",Wk]],[Jk,["Safari",Yk]],[nk,["TBS",rk]],[ok,["XWEB",sk]],[dk&&xb,["WeChat",uk]],[mk,["QQ(Win)",fk]],[pk,["QQ(Mobile)",_k]],[hk,["QQ(Mobile X5)",_k]],[gk,["QQ(Mac)",Tk]],[Ek,["QQ(iPad)",Ik]],[kk,["MI",Dk]],[Nk,["HW",Pk]],[Lk,["Samsung",wk]],[Mk,["OPPO",Vk]],[Uk,["VIVO",xk]],[zb,["EDGE",qb]],[$b,["SogouMobile",ek]],[tk,["Sogou",ik]]]);function aP(){let e=sP.get(!0);return{browserName:e?e[0]:"unknown",browserVersion:e?e[1]:"unknown"}}var cP=function(){return!(Ck||zb||Qb&&Zb<80||Jb&&Yb<56)},lP=function(){return["VideoDecoder","VideoEncoder","AudioEncoder","AudioDecoder","MediaStreamTrackGenerator"].every((e=>e in window))},dP=function(){if(!navigator.mediaDevices)return hP()||YO.error(ZO.NOT_SUPPORTED_MEDIA),!1;let e=["getUserMedia","enumerateDevices"];return e.filter((e=>e in navigator.mediaDevices)).length===e.length},uP=!1;function hP(){return"http:"===location.protocol&&!eD&&(uP||YO.error(rP({key:XO.NOT_SUPPORTED_HTTP})),uP=!0,!0)}var pP=function(){return(null==window?void 0:window.OffscreenCanvas)&&(null==window?void 0:window.MediaStreamTrackProcessor)&&(null==window?void 0:window.MediaStreamTrackGenerator)},_P=function(){return _b(this,null,(function*(){if(oP.detail.isH264EncodeSupported||oP.detail.isVp8EncodeSupported)return{isH264EncodeSupported:oP.detail.isH264EncodeSupported,isVp8EncodeSupported:oP.detail.isVp8EncodeSupported};let e,t=!1,i=!1;try{let n=new RTCPeerConnection,r=document.createElement(HD.CANVAS);r.getContext("2d");let o=r.captureStream(0);return n.addTrack(o.getVideoTracks()[0],o),e=yield n.createOffer(),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),n.close(),oP.detail.isH264EncodeSupported=t,oP.detail.isVp8EncodeSupported=i,{isH264EncodeSupported:oP.detail.isH264EncodeSupported,isVp8EncodeSupported:oP.detail.isVp8EncodeSupported}}catch(pN){return{isH264EncodeSupported:!1,isVp8EncodeSupported:!1}}}))},mP=function(){return _b(this,null,(function*(){if(oP.detail.isH264DecodeSupported&&oP.detail.isVp8DecodeSupported)return{isH264DecodeSupported:oP.detail.isH264DecodeSupported,isVp8DecodeSupported:oP.detail.isVp8DecodeSupported};let e,t=!1,i=!1;try{let n=new RTCPeerConnection;return e=yield n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),-1!==e.sdp.toLowerCase().indexOf("h264")&&(t=!0),-1!==e.sdp.toLowerCase().indexOf("vp8")&&(i=!0),n.close(),{isH264DecodeSupported:t,isVp8DecodeSupported:i}}catch(pN){return{isH264DecodeSupported:!1,isVp8DecodeSupported:!1}}}))},fP=function(){return _b(this,null,(function*(){if(oP.result)return oP;let e=cP(),t=xP(),i=lP(),n=dP(),{isH264EncodeSupported:r,isVp8EncodeSupported:o}=yield _P(),{isH264DecodeSupported:s,isVp8DecodeSupported:a}=yield mP();return oP.result=e&&t&&n&&(r||o)&&(s||a),oP.detail.isBrowserSupported=e,oP.detail.isWebRTCSupported=t,oP.detail.isWebCodecsSupported=i,oP.detail.isMediaDevicesSupported=n,oP.detail.isScreenShareSupported=TP(),oP.detail.isSmallStreamSupported=RP(),oP.detail.isH264EncodeSupported=r,oP.detail.isVp8EncodeSupported=o,oP.detail.isH264DecodeSupported=s,oP.detail.isVp8DecodeSupported=a,oP.result||YO.error("".concat(navigator.userAgent," ").concat(xO(oP.detail,!1))),oP}))},gP=function(){return oP.result},TP=function(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)},EP=(e,t,i)=>{"http:"===location.protocol&&!eD&&(e[t]=()=>{throw new vb({code:Ab.INVALID_OPERATION,message:ZO.NOT_SUPPORTED_HTTP})})},IP=function(e){return!("candidate-pair"!==e.type||!e.nominated||"in-progress"!==e.state&&"succeeded"!==e.state)&&!(pO(e.selected)&&!e.selected)};function SP(){let e="";if(screen.width){let t=screen.width?screen.width*window.devicePixelRatio:"",i=screen.height?screen.height*window.devicePixelRatio:"";e+="".concat(t," * ").concat(i)}return e}function AP(){return navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia}function yP(){let e={isSupported:!1},t=["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"];for(let i=0;i<t.length;i++)if(t[i]in window){e.isSupported=!0;break}return e.isSupported}function vP(){return"captureStream"in HTMLCanvasElement.prototype}function RP(){return!(dk||Bb||Gk&&Gk<63)&&!(!cP()||!vP())}var CP=function(){if(dO(window.RTCRtpTransceiver)||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let e=null,t=!1;try{e=new RTCPeerConnection({sdpSemantics:EN}),e.addTransceiver(HD.AUDIO),t=!0}catch(pD){}return null==e||e.close(),t};function bP(){return"RTCPeerConnection"in window&&"getReceivers"in window.RTCPeerConnection.prototype}function kP(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}function DP(){return"RTCPeerConnection"in window&&"getTransceivers"in window.RTCPeerConnection.prototype}function NP(){return 11!==Qk&&("RTCPeerConnection"in window&&"addTransceiver"in window.RTCPeerConnection.prototype)}var OP=NP();function PP(){return"RTCRtpTransceiver"in window&&"stop"in window.RTCRtpTransceiver.prototype}function LP(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}function wP(){return"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype&&kP()}var MP=window.MediaStreamTrack&&"getSettings"in MediaStreamTrack.prototype,VP=window.MediaStreamTrack&&"getCapabilities"in MediaStreamTrack.prototype,UP="RTCRtpSender"in window&&"createEncodedStreams"in window.RTCRtpSender.prototype&&Fk()>=86,xP=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((e=>e in window)).length>0};function FP(){let e={AudioDecoder:!1,AudioEncoder:!1,VideoDecoder:!1,VideoEncoder:!1,ImageDecoder:!1};return dO(window.AudioDecoder)||(e.AudioDecoder=!0),dO(window.AudioEncoder)||(e.AudioEncoder=!0),dO(window.VideoDecoder)||(e.VideoDecoder=!0),dO(window.VideoEncoder)||(e.VideoEncoder=!0),dO(window.ImageDecoder)||(e.ImageDecoder=!0),e}function BP(){return"mediaSession"in navigator&&!dO(navigator.mediaSession.setActionHandler)}function HP(){return!dO(window.WebTransport)}function jP(){let e={browser:"".concat(iD.name,"/").concat(iD.version),os:aD(),displayResolution:SP(),isScreenShareSupported:TP(),isWebRTCSupported:xP(),isGetUserMediaSupported:AP(),isWebAudioSupported:yP(),isWebSocketsSupported:"WebSocket"in window&&2===window.WebSocket.CLOSING,isWebCodecSupported:FP(),isMediaSessionSupported:BP(),isWebTransportSupported:HP()};return navigator.userAgent.includes("miniProgram")&&(e.browser="mini/".concat(e.browser)),e}var GP=db(mb(),1),WP=Symbol("instance"),JP=Symbol("cacheResult"),KP=class{constructor(e,t,i){this.oldState=e,this.newState=t,this.action=i,this.aborted=!1}abort(e){this.aborted=!0,XP.call(e,this.oldState,new Error("action '".concat(this.action,"' aborted")))}toString(){return"".concat(this.action,"ing")}},YP=class extends Error{constructor(e,t,i){super(t),this.state=e,this.message=t,this.cause=i}};var zP=new Map;function qP(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return(n,r,o)=>{let s=i.action||r;if(!i.context){let i=zP.get(n)||[];zP.has(n)||zP.set(n,i),i.push({from:e,to:t,action:s})}let a=o.value;o.value=function(){let n=this;for(var r=arguments.length,o=new Array(r),c=0;c<r;c++)o[c]=arguments[c];if(i.context&&(n=ZP.get("function"==typeof i.context?i.context.call(this,...o):i.context)),n.state===t)return n[JP];n.state instanceof KP&&n.state.action==i.abortAction&&n.state.abort(n);let l=null;if(Array.isArray(e)?0==e.length?n.state instanceof KP&&n.state.abort(n):("string"!=typeof n.state||!e.includes(n.state))&&(l=new YP(n._state,"".concat(n.name," ").concat(s," to ").concat(t," failed: current state ").concat(n._state," not in from config"))):e!==n.state&&(l=new YP(n._state,"".concat(n.name," ").concat(s," to ").concat(t," failed: current state ").concat(n._state," not from ").concat(e))),l){if(!i.fail){if(i.ignoreError)return l;throw l}i.fail.call(this,l)}let d=n.state,u=new KP(d,t,s);XP.call(n,u);let h=e=>{var r;return n[JP]=e,u.aborted||(XP.call(n,t),null===(r=i.success)||void 0===r||r.call(this,n[JP])),e},p=e=>{let t=e instanceof Error?e.message:String(e);if(XP.call(n,d,e),!i.fail){if(i.ignoreError)return e;throw e}i.fail.call(this,new YP(n._state,"action '".concat(s,"' failed :").concat(t),e instanceof Error?e:new Error(t)))};try{let e=a.apply(this,o);return function(e){return"object"==typeof e&&e&&"then"in e}(e)?e.then(h).catch(p):h(e)}catch(_){p(_)}}}}var QP="undefined"!=typeof window&&window.__AFSM__?(e,t)=>{window.dispatchEvent(new CustomEvent(e,{detail:t}))}:"undefined"!=typeof importScripts?(e,t)=>{postMessage({type:e,payload:t})}:()=>{};function XP(e,t){let i=this._state;this._state=e;let n=e.toString();e&&this.emit(n,i),this.emit(ZP.STATECHANGED,e,i,t),this.updateDevTools({value:e,old:i,err:t instanceof Error?t.message:String(t)})}var ZP=class extends GP.default{constructor(e,t,i){super(),this.name=e,this.groupName=t,this._state=ZP.INIT,e||(e=Date.now().toString(36)),i?Object.setPrototypeOf(this,i):i=Object.getPrototypeOf(this),t||(this.groupName=this.constructor.name);let n=i[WP];n?this.name=n.name+"-"+n.count++:i[WP]={name:this.name,count:0},this.updateDevTools({diagram:this.stateDiagram})}get stateDiagram(){let e=Object.getPrototypeOf(this),t=zP.get(e)||[],i=new Set,n=[],r=[],o=new Set,s=Object.getPrototypeOf(e);zP.has(s)&&(s.stateDiagram.forEach((e=>i.add(e))),s.allStates.forEach((e=>o.add(e)))),t.forEach((e=>{let{from:t,to:i,action:o}=e;"string"==typeof t?n.push({from:t,to:i,action:o}):t.length?t.forEach((e=>{n.push({from:e,to:i,action:o})})):r.push({to:i,action:o})})),n.forEach((e=>{let{from:t,to:n,action:r}=e;o.add(t),o.add(n),o.add(r+"ing"),i.add("".concat(t," --\x3e ").concat(r,"ing : ").concat(r)),i.add("".concat(r,"ing --\x3e ").concat(n," : ").concat(r," ð¢")),i.add("".concat(r,"ing --\x3e ").concat(t," : ").concat(r," ð´"))})),r.forEach((e=>{let{to:t,action:n}=e;i.add("".concat(n,"ing --\x3e ").concat(t," : ").concat(n," ð¢")),o.forEach((e=>{e!==t&&i.add("".concat(e," --\x3e ").concat(n,"ing : ").concat(n))}))}));let a=[...i];return Object.defineProperties(e,{stateDiagram:{value:a},allStates:{value:o}}),a}static get(e){let t;return"string"==typeof e?(t=ZP.instances.get(e),t||ZP.instances.set(e,t=new ZP(e,void 0,Object.create(ZP.prototype)))):(t=ZP.instances2.get(e),t||ZP.instances2.set(e,t=new ZP(e.constructor.name,void 0,Object.create(ZP.prototype)))),t}static getState(e){var t;return null===(t=ZP.get(e))||void 0===t?void 0:t.state}updateDevTools(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};QP(ZP.UPDATEAFSM,Object.assign({name:this.name,group:this.groupName},e))}get state(){return this._state}set state(e){XP.call(this,e)}};ZP.STATECHANGED="stateChanged",ZP.UPDATEAFSM="updateAFSM",ZP.INIT="[*]",ZP.ON="on",ZP.OFF="off",ZP.instances=new Map,ZP.instances2=new WeakMap;var $P=(null==window?void 0:window.requestIdleCallback)||function(e){let t=Date.now();return setTimeout((()=>{e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),1e3)},eL=(null==window?void 0:window.cancelIdleCallback)||function(e){clearTimeout(e)},tL=(null==window?void 0:window.cancelAnimationFrame)||(null==window?void 0:window.mozCancelAnimationFrame),iL=class{static generateTaskID(){return this.currentTaskID++}static run(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:jN,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;i=sb(e===HN?{delay:2e3,count:0,backgroundTask:!0}:e===FN?{delay:1e4,count:0}:e===BN?{fps:60,delay:16.6,count:0,backgroundTask:!0}:{delay:2e3,count:0,backgroundTask:!0},i),_O(t)&&(i=sb(sb({},i),t)),lO(e)&&(t=e,e=jN);let n=sb({taskID:this.generateTaskID(),loopCount:0,intervalID:null,timeoutID:null,rafID:null,ricID:null,taskName:e,callback:t},i);return this.taskMap.set(n.taskID,n),this[e](n),n.taskID}static interval(e){return e.intervalID=setInterval((()=>{e.callback(),e.loopCount+=1,this.isBreakLoop(e)}),e.delay)}static timeout(e){let t=()=>{if(e.callback(),e.loopCount+=1,!this.isBreakLoop(e))return e.timeoutID=setTimeout(t,e.delay)};return e.timeoutID=setTimeout(t,e.delay)}static ric(e){let t,i=yO(),n=()=>{if(t=yO()-i,t>=e.delay&&(i=yO()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),!this.isBreakLoop(e))return e.ricID=$P(n,{timeout:e.delay})};return e.ricID=$P(n,{timeout:e.delay})}static raf(e){e.delay=(1e3/e.fps).toFixed(2);let t,i=yO(),n=()=>document.hidden&&e.backgroundTask?(t=yO()-i,i=yO(),e.callback(),e.loopCount+=1,this.isBreakLoop(e)?void 0:e.timeoutID=setTimeout(n,e.delay-Math.floor(t%e.delay))):(t=yO()-i,t>=e.delay&&(i=yO()-Math.floor(t%e.delay),e.callback(),e.loopCount+=1),this.isBreakLoop(e)?void 0:e.rafID=requestAnimationFrame(n));if(e.rafID=requestAnimationFrame(n),e.backgroundTask){let t=()=>{if(document.hidden){let t=yO()-i;t>=e.delay?n():e.timeoutID=setTimeout(n,e.delay-t)}};document.addEventListener("visibilitychange",t),e.onVisibilitychange=t,document.hidden&&t()}return e.taskID}static hasTask(e){return this.taskMap.has(e)}static clearTask(e){if(!this.taskMap.has(e))return!0;let{intervalID:t,timeoutID:i,rafID:n,ricID:r,onVisibilitychange:o}=this.taskMap.get(e);return t&&clearInterval(t),i&&clearTimeout(i),n&&tL(n),r&&eL(r),o&&document.removeEventListener("visibilitychange",o),this.taskMap.delete(e),!0}static isBreakLoop(e){return!this.taskMap.has(e.taskID)||0!==e.count&&e.loopCount>=e.count&&(this.clearTask(e.taskID),!0)}};iL.taskMap=new Map,iL.currentTaskID=1;var nL=iL,rL="connection-state-changed";HD.SEI_MESSAGE;HD.SEI_MESSAGE;var oL={LOADED_DATA:HD.LOADEDDATA,MEDIA_TRACK_CHANGED:"media-track-changed",PLAYER_STATE_CHANGED:"player-state-changed"},sL=new class{constructor(){this._roomIdMap=new Map,"undefined"==typeof registerProcessor&&(this._configs={sdkAppId:"",userId:"",version:uD,env:OD.QCLOUD,browserVersion:iD.name+iD.version,ua:navigator.userAgent})}setConfig(e){let{sdkAppId:t,env:i,userId:n,roomId:r}=e;t!==this._configs.sdkAppId&&(this._configs.sdkAppId=String(t)),this._configs.env=i,this._configs.userId=n,this._roomIdMap.set(n,String(r))}logSuccessEvent(e){eD||!YO.isAbleToUpload||this._configs.env===OD.QCLOUD&&this.uploadEventToKibana(ab(sb({},e),{result:"success"}))}logFailedEvent(e){if(eD||!YO.isAbleToUpload)return;let{eventType:t,code:i,error:n,userId:r}=e,o={roomId:this._roomIdMap.get(r||this._configs.userId),userId:r,eventType:t,result:"failed",code:i||(null==n?void 0:n.extraCode)||(null==n?void 0:n.code)||Ab.UNKNOWN};this._configs.env===OD.QCLOUD&&this.uploadEventToKibana(ab(sb({},o),{error:n}))}uploadEventToKibana(e){let t="stat-".concat(e.eventType,"-").concat(e.result);("delta-join"===e.eventType||"delta-leave"===e.eventType||"delta-publish"===e.eventType)&&(t="".concat(e.eventType,":").concat(e.delta)),this.uploadEvent({log:t,userId:e.userId}),"failed"===e.result&&(t="stat-".concat(e.eventType,"-").concat(e.result,"-").concat(e.code),this.uploadEvent({log:t,userId:e.userId,error:e.error}))}uploadEvent(e){let{log:t,userId:i,error:n}=e,r={timestamp:bb(),sdkAppId:this._configs.sdkAppId,userId:i||this._configs.userId,version:uD,log:t};n&&(r.errorInfo=n.message),this.sendRequest(YN(this._configs.sdkAppId,ND.LOG),r)}sendRequest(e,t){YO.isAbleToUpload?FO({url:e,body:JSON.stringify(t)}).catch((()=>{})):setTimeout((()=>{this.sendRequest(e,t)}),1e3)}},aL="trtc_autoplay",cL="".concat(aL,"_mask"),lL="".concat(aL,"_wrapper"),dL="".concat(aL,"_header"),uL="".concat(aL,"_content"),hL="".concat(aL,"_action_wrapper"),pL="".concat(aL,"_question"),_L="".concat(aL,"_collapse"),mL="".concat(aL,"_action_confirm"),fL="".concat(aL,"_detail"),gL="#2473E8",TL="dialog",EL="".concat(TL,"-show"),IL="".concat(TL,"-1"),SL="".concat(TL,"-2"),AL=!1,yL=()=>!!document.querySelector(".".concat(lL)),vL="".concat(RD,"/").concat(rO()?"zh-cn":"en","/tutorial-21-advanced-auto-play-policy.html"),RL="<br><a href='".concat(vL,"' target='_blank'>").concat(rO()?"å¶ä»æ¹æ¡ï¼":"Any other solution?","</a>"),CL="".concat(rO()?"æµè§å¨èªå¨æ­æ¾ç­ç¥ï¼å¨ç¨æ·ä¸é¡µé¢äº§çäº¤äºï¼ç¹å»ãè§¦æ¸ï¼ä¹åï¼æµè§å¨ç¦æ­¢æ­æ¾æå£°åªä½ãè¯¥å¼¹çªç¨äºå¸®å©ç¨æ·æ¢å¤é³è§é¢æ­æ¾ã".concat(RL):"Autoplay Policy: Before user interacts with the web page (clicking, touching), page will not be allowed to play media with sound. This Dialog is used to help users resume playback. ".concat(RL)),bL=class{constructor(){if(hb(this,"content","é³è§é¢æ­æ¾è¢«æµè§å¨æ¦æªï¼è¯·ç¹å»âæ¢å¤æ­æ¾âã"),hb(this,"_dialogNode",null),hb(this,"_bodyPosition",""),hb(this,"_showDetail",!1),hb(this,"_isCollapseClicked",!1),hb(this,"_isQuestionClicked",!1),rO()||(this.content='Media playback failed. Click the "Resume" to resume playback.'),!AL){let e=document.createElement("style");e.innerHTML=".".concat(cL,"{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);z-index:1500;}.").concat(cL," div:not(.").concat(hL,"){display:block !important;}.").concat(lL,"{padding:14px;background:#fff;border-radius:3px;box-shadow:0px 3px 15px #434343;border:1px solid #d1cfcf;max-width:500px;}.").concat(lL," a{color:").concat(gL,";}.").concat(dL,"{overflow:hidden;text-overflow:ellipsis;font-size:16px;font-weight:600;}.").concat(uL,"{margin:8px 0;}.").concat(hL,"{width:100%;display:flex !important;align-items:center;justify-content:right;float:right;}.").concat(_L,"{margin-right:auto;cursor:pointer}.").concat(pL,"{height:100%;line-height:16px;cursor:pointer;}.").concat(mL,"{margin-left:8px;color:#fff;background:").concat(gL,";padding:4px 12px;outline:none;border:1px solid;border-radius:3px;font-weight:bold;}.").concat(mL,":hover{opacity:0.9;}.").concat(_L,",.").concat(mL,",.").concat(uL,",.").concat(pL,"{font-size:14px;}@media screen and (max-width:750px){.").concat(lL,"{width:80vw;}}"),document.head.appendChild(e),AL=!0}this.addDiaLog()}createDiaLog(){let e=document.createElement("template");e.innerHTML='<div class="'.concat(cL,"\"><div class='").concat(lL,"'><div class='").concat(dL,"'>").concat(location.host,"</div><div class='").concat(uL,"'>").concat(this.content,"</div><div class='").concat(fL,'\' style="visibility:hidden;width:100%;height:0;font-size:12px;color:gray;">').concat(CL,"</div><div class='").concat(hL,"'></div></div></div>").trim();let t=document.createElement("button");t.className=mL,t.innerText=rO()?"æ¢å¤æ­æ¾":"Resume",t.onclick=this.onConfirm.bind(this);let i=document.createElement("div");i.className=pL,i.innerHTML='<?xml version="1.0" encoding="UTF-8"?>\n    <svg class="icon" width="18" height="18" p-id="2030" t="1639646523624" version="1.1" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">\n    <path d="m464 784.35c0 26.51 21.49 48 48 48s48-21.49 48-48-21.49-48-48-48-48 21.49-48 48z" p-id="2031"/>\n    <path d="m512 960c-247.04 0-448-200.96-448-448s200.96-448 448-448 448 200.96 448 448-200.96 448-448 448zm0-831.71c-211.58 0-383.71 172.13-383.71 383.71 0 211.55 172.13 383.71 383.71 383.71 211.55 0 383.71-172.16 383.71-383.71 0-211.58-172.16-383.71-383.71-383.71z" p-id="2032"/>\n    <path d="m512 673.7c-17.665 0-32.001-14.336-32.001-31.999v-54.112c0-52.353 40-92.352 75.328-127.65 25.887-25.92 52.672-52.672 52.672-74.017 0-53.343-43.072-96.735-95.999-96.735-53.823 0-95.999 41.536-95.999 94.559 0 17.665-14.336 31.999-32.001 31.999s-32.001-14.336-32.001-31.999c0-87.424 71.775-158.56 160-158.56s160 72.095 160 160.74c0 47.904-36.32 84.192-71.424 119.3-27.84 27.776-56.576 56.512-56.576 82.336v54.112c0 17.665-14.336 32.032-32.001 32.032z" p-id="2033"/>\n    </svg>\n    ',i.onclick=this.onQuestionClick.bind(this);let n=document.createElement("div");n.className=_L,n.innerText="".concat(rO()?"è¯¦æ >":"Detail >"),n.onclick=this.onCollapseClick.bind(this);let r=e.content.firstChild,o=r.querySelector(".".concat(hL));return o.appendChild(n),o.appendChild(i),o.appendChild(t),r}addDiaLog(){yL()||(this._dialogNode=this.createDiaLog(),document.body.appendChild(this._dialogNode),this._dialogNode.onclick=this.onConfirm.bind(this),this._dialogNode.querySelector(".".concat(lL)).onclick=e=>e.stopPropagation(),this._bodyPosition=document.body.style.position,document.body.style.position="fixed",YO.info("show autoplay dialog"),sL.uploadEvent({log:EL}))}deleteDiaLog(){this._dialogNode&&(document.body.removeChild(this._dialogNode),document.body.style.position=this._bodyPosition,this._dialogNode=null)}onConfirm(){YO.warn("confirm clicked, try resume stream"),GO.emit(JO.AUTOPLAY_DIALOG_CLICK_CONFIRM),this.deleteDiaLog()}onCollapseClick(){let e=this._dialogNode.querySelector(".".concat(fL));e.style.visibility="".concat(this._showDetail?"hidden":"visible"),e.style.height="".concat(this._showDetail?0:"fit-content"),this._showDetail=!this._showDetail,this._isCollapseClicked||sL.uploadEvent({log:IL}),this._isCollapseClicked=!0}onQuestionClick(){window.open(vL,"_blank"),this._isQuestionClicked||sL.uploadEvent({log:SL}),this._isQuestionClicked=!0}},kL={};lb(kL,{create:()=>NL,remove:()=>OL});var DL=new WeakMap;function NL(e,t){DL.has(e)||DL.set(e,[]);let i=DL.get(e),n={add:(e,r)=>("addEventListener"in t?(i.push(t.removeEventListener.bind(t,e,r)),t.addEventListener(e,r)):(i.push(t.off.bind(t,e,r)),t.on(e,r)),n)};return n}function OL(e){let t=DL.get(e);t&&(t.forEach((e=>e())),DL.delete(e))}var PL=class extends ZP{constructor(e,t){super(e.id,"".concat(t,"-player")),this.kind=t,hb(this,"id"),hb(this,"element",null),hb(this,"container",null),hb(this,"mediaStream",new MediaStream),hb(this,"track"),hb(this,"url"),hb(this,"attr"),hb(this,"muted"),hb(this,"_log"),hb(this,"_pausedRetryCount"),hb(this,"_isElementPlayingFired",!1),hb(this,"_interval"),this.id=e.id,this._log=e.log,this.track=e.track,this.container=e.container,this.muted=e.muted,this._pausedRetryCount=ON,this._state="STOPPED",this.bindTrackEvents()}get isPlaying(){return"PLAYING"===this._state}get isStopped(){return"STOPPED"===this._state}setAttr(e){this.attr=e}setTrack(e){if(e!==this.track&&(this.unbindTrackEvents(),this.track=e,this.emit(oL.MEDIA_TRACK_CHANGED,e),null!==e&&(this.bindTrackEvents(),this.element))){let t=new MediaStream;t.addTrack(e),this.element.srcObject=t}}setUrl(e){this.track&&(this.unbindTrackEvents(),this.element&&(this.element.srcObject=null),this.track=null),e!==this.url&&(this.url=e,null!==e&&this.element&&(this.element.crossOrigin="anonymous",this.element.src=e))}setContainer(e){this.container=e,this.track&&this.element&&this.container&&this.container.appendChild(this.element)}play(){return _b(this,null,(function*(){if(this.element&&this.element.parentElement!==this.container&&this.container&&this.container.append(this.element),!this.isPlaying)try{this.bindAutoPlayEvent(),yield this.element.play()}catch(pD){let t=rP({key:XO.PLAY_FAILED,data:{media:this.kind,error:pD}});if(this.track&&!this.track.muted&&this._log.warn(pD),t.includes("NotAllowedError"))throw new vb({code:Ab.PLAY_NOT_ALLOWED,message:t})}}))}stop(){this.unbindEvents(),this._isElementPlayingFired=!1,this.element&&(this.container&&this.container.removeChild(this.element),this.element.srcObject=null,this.element=null),this.handleStopped(HD.ENDED),this._interval>0&&nL.clearTask(this._interval)}pause(){var e;this.isPlaying&&(null==(e=this.element)||e.pause())}resume(){return this.isPlaying?Promise.resolve():Zk?this.replay():this.play().catch((()=>{}))}setMuted(e){this.element&&(this.element.muted=e),this.muted=e}setRect(e,t){this.element&&(this.element.style.width="".concat(e,"px"),this.element.style.height="".concat(t,"px"))}replay(){return this.stop(),this.play().catch((()=>{}))}bindElementEvents(){if(this.element){let e=this.handleElementEvent.bind(this);NL(this.element,this.element).add(HD.PLAYING,e).add(HD.ENDED,e).add(HD.PAUSE,e).add(HD.ERROR,e).add(HD.LOADEDDATA,e)}}bindTrackEvents(){if(this.track){let e=this.handleTrackEvent.bind(this);null==kL||kL.create(this.track,this.track).add(HD.ENDED,e).add(HD.MUTE,e).add(HD.UNMUTE,e),this.track.readyState===HD.ENDED&&this.handleTrackEvent({type:HD.ENDED}),this.track.muted&&this.handleTrackEvent({type:HD.MUTE})}}bindAutoPlayEvent(){GO.on(JO.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}unbindTrackEvents(){this.track&&OL(this.track)}unbindEvents(){this.element&&OL(this.element),this.unbindTrackEvents(),GO.off(JO.AUTOPLAY_DIALOG_CLICK_CONFIRM,this.resume,this)}handleElementEvent(e){var t;switch(e.type){case HD.PLAYING:this._isElementPlayingFired=!0,this._log.info("".concat(this.kind," player is playing")),this.handlePlaying(HD.PLAYING),this._interval&&(nL.clearTask(this._interval),this._interval=-1);break;case HD.ENDED:this._log.info("".concat(this.kind," player is ended")),this.handleStopped(HD.ENDED);break;case HD.PAUSE:this._log.info("".concat(this.kind," player is paused")),this.handlePaused(HD.PAUSE);let e=this.container&&document.getElementById(this.container.id);e||this._log.warn("".concat(this.kind," player has been remove, element ID: ").concat(null==(t=this.container)?void 0:t.id));let i=Fk();this._pausedRetryCount>0&&(this.kind===HD.VIDEO&&!yL()||this.kind===HD.AUDIO&&(hO(i)&&i<=70||!e))&&(this._log.info("".concat(this.kind," player auto resume when paused")),this.resume(),this._pausedRetryCount--),Bb&&(this._interval=nL.run(jN,(()=>{this.element&&"PAUSED"===this._state&&this.resume()}),{delay:3e3}));break;case HD.ERROR:if(this.element&&this.element.error){let{code:e,message:t}=this.element.error;this._log.error("".concat(this.kind," player error observed. code: ").concat(e," message: ").concat(t," userAgent: ").concat(navigator.userAgent)),sL.uploadEvent({log:"stat-".concat(this.kind,"-").concat(mN.PLAYER_ERROR,"-").concat(e,"-").concat(navigator.userAgent),error:this.element.error})}break;case HD.LOADEDDATA:this.kind===HD.VIDEO&&this.emit(oL.LOADED_DATA)}}handleTrackEvent(e){switch(e.type){case HD.ENDED:this._log.info("".concat(this.kind," track is ended")),this.handleStopped(HD.ENDED);break;case HD.MUTE:this._log.info("".concat(this.kind," track is unable to provide media output")),this.handlePaused(HD.MUTE);break;case HD.UNMUTE:this._log.info("".concat(this.kind," track is able to provide media output")),this._isElementPlayingFired&&this.handlePlaying(HD.UNMUTE)}}handlePlaying(e){this.emit(oL.PLAYER_STATE_CHANGED,{type:this.kind,state:"PLAYING",reason:e})}handlePaused(e){this.emit(oL.PLAYER_STATE_CHANGED,{type:this.kind,state:"PAUSED",reason:e})}handleStopped(e){this.emit(oL.PLAYER_STATE_CHANGED,{type:this.kind,state:"STOPPED",reason:e})}getElement(){return this.element}};ub([qP([],"PLAYING")],PL.prototype,"handlePlaying",1),ub([qP("PLAYING","PAUSED",{ignoreError:!0})],PL.prototype,"handlePaused",1),ub([qP([],"STOPPED")],PL.prototype,"handleStopped",1);var LL=class extends PL{constructor(e){super(e,HD.VIDEO),hb(this,"mirror"),hb(this,"objectFit"),dO(e.mirror)||(this.mirror=e.mirror),dO(e.objectFit)||(this.objectFit=e.objectFit)}initializeElement(){var e;let t=document.createElement(HD.VIDEO);if(this.track){let e=new MediaStream;e.addTrack(this.track),t.srcObject=e}t.muted=!0;let i="width: 100%; height: 100%; object-fit: ".concat(this.objectFit,";background-color: black;");this.mirror&&(i+="transform: scaleX(-1);"),t.setAttribute("id","video_".concat(this.id)),t.setAttribute("style",i),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),null==(e=this.container)||e.appendChild(t),this.element=t,this.bindElementEvents()}setAttr(e){let t=Object.assign({autoplay:"autoplay",playsinline:"playsinline",muted:!0},e);t.style=Object.assign({width:"100%",height:"100%"},t.style),super.setAttr(t)}setMirror(e){this.element&&(this.element.style.transform=e?"scaleX(-1)":""),this.mirror=e}setObjectFit(e){this.element&&(this.element.style.objectFit="".concat(e)),this.objectFit=e}play(){return this.element||this.initializeElement(),super.play()}getVideoFrame(){if(!this.element)return"";let e=document.createElement("canvas");return e.width=this.element.videoWidth,e.height=this.element.videoHeight,e.getContext("2d").drawImage(this.element,0,0),e.toDataURL("image/png")}getElement(){return this.element}},wL=!1,ML=class{constructor(e){hb(this,"context_"),hb(this,"blob_"),this.context_=e.context,this.blob_=new Blob(["class VolumeMeter extends AudioWorkletProcessor{constructor(){super();this.volume=0;this.intervalTime=200;this.tick=this.intervalTime;this.isStop=false;this.port.onmessage=event=>{const{data}=event;switch(data.name){case'setIntervalTime':this.intervalTime=data.intervalTime;break;case'stop':this.isStop=true;break}}}process(inputs){const input=inputs[0];if(this.isStop){return false}if(input.length>0){const firstChannel=input[0];let sum=0;let rms;for(let i=0;i<firstChannel.length;++i){sum+=firstChannel[i]*firstChannel[i]}rms=Math.sqrt(sum/firstChannel.length);this.volume=rms;this.tick-=firstChannel.length;if(this.tick<0){this.tick+=(this.intervalTime/1000)*sampleRate;this.port.postMessage({volume:this.volume})}}return true}}registerProcessor('volume-meter',VolumeMeter);"],{type:"application/javascript"}),this.addModuleToContext()}addModuleToContext(){return _b(this,null,(function*(){try{yield this.context_.audioWorklet.addModule(URL.createObjectURL(this.blob_)),YO.info("worklet addModule success"),GO.emit(JO.WORKLET_LOADED_SUCCESS),wL=!0}catch(Xw){YO.info("worklet addModule catch error. ".concat(Xw.message)),GO.emit(JO.WORKLET_LOADED_FAILED)}}))}get initWorkletSuccess(){return wL}};"undefined"!=typeof window&&(window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext);var VL,UL,xL=0,FL=()=>{let e=new window.AudioContext;xL+=1;let t=()=>{"suspended"===e.state?(e.resume(),document.addEventListener("click",t)):"interrupted"===e.state?e.resume():document.removeEventListener("click",t)};document.addEventListener("click",t);let i=xL;return e.onstatechange=()=>{YO.info("audioContext[".concat(i,"] state: ").concat(e.state)),t()},e},BL=0,HL=class{constructor(e){hb(this,"_volume"),hb(this,"_log"),hb(this,"_track"),hb(this,"_stream"),hb(this,"_audioCtx"),hb(this,"_destination"),hb(this,"_streamSource"),hb(this,"_scriptProcessorNode"),hb(this,"_audioWorkletNode"),hb(this,"_interval");let{track:t,log:i}=e;this._volume=0,this._log=i,this._track=t,VL||(VL=FL()),this._audioCtx=VL,this._destination=this._audioCtx.destination;let n=new MediaStream;n.addTrack(this._track),this._streamSource=this._audioCtx.createMediaStreamSource(n),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._interval=200,GO.on(JO.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),SO?(GO.on(JO.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),GO.on(JO.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),this.preload()):this.initScriptProcessor(),BL+=1}preload(){UL?UL.initWorkletSuccess&&this.initAudioWorklet():UL=new ML({context:VL})}initAudioWorklet(){if(!this._audioWorkletNode)try{this._audioWorkletNode=new AudioWorkletNode(this._audioCtx,"volume-meter"),this._audioWorkletNode.port.onmessage=e=>{this._volume=e.data.volume||0},this._streamSource.connect(this._audioWorkletNode).connect(this._destination),this.handleAudioLevelInterval({interval:this._interval})}catch(Xw){sL.logFailedEvent({userId:this._log.userId,eventType:mN.LOAD_WORKLET,error:Xw}),this.initScriptProcessor()}}initScriptProcessor(){if(!this._scriptProcessorNode)try{this._scriptProcessorNode=this._audioCtx.createScriptProcessor(2048,1,1),this._scriptProcessorNode.onaudioprocess=e=>{let t=e.inputBuffer.getChannelData(0),i=0;for(let n=0;n<t.length;++n)i+=t[n]*t[n];this._volume=Math.sqrt(i/t.length)||0},this._streamSource.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._destination)}catch(Xw){this._log.error("volumeMeter init script processor error: ".concat(Xw))}}destroy(){this._streamSource&&this._streamSource.disconnect(),this._scriptProcessorNode&&(this._scriptProcessorNode.onaudioprocess=null,this._scriptProcessorNode.disconnect()),this._audioWorkletNode&&(this._audioWorkletNode.port.postMessage({name:"stop"}),this._audioWorkletNode.port.onmessage=null,this._audioWorkletNode.disconnect()),this._audioWorkletNode=null,this._scriptProcessorNode=null,this._audioCtx=null,GO.off(JO.AUDIO_LEVEL_INTERVAL,this.handleAudioLevelInterval,this),GO.off(JO.WORKLET_LOADED_SUCCESS,this.initAudioWorklet,this),GO.off(JO.WORKLET_LOADED_FAILED,this.initScriptProcessor,this),BL>0&&(BL-=1),0===BL&&(null==VL||VL.close(),VL=null,UL=null)}resume(){null==VL||VL.resume()}getInternalAudioLevel(){return this._volume}getCalculatedVolume(){return parseFloat(this._volume.toFixed(2))}handleAudioLevelInterval(e){var t;let{interval:i}=e;this._interval=i,null==(t=this._audioWorkletNode)||t.port.postMessage({name:"setIntervalTime",intervalTime:i})}},jL=null,GL=0,WL=class extends PL{constructor(e){super(e,HD.AUDIO),hb(this,"_volumeMeter"),hb(this,"_gainedTrack",null),hb(this,"_gainNode",null),hb(this,"_destination",null),hb(this,"_mediaStreamSource",null),hb(this,"_sourceElement",null),hb(this,"_outputDeviceId"),hb(this,"_volume",1),hb(this,"_loop",!1),e.gainedTrack&&(this._gainedTrack=e.gainedTrack),this._outputDeviceId=e.outputDeviceId,this.track&&this.initVolumeMeter(this.track)}setTrack(e){this.track!==e&&(this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),null!==e&&this.initVolumeMeter(e)),super.setTrack(e)}initVolumeMeter(e){this._volumeMeter=new HL({track:this._gainedTrack||e,log:this._log})}initializeElement(){if(("15.2"===qk||"15.3"===qk||"15.4"===qk)&&this.muted)return void this._log.info("audioElement is muted.");let e=document.createElement(HD.AUDIO);this.track&&(e.srcObject=new MediaStream([this._gainedTrack||this.track])),e.muted=this.muted,e.setAttribute("id","audio_".concat(this.id)),e.setAttribute("autoplay","autoplay"),e.setAttribute("playsinline","playsinline"),this.element=e,this.bindElementEvents()}play(){return _b(this,null,(function*(){this.element||this.initializeElement(),this._outputDeviceId&&(yield this.setSinkId(this._outputDeviceId)),!this._volumeMeter&&this.track&&this.initVolumeMeter(this.track),this.setVolume(this._volume),yield pb(WL.prototype,this,"play").call(this)}))}stop(){this._volumeMeter&&(this._volumeMeter.destroy(),this._volumeMeter=null),this.destroyGain(),super.stop()}resume(){return _b(this,null,(function*(){yield pb(WL.prototype,this,"resume").call(this),this._volumeMeter&&this._volumeMeter.resume()}))}setSinkId(e){return _b(this,null,(function*(){this._outputDeviceId!==e&&(this.element&&(yield this.element.setSinkId(e)),this._outputDeviceId=e)}))}setVolume(e){this._volume=e,this._gainNode?this._gainNode.gain.value=e:e>1?this.createGain(e):this.element&&(this.element.volume=e)}createGain(e){jL||(jL=FL()),this._log.info("create gainNode ".concat(e));let t=jL.createMediaStreamSource(new MediaStream([this.track])),i=jL.createGain(),n=jL.createMediaStreamDestination();t.connect(i),i.connect(n),i.gain.value=e,this._gainNode=i,this._destination=n,this._mediaStreamSource=t,this._gainedTrack=n.stream.getAudioTracks()[0],GL+=1,this.element&&(OL(this.element),this._sourceElement=this.element,this.element.muted=!0,this.element=null),this.play()}destroyGain(){var e,t,i;!this._gainNode||(this._log.info("destroy gainNode"),null==(e=this._gainNode)||e.disconnect(),null==(t=this._destination)||t.disconnect(),null==(i=this._mediaStreamSource)||i.disconnect(),this._gainNode=null,this._destination=null,this._mediaStreamSource=null,this._sourceElement&&(this._sourceElement.srcObject=null,this._sourceElement=null),this._gainedTrack=null,0===(GL-=1)&&jL&&(this._log.info("destroy gain audioContext"),jL.close(),jL=null))}setLoop(e){!this.element||(this.element.loop=e,this._loop=e)}getAudioLevel(){var e;return(null==(e=this._volumeMeter)?void 0:e.getCalculatedVolume())||0}getInternalAudioLevel(){var e;return null==(e=this._volumeMeter)?void 0:e.getInternalAudioLevel()}},JL=class extends ZP{constructor(e){let{userId:t,sdkAppId:i,mediaType:n,room:r,isInitPlayer:o=!0}=e;var s;super(),hb(this,"id",zO()),hb(this,"userId"),hb(this,"isRemote"),hb(this,"mediaType"),hb(this,"room"),hb(this,"user"),hb(this,"_log"),hb(this,"isPlayCalled"),hb(this,"mediaTrack",null),hb(this,"mediaStream"),hb(this,"container",null),hb(this,"subVideoPlayerMap"),hb(this,"playerMuted",!1),hb(this,"abortCtrl"),hb(this,"audioOutputDeviceId"),hb(this,"audioVolume"),hb(this,"objectFit","cover"),hb(this,"mirror",!1),hb(this,"gain"),hb(this,"isScreen",!1),dO(t)||(this.userId=t),this.mediaType=n,this._log=YO.createLogger({id:"".concat(this.kind[0],"t"),userId:null==(s=r||this.room)?void 0:s.userId,remoteUserId:this instanceof pw?void 0:this.userId,sdkAppId:i,type:2===this.mediaType?"auxiliary":"main",isLocal:this instanceof pw}),o&&this.initPlayer()}get log(){return this._log||YO}get kind(){return 1===this.mediaType?HD.AUDIO:HD.VIDEO}get muted(){return!(!this.mediaTrack||this.mediaTrack.enabled)}get strMediaType(){return 4===this.mediaType?HD.VIDEO:2===this.mediaType?HD.SCREEN:HD.AUDIO}uninstallEvents(){}play(e,t){return _b(this,null,(function*(){let i=mO(e)?e[0]:e;if(this.isPlayCalled)return this.log.info("play update options: ".concat(t)),t&&!dO(t.muted)&&this.setPlayerMute(t.muted),t&&!dO(t.objectFit)&&(this.objectFit=t.objectFit),this.isScreen?this.mirror=!1:t&&!dO(t.mirror)&&(this.mirror=t.mirror),void(this.kind===HD.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror),this.container!==i&&i&&(this.container=i,this.player.setContainer(i)),mO(e)&&e.length>=1&&(yield this.playSubContainer(e.slice(1),t))));if((!this.isRemote||this.kind===HD.VIDEO)&&this.setPlayerMute(!0),t&&!dO(t.muted)&&this.setPlayerMute(t.muted),t&&!dO(t.objectFit)&&(this.objectFit=t.objectFit),this.isRemote||(this.mirror=!0),this.isScreen?this.mirror=!1:t&&!dO(t.mirror)&&(this.mirror=t.mirror),this.kind===HD.VIDEO&&(this.player.setObjectFit(this.objectFit),this.player.setMirror(this.mirror)),this.isPlayCalled=!0,i&&(this.container=i,this.player.setContainer(i)),GO.emit(JO.PLAY_TRACK_START,{track:this}),this.mediaTrack){this._log.info("play with options: ".concat(JSON.stringify(t)));try{yield this.player.play(),mO(e)&&e.length>1&&(yield this.playSubContainer(e.slice(1),t))}catch(n){throw this.handleAutoPlayFailed(),this.emit("error",n),n}}else this.log.info("play has not mediaTrack, abort")}))}playSubContainer(e,t){return _b(this,null,(function*(){if(!this.mediaTrack||this.kind===HD.AUDIO)return;this.subVideoPlayerMap||(this.subVideoPlayerMap=new Map),this.subVideoPlayerMap.forEach(((t,i)=>{var n;e.find((e=>i===e))||(t.stop(),t.setContainer(null),null==(n=this.subVideoPlayerMap)||n.delete(i))}));for(let[n,r]of e.entries()){let e=this.subVideoPlayerMap.get(r);e?t&&(dO(t.mirror)||e.setMirror(t.mirror),dO(t.objectFit)||e.setObjectFit(t.objectFit)):this.subVideoPlayerMap.set(r,new LL({id:this.userId||this.id,track:this.mediaTrack,container:r,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log.createChild({id:"vp-sub".concat(n+1)})}))}let i=[...this.subVideoPlayerMap.values()];for(let e of i)yield e.play()}))}initPlayer(){var e;this.log.info("create ".concat(this.kind,"Player")),this.kind===HD.AUDIO?this.player=new WL({id:this.userId||this.id,track:this.mediaTrack,gainedTrack:null==(e=this.gain)?void 0:e.audioTrack,container:this.container||null,muted:this.playerMuted,outputDeviceId:this.audioOutputDeviceId,log:this.log}):(this.player=new LL({id:this.userId||this.id,track:this.mediaTrack,container:this.container||null,muted:this.playerMuted,objectFit:this.objectFit,mirror:this.mirror,log:this.log}),this.player.on(oL.LOADED_DATA,(()=>{GO.emit(JO.VIDEO_LOADED_DATA,{track:this})})),this.player.on(oL.MEDIA_TRACK_CHANGED,(e=>{var t;null==(t=this.subVideoPlayerMap)||t.forEach((t=>t.setTrack(e)))}))),this.player.on(oL.PLAYER_STATE_CHANGED,(e=>{GO.emit(JO.PLAYER_STATE_CHANGED,sb({track:this},e)),this.emit("player-state-changed",e)}))}setAudioOutput(e){return _b(this,null,(function*(){var t;this.audioOutputDeviceId=e,yield null==(t=this.player)?void 0:t.setSinkId(e)}))}setAudioVolume(e){var t;this.audioVolume=e,this.log.info("setAudioVolume to ".concat(e)),null==(t=this.player)||t.setVolume(e)}getAudioLevel(){var e;return(null==(e=this.player)?void 0:e.getAudioLevel())||0}getInternalAudioLevel(){var e;return(null==(e=this.player)?void 0:e.getInternalAudioLevel())||0}stop(){!this.isPlayCalled||(this.isPlayCalled=!1,this.player&&(this.log.info("stop ".concat(this.kind," player")),this.player.stop(),this.player.setContainer(null)),this.subVideoPlayerMap&&this.subVideoPlayerMap.size>0&&this.subVideoPlayerMap.forEach((e=>{e.stop(),e.setContainer(null)})),this.container=null)}resume(){return _b(this,null,(function*(){var e;!this.isPlayCalled||(yield null==(e=this.player)?void 0:e.resume())}))}close(){var e;this.log.info("close"),this.isPlayCalled&&this.stop(),!this.isRemote&&(null==(e=this.mediaTrack)||e.stop(),this.mediaTrack=null,this.uninstallEvents())}setMute(e){return!!this.mediaTrack&&(this.mediaTrack.enabled=!e,this.emit(e?"mute":"unmute",this),GO.emit(e?JO.TRACK_MUTED:JO.TRACK_UNMUTED,{track:this}),!0)}setPlayerMute(e){this.playerMuted=e,this.player.setMuted(e)}setMediaStream(e){e!==this.mediaStream&&(this.mediaStream=e)}setMediaStreamTrack(e){this.mediaStream||(this.mediaStream=new MediaStream),this.mediaTrack&&this.mediaStream.removeTrack(this.mediaTrack);let t=this.mediaTrack;this.mediaTrack=e,this.mediaTrack&&(this.mediaTrack.enabled=!this.muted,this.mediaStream.addTrack(this.mediaTrack),this.isRemote||this.player.setTrack(this.mediaTrack)),this.updatePlayingState(!!e),this.emit("media-track-changed",this.mediaTrack,t)}setMediaType(e){this.mediaType=e}updatePlayingState(e){if(!this.isPlayCalled||e&&!this.player.isStopped||!e&&this.player.isStopped)this.log.debug("updatePlayingState abort ".concat(this.isPlayCalled," ").concat(e," ").concat(this.player.isStopped));else if(this.log.info("playing state updated, ".concat(e?"play":"stop"," ").concat(this.kind)),e){if(this instanceof ww&&(!this.isSubscribed||!this.hasFlag))return void this.log.info("abort play, isSubscribed:".concat(this.isSubscribed," hasFlag:").concat(this.hasFlag));this.player.play().catch((()=>this.handleAutoPlayFailed()))}else this.player.stop()}handleAutoPlayFailed(){if(this.room&&this.room.enableAutoPlayDialog)new bL;else{let e=()=>{this.resume().then((()=>{document.removeEventListener("click",e,!0),document.removeEventListener("touchstart",e,!0)}))};document.addEventListener("click",e,!0),document.addEventListener("touchstart",e,!0)}}};ub([qP([],ZP.INIT)],JL.prototype,"close",1);var KL=Object.prototype.hasOwnProperty;var YL=function(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e||"function"==typeof e||Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(oO(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(let t in e)if(KL.call(e,t))return!1;return!0}return!1},zL=db(mb(),1),qL=e=>t=>t.deviceId===e,QL=class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Input";hb(this,"kind"),hb(this,"type"),hb(this,"devices",[]),this.kind=e,this.type=t}update(e,t){let i=e.filter((e=>e.kind==="".concat(this.kind).concat(this.type.toLocaleLowerCase())));t&&(i.forEach((e=>{if(e.deviceId&&!this.devices.find(qL(e.deviceId))){let i="".concat(this.kind).concat(this.type,"Added");YO.warn("".concat(i,": ").concat(JSON.stringify(e))),t.emit(i,e)}})),this.devices.forEach((e=>{if(e.deviceId&&!i.find(qL(e.deviceId))){let i="".concat(this.kind).concat(this.type,"Removed");YO.warn("".concat(i,": ").concat(JSON.stringify(e))),t.emit(i,e)}}))),this.devices=i}hasDevice(e){return!!this.devices.find((t=>t.deviceId===e))}},XL=class extends zL.EventEmitter{constructor(){super(),hb(this,"audioInputs",new QL(HD.AUDIO)),hb(this,"videoInputs",new QL(HD.VIDEO)),hb(this,"audioOutputs",new QL(HD.AUDIO,"Output")),this.init(),navigator.mediaDevices&&navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.update.bind(this))}init(){$L().then((e=>{this.audioInputs.update(e),this.videoInputs.update(e),this.audioOutputs.update(e)}))}update(){return _b(this,null,(function*(){let e=yield $L();return this.audioInputs.update(e,this),this.videoInputs.update(e,this),this.audioOutputs.update(e,this),this}))}},ZL=gD||fD?null:new XL;function $L(){return _b(this,null,(function*(){return hP()||!dP()?[]:(yield navigator.mediaDevices.enumerateDevices()).map(((e,t)=>{let i={kind:e.kind,deviceId:e.deviceId,groupId:e.groupId,label:e.label||"".concat(e.kind,"_").concat(t)};return e.deviceId.length>0&&nw.add("".concat(e.deviceId,"_").concat(e.kind)),e.getCapabilities&&(i.getCapabilities=()=>e.getCapabilities()),i}))}))}function ew(){return ZL.update().then((e=>e.audioInputs.devices))}function tw(){return ZL.update().then((e=>e.videoInputs.devices))}function iw(){return _b(this,null,(function*(){return ZL.update().then((e=>e.audioOutputs.devices))}))}var nw=new Set;function rw(e,t){return _b(this,null,(function*(){let i=(yield ew()).find((e=>e.deviceId===PN));return(null==i?void 0:i.groupId)===e&&i.label===t}))}var ow=HO({retryFunction:function(e){return _b(this,null,(function*(){let t=function(e){return{audio:aw(e),video:cw(e)}}(e);YO.info("getUserMedia with constraints: ".concat(JSON.stringify(t)));let i=[],n=[];t.audio&&(i=yield ew(),YO.info("microphones: ".concat(UO(i,["label","deviceId"])))),t.video&&(n=yield tw(),YO.info("cameras: ".concat(UO(n,["label","deviceId"]))));try{let e=yield navigator.mediaDevices.getUserMedia(t);return VP&&e.getTracks().forEach((e=>{YO.info("".concat(e.kind," capabilities: ").concat(UO(e.getCapabilities(),GN)))})),e}catch(_D){if("NotFoundError"===_D.name){if(n&&0===n.length)throw new vb({code:Ab.DEVICE_NOT_FOUND,message:rP({key:XO.CAMERA_NOT_FOUND})});if(i&&0===i.length)throw new vb({code:Ab.DEVICE_NOT_FOUND,message:rP({key:XO.MICROPHONE_NOT_FOUND})})}throw new vb({code:Ab.INITIALIZE_FAILED,name:_D.name,message:_D.message,constraint:_D.constraint})}}))},settings:{retries:3,timeout:500},onError:(e,t,i,n)=>{"NotReadableError"===e.name?(n[0].video&&(n[0].maxResolution=!1,n[0].frameRate&&(n[0].frameRate=n[0].frameRate>10?10:5)),t()):i(e),n[0].microphoneId&&sw(n[0].microphoneId,!1),n[0].cameraId&&sw(n[0].cameraId,!0)},onRetrying:e=>{YO.warn("getUserMedia NotReadableError observed, retrying [".concat(e,"/3]"))}});function sw(e,t){return _b(this,null,(function*(){let i=(t?yield tw():yield ew()).find((t=>t.deviceId===e));i&&lO(i.getCapabilities)&&YO.warn(UO(i.getCapabilities(),GN))}))}function aw(e){if(!e.audio)return!1;let t={};return YL(e.microphoneId)||(t.deviceId=e.useExact?{exact:e.microphoneId}:e.microphoneId),hO(e.channelCount)&&e.channelCount>1&&(t.channelCount=e.channelCount),pO(e.echoCancellation)&&!e.echoCancellation&&(t.echoCancellation=!1),pO(e.noiseSuppression)&&!e.noiseSuppression&&(t.noiseSuppression=!1),pO(e.autoGainControl)&&!e.autoGainControl&&(t.autoGainControl=!1),!!YL(t)||t}function cw(e){if(!e.video)return!1;let{maxResolution:t=!0}=e,i={};return e.cameraId?i.deviceId=e.useExact?{exact:e.cameraId}:e.cameraId:e.facingMode&&(i.facingMode=e.facingMode),e.width&&(i.width={ideal:e.width},t&&!Jb&&(i.width.max=e.width)),e.height&&(i.height={ideal:e.height},t&&!Jb&&(i.height.max=e.height)),Jb&&Ak&&e.width&&e.height&&e.width*e.height<101376&&(i.width=e.width,i.height=e.height),e.frameRate&&(i.frameRate=e.frameRate),!!YL(i)||i}var lw=ow;function dw(e){return hw(((t,i)=>function(){for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return _b(this,null,(function*(){return yield e.apply(this,n),t.apply(this,n)}))}))}function uw(e){return hw(((t,i)=>function(){for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return _b(this,null,(function*(){return e.call(this,t.apply(this,n))}))}))}function hw(e){return function(t,i,n){return n.value=e(n.value,i),n}}var pw=class extends JL{constructor(e){super({mediaType:e,isInitPlayer:!(arguments.length>1&&void 0!==arguments[1])||arguments[1]}),hb(this,"isRemote",!1),hb(this,"deviceId"),hb(this,"groupId",""),hb(this,"label",""),hb(this,"_isRecapturing",!1),hb(this,"_lastRecaptureTime",0),hb(this,"_onMuteTimeoutId",-1),this.onTrackMuted=this.onTrackMuted.bind(this),this.onTrackUnmuted=this.onTrackUnmuted.bind(this),this.onTrackEnded=this.onTrackEnded.bind(this)}installTrackEvent(e){e.addEventListener(HD.MUTE,this.onTrackMuted),e.addEventListener(HD.UNMUTE,this.onTrackUnmuted),e.addEventListener(HD.ENDED,this.onTrackEnded),e.muted&&this.onTrackMuted(),e.readyState===HD.ENDED&&this.onTrackEnded()}uninstallTrackEvent(e){e.removeEventListener(HD.MUTE,this.onTrackMuted),e.removeEventListener(HD.UNMUTE,this.onTrackUnmuted),e.removeEventListener(HD.ENDED,this.onTrackEnded)}setStateToCapture(){}capture(e){return _b(this,null,(function*(){try{let t;GO.emit(JO.LOCAL_TRACK_CAPTURE_START,{track:this}),e.customSource?(t=new MediaStream,t.addTrack(e.customSource)):t=yield lw(e);let i=t.getTracks()[0];return this.setMediaStream(t),this.setMediaStreamTrack(i),e.customSource||(this.updateDeviceIdInUse(),this.listenDeviceChange()),GO.emit(JO.LOCAL_TRACK_CAPTURE_SUCCESS,{track:this}),t}catch(pN){throw GO.emit(JO.LOCAL_TRACK_CAPTURE_FAILED,{track:this,error:pN}),this.log.error("getUserMedia error observed ".concat(pN)),pN}}))}setMediaStreamTrack(e){this.state===ZP.INIT&&this.setStateToCapture(),this.mediaTrack&&this.uninstallTrackEvent(this.mediaTrack),super.setMediaStreamTrack(e),e&&this.installTrackEvent(e)}setPublishStarting(e){this.room=e}setPublishStarted(){}setPublishStopped(e,t){}publish(e){this.room=e,this.userId=e.userId,this._log.setUserId(e.userId),this._log.setSdkAppId(e.sdkAppId),GO.emit(JO.LOCAL_TRACK_PUBLISHED,{track:this}),this.setPublishStarted()}unpublish(){GO.emit(JO.LOCAL_TRACK_UNPUBLISHED,{track:this}),2===this.mediaType&&(this.mediaType=4),this.setPublishStopped("api-call"),this.room=void 0}get isPublishing(){return"publish"===this.state}updateDeviceIdInUse(){return _b(this,null,(function*(){if(this.mediaTrack&&MP){let{deviceId:e,groupId:t}=this.mediaTrack.getSettings(),{label:i}=this.mediaTrack;(yield function(e){return _b(this,arguments,(function(e){let{newDeviceId:t,oldDeviceId:i,oldGroupId:n,oldLabel:r,kind:o}=e;return function*(){return t===i&&(o!==HD.AUDIO||t!==PN||(yield rw(n,r)))}()}))}({newDeviceId:e,oldDeviceId:this.deviceId,oldGroupId:this.groupId,oldLabel:this.label,kind:this.kind}))||(this.deviceId=e,this.label=i,t&&(this.groupId=t),$L().then((t=>{let i=t.find((t=>t.deviceId===e));i&&this.emit("2",i)})))}}))}setProfile(e){this.log.info("setProfile",e),Object.assign(this.profile,e)}isNeedToRecapture(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return!(!this.deviceId||!this.mediaTrack||this.kind===HD.AUDIO&&!function(e){if(e instanceof CanvasCaptureMediaStreamTrack||!(e instanceof MediaStreamTrack))return!1;let t=e.label.toLocaleLowerCase();if(t.includes("mic")||t.includes("éº¦åé£"))return!0;let i="".concat(((null==e?void 0:e.getSettings())||{}).deviceId,"_").concat(HD.AUDIO_INPUT);return!!nw.has(i)}(this.mediaTrack)||this.kind===HD.VIDEO&&!function(e){if(e instanceof CanvasCaptureMediaStreamTrack||!(e instanceof MediaStreamTrack))return!1;let t=e.label.toLocaleLowerCase();if(t.includes("camera")||t.includes("webcam"))return!0;let i="".concat(((null==e?void 0:e.getSettings())||{}).deviceId,"_").concat(HD.VIDEO_INPUT);return!!nw.has(i)}(this.mediaTrack)||this._isRecapturing||e&&Ak&&Jk)}onTrackMuted(){if(this.isNeedToRecapture(!0)){if(Date.now()-this._lastRecaptureTime<xN)return void setTimeout((()=>this.onTrackMuted()),xN);this._onMuteTimeoutId=setTimeout((()=>_b(this,null,(function*(){var e;(null==(e=this.mediaTrack)?void 0:e.muted)&&"visible"===document.visibilityState&&this.recapture(yield this.getRecoverCaptureDeviceId())}))),5e3)}}onTrackUnmuted(){this._onMuteTimeoutId>0&&clearTimeout(this._onMuteTimeoutId)}onTrackEnded(){return _b(this,null,(function*(){if(this.isNeedToRecapture()){if(Date.now()-this._lastRecaptureTime<xN)return void setTimeout((()=>this.onTrackEnded()),xN);this.recapture(yield this.getRecoverCaptureDeviceId())}}))}recapture(e){return _b(this,null,(function*(){var t;if(this._isRecapturing||!this.mediaTrack)return;let i;return this.log.warn("recapture trying"),null==(t=this.mediaTrack)||t.stop(),this._isRecapturing=!0,this._lastRecaptureTime=Date.now(),("audio"===this.kind?yield ew():yield tw()).find((t=>t.deviceId===e))&&(i=e),this.capture({deviceId:i,useExact:!0}).then((()=>{var e;return null==(e=this.room)?void 0:e.replaceTrack(this)})).then((()=>{this._isRecapturing=!1,this.log.warn("recapture success"),this.emit("1",{deviceId:this.deviceId})})).catch((e=>{this._isRecapturing=!1,this.log.warn("recapture failed ".concat(e.message)),this.emit("5",e)}))}))}getRecoverCaptureDeviceId(){return _b(this,null,(function*(){let{deviceId:e}=this;if(e){let t=(_w.get(e)||0)+1;if(_w.set(e,t),t>=3){let i="video"===this.kind?(yield tw()).find((e=>!_w.has(e.deviceId))):(yield ew()).find((e=>!_w.has(e.deviceId)));i&&(this.log.warn("".concat(e," capture fail ").concat(t," times, change new ").concat(i.deviceId)),e=i.deviceId)}}return e}))}};ub([qP(ZP.INIT,"capture")],pw.prototype,"setStateToCapture",1),ub([qP("capture","publish_starting",{success(){this.emit("4",{mediaType:this.strMediaType,state:"starting",prevState:"stopped"})}})],pw.prototype,"setPublishStarting",1),ub([qP("publish_starting","publish",{ignoreError:!0,success(){this.emit("4",{mediaType:this.strMediaType,state:"started",prevState:"starting"})}})],pw.prototype,"setPublishStarted",1),ub([hw((e=>function(t,i){let n=this.state.oldState||this.state;e.call(this,t,i),"capture"!==n&&this.emit("4",{mediaType:this.strMediaType,state:"stopped",prevState:"publish_starting"===this.state.oldState?"starting":"started",reason:t,error:i})})),qP(["publish","publish_starting"],"capture",{ignoreError:!0})],pw.prototype,"setPublishStopped",1);var _w=new Map;GO.on(JO.SWITCH_DEVICE_SUCCESS,(e=>{e.track.deviceId&&_w.delete(e.track.deviceId)}));var mw=class extends pw{constructor(){super(1),hb(this,"mediaType",1),hb(this,"volume",0),hb(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40}),hb(this,"playerMuted",!0)}getAudioLevel(){return this.volume||super.getAudioLevel()}capture(){let{deviceId:e,customSource:t,useExact:i=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return super.capture({video:!1,audio:!0,microphoneId:e,echoCancellation:this.profile.echoCancellation,autoGainControl:this.profile.autoGainControl,noiseSuppression:this.profile.noiseSuppression,sampleRate:this.profile.sampleRate,channelCount:this.profile.channelCount,useExact:i,customSource:t})}switchDevice(e){return _b(this,null,(function*(){if(this.mediaStream&&this.mediaTrack){if(this.deviceId===e){if(e!==PN)return;if(yield rw(this.groupId,this.label))return}try{this.log.info("switchDevice audio to: ".concat(e)),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),GO.emit(JO.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch microphone success")}catch(pN){throw this.log.error("switch microphone failed ".concat(pN)),this.deviceId&&this.recapture(this.deviceId),pN}}}))}listenDeviceChange(){ZL&&!ZL.listeners("audioInputRemoved").includes(this.handleMicrophoneRemoved)&&ZL.on("audioInputRemoved",this.handleMicrophoneRemoved,this)}handleMicrophoneRemoved(e){return _b(this,null,(function*(){if(e.deviceId===this.deviceId){this.log.warn("current microphone is lost: ".concat(JSON.stringify(e)));let t=yield ew();t[0]?this.recapture(t[0].deviceId):ZL.on("audioInputAdded",this.handleMicrophoneAdded,this)}}))}handleMicrophoneAdded(e){return _b(this,null,(function*(){this.log.warn("microphone added: ".concat(JSON.stringify(e))),this.recapture(e.deviceId)}))}close(){ZL.off("audioInputAdded",this.handleMicrophoneAdded,this),ZL.off("audioInputRemoved",this.handleMicrophoneRemoved,this),super.close()}},fw=class extends pw{constructor(){super(4),hb(this,"mediaType",4),hb(this,"profile",{width:640,height:480,frameRate:15,bitrate:500}),hb(this,"states",{bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0}),hb(this,"small"),hb(this,"facingMode"),hb(this,"_canvas"),hb(this,"_canvasInterval"),hb(this,"canvasTrack")}capture(){let{deviceId:e,facingMode:t,useExact:i=!1,customSource:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return super.capture({audio:!1,video:!0,facingMode:t||this.facingMode,cameraId:e,width:this.profile.width,height:this.profile.height,frameRate:this.profile.frameRate,useExact:i,customSource:n})}genCanvasTrack(){if(this.canvasTrack||!this.mediaTrack)return;this.log.info("gen canvas track");let{width:e,height:t,frameRate:i}=this.mediaTrack.getSettings();this._canvas=document.createElement("canvas");let n=this._canvas.getContext("2d");e&&t&&(this._canvas.width=e,this._canvas.height=t),this._canvasInterval=nL.run(BN,(()=>{if(!this._canvas)return;if(this.mediaTrack){let e=this.mediaTrack.getSettings();(e.width!==this._canvas.width||e.height!==this._canvas.height)&&(this._canvas.width=e.width,this._canvas.height=e.height)}let e=this.player.getElement();e&&(null==n||n.drawImage(e,0,0,this._canvas.width,this._canvas.height))}),{fps:Math.max(15,i||0)});let r=this._canvas.captureStream();this.canvasTrack=r.getVideoTracks()[0]}destoryCanvasTrack(){this._canvasInterval&&(nL.clearTask(this._canvasInterval),this._canvasInterval=void 0,this._canvas=void 0,this.canvasTrack=void 0)}setPublishStarting(e){super.setPublishStarting(e),this.isNeedToResetVideoProfile(this.profile)&&this.setProfile(this.profile)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.isNeedToResetVideoProfile(this.profile)&&this.setProfile(this.profile)}setProfile(e){var t;if(!e)return;let i=e.bitrate&&e.bitrate!==this.profile.bitrate;return this.isNeedToResetVideoProfile(e)&&(this.log.warn("Resolution is reset to 1080p, need to upgrade ability here https://cloud.tencent.com/document/product/647/85386"),e.width=1920,e.height=1080),super.setProfile(e),null==(t=this.mediaTrack)?void 0:t.applyConstraints({width:e.width,height:e.height,frameRate:e.frameRate}).then((()=>{if(i&&this.room&&this.room.setBandWidth)return this.room.setBandWidth({bandwidth:e.bitrate,type:HD.VIDEO,videoType:HD.BIG})}))}isNeedToResetVideoProfile(e){return!!(this.room&&this.room.scheduleResult&&1!==(this.room.scheduleResult.trtcAutoConf||{})["2k4k"]&&!this.isScreen&&e.height*e.width>=3686400)}switchDevice(e){return _b(this,null,(function*(){try{if(!this.mediaStream||this.deviceId===e||this.facingMode===e)return;(e===HD.FACING_MODE_USER||e===HD.FACING_MODE_ENVIRONMENT)&&(this.facingMode=e,e=void 0),this.mediaTrack&&this.mediaTrack.stop(),yield this.capture({deviceId:e,useExact:!0}),this.room&&(yield this.room.replaceTrack(this)),GO.emit(JO.SWITCH_DEVICE_SUCCESS,{track:this}),this.log.info("switch camera success")}catch(pN){throw this.log.error("switch camera failed ".concat(pN)),this.deviceId&&this.recapture(this.deviceId),pN}}))}listenDeviceChange(){ZL&&!ZL.listeners("audioInputRemoved").includes(this.handleCameraRemoved)&&ZL.on("videoInputRemoved",this.handleCameraRemoved,this)}handleCameraRemoved(e){return _b(this,null,(function*(){if(e.deviceId===this.deviceId){this.log.warn("current camera is lost: ".concat(JSON.stringify(e)));let t=yield tw();t[0]?this.recapture(t[0].deviceId):ZL.on("videoInputAdded",this.handleCameraAdded,this)}}))}handleCameraAdded(e){return _b(this,null,(function*(){this.log.warn("camera added: ".concat(JSON.stringify(e))),this.recapture(e.deviceId)}))}close(){ZL.off("videoInputAdded",this.handleCameraAdded,this),ZL.off("videoInputRemoved",this.handleCameraRemoved,this),this.destoryCanvasTrack(),super.close()}};var gw=function(e){return _b(this,null,(function*(){let t=null,i=function(e){let t={systemAudio:"include",selfBrowserSurface:"include",surfaceSwitching:"include"},i={width:Jk?{max:e.width}:{ideal:e.width,max:e.width},height:Jk?{max:e.height}:{ideal:e.height,max:e.height},frameRate:e.frameRate,displaySurface:"monitor"};if(t.video=i,e.systemAudio){let{echoCancellation:i=!0,noiseSuppression:n=!1,autoGainControl:r=!1}=e;t.audio={echoCancellation:i,noiseSuppression:n,autoGainControl:r,sampleRate:48e3}}return t}(e);YO.info("getDisplayMedia with constraints: ".concat(JSON.stringify(i)));let n=yield navigator.mediaDevices.getDisplayMedia(i);if(e.systemAudio&&0===n.getAudioTracks().length&&(Hk&&Gk<74||Jk||Jb)&&YO.warn("Your browser not support capture system audio"),e.frameRate&&n.getVideoTracks()[0]&&n.getVideoTracks()[0].applyConstraints({frameRate:{min:e.frameRate,ideal:e.frameRate},width:e.width,height:e.height}).catch((e=>{YO.warn("screen applyConstraints failed: ".concat(e))})),e.audio){let i=function(e){let t={echoCancellation:e.echoCancellation,autoGainControl:e.autoGainControl,noiseSuppression:e.noiseSuppression,sampleRate:e.sampleRate,channelCount:e.channelCount};return dO(e.microphoneId)||(t.deviceId=e.microphoneId),{audio:t,video:!1}}(e);YO.info("getUserMedia with constraints: ".concat(JSON.stringify(i))),t=yield navigator.mediaDevices.getUserMedia(i),n.addTrack(t.getAudioTracks()[0])}return n}))},Tw=class extends fw{constructor(){super(),hb(this,"profile",{width:1920,height:1080,frameRate:5,bitrate:1600}),hb(this,"objectFit","contain"),hb(this,"isScreen",!0),this._log.id="s-".concat(this._log.id)}capture(){return _b(this,arguments,(function(){var e=this;let{systemAudio:t=!1,autoGainControl:i,echoCancellation:n,noiseSuppression:r,audioTrack:o,videoTrack:s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){try{let a;return s||o?(a=new MediaStream,s&&a.addTrack(s),o&&a.addTrack(o)):a=yield gw({audio:!1,systemAudio:t,width:e.profile.width,height:e.profile.height,frameRate:e.profile.frameRate,autoGainControl:i,echoCancellation:n,noiseSuppression:r}),e.setMediaStream(a),e.setMediaStreamTrack(a.getVideoTracks()[0]),a}catch(a){throw e.log.error("getDisplayMedia error observed ".concat(a)),a instanceof vb?a:new vb({code:Ab.INITIALIZE_FAILED,name:a.name,message:a.message})}}()}))}switchDevice(e){return _b(this,null,(function*(){throw new Error("Method not implemented.")}))}},Ew=class extends mw{constructor(){super(),this._log.id="s-".concat(this._log.id)}setScreenAudioTrack(e,t){this.setMediaStream(t),this.setMediaStreamTrack(e)}},Iw=class extends pw{constructor(e){super(1,!1),hb(this,"musicId"),hb(this,"mediaType",1),hb(this,"volume",0),hb(this,"profile",{echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:48e3,channelCount:1,bitrate:40}),hb(this,"playerMuted",!1),hb(this,"audio"),hb(this,"_audioContext"),hb(this,"_destination"),hb(this,"_source",null),this.initAudioContext(),this._destination=this._audioContext.createMediaStreamDestination(),this._destination.channelCount=1,this.audio=document.createElement("audio"),this.audio.src=e.url,this.audio.crossOrigin="anonymous",pO(e.loop)&&this.loop(e.loop),hO(e.volume)&&this.setVolume(e.volume),e.id&&(this.musicId=e.id),this._source=this._audioContext.createMediaElementSource(this.audio),this._source.connect(this._destination),this.setMediaStream(this._destination.stream),this.installPlayerEvent()}installPlayerEvent(){this.audio.addEventListener("error",this.handleAudioError.bind(this))}uninstallPlayerEvent(){this.audio.removeEventListener("error",this.handleAudioError.bind(this))}handleAudioError(e){this._log.warn("local music ".concat(this.musicId," audio error"),e)}initAudioContext(){this._audioContext=FL(),"running"!==this._audioContext.state&&this._log.warn("local music ".concat(this.musicId," context state: ").concat(this._audioContext.state))}play(){return _b(this,null,(function*(){try{yield this.audio.play(),this._log.info("music ".concat(this.musicId," play success"))}catch(pD){this._log.error("music ".concat(this.musicId," play error"),pD)}}))}destroy(){var e,t;null==(e=this._source)||e.disconnect(),null==(t=this._destination)||t.disconnect(),this.uninstallPlayerEvent(),this.player.stop(),this._audioContext.close().then((()=>{this._source=null,this._destination=null,this._audioContext=null}))}getStream(){var e;return(null==(e=this._destination)?void 0:e.stream)||null}seek(e){e<0&&e>this.duration()?this._log.warn("Time beyond song duration."):this.audio.currentTime=e}getPosition(){return this.audio.currentTime||0}setVolume(e){e>1&&e<0?this.log.warn("volume is out of range"):this.audio.volume=e}getVolume(){return this.audio.volume||0}setPlayBackRate(e){e>8&&e<0?this.log.warn("rate is out of range"):this.audio.playbackRate=e}getPlayBackRate(){return this.audio.playbackRate||0}duration(){return this.audio.duration||0}loop(e){return this.audio&&pO(e)&&(this.audio.loop=e),this.audio.loop||!1}setOperation(e){"pause"===e&&this.audio.pause(),"resume"===e&&(this.audio.pause(),this.audio.play()),"stop"===e&&(this.audio.pause(),this.seek(0))}listenDeviceChange(){}};window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;var Sw=(()=>{let e;return()=>{if(e)return e;e=new window.AudioContext({sampleRate:48e3});let t=()=>{"suspended"===e.state?(e.resume(),document.removeEventListener("click",t)):"interrupted"===e.state?e.resume():document.removeEventListener("click",t)};return document.addEventListener("click",t),e.onstatechange=()=>{t()},e}})(),Aw="input",yw="output";var vw=e=>(e=Number(e))>0&&e<14e8;function Rw(e){return _b(this,arguments,(function(e){let{sdkAppId:t,userId:i,userSig:n,timestamp:r}=e;return function*(){let e="https://".concat(function(e){let t;return t=vw(e)?"intl-schedule.rtc.qq.com":"schedule.rtc.qq.com",t}(t),"/api/v1/audioAiAuth?sdkAppId=").concat(t,"&userId=").concat(i,"&userSig=").concat(n,"&timestamp=").concat(r),o=yield fetch(e),{data:{errCode:s,errMsg:a,sign:c,status:l}}=yield o.json();if("1"===l)return{auth:!0,sign:c,status:l,message:a};let d="Init RTCAIDenoiser failed.",u="";switch(s){case 1:u="Please check your params.";break;case 2:u="You need to buy packages. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 3:u="Server is invalid. Please contact our engineer. ";break;case 4:u="Your packages is not active. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 5:u="Your packages is expired. Refer to: https://cloud.tencent.com/document/product/647/44247";break;case 6:u="Your version is not supported."}return{auth:!1,status:l,message:a?"".concat(d," Reason: ").concat(a,". ").concat(u):"".concat(d,", ").concat(u)}}()}))}var Cw=db(mb(),1);function bw(e,t){t=t||{};let i,n=e.numberOfChannels,{sampleRate:r}=e,o=t.float32?3:1,s=3===o?32:16;return i=2===n?function(e,t){let i=e.length+t.length,n=new Float32Array(i),r=0,o=0;for(;r<i;)n[r++]=e[o],n[r++]=t[o],o++;return n}(e.getChannelData(0),e.getChannelData(1)):e.getChannelData(0),function(e,t,i,n,r){let o=r/8,s=n*o,a=new ArrayBuffer(44+e.length*o),c=new DataView(a);return kw(c,0,"RIFF"),c.setUint32(4,36+e.length*o,!0),kw(c,8,"WAVE"),kw(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,t,!0),c.setUint16(22,n,!0),c.setUint32(24,i,!0),c.setUint32(28,i*s,!0),c.setUint16(32,s,!0),c.setUint16(34,r,!0),kw(c,36,"data"),c.setUint32(40,e.length*o,!0),1===t?function(e,t,i){for(let n=0;n<i.length;n++,t+=2){let r=Math.max(-1,Math.min(1,i[n]));e.setInt16(t,r<0?32768*r:32767*r,!0)}}(c,44,e):function(e,t,i){for(let n=0;n<i.length;n++,t+=4)e.setFloat32(t,i[n],!0)}(c,44,e),a}(i,o,r,n,s)}function kw(e,t,i){for(let n=0;n<i.length;n++)e.setUint8(t+n,i.charCodeAt(n))}var Dw=class{constructor(e){hb(this,"audioContext_"),hb(this,"inputPCM_",new Float32Array),hb(this,"outputPCM_",new Float32Array),this.audioContext_=e}onDump(e,t){if(t===Aw){let t=this.inputPCM_.length,i=new Float32Array(t+e[0].length);i.set(this.inputPCM_),i.set(e[0],t),this.inputPCM_=i}if(t===yw){let t=this.outputPCM_.length,i=new Float32Array(t+e[0].length);i.set(this.outputPCM_),i.set(e[0],t),this.outputPCM_=i}}getBlob(e){let t=e===Aw?this.inputPCM_:this.outputPCM_,i=this.audioContext_.createBuffer(2,t.length,48e3);i.copyToChannel(t,0,0),i.copyToChannel(t,1,0);let n=bw(i);return i=null,new window.Blob([new DataView(n)],{type:"audio/wav"})}reset(){this.inputPCM_=new Float32Array,this.outputPCM_=new Float32Array}destroy(){this.reset()}},Nw=class{constructor(e){let{sdkAppId:t,userId:i,audioContext:n,sign:r,status:o,worklet:s,timestamp:a,logger:c}=e;hb(this,"audioContext_"),hb(this,"destination_"),hb(this,"gainNode_"),hb(this,"log_"),hb(this,"workletNode_"),hb(this,"isDumping_",!1),hb(this,"dump_"),hb(this,"trackConstraint_",{}),hb(this,"audioTrack_"),hb(this,"source_"),hb(this,"denoiserTrack_"),hb(this,"enableDenoise_",!0),hb(this,"emitter_",new Cw.default),this.audioContext_=n,this.destination_=this.audioContext_.createMediaStreamDestination(),this.gainNode_=this.audioContext_.createGain(),this.gainNode_.gain.value=1.1,this.log_=c,this.workletNode_=s,this.workletNode_.connect(this.gainNode_).connect(this.destination_),this.workletNode_.port.postMessage({type:"init",data:{sdkAppId:String(t),userId:i,timestamp:a,sign:r,status:o}}),this.workletNode_.port.onmessage=e=>{let{type:t,data:i}=e.data;if("ondump"===t&&this.isDumping_){let{inputPCM:e,outputPCM:t}=i;this.dump_.onDump(e,Aw),this.dump_.onDump(t,yw)}"dumped"===t&&this.dumped()},this.dump_=new Dw(this.audioContext_)}dumped(){this.isDumping_=!1;let e=this.dump_.getBlob(Aw),t=this.dump_.getBlob(yw);this.emitter_.emit("ondumpend",{blob:e,name:Aw}),this.emitter_.emit("ondumpend",{blob:t,name:yw}),this.dumpedWAV(e,Aw),this.dumpedWAV(t,yw),this.dump_.reset()}dumpedWAV(e,t){let i=window.URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download="".concat(t,"-").concat(Date.now(),".wav"),n.click(),window.URL.revokeObjectURL(i),n.href=""}process(e){return _b(this,null,(function*(){if(this.audioTrack_=e,!this.audioTrack_)throw new Error("RTCAIDenoiser: cannot process without audioTrack.");let t=new MediaStream;t.addTrack(this.audioTrack_),this.source_=this.audioContext_.createMediaStreamSource(t),yield this.source_.connect(this.workletNode_),this.trackConstraint_=this.audioTrack_.getConstraints(),this.trackConstraint_.noiseSuppression=!1,yield this.audioTrack_.applyConstraints(this.trackConstraint_);let i=this.destination_.stream;return this.denoiserTrack_=i.getAudioTracks()[0],this.log_.info("RTCAIDenoiser: denoiser process track ID: ".concat(e.id," success.")),this.denoiserTrack_}))}updateTrack(e){return _b(this,null,(function*(){var t;let i=new MediaStream;yield i.addTrack(e);let n=this.audioContext_.createMediaStreamSource(i);this.source_.disconnect(),n.connect(this.workletNode_),null==(t=this.audioTrack_)||t.stop(),this.audioTrack_=e,this.source_=n,this.log_.info("RTCAIDenoiser: updateTrack success.")}))}disable(){return _b(this,null,(function*(){var e,t;return this.enableDenoise_=!1,null==(e=this.workletNode_)||e.port.postMessage({type:"disable"}),this.trackConstraint_.noiseSuppression=!0,yield null==(t=this.audioTrack_)?void 0:t.applyConstraints(this.trackConstraint_),this.log_.info("RTCAIDenoiser: disable ai denoiser."),this.enableDenoise_}))}enable(){return _b(this,null,(function*(){var e,t;return this.enableDenoise_=!0,null==(e=this.workletNode_)||e.port.postMessage({type:"enable"}),this.trackConstraint_.noiseSuppression=!1,yield null==(t=this.audioTrack_)?void 0:t.applyConstraints(this.trackConstraint_),this.log_.info("RTCAIDenoiser: enable ai denoiser."),this.enableDenoise_}))}startDump(){return this.isDumping_?(this.log_.info("RTCAIDenoiser: data is currently being dumped."),!1):(this.workletNode_.port.postMessage({type:"startDump"}),this.dump_?this.dump_.reset():this.dump_=new Dw(this.audioContext_),this.isDumping_=!0,this.log_.info("RTCAIDenoiser: start dump data."),!0)}stopDump(){!this.isDumping_||(this.workletNode_.port.postMessage({type:"stopDump"}),this.isDumping_=!1,this.log_.info("RTCAIDenoiser: stop dump data."))}getAudioTrack(){return this.audioTrack_}getDenoiserTrack(){return this.destination_.stream.getAudioTracks()[0]}get enabled(){return this.enableDenoise_}destroy(){var e,t,i,n,r,o;this.log_.info("RTCAIDenoiser: destroy processor."),null==(e=this.audioTrack_)||e.stop(),null==(t=this.workletNode_)||t.port.postMessage({type:"destroy"}),this.workletNode_.port.onmessage=null,null==(i=this.source_)||i.disconnect(),null==(n=this.destination_)||n.disconnect(),null==(r=this.workletNode_)||r.disconnect(),null==(o=this.dump_)||o.destroy(),this.emitter_.removeAllListeners()}on(e,t,i){this.emitter_.on(e,t,i)}off(e,t,i){"*"===e?this.emitter_.removeAllListeners():this.emitter_.off(e,t,i)}},Ow=class{constructor(e){let{assetsPath:t,log:i}=e;this.isLoaded_=!1,this.audioContext_=Sw(),this.log_=i,this.assetsPath_=t}createProcessor(e){return _b(this,null,(function*(){let t=String(Date.now()).slice(0,-3),{auth:i,sign:n,status:r,message:o}=yield Rw(ab(sb({},e),{timestamp:t}));if(!i)throw this.log_.info("RTCAIDenoiser: ".concat(e.userId," auth result: ").concat(i,". Message: ").concat(o)),new Error(o);try{yield this.load()}catch(c){throw new Error("Init wasm failed, please check your assetsPath.")}let s=yield this.initWorklet(),a=new Nw(ab(sb({},e),{audioContext:this.audioContext_,timestamp:t,sign:n,status:r,worklet:s,logger:this.log_}));return this.log_.info("RTCAIDenoiser: ".concat(e.userId," create denoiser processor success.")),a}))}load(){return _b(this,null,(function*(){if(!this.isLoaded_)try{yield this.audioContext_.audioWorklet.addModule("".concat(this.assetsPath_,"/denoiser-wasm.js")),this.isLoaded_=!0}catch(Xw){throw this.log_.error("Init assets from ".concat(this.assetsPath_," failed! Reason: ").concat(Xw)),Xw}}))}initWorklet(){return _b(this,null,(function*(){try{return new AudioWorkletNode(this.audioContext_,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1})}catch(Xw){return yield this.load(),new AudioWorkletNode(this.audioContext_,"trtc-denoiser-processor",{numberOfInputs:1,numberOfOutputs:1})}}))}destroy(){var e;null==(e=this.audioContext_)||e.close()}isSupported(){return"AudioWorklet"in window&&"WebAssembly"in window}},Pw=class{constructor(e){let{room:t}=e;hb(this,"audioContext",null),hb(this,"_destination",null),hb(this,"_localAudioTrack",null),hb(this,"_localScreenAudioTrack",null),hb(this,"_localMediaStreamAudioTrack",null),hb(this,"_audioTrackStreamSource",null),hb(this,"_screenAudioTrackStreamSource",null),hb(this,"_mixedMusicSet",new Set),hb(this,"hasMusic",!1),hb(this,"isDenoiserInit",!1),hb(this,"isDenoiserEnabled",!1),hb(this,"isDenoiserProcessed",!1),hb(this,"mixedMusicMap",new Map),hb(this,"cacheMusicMap",new Map),hb(this,"_log"),hb(this,"originTrack",null),hb(this,"denoiserTrack",null),hb(this,"denoiser",null),hb(this,"denoiserProcessor",null),hb(this,"initProcessorOptions"),this._log=YO.createLogger({id:"am",userId:t.userId,sdkAppId:t.sdkAppId}),this.initAudioContext()}get hasScreenAudioTrack(){return null!==this._localScreenAudioTrack}get hasAudioTrack(){return null!==this._localAudioTrack}get isMixed(){return(this._localAudioTrack?1:0)+(this._localScreenAudioTrack?1:0)>=1}get mediaStreamTrack(){return this._destination.stream.getAudioTracks()[0]}addMusicSource(e){return _b(this,null,(function*(){this._log.info("add music source, id: ".concat(e.id," url: ").concat(e.url)),this.initAudioContext();let t,{id:i,url:n,loop:r,volume:o}=e;if(this.mixedMusicMap.has(i))return;t=this.cacheMusicMap.has(i)?this.cacheMusicMap.get(i).localMusicTrack:new Iw(e);let{stream:s}=t._destination,a=document.createElement("audio");a.srcObject=s,t.play(),yield a.play(),this._log.info("start mix audio ".concat(i," success."));let c=this.audioContext.createMediaStreamSource(s),l=this.audioContext.createGain();return c.connect(l),l.connect(this._destination),this._mixedMusicSet.add(i),this.mixedMusicMap.set(i,{localMusicTrack:t,streamSource:c,gainNode:l,audioPlayer:a}),this.cacheMusicMap.set(i,{localMusicTrack:t}),this.hasMusic=!0,t}))}updateMusicSource(e){return _b(this,null,(function*(){let{id:t,volume:i,loop:n,operation:r,seekFrom:o}=e;if(this._log.info("update music source, ".concat(JSON.stringify(e))),this.mixedMusicMap.has(t)){let{localMusicTrack:e}=this.mixedMusicMap.get(t);dO(i)||e.setVolume(i),dO(n)||e.loop(n),dO(r)||e.setOperation(r),dO(o)||e.seek(o)}}))}addAudioTrack(e){return _b(this,null,(function*(){var t;if(this._log.info("start add audioTrack, userId: ".concat(e.userId)),this.initAudioContext(),null!=e&&e.mediaStream&&this._localMediaStreamAudioTrack!==e.mediaTrack){if(MP){let i=yield null==(t=e.mediaTrack)?void 0:t.getSettings();this._destination.channelCount=(null==i?void 0:i.channelCount)||1}this._localAudioTrack=e,this._localMediaStreamAudioTrack=e.mediaTrack,this.isDenoiserProcessed?this.denoiserProcessor.updateTrack(e.mediaTrack):(this._audioTrackStreamSource=this.audioContext.createMediaStreamSource(e.mediaStream),this._audioTrackStreamSource.connect(this._destination))}}))}removeAudioTrack(e){var t,i;this._localAudioTrack===e&&(this._log.info("remove audioTrack, userId: ".concat(e.userId)),null==(t=this._audioTrackStreamSource)||t.disconnect(),this._audioTrackStreamSource=null,this._localMediaStreamAudioTrack=null,this._localAudioTrack=null,this.destroyDenoiserProcessor()),this._localScreenAudioTrack===e&&(this._log.info("start remove screenTrack, userId: ".concat(e.userId)),null==(i=this._screenAudioTrackStreamSource)||i.disconnect(),this._localScreenAudioTrack=null)}addScreenAudioTrack(e){this._log.info("start add screenAudioTrack, userId: ".concat(e.userId)),this.initAudioContext(),null!=e&&e.mediaStream&&this._localScreenAudioTrack!==e&&(this._localScreenAudioTrack=e,this._screenAudioTrackStreamSource=this.audioContext.createMediaStreamSource(e.mediaStream),this._screenAudioTrackStreamSource.connect(this._destination))}removeAudioTrackSource(e){var t,i;this._log.info("remove audio track source, type: ".concat(e)),"main"===e&&(null==(t=this._audioTrackStreamSource)||t.disconnect(),this._audioTrackStreamSource=null,this._localAudioTrack=null),"screen"===e&&(null==(i=this._screenAudioTrackStreamSource)||i.disconnect(),this._screenAudioTrackStreamSource=null,this._localScreenAudioTrack=null)}removeMusicSource(e){let{id:t}=e;if(this.mixedMusicMap.has(t)){this._log.info("remove music source, music id: ".concat(t));let{localMusicTrack:e,streamSource:i,gainNode:n,audioPlayer:r}=this.mixedMusicMap.get(t);i.disconnect(),n.disconnect(),r.pause(),r.srcObject=null,e.stop(),this.mixedMusicMap.delete(t),this._mixedMusicSet.delete(t),0===this._mixedMusicSet.size&&(this.hasMusic=!1)}"*"===t&&this.destroyAllMusic()}destroyAllMusic(){this._log.info("destroy all music source."),this._mixedMusicSet.forEach((e=>{this.removeMusicSource({id:e})}))}destroyAllCache(){this._log.info("destroy all music cache."),this.cacheMusicMap.forEach((e=>{e.localMusicTrack.stop()}))}initAudioContext(){this.audioContext||(this.audioContext=FL(),"running"!==this.audioContext.state&&this._log.warn("context state: ".concat(this.audioContext.state)),this._destination=this.audioContext.createMediaStreamDestination(),this._destination.channelCount=1)}initDenoiser(e){return _b(this,null,(function*(){let{assetsPath:t,sdkAppId:i,userId:n,userSig:r}=e;try{this.denoiser||(this.denoiser=new Ow({assetsPath:t,log:this._log})),this.denoiserProcessor||(this.denoiserProcessor=yield this.denoiser.createProcessor({sdkAppId:i,userId:n,userSig:r})),this.isDenoiserInit=!0,this.initProcessorOptions=e}catch(mD){throw mD}}))}enableDenoiser(e){return _b(this,null,(function*(){var e;if(this.isDenoiserEnabled=!0,this.hasAudioTrack)if(this.isDenoiserProcessed)this.denoiserProcessor.enable();else{if(this.originTrack=this._localAudioTrack.mediaTrack,!this.originTrack)return;null==(e=this._audioTrackStreamSource)||e.disconnect(),this.denoiserProcessor||(yield this.initDenoiser(this.initProcessorOptions)),this.denoiserTrack=yield this.denoiserProcessor.process(this.originTrack);let t=new MediaStream;t.addTrack(this.denoiserTrack),this._audioTrackStreamSource=this.audioContext.createMediaStreamSource(t),this._audioTrackStreamSource.connect(this._destination),this.isDenoiserProcessed=!0}else this._log.warn("enableDenoiser failed, there is no audio")}))}disableDenoiser(){return _b(this,null,(function*(){this.isDenoiserEnabled&&(this.denoiserProcessor.disable(),this.isDenoiserEnabled=!1)}))}destroyDenoiserProcessor(){var e;this.denoiserProcessor&&(this.denoiserProcessor.destroy(),this.denoiserProcessor=null,this.isDenoiserInit=!1,this.isDenoiserEnabled=!1,this.isDenoiserProcessed=!1,null==(e=this.denoiserTrack)||e.stop(),this.denoiserTrack=null,this.originTrack=null)}destroy(){var e;this.removeAudioTrackSource("main"),this.removeAudioTrackSource("aux"),this.audioContext.close(),this.destroyAllMusic(),this.destroyAllCache(),this.destroyDenoiserProcessor(),null==(e=this.denoiser)||e.destroy()}},Lw=class extends JL{constructor(e,t,i){super({userId:t.userId,sdkAppId:e.sdkAppId,mediaType:i,room:e}),this.room=e,this.user=t,hb(this,"userId"),hb(this,"tinyId"),hb(this,"isRemote",!0),this.tinyId=t.tinyId,this.userId=t.userId}play(e,t){return this.hasFlag?super.play(e,t):(this.isPlayCalled=!0,this.container=e,e&&this.player.setContainer(e),Promise.resolve())}setMute(e){return this.hasFlag&&super.setMute(e)}setMediaStreamTrack(e){super.setMediaStreamTrack(e),this.mediaTrack&&this.hasFlag&&this.isSubscribed&&this.player.setTrack(this.mediaTrack)}get isSubscribing(){return"subscribeing"===this.state.toString()}get isSubscribed(){return this.state===Lw.STATE_SUBSCRIBE}get streamType(){return 0==(2&this.mediaType)?"main":"auxiliary"}subscribe(e){return e}unsubscribe(){this.player.setTrack(null),"main"===this.streamType&&"video"===this.kind&&this.room.changeType(!1,this.user)}onFlagChanged(){this.updatePlayingState(this.hasFlag),this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack)}},ww=Lw;hb(ww,"STATE_SUBSCRIBE","subscribe"),ub([qP(ZP.INIT,ww.STATE_SUBSCRIBE,{success(){this.log.info("subscribed"),this.mediaTrack&&this.hasFlag&&this.player.setTrack(this.mediaTrack),GO.emit(JO.REMOTE_TRACK_SUBSCRIBED,{track:this}),this.updatePlayingState(!0)},ignoreError:!0})],ww.prototype,"subscribe",1),ub([qP(ww.STATE_SUBSCRIBE,ZP.INIT,{success(){this.log.info("unsubscribed"),this.updatePlayingState(!1),GO.emit(JO.REMOTE_TRACK_UNSUBSCRIBED,{track:this})}})],ww.prototype,"unsubscribe",1);var Mw=class extends ww{constructor(e,t){super(e,t,1),hb(this,"volume",0),hb(this,"mediaType",1),hb(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,end2EndDelay:0,jitterBufferDelay:0})}getAudioLevel(){return this.volume||super.getAudioLevel()}get hasFlag(){return this.user.muteState.hasAudio&&!this.user.muteState.audioMuted}isFlagChanged(e){let t=e.hasAudio&&!e.audioMuted;return this.hasFlag||(this.volume=0),this.hasFlag!==t}},Vw=class extends ww{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:4),hb(this,"mediaType",4),hb(this,"stat",{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,end2EndDelay:0,jitterBufferDelay:0})}changeType(e){this.room.changeType(e,this.user)}get hasFlag(){return this.user.muteState.hasVideo&&!this.user.muteState.videoMuted}isFlagChanged(e){let t=e.hasVideo&&!e.videoMuted;return this.hasFlag!==t}},Uw=class extends Vw{constructor(e,t){super(e,t,2),hb(this,"mediaType",2),hb(this,"objectFit","contain")}get hasFlag(){return this.user.muteState.hasAuxiliary}isFlagChanged(e){let t=e.hasAuxiliary;return this.hasFlag!==t}};function xw(){}var Fw=e=>e(),Bw=()=>"undefined"!=typeof __FASTRX_DEVTOOLS__,Hw=1,jw=class extends Function{toString(){return"".concat(this.name,"(").concat(this.args.length?[...this.args].join(", "):"",")")}subscribe(e){let t=new Yw(e,this,this.streamId++);return zw.subscribe({id:this.id,end:!1},{nodeId:t.sourceId,streamId:t.id}),this(t),t}},Gw=class{constructor(){this.defers=new Set,this.disposed=!1}next(e){}complete(){this.dispose()}error(e){this.dispose()}get bindDispose(){return()=>this.dispose()}dispose(){this.disposed=!0,this.complete=xw,this.error=xw,this.next=xw,this.dispose=xw,this.subscribe=xw,this.doDefer()}subscribe(e){return e instanceof jw?e.subscribe(this):e(this),this}get bindSubscribe(){return e=>this.subscribe(e)}doDefer(){this.defers.forEach(Fw),this.defers.clear()}defer(e){this.defers.add(e)}removeDefer(e){this.defers.delete(e)}reset(){this.disposed=!1,delete this.complete,delete this.next,delete this.dispose,delete this.next,delete this.subscribe}resetNext(){delete this.next}resetComplete(){delete this.complete}resetError(){delete this.error}},Ww=class extends Gw{constructor(e){super(),this.sink=e,e.defer(this.bindDispose)}next(e){this.sink.next(e)}complete(){this.sink.complete()}error(e){this.sink.error(e)}};function Jw(e,t,i){if(Bw()){let n=Object.defineProperties(Object.setPrototypeOf(e,jw.prototype),{streamId:{value:0,writable:!0,configurable:!0},name:{value:t,writable:!0,configurable:!0},args:{value:i,writable:!0,configurable:!0},id:{value:0,writable:!0,configurable:!0}});zw.create(n);for(let e=0;e<i.length;e++){let t=i[e];"function"==typeof t&&t instanceof jw&&zw.addSource(n,t)}return n}return e}function Kw(e,t){window.postMessage({source:"fastrx-devtools-backend",payload:{event:e,payload:t}})}var Yw=class extends Ww{constructor(e,t,i){super(e),this.source=t,this.id=i,this.sourceId=e.sourceId,this.defer((()=>{zw.defer(this.source,this.id)}))}next(e){zw.next(this.source,this.id,e),this.sink.next(e)}complete(){zw.complete(this.source,this.id),this.sink.complete()}error(e){zw.complete(this.source,this.id,e),this.sink.error(e)}},zw={addSource(e,t){Kw("addSource",{id:e.id,name:e.toString(),source:{id:t.id,name:t.toString()}})},next(e,t,i){Kw("next",{id:e.id,streamId:t,data:i&&i.toString()})},subscribe(e,t){let{id:i,end:n}=e;Kw("subscribe",{id:i,end:n,sink:{nodeId:t&&t.nodeId,streamId:t&&t.streamId}})},complete(e,t,i){Kw("complete",{id:e.id,streamId:t,err:i?i.toString():null})},defer(e,t){Kw("defer",{id:e.id,streamId:t})},pipe(e){Kw("pipe",{name:e.toString(),id:e.id,source:{id:e.source.id,name:e.source.toString()}})},update(e){Kw("update",{id:e.id,name:e.toString()})},create(e){e.id||(e.id=Hw++),Kw("create",{name:e.toString(),id:e.id})}},qw=class extends Gw{constructor(e){super(),this.source=e,this.sinks=new Set}add(e){e.defer((()=>this.remove(e))),1===this.sinks.add(e).size&&(this.reset(),this.subscribe(this.source))}remove(e){this.sinks.delete(e),0===this.sinks.size&&this.dispose()}next(e){this.sinks.forEach((t=>t.next(e)))}complete(){this.sinks.forEach((e=>e.complete())),this.sinks.clear()}error(e){this.sinks.forEach((t=>t.error(e))),this.sinks.clear()}};var Qw,Xw,Zw=(Qw=class extends Ww{constructor(e,t,i){super(e),this.mapper=t,this.thisArg=i}next(e){super.next(this.mapper.call(this.thisArg,e))}},Xw="map",function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return e=>{if(e instanceof jw){let i=Jw((n=>{let r=new Qw(n,...t);r.sourceId=i.id,r.subscribe(e)}),Xw,arguments);return i.source=e,zw.pipe(i),i}return i=>e(new Qw(i,...t))}});!function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];i.reduce(((e,t)=>t(e)),e)}(function(e){return Jw((t=>{let i=0,n=setInterval((()=>t.next(i++)),e);return t.defer((()=>{clearInterval(n)})),"interval"}),"interval",arguments)}(250),Zw((()=>performance.now())),function(){return e=>{let t=new qw(e);if(e instanceof jw){let i=Jw((e=>{t.add(e)}),"share",arguments);return t.sourceId=i.id,i.source=e,zw.pipe(i),i}return Jw(t.add.bind(t),"share",arguments)}}());var $w=new Map;function eM(e,t){let i=ab(sb({},t),{timestamp:Cb()});$w.has(e)?$w.get(e).push(i):$w.set(e,[i])}GO.on(JO.JOIN_SUCCESS,(e=>{let{room:t}=e;eM(t.userId,{eventId:32788,eventDesc:"join room"})})),GO.on(JO.LEAVE_START,(e=>{let{room:t}=e;eM(t.userId,{eventId:32789,eventDesc:"leave room"})})),GO.on(JO.LOCAL_TRACK_PUBLISHED,(e=>{let{track:t}=e;if(t.room){let e=32769;4===t.mediaType?e=32768:2===t.mediaType&&(e=32805),eM(t.room.userId,{eventId:e,eventDesc:"publish ".concat(t.kind)})}})),GO.on(JO.LOCAL_TRACK_UNPUBLISHED,(e=>{let{track:t}=e;if(t.room){let e=32771;4===t.mediaType?e=32770:2===t.mediaType&&(e=32806),eM(t.room.userId,{eventId:e,eventDesc:"unpublish ".concat(t.kind)})}})),GO.on(JO.TRACK_MUTED,(e=>{let{track:t}=e;t.room&&(t.kind===HD.AUDIO?eM(t.room.userId,{eventId:t.isRemote?32785:32772,eventDesc:"mute audio",remoteUserId:t.isRemote?t.userId:void 0}):eM(t.room.userId,{eventId:t.isRemote?32784:32773,eventDesc:"mute video",remoteUserId:t.isRemote?t.userId:void 0}))})),GO.on(JO.TRACK_UNMUTED,(e=>{let{track:t}=e;t.room&&(t.kind===HD.AUDIO?eM(t.room.userId,{eventId:t.isRemote?32787:32774,eventDesc:"unmute audio",remoteUserId:t.isRemote?t.userId:void 0}):eM(t.room.userId,{eventId:t.isRemote?32786:32775,eventDesc:"unmute video",remoteUserId:t.isRemote?t.userId:void 0}))})),GO.on(JO.REMOTE_TRACK_SUBSCRIBED,(e=>{let{track:t}=e;!t.room||(1===t.mediaType&&eM(t.room.userId,{eventId:32777,eventDesc:"".concat(HD.SUBSCRIBE," ").concat(t.kind),remoteUserId:t.userId}),4===t.mediaType&&eM(t.room.userId,{eventId:32776,eventDesc:"".concat(HD.SUBSCRIBE," ").concat(t.kind),remoteUserId:t.userId}),8===t.mediaType&&eM(t.room.userId,{eventId:32803,eventDesc:"".concat(HD.SUBSCRIBE," ").concat(HD.SMALL_VIDEO),remoteUserId:t.userId}))})),GO.on(JO.REMOTE_TRACK_UNSUBSCRIBED,(e=>{let{track:t}=e;!t.room||(1===t.mediaType&&eM(t.room.userId,{eventId:32779,eventDesc:"".concat(HD.UNSUBSCRIBE," ").concat(t.kind),remoteUserId:t.userId}),4===t.mediaType&&eM(t.room.userId,{eventId:32778,eventDesc:"".concat(HD.UNSUBSCRIBE," ").concat(t.kind),remoteUserId:t.userId}),8===t.mediaType&&eM(t.room.userId,{eventId:32804,eventDesc:"".concat(HD.UNSUBSCRIBE," ").concat(HD.SMALL_VIDEO),remoteUserId:t.userId}))})),GO.on(JO.SWITCH_DEVICE_SUCCESS,(e=>{let{track:t}=e;t.room&&eM(t.room.userId,{eventId:t.kind===HD.VIDEO?32780:32781,eventDesc:"switch ".concat(t.kind===HD.VIDEO?"camera":"microphone")})})),GO.on(JO.LOCAL_TRACK_REPLACED,(e=>{let{track:t}=e;t.room&&eM(t.room.userId,{eventId:t.kind===HD.VIDEO?32782:32783,eventDesc:"replace ".concat(t.kind)})})),GO.on(JO.SIGNAL_CONNECTION_STATE_CHANGED,(e=>{let t,i,{room:n,prevState:r,state:o}=e;switch(o){case"CONNECTED":"RECONNECTING"===r?(t=32795,i="signal reconnected"):(t=32791,i="signal connected");break;case"DISCONNECTED":"RECONNECTING"===r?(t=32796,i="signal reconnect fail"):(t=32790,i="signal disconnected");break;case"RECONNECTING":t=32794,i="signal reconnecting"}t&&i&&eM(n.userId,{eventId:t,eventDesc:i})})),GO.on(JO.PEER_CONNECTION_STATE_CHANGED,(e=>{let t,i,{room:n,prevState:r,state:o,remoteUserId:s}=e,a=!!s,c=a?"downlink":"uplink";switch(o){case"CONNECTED":"RECONNECTING"===r?(t=a?32801:32798,i="".concat(c," reconnected")):(t=a?32793:32792,i="".concat(c," connected"));break;case"DISCONNECTED":"RECONNECTING"===r&&(t=a?32802:32799,i="".concat(c," reconnect fail"));break;case"RECONNECTING":t=a?32800:32797,i="".concat(c," reconnecting")}t&&i&&eM(n.userId,{eventId:t,eventDesc:i,remoteUserId:s})}));var tM=db(mb(),1),iM=class extends tM.EventEmitter{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"userId";super(),this.mySelfId=e,this._log=t,this.key=i,hb(this,"userMap",new Map),hb(this,"remotePublishedUserMap",new Map)}getPublishedUser(e){return this.remotePublishedUserMap.get(e)}addUser(e){let t=e[this.key],{userId:i,tinyId:n,role:r}=e;if(this.userMap.has(t))return;let o={userId:i,tinyId:n,role:20===r?"anchor":"audience"};this.userMap.set(t,o),this.emit("1",o)}deleteUser(e,t){let i=this.userMap.get(e);if(!i)return;let n="peer leave [".concat(e,"]");dO(t)||(n+=":".concat(VN[t])),this._log.info(n);let r=this.remotePublishedUserMap.get(e);if(r){let t=r.muteState;r.flag=0,this.emit("5",r.userId),this.deleteRemotePublishedUser(e),this.emit("6",{prevMuteState:t,muteState:r.muteState,flag:0})}this.userMap.delete(e),this.emit("2",i.userId)}setUserList(e){this.userMap.forEach((t=>{e.findIndex((e=>e[this.key]===t[this.key]))<0&&this.deleteUser(t[this.key],0)})),e.forEach((e=>{!this.userMap.has(e[this.key])&&e[this.key]!==this.mySelfId&&this.addUser(e)}))}addRemotePublishedUser(e){this.remotePublishedUserMap.has(e[this.key])||this.remotePublishedUserMap.set(e[this.key],e)}deleteRemotePublishedUser(e){!this.remotePublishedUserMap.has(e)||this.remotePublishedUserMap.delete(e)}setRemotePublishedUserList(e){this.remotePublishedUserMap.forEach((t=>{let i=t[this.key];if(e.findIndex((e=>e[this.key]===t[this.key]))<0){this._log.info("remote [".concat(i,"] unpublish"));let e=t.muteState;t.flag=0,this.emit("5",t.userId),this.deleteRemotePublishedUser(i),this.emit("6",{prevMuteState:e,muteState:t.muteState,flag:0})}})),e.forEach((e=>{var t;let i=e[this.key];if(i===this.mySelfId)return;let{flag:n,userId:r,tinyId:o}=e,s=kO(n,r),a=null==(t=this.remotePublishedUserMap.get(i))?void 0:t.muteState;if(a){let e=this.remotePublishedUserMap.get(i);e&&e.flag!==n&&(e.flag=n,this._log.info("remote publish updated: ".concat(JSON.stringify(e.muteState))),this.emit("6",{prevMuteState:a,muteState:s,flag:n}))}else this._log.info("remote publish. state: ".concat(JSON.stringify(s))),this.addUser({userId:r,tinyId:o,role:20}),this.emit("3",e),this.emit("6",{prevMuteState:kO(0,r),muteState:s,flag:n})}))}clear(){this.userMap.clear(),this.remotePublishedUserMap.clear()}};var nM,rM=!0,oM={SCENE_LIVE:"live",SCENE_RTC:"rtc",ROLE_ANCHOR:"anchor",ROLE_AUDIENCE:"audience",STREAM_TYPE_MAIN:"main",STREAM_TYPE_SUB:"sub",AUDIO_PROFILE_STANDARD:"standard",AUDIO_PROFILE_STANDARD_STEREO:"standard-stereo",AUDIO_PROFILE_HIGH:"high",AUDIO_PROFILE_HIGH_STEREO:"high-stereo",QOS_PREFERENCE_SMOOTH:"smooth",QOS_PREFERENCE_CLEAR:"clear"},sM={INVALID_PARAMETER:5e3,INVALID_OPERATION:5100,ENV_NOT_SUPPORTED:5200,DEVICE_ERROR:5300,SERVER_ERROR:5400,OPERATION_FAILED:5500,OPERATION_ABORT:5998,UNKNOWN_ERROR:5999},aM=((nM=aM||{})[nM.INVALID_PARAMETER=5e3]="INVALID_PARAMETER",nM[nM.INVALID_PARAMETER_REQUIRED=5001]="INVALID_PARAMETER_REQUIRED",nM[nM.INVALID_PARAMETER_TYPE=5002]="INVALID_PARAMETER_TYPE",nM[nM.INVALID_PARAMETER_EMPTY=5003]="INVALID_PARAMETER_EMPTY",nM[nM.INVALID_PARAMETER_INSTANCE=5004]="INVALID_PARAMETER_INSTANCE",nM[nM.INVALID_PARAMETER_RANGE=5005]="INVALID_PARAMETER_RANGE",nM[nM.INVALID_PARAMETER_LESS_THAN_ZERO=5006]="INVALID_PARAMETER_LESS_THAN_ZERO",nM[nM.INVALID_PARAMETER_MIN=5007]="INVALID_PARAMETER_MIN",nM[nM.INVALID_PARAMETER_MAX=5008]="INVALID_PARAMETER_MAX",nM[nM.INVALID_ELEMENT_ID=5009]="INVALID_ELEMENT_ID",nM[nM.INVALID_ELEMENT_ID_TYPE=5010]="INVALID_ELEMENT_ID_TYPE",nM[nM.INVALID_STREAM_ID=5011]="INVALID_STREAM_ID",nM[nM.INVALID_ROOM_ID_STRING=5012]="INVALID_ROOM_ID_STRING",nM[nM.INVALID_ROOM_ID_INTEGER=5013]="INVALID_ROOM_ID_INTEGER",nM[nM.INVALID_STREAM_TYPE=5014]="INVALID_STREAM_TYPE",nM[nM.INVALID_ROOM_ID_REQUIED=5015]="INVALID_ROOM_ID_REQUIED",nM[nM.INVALID_ROOM_ID_INTEGER_STRING=5016]="INVALID_ROOM_ID_INTEGER_STRING",nM[nM.INVALID_OPERATION=5100]="INVALID_OPERATION",nM[nM.INVALID_OPERATION_NOT_JOINED=5101]="INVALID_OPERATION_NOT_JOINED",nM[nM.INVALID_OPERATION_REMOTE_USER_NOT_EXIST=5102]="INVALID_OPERATION_REMOTE_USER_NOT_EXIST",nM[nM.INVALID_OPERATION_STREAM_TYPE_NOT_EXIST=5103]="INVALID_OPERATION_STREAM_TYPE_NOT_EXIST",nM[nM.INVALID_OPERATION_REPEAT_CALL=5104]="INVALID_OPERATION_REPEAT_CALL",nM[nM.ENV_NOT_SUPPORTED=5200]="ENV_NOT_SUPPORTED",nM[nM.NOT_SUPPORTED_HTTP=5201]="NOT_SUPPORTED_HTTP",nM[nM.NOT_SUPPORTED_WEBRTC=5202]="NOT_SUPPORTED_WEBRTC",nM[nM.NOT_SUPPORTED_H264_ENCODE=5203]="NOT_SUPPORTED_H264_ENCODE",nM[nM.NOT_SUPPORTED_H264_DECODE=5204]="NOT_SUPPORTED_H264_DECODE",nM[nM.NOT_SUPPORTED_SCREEN_SHARE=5205]="NOT_SUPPORTED_SCREEN_SHARE",nM[nM.NOT_SUPPORTED_SMALL_VIDEO=5206]="NOT_SUPPORTED_SMALL_VIDEO",nM[nM.NOT_SUPPORTED_SEI=5207]="NOT_SUPPORTED_SEI",nM[nM.DEVICE_ERROR=5300]="DEVICE_ERROR",nM[nM.DEVICE_NOT_FOUND_ERROR=5301]="DEVICE_NOT_FOUND_ERROR",nM[nM.DEVICE_NOT_ALLOWED_ERROR=5302]="DEVICE_NOT_ALLOWED_ERROR",nM[nM.DEVICE_NOT_READABLE_ERROR=5303]="DEVICE_NOT_READABLE_ERROR",nM[nM.DEVICE_OVERCONSTRAINED_ERROR=5304]="DEVICE_OVERCONSTRAINED_ERROR",nM[nM.DEVICE_INVALID_STATE_ERROR=5305]="DEVICE_INVALID_STATE_ERROR",nM[nM.DEVICE_SECURITY_ERROR=5306]="DEVICE_SECURITY_ERROR",nM[nM.DEVICE_ABORT_ERROR=5307]="DEVICE_ABORT_ERROR",nM[nM.CAMERA_RECOVER_FAILED=5308]="CAMERA_RECOVER_FAILED",nM[nM.MICROPHONE_RECOVER_FAILED=5309]="MICROPHONE_RECOVER_FAILED",nM[nM.SERVER_ERROR=5400]="SERVER_ERROR",nM[nM.ACCOUNT_NO_MONEY=-100013]="ACCOUNT_NO_MONEY",nM[nM.OPERATION_FAILED=5500]="OPERATION_FAILED",nM[nM.FIREWALL_RESTRICTION=5501]="FIREWALL_RESTRICTION",nM[nM.REJOIN_FAILED=5502]="REJOIN_FAILED",nM[nM.EVENT_HANDLER_ERROR=5503]="EVENT_HANDLER_ERROR",nM[nM.OPERATION_ABORT=5998]="OPERATION_ABORT",nM[nM.UNKNOWN_ERROR=5999]="UNKNOWN_ERROR",nM);var cM=ab(sb({},ZO),{INVALID_PARAMETER(e){let{fnName:t}=e;return"the parameters of the '".concat(t,"' you called does not meet the requirements, please check the API documentation.")},INVALID_PARAMETER_REQUIRED(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' is a required param when calling ").concat(n,"(), received: ").concat(r,".")},INVALID_PARAMETER_TYPE(e){let{key:t,rule:i,fnName:n,value:r}=e,o="".concat(t||i.name),s="";return s=Array.isArray(i.type)?i.type.join("|"):i.type,"'".concat(o,"' must be type of ").concat(s," when calling ").concat(n,"(), received type: ").concat(cO(r),".")},INVALID_PARAMETER_EMPTY(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' cannot be '").concat(r,"' when calling ").concat(n,"().")},INVALID_PARAMETER_INSTANCE(e){let{key:t,rule:i,fnName:n,value:r}=e,o="".concat(t||i.name),s="".concat(i.instanceOf.name||i.instanceOf);return"'".concat(o,"' must be instanceof ").concat(s," when calling ").concat(n,"(), received type: ").concat(cO(r),".")},INVALID_PARAMETER_RANGE(e){let{key:t,rule:i,fnName:n,value:r}=e;return"'".concat(t||i.name,"' must be one of ").concat(i.values.join("|")," when calling ").concat(n,"(), received: ").concat(r,".")},INVALID_PARAMETER_LESS_THAN_ZERO(e){let{key:t,rule:i,fnName:n}=e;return"'".concat(t||i.name,"' cannot be less than 0 when calling ").concat(n,"().")},INVALID_PARAMETER_MIN(e){let{key:t,rule:i,value:n}=e;return"the min value of ".concat(t||i.name," is ").concat(i.min,", received: ").concat(n,".")},INVALID_PARAMETER_MAX(e){let{key:t,rule:i,value:n}=e;return"the max value of ".concat(t||i.name," is ").concat(i.max,", received: ").concat(n,".")},INVALID_ELEMENT_ID(e){let{key:t,fnName:i}=e;return"'".concat(t,"' is not found in the document object when calling ").concat(i,"().")},INVALID_ELEMENT_ID_TYPE(e){let{key:t,fnName:i,type:n}=e;return"the element corresponding to '".concat(t,"' must be instanceof HTMLElement when calling ").concat(i,"(), received: ").concat(n,".")},INVALID_STREAM_ID(e){let{key:t}=e;return"'".concat(t,"' can only consist of uppercase and lowercase english letters (a-zA-Z), numbers (0-9), hyphens and underscores.")},INVALID_ROOM_ID_STRING(e){let{key:t}=e;return"'".concat(t,"' must be a valid string.")},INVALID_ROOM_ID_INTEGER(e){let{key:t}=e;return"'".concat(t,"' must be an integer between [1, 4294967294].")},INVALID_ROOM_ID_INTEGER_STRING(e){let{key:t}=e;return"'".concat(t,"' must be an integer but go a string, use 'parseInt' to convert it or use 'strRoomId' instead.")},INVALID_ROOM_ID_REQUIED:()=>"at least one of 'roomId'(between [1, 4294967294]) and 'strRoomId'(not empty) is required.",INVALID_STREAM_TYPE:e=>{let{fnName:t}=e;return"'streamType' is required when 'userId' is not '*', calling ".concat(t,"()")},MIX_PARAMS_USER_Z_ORDER(e){let{key:t}=e;return"'".concat(t,"' is required and must be between 1 and 15.")},MIX_PARAMS_VIDEO_FRAMERATE:"'config.videoFramerate' should be an integer between 0 and 30, excluding 0.",MIX_PARAMS_VIDEO_GOP:"'config.videoGOP' should be an integer between 1 and 8.",MIX_PARAMS_AUDIO_BITRATE:"'config.audioBitrate' should be an integer between 32 and 192.",MIX_PARAMS_NOT_SELF:"'config.mixUsers' must contain self.",MIX_PARAMS_USER_STREAM:"'config.videoWidth' and 'config.videoHeight' of output stream should be contain all mix stream.",INVALID_OPERATION(e){let{fnName:t}=e;return"the API '".concat(t,"' you called does not meet the requirements, please check the API documentation.")},INVALID_OPERATION_NOT_JOINED(e){let{fnName:t}=e;return"cannot ".concat(t," because you are not enter room yet.")},INVALID_OPERATION_REMOTE_USER_NOT_EXIST(e){let{fnName:t,value:i}=e;return"cannot ".concat(t," because remote user(userId: ").concat(i.userId,") does not publishing stream.")},INVALID_OPERATION_STREAM_TYPE_NOT_EXIST(e){let{fnName:t,value:i}=e;return"cannot ".concat(t," because remote user(userId: ").concat(i.userId,") does not publishing ").concat(i.streamType," video.")},INVALID_OPERATION_REPEAT_CALL(e){let{fnName:t}=e;return"you are already ".concat(t,"(), cannot repeated call '").concat(t,"'.")},ENV_NOT_SUPPORTED(e){let{fnName:t}=e;return"the current browser does not support the capability of the function '".concat(t,"' you are calling, please check the API documentation.")},NOT_SUPPORTED_WEBRTC:"the current browser does not support WebRTC capability, please check the SDK documentation.",NOT_SUPPORTED_H264_ENCODE:"this browser does not support H264 encode.",NOT_SUPPORTED_H264_DECODE:"this browser does not support H264 decode.",NOT_SUPPORTED_SCREEN_SHARE:"this browser does not support screen share, please check the browser version.",NOT_SUPPORTED_SMALL_VIDEO:"this browser does not support small video, please check the browser version.",NOT_SUPPORTED_SEI:"this browser does not support SEI, please check the browser version.",DEVICE_ERROR(e){let{fnName:t,error:i}=e;return"'".concat(t,"' got server exception").concat(i?", error: ".concat(i.toString(),"."):".")},DEVICE_NOT_FOUND_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"NotFoundError, no ".concat(i," detected, please check your device and the configuration on '").concat(t,"'").concat(n?", error: ".concat(n.toString(),"."):".")},DEVICE_NOT_ALLOWED_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"NotAllowedError, you have disabled ".concat(i," access, please allow the current application to use the ").concat(i).concat(n?", error: ".concat(n.toString(),"."):".")},DEVICE_NOT_READABLE_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"NotReadableError, the ".concat(i," maybe in use by another APP, please check if the device is pre-occupied by another APP.")},DEVICE_OVERCONSTRAINED_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"OverconstrainedError, the device ID is incorrect, please check whether the device ID passed in is correct".concat(n?", error: ".concat(n.toString(),"."):".")},DEVICE_INVALID_STATE_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"InvalidStateError, after the user clicks and interacts with the page, turn on the ".concat(i).concat(n?", error: ".concat(n.toString(),"."):".")},DEVICE_SECURITY_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"SecurityError, check whether the system security policy restricts the use of the ".concat(i,", and it is recommended to turn on the ").concat(i," after the user interacts with the page").concat(n?", error: ".concat(n.toString(),"."):".")},DEVICE_ABORT_ERROR(e){let{fnName:t,deviceType:i=lM(t),error:n}=e;return"AbortError, an unknown exception in the system makes the device unusable, recommended to change the device or browser and re-check whether the device is normal".concat(n?" error: ".concat(n.toString(),"."):".")},CAMERA_RECOVER_FAILED(e){let{error:t}=e;return"camera recover capture failed ".concat((null==t?void 0:t.name)||"",": ").concat((null==t?void 0:t.originMessage)||(null==t?void 0:t.message))},MICROPHONE_RECOVER_FAILED(e){let{error:t}=e;return"microphone recover capture failed ".concat((null==t?void 0:t.name)||"",": ").concat((null==t?void 0:t.originMessage)||(null==t?void 0:t.message))},OPERATION_FAILED(e){let{fnName:t,error:i}=e;return"'".concat(t,"' failed, reason: ").concat(null==i?void 0:i.toString())},FIREWALL_RESTRICTION:()=>"media connection failure due to firewall restrictions, please try to change your network.",EVENT_HANDLER_ERROR(e){let{eventName:t}=e;return"an error was caught on trtc.on('".concat(t,"', handler), please check your code on 'handler'.")},SERVER_ERROR(e){let{fnName:t,error:i}=e;return"'".concat(t,"' got server error: ").concat(null==i?void 0:i.toString(),", please check the SDK documentation.")},ACCOUNT_NO_MONEY:e=>{let{fnParams:t}=e;return"your TRTC account run out of credit, please recharge.".concat(t.sdkAppId?" SDKAppId: ".concat(t.sdkAppId):"")},OPERATION_ABORT(e){let{fnName:t}=e;return"'".concat(t,"' abort")},UNKNOWN_ERROR(e){let{fnName:t,error:i}=e;return"'".concat(t,"' throw unknown exception").concat(i?", error: ".concat(i.toString(),"."):".")}});function lM(e){if(!e)return"camera";let t=e.toLowerCase();return t.includes("screen")?"screen share":t.includes("audio")?"microphone":"camera"}var dM=class extends Error{constructor(e){let t,{code:i,extraCode:n,message:r="",messageParams:o,fnName:s="",originError:a}=e;t=r||function(e){let t,{code:i,params:n,enableDocLink:r=!1}=e,o="",a=aM[i];try{t=cM[a]}catch(s){t=cM.UNKNOWN_ERROR}return lO(t)?o=t(n):uO(t)&&(o=t),r&&(o+=" doc:"),o}({code:n||i,params:sb({fnName:s,error:a},o)}),super(t),hb(this,"name","RtcError"),hb(this,"code"),hb(this,"extraCode"),hb(this,"functionName"),hb(this,"message"),hb(this,"originError"),this.name=aM[i],this.code=i,this.extraCode=n,this.functionName=s,this.originError=a,this.message=t}static convertFrom(e,t,i){let n=e;if(e instanceof vb){let{stack:r}=e,o={code:sM.UNKNOWN_ERROR,fnName:t,originError:e};switch(e.getCode()){case Ab.INVALID_PARAMETER:o.code=sM.INVALID_PARAMETER;break;case Ab.INVALID_OPERATION:o.code=sM.INVALID_OPERATION;break;case Ab.NOT_SUPPORTED:case Ab.NOT_SUPPORTED_H264:o.code=sM.ENV_NOT_SUPPORTED,e.getCode()===Ab.NOT_SUPPORTED_H264&&(o.extraCode=e.message.includes(ZO.NOT_SUPPORTED_H264ENCODE)?5203:5204);break;case Ab.DEVICE_NOT_FOUND:case Ab.DEVICE_AUTO_RECOVER_FAILED:o.code=sM.DEVICE_ERROR;break;case Ab.JOIN_ROOM_FAILED:o.messageParams={fnParams:i};case Ab.SERVER_TIMEOUT:case Ab.SWITCH_ROLE_FAILED:o.code=sM.SERVER_ERROR,o.extraCode=e.getExtraCode();break;case Ab.API_CALL_ABORTED:o.code=sM.OPERATION_ABORT;break;case Ab.INITIALIZE_FAILED:o.code=5300,o.extraCode=function(e){let t;switch(e){case"NotFoundError":t=5301;break;case"NotAllowedError":t=5302;break;case"NotReadableError":t=5303;break;case"OverconstrainedError":t=5304;break;case"InvalidStateError":t=5305;break;case"SecurityError":t=5306;break;case"AbortError":t=5307;break;default:t=5300}return t}(e.name);break;case Ab.UNKNOWN:break;default:o.code=sM.OPERATION_FAILED}n=new dM(o),r&&(n.stack+=r.substr(r.indexOf("\n")))}else n=new dM({code:sM.UNKNOWN_ERROR,fnName:t,originError:e});return n}};var uM=dM,hM={type:"object",properties:{cameraId:{type:"string"},useFrontCamera:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"},small:{properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack}}},pM={type:"object",properties:{systemAudio:{type:"boolean"},fillMode:{type:"string",values:["contain","cover","fill"]},profile:{type:["string","object"],properties:{width:{type:"number"},height:{type:"number"},frameRate:{type:"number"},bitrate:{type:"number"}}},videoTrack:{instanceOf:MediaStreamTrack},audioTrack:{instanceOf:MediaStreamTrack}}},_M={type:["string",HTMLElement,null,"array"],arrayItem:{instanceOf:HTMLElement},validate(e,t,i){if(uO(e)){let n=document.getElementById(e);if(!n)throw new uM({code:sM.INVALID_PARAMETER,extraCode:5009,fnName:i,messageParams:{key:t}});if(!(n instanceof HTMLElement))throw new uM({code:sM.INVALID_PARAMETER,extraCode:5010,fnName:i,messageParams:{key:t,type:cO(n)}})}}},mM={name:"userId",required:!0,type:"string"},fM={type:"object",properties:{microphoneId:{type:"string"},audioTrack:{instanceOf:MediaStreamTrack},captureVolume:{type:"number",min:0,max:100},earMonitorVolume:{type:"number",min:0,max:100},echoCancellation:{type:"boolean"},autoGainControl:{type:"boolean"},noiseSuppression:{type:"boolean"}}};function gM(e,t){if(!e)throw new uM({code:sM.INVALID_OPERATION,extraCode:5101,fnName:t})}function TM(e,t,i){if(!e)throw new uM({code:sM.INVALID_OPERATION,extraCode:5102,fnName:t,messageParams:{value:i}})}var EM={create:[{name:"RoomConfig",instanceOf:Function},{name:"CreateConfig",type:"object",properties:{plugins:{type:"array",arrayItem:{instanceOf:Function}}}}],enterRoom:{name:"EnterRoomConfig",type:"object",required:!0,validate(e,t,i){if(this._room.isJoined)throw new uM({code:sM.INVALID_OPERATION,extraCode:5104,fnName:i});if(e.roomId){if(uO(e.roomId))throw new uM({code:sM.INVALID_PARAMETER,extraCode:5016,fnName:i,messageParams:{key:t}});if(!(/^[1-9]\d*$/.test(String(e.roomId))&&e.roomId<4294967295))throw new uM({code:sM.INVALID_PARAMETER,extraCode:5013,fnName:i,messageParams:{key:t}})}else{if(!e.strRoomId)throw new uM({code:sM.INVALID_PARAMETER,extraCode:5015,fnName:i});if(!/^[A-Za-z\d\s!#$%&()+\-:;<=.>?@[\]^_{}|~,]{1,64}$/.test(e.strRoomId))throw new uM({code:sM.INVALID_PARAMETER,extraCode:5012,fnName:i,messageParams:{key:t}})}},properties:{sdkAppId:{required:!0,type:"number",allowEmpty:!1},userId:{required:!0,type:"string",allowEmpty:!1},userSig:{required:!0,type:"string",allowEmpty:!1},scene:{type:"string",values:["live","rtc"]},role:{type:"string",values:["audience","anchor"]},roomId:{type:["string","number"]},strRoomId:{type:"string"},proxy:{type:["object","string"],properties:{websocketProxy:{type:"string"},turnServer:{type:["object","array"],properties:{url:{required:!0,type:"string"},username:{type:"string"},credential:{type:"string"},credentialType:{type:"string",values:["password"]}}},loggerProxy:{type:"string"},webtransportProxy:{type:"string"}}},enableAutoPlayDialog:{type:"boolean"},userDefineRecordId:{type:"string"}}},startLocalVideo:{name:"LocalVideoConfig",type:"object",properties:{view:_M,publish:{type:"boolean"},option:hM},validate(e){var t;if((null==(t=null==e?void 0:e.option)||!t.videoTrack)&&hP())throw new uM({code:sM.ENV_NOT_SUPPORTED,extraCode:5201})}},updateLocalVideo:{name:"updateLocalVideoConfig",type:"object",required:!0,properties:{view:ab(sb({},_M),{required:!1}),publish:{type:"boolean"},mute:{type:"boolean"},option:hM}},startLocalAudio:{name:"LocalAudioConfig",type:"object",properties:{publish:{type:"boolean"},option:fM},validate(e){var t;if((null==(t=null==e?void 0:e.option)||!t.audioTrack)&&hP())throw new uM({code:sM.ENV_NOT_SUPPORTED,extraCode:5201})}},updateLocalAudio:{name:"updateLocalAudioConfig",type:"object",required:!0,properties:{publish:{type:"boolean"},mute:{type:"boolean"},option:fM}},startScreenShare:{name:"ScreenShareConfig",type:"object",properties:{view:_M,publish:{type:"boolean"},option:pM},validate(e,t,i,n,r){var o;if((null==(o=null==e?void 0:e.option)||!o.videoTrack)&&hP())throw new uM({code:sM.ENV_NOT_SUPPORTED,extraCode:5201});if(!TP())throw new uM({code:sM.ENV_NOT_SUPPORTED,fnName:i,extraCode:5205})}},updateScreenShare:{name:"updateScreenShareConfig",type:"object",required:!0,properties:{view:_M,publish:{type:"boolean"},option:pM}},muteRemoteAudio:[mM,{name:"mute",required:!0,type:"boolean"}],setRemoteAudioVolume:[mM,{name:"volume",required:!0,type:"number",min:0}],startRemoteVideo:{name:"startRemoteVideoConfig",type:"object",required:!0,properties:{view:_M,userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(e,t,i){gM(this._room.isJoined,i);let n=this._room.remotePublishedUserMap.get(e.userId);if(TM(!!n,i,e),n&&("main"===e.streamType&&!n.muteState.videoAvailable||"sub"===e.streamType&&!n.muteState.hasAuxiliary))throw new uM({code:sM.INVALID_OPERATION,extraCode:5103,fnName:i,messageParams:{value:e}})}},updateRemoteVideo:{name:"updateRemoteVideoConfig",type:"object",required:!0,properties:{view:ab(sb({},_M),{required:!1}),userId:{type:"string",required:!0},streamType:{values:["main","sub"],required:!0},option:{type:"object",properties:{fillMode:{type:"string",values:["contain","cover","fill"]},mirror:{type:"boolean"}}}},validate(e,t,i){gM(this._room.isJoined,i);let n=this._room.remotePublishedUserMap.get(e.userId);if(TM(!!n,i,e),n&&("main"===e.streamType&&!n.muteState.videoAvailable||"sub"===e.streamType&&!n.muteState.hasAuxiliary))throw new uM({code:sM.INVALID_OPERATION,extraCode:5103,fnName:i,messageParams:{value:e}})}},stopRemoteVideo:{name:"stopRemoteVideoConfig",type:"object",required:!0,properties:{userId:{type:"string",required:!0},streamType:{values:["main","sub"]}},validate(e,t,i){if("*"!==e.userId&&dO(e.streamType))throw new uM({code:sM.INVALID_PARAMETER,extraCode:5014,fnName:i})}},switchRole:{name:"role",required:!0,values:["anchor","audience"],validate(e,t,i){gM(this._room.isJoined,i)}},enableAudioVolumeEvaluation:[{name:"interval",type:"number"},{name:"enableInBackground",type:"boolean"}],sendSEIMessage:[{name:"buffer",required:!0,instanceOf:ArrayBuffer,validate(e,t,i,n){if(!UP)throw new uM({code:sM.ENV_NOT_SUPPORTED,fnName:i,extraCode:5207});if(!this._room.enableSEI)throw new uM({code:sM.INVALID_OPERATION,messageParams:{key:XO.SEI_DISABLED}});if(e.byteLength>1e3)throw new uM({code:sM.INVALID_PARAMETER,messageParams:{key:XO.SEI_OVERSIZE,data:e.byteLength}});if(0===e.byteLength)throw new uM({code:sM.INVALID_PARAMETER,messageParams:{key:XO.SEI_EMPTY}});if(gM(this._room.isJoined,i),!this._room.isMainStreamPublished)throw new uM({code:sM.INVALID_PARAMETER,messageParams:{key:XO.SEI_BEFORE_PUBLISH}})}},{name:"options",type:"object",properties:{seiPayloadType:{type:"number",values:[5,243]}}}]},IM={TRTC:EM},SM=class extends Error{};function AM(e,t){let i=[];return LO(i,e),LO(i,t),i}function yM(e){this._resolve=Promise.resolve(e)}function vM(e){this._reject=Promise.reject(e)}var RM=class{constructor(e,t){this.instance=e,this.group=t,this.started=!1,this.ops=[],this.startSame=()=>!0,this.mergeUpdate=AM;let i=RM.instances.get(e);i?i.set(t,this):RM.instances.set(e,new Map([[t,this]]))}static get(e,t){let i=RM.instances.get(e);return i&&i.get(t)||new RM(e,t)}action(e,t,i){let n=t=>{var i;return 0===e?this.started=!0:3===e&&(this.started=!1),this.ops.shift(),null==(i=this.currentOp)||i.action(),t},r=t=>{var i,n;throw this.ops.shift(),0===e&&2===(null==(i=this.currentOp)?void 0:i.type)&&this.ops.shift().reject(new SM("start failed")),null==(n=this.currentOp)||n.action(),t},o={type:e,action:()=>t(...o.args).then(n,r),args:i,resolve:yM,reject:vM};try{switch(this.state){case 1:if(0===e)throw new SM("already started");break;case 4:if(2===e)throw new SM("not started");break;default:return this.cacheOp(o)}}catch(BU){return Promise.reject(BU)}return this.ops.push(o),o.promise=t(...o.args).then(n,r)}cacheOp(e){if(1===this.ops.length)switch(this.state){case 0:case 2:if(0===e.type)throw new SM("already start");break;case 3:switch(e.type){case 2:throw new SM("update not allowed when stopping");case 3:return this.currentOp.promise}break;default:throw new SM("unknown state")}else switch(e.type){case 3:if(3===this.lastOpType)return this.lastOp.promise;{let e=new SM("keep stop");if(this.ops.slice(1).forEach((t=>t.reject(e))),this.ops=this.ops.slice(0,1),3===this.state)return this.currentOp.promise}break;case 2:switch(this.lastOpType){case 2:return this.lastOp.args=this.mergeUpdate(this.lastOp.args,e.args),this.lastOp.promise;case 3:throw new SM("update not allowed after stop")}break;case 0:switch(this.lastOpType){case 2:throw new SM("start not allowed after update");case 0:throw new SM("duplicate start");case 3:if(this.startSame(this.currentOp.args,e.args))throw this.ops.pop().reject(new SM("keep start")),new SM("already start")}}e.promise=new Promise(((t,i)=>{e._resolve?e._resolve.then(t):e.resolve=t,e._reject?e._reject.catch(i):e.reject=i}));let{action:t}=e;return e.action=()=>t().then(e.resolve,e.reject),this.ops.push(e),e.promise}get lastOp(){return this.ops[this.ops.length-1]}get lastOpType(){return this.lastOp.type}get currentOp(){return this.ops[0]}get state(){return this.currentOp?this.currentOp.type:this.started?1:4}},CM=RM;CM.instances=new WeakMap;var bM=(e,t)=>{if(t instanceof SM){let{stack:i}=t;t=new uM({code:sM.OPERATION_ABORT,message:"".concat(e," abort: ").concat(t.message),fnName:e}),i&&(t.stack+=i.substr(i.indexOf("\n")))}throw t};function kM(e,t){return hw(((i,n)=>function(){for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];let a=CM.get(this,"string"==typeof e?e:e.call(this,...o));return t&&(a.startSame=t.bind(this)),a.action(0,i.bind(this),o).catch(bM.bind(null,n))}))}function DM(e,t){return hw(((i,n)=>function(){for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];let a=CM.get(this,"string"==typeof e?e:e.call(this,...o));return t&&(a.mergeUpdate=t.bind(this)),a.action(2,i.bind(this),o).catch(bM.bind(null,n))}))}function NM(e){return hw(((t,i)=>function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return CM.get(this,"string"==typeof e?e:e.call(this,...r)).action(3,t.bind(this),r).catch(bM.bind(null,i))}))}var OM={ERROR:"error",AUTOPLAY_FAILED:"autoplay-failed",KICKED_OUT:"kicked-out",REMOTE_USER_ENTER:"remote-user-enter",REMOTE_USER_EXIT:"remote-user-exit",REMOTE_AUDIO_AVAILABLE:"remote-audio-available",REMOTE_AUDIO_UNAVAILABLE:"remote-audio-unavailable",REMOTE_VIDEO_AVAILABLE:"remote-video-available",REMOTE_VIDEO_UNAVAILABLE:"remote-video-unavailable",AUDIO_VOLUME:"audio-volume",NETWORK_QUALITY:"network-quality",CONNECTION_STATE_CHANGED:"connection-state-changed",AUDIO_PLAY_STATE_CHANGED:"audio-play-state-changed",VIDEO_PLAY_STATE_CHANGED:"video-play-state-changed",SCREEN_SHARE_STOPPED:"screen-share-stopped",DEVICE_CHANGED:"device-changed",PUBLISH_STATE_CHANGED:"publish-state-changed",SEI_MESSAGE:"sei-message"};function PM(e){return e===oM.QOS_PREFERENCE_CLEAR?"detail":e===oM.QOS_PREFERENCE_SMOOTH?"motion":""}function LM(e){return{room:e,innerEmitter:GO,constants:lD,environment:Db,utils:kb,eventLogger:sL,log:e.getLogger(),clearStarted(t,i){let n=t.getAlias(),r=CM.instances.get(e);if(r)if(i){let e=r.get(n+i);if(!e)return;e.started=!1}else r.forEach(((e,t)=>{t.startsWith(n)&&(e.started=!1)}))}}}var wM=new WeakMap;function MM(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return hw(((e,i)=>function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];try{UM.call(this,t,r,i,this._name)}catch(_D){return Promise.reject(_D)}return e.apply(this,r)}))}function VM(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return hw(((e,i)=>function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];try{UM.call(this,t,r,i,this._name)}catch(_D){throw _D}return e.apply(this,r)}))}function UM(e,t,i,n){if(mO(e))for(let r=0;r<e.length;r++)xM.call(this,{rule:e[r],value:t[r],key:e[r].name,fnName:i,className:n});else xM.call(this,{rule:e,value:t[0],key:e.name,fnName:i,className:n})}function xM(e){let{rule:t,value:i,key:n,fnName:r,className:o}=e;function s(e){return{code:sM.INVALID_PARAMETER,extraCode:e,fnName:r,messageParams:{key:n,rule:t,value:i}}}if(dO(i)){if(t.required)throw new uM(s(5001));if(dO(t.defaultValue))return void(lO(t.validate)&&t.validate.call(this,i,n,r,o,this));i=t.defaultValue}if(Array.isArray(t.type)){let e=!1;for(let n=0;n<t.type.length;n++)null===t.type[n]&&null===i&&(e=!0),lO(t.type[n])&&i instanceof t.type[n]&&(e=!0),uO(t.type[n])&&cO(i)===t.type[n].toLowerCase()&&(e=!0);if(!e)throw new uM({code:sM.INVALID_PARAMETER,extraCode:5002,fnName:r,messageParams:{key:n,rule:{type:t.type.map((e=>EO(e)?IO(e):uO(e)?e:cO(e)))},value:i}})}else if(!dO(t.type)&&cO(i)!==t.type)throw new uM(s(5002));if(!1===t.allowEmpty){let e=hO(i)&&(0===i||Number.isNaN(i)),t=uO(i)&&""===i.trim();if(e||t)throw new uM(s(5003))}if(t.notLessThanZero&&hO(i)&&i<0)throw new uM(s(5006));if(!dO(t.min)&&hO(i)&&i<t.min)throw new uM(s(5007));if(!dO(t.max)&&hO(i)&&i>t.max)throw new uM(s(5008));if(uO(t.instanceOf)){if(!i||i._name!==t.instanceOf)throw new uM(s(5004))}else if(lO(t.instanceOf)&&!(i instanceof t.instanceOf))throw new uM(s(5004));if(Array.isArray(t.values)&&!t.values.includes(i))throw new uM(s(5005));let{properties:a}=t;oO(a)&&_O(i)&&Object.keys(a).forEach((e=>{xM.call(this,{rule:a[e],value:i&&i[e],key:"".concat(e),fnName:r,className:o})}));let{arrayItem:c}=t;oO(c)&&mO(i)&&i.forEach(((e,t)=>{xM.call(this,{rule:c,value:e,key:"".concat(n,"[").concat(t,"]"),fnName:r,className:o})})),lO(t.validate)&&t.validate.call(this,i,n,r,o,this)}function FM(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>"";return hw(((t,i)=>function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];let s=this._log||loggerManager;r.length>0?s.info("".concat(i,"() ").concat(JSON.stringify(r,((e,t)=>{if(t===r||e in r)return t;try{return t instanceof HTMLElement?"id: ".concat(t.id," type:").concat(cO(t)):(JSON.stringify(t),t)}catch(BU){return"type:".concat(cO(t))}})))):s.info("".concat(i,"()"));try{let n=t.apply(this,r),o=yO();return TO(n)?n.then((t=>(s.info("".concat(i,"() success ").concat(e.call(this,...r))),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:i,cost:yO()-o}),t))).catch((t=>{throw t=uM.convertFrom.call(this,t,i,1===r.length?r[0]:r),s.error("".concat(i,"() failed ").concat(e.call(this,...r)," ").concat(t)),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:i,error:t}),t})):(GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:i,cost:yO()-o}),n)}catch(a){throw a=uM.convertFrom.call(this,a,i),s.error("".concat(i,"() failed ").concat(a)),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:i,error:a}),a}}))}var BM=e=>hw(((t,i)=>function(n,r){return _b(this,null,(function*(){let o=this._plugins.get(n);if(o)return UM.call(this,o.getValidateRule(e),[r],i,"TRTC"),t.call(this,o,r);this._log.warn("plugin ".concat(n," is not found"))}))})),HM=class{constructor(e){this.core=e,this.core=e}getName(){return"AudioMixer"}getAlias(){return"ax"}getGroup(e){return null==e?void 0:e.id}getValidateRule(e){switch(e){case"start":return HM.startValidateRule;case"update":return HM.updateValidateRule;case"stop":return HM.stopValidateRule}}start(e){return _b(this,null,(function*(){let{room:t}=this.core;if(yield t.audioManager.addMusicSource(e),t.isJoined)for(let e of t.localTracks)e instanceof mw&&(yield t.replaceTrack(e))}))}update(e){return _b(this,null,(function*(){let{room:t}=this.core;yield t.audioManager.updateMusicSource(e)}))}stop(e){return _b(this,null,(function*(){let{room:t}=this.core;yield t.audioManager.removeMusicSource(e)}))}},jM=HM;hb(jM,"startValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},url:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"}},validate(e,t,i){if("*"!==e.url){let t=["mp3","ogg","wav","flac"],n=e.url.split(".").pop(),r=t.indexOf(n)>=0,o=e.url.startsWith("blob"),s=e.url.startsWith("data");if(!(r||o||s))throw new uM({code:sM.INVALID_PARAMETER,message:"start audioMixer plugin: music url is invalid, please check your file format.",fnName:i})}}}),hb(jM,"updateValidateRule",{name:"options",required:!0,type:"object",properties:{id:{type:"string",required:!0},loop:{type:"boolean"},volume:{type:"number"},seekFrom:{type:"number"},operation:{type:"string",values:["pause","resume","stop"]}}}),hb(jM,"stopValidateRule",{name:"options",type:"object",required:!0,properties:{id:{type:"string",required:!0}}});var GM=class{constructor(e){this.core=e,this.core=e}getName(){return"AIDenoiser"}getAlias(){return"ad"}getGroup(e){return"AIDenoiser_".concat(Date.now())}getValidateRule(e){switch(e){case"start":return GM.startValidateRule;case"update":return GM.updateValidateRule;case"stop":return GM.stopValidateRule}}start(e){return _b(this,null,(function*(){let{room:t}=this.core,{assetsPath:i,sdkAppId:n,userId:r,userSig:o}=e;if(i&&!t.audioManager.isDenoiserInit)try{yield t.audioManager.initDenoiser({assetsPath:i,sdkAppId:n,userId:r,userSig:o})}catch(BU){if(BU.message)throw new vb({code:Ab.INVALID_PARAMETER,message:BU.message})}if(yield t.audioManager.enableDenoiser(e),t.isJoined)for(let e of t.localTracks)e instanceof mw&&(yield t.replaceTrack(e))}))}update(e){return _b(this,null,(function*(){}))}stop(e){return _b(this,null,(function*(){let{room:e}=this.core;yield e.audioManager.disableDenoiser()}))}},WM=GM;hb(WM,"startValidateRule",{name:"options",required:!0,type:"object",properties:{assetsPath:{type:"string",required:!0},sdkAppId:{type:"number",required:!0},userId:{type:"string",required:!0},userSig:{type:"string",required:!0}}}),hb(WM,"updateValidateRule",{type:"object"}),hb(WM,"stopValidateRule",{type:"object"});var JM=0,KM=new Set,YM=null;hD("5.1.3");var zM=class extends Ib.EventEmitter{constructor(e,t){super(),hb(this,"_room"),hb(this,"_eventListened",new Set),hb(this,"_localVideoTrack",null),hb(this,"_localAudioTrack",null),hb(this,"_localScreenTrack",null),hb(this,"_localScreenAudioTrack",null),hb(this,"_localVideoConfig",null),hb(this,"_localScreenConfig",null),hb(this,"_localAudioConfig",null),hb(this,"_remoteVideoConfigMap",new Map),hb(this,"_remoteAudioConfigMap",new Map),hb(this,"_remoteAudioMuteMap",new Map),hb(this,"_log",YO.createLogger({id:"t".concat(++JM)})),hb(this,"_plugins",new Map),this._room=new e(sb({logger:this._log,frameWorkType:zM.frameWorkType},t)),t.plugins&&t.plugins.forEach((e=>{let t=new e(LM(this._room));this._plugins.set(t.getName(),t)}));let i=new jM(LM(this._room));this._plugins.set(i.getName(),i);let n=new WM(LM(this._room));this._plugins.set(n.getName(),n),this._room.on("audio-volume",(e=>{!e.find((e=>""===e.userId))&&this._localAudioTrack&&e.push({userId:"",volume:Math.floor(100*this._localAudioTrack.getAudioLevel())}),this.emit(OM.AUDIO_VOLUME,{result:e.sort(((e,t)=>t.volume-e.volume))})})),this.on(OM.REMOTE_AUDIO_UNAVAILABLE,(e=>{let{userId:t}=e;this._stopRemoteAudio({userId:t},!1).catch((()=>{}))})),this.on(OM.REMOTE_VIDEO_UNAVAILABLE,(e=>{let{userId:t,streamType:i}=e;this._stopRemoteVideo({userId:t,streamType:i},!1).catch((()=>{}))})),NL(ZL,ZL).add("audioInputAdded",(e=>{this.emit(OM.DEVICE_CHANGED,{type:"microphone",action:"add",device:e})})).add("audioInputRemoved",(e=>{this.emit(OM.DEVICE_CHANGED,{type:"microphone",action:"remove",device:e})})).add("videoInputAdded",(e=>{this.emit(OM.DEVICE_CHANGED,{type:"camera",action:"add",device:e})})).add("videoInputRemoved",(e=>{this.emit(OM.DEVICE_CHANGED,{type:"camera",action:"remove",device:e})})).add("audioOutputAdded",(e=>_b(this,null,(function*(){if(this.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"add",device:e}),YM&&YM.deviceId===LN){let e=(yield iw()).find((e=>e.deviceId===LN));e&&YM.groupId!==e.groupId&&(YM=e,this.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"active",device:e}))}})))).add("audioOutputRemoved",(e=>_b(this,null,(function*(){this.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"remove",device:e});let t=(yield iw())[0];t&&YM&&(YM.deviceId===e.deviceId||YM.deviceId===LN&&YM.groupId!==t.groupId)&&(YM=t,this.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"active",device:t}))})))),((e,t)=>{let{emit:n}=e;e.emit=function(){for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];try{return n.apply(e,o)}catch(i){let n=rP({key:XO.CATCH_HANDLER_ERROR,data:{name:t,event:o[0]},addDocLink:!1});return YO.warn("".concat(n,"\n\n").concat(i.stack)),!1}}})(this,"trtc")}static create(e){}static _create(e,t){!function(){var e;rM&&(rM=!1,5!==YO.getLogLevel()&&(console.info("******************************************************************************"),console.info("*   TRTC Web SDK"),console.info("*   API Document: ".concat(RD,"/en/index.html")),console.info("*   Changelog: ".concat(RD,"/en/tutorial-01-info-changelog.html")),console.info("*   Report issues: https://github.com/LiteAVSDK/TRTC_Web/issues"),console.info("******************************************************************************")),YO.info("TRTC Web SDK Version:",uD),YO.info("UA:",navigator.userAgent),YO.info("URL: ".concat(location.href).concat("IFRAME"===(null==(e=self.frameElement)?void 0:e.tagName)?" in iframe":"")),oD().then((e=>{if(e){let t="UAData: ".concat(e.platform,"/").concat(e.platformVersion);e.architecture&&e.bitness&&(t+=" ".concat(e.architecture,"/").concat(e.bitness)),e.mobile&&(t+=" mobile"),e.model&&(t+=" model: ".concat(e.model)),e.fullVersionList&&(t+=" ".concat(e.fullVersionList.filter((e=>"Not/A)Brand"!==e.brand)).map((e=>"".concat(e.brand,"/").concat(e.version))).join(","))),YO.info(t)}})))}();let i=new zM(e,t||{});return KM.add(i),YM?i.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"active",device:YM}):iw().then((e=>{e[0]&&(YM=e[0],i.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"active",device:e[0]}))})),i}enterRoom(e){return _b(this,null,(function*(){var t,i;let{scene:n="rtc",enableAutoPlayDialog:r=!0,autoReceiveAudio:o=!0,autoReceiveVideo:s=!0}=e;e.proxy&&(this._room.setProxyServer(e.proxy),!uO(e.proxy)&&e.proxy.turnServer&&(null==(i=(t=this._room).setTurnServer)||i.call(t,e.proxy.turnServer,e.proxy.iceTransportPolicy))),this._room.enableAutoPlayDialog=r,this._room.autoReceiveAudio=o,this._room.autoReceiveVideo=s,pO(e.enableHWEncoder)&&(this._room.enableHWEncoder=e.enableHWEncoder);let a={sdkAppId:e.sdkAppId,userId:e.userId,userSig:e.userSig,privateMapKey:e.privateMapKey||null,role:"audience"===e.role?21:20,roomId:e.roomId||0,strRoomId:e.strRoomId||"",businessInfo:e.businessInfo||null,streamId:null,userDefineRecordId:e.userDefineRecordId||null,frameWorkType:e.frameWorkType,component:e.component,language:e.language};e.strRoomId&&!e.roomId&&(this._room.useStringRoomId=!0),NL(this,this._room).add("peer-join",(e=>{let{userId:t}=e;this.emit(OM.REMOTE_USER_ENTER,{userId:t})})).add("peer-leave",(e=>{this.emit(OM.REMOTE_USER_EXIT,{userId:e})})).add("banned",(e=>{this._exitRoom().then((()=>{this.emit(OM.KICKED_OUT,{reason:e.reason})}))})).add("error",(e=>{this._exitRoom().then((()=>{this.emit(OM.ERROR,uM.convertFrom(e))}))})).add("signal-connection-state-changed",(e=>{this.emit(OM.CONNECTION_STATE_CHANGED,e)})).add("network-quality",(e=>{this.emit(OM.NETWORK_QUALITY,e)})).add("remote-published",(e=>{[e.remoteAudioTrack,e.remoteVideoTrack,e.remoteAuxiliaryTrack].forEach((t=>{NL(t,t).add("player-state-changed",(i=>{let n=ab(sb({},i),{userId:e.userId});t.kind===HD.VIDEO&&(n.streamType=function(e){return"sub"===e?"auxiliary":"auxiliary"===e?"sub":"main"}(t.streamType)),this.emit(t.kind===HD.AUDIO?OM.AUDIO_PLAY_STATE_CHANGED:OM.VIDEO_PLAY_STATE_CHANGED,n)})).add("error",(e=>{e.getCode()===Ab.PLAY_NOT_ALLOWED&&this.emit(OM.AUTOPLAY_FAILED,{userId:t.userId})}))}))})).add("remote-unpublished",(e=>{[e.remoteAudioTrack,e.remoteVideoTrack,e.remoteAuxiliaryTrack].forEach((e=>{OL(e)}))})).add("remote-publish-state-changed",(e=>{let{prevMuteState:t,muteState:i}=e,{userId:n}=i;this._room.remotePublishedUserMap.get(n);let r=t.audioAvailable,o=t.videoAvailable,{audioAvailable:s,videoAvailable:a}=i;s||this._remoteAudioConfigMap.delete(n),a||this._remoteVideoConfigMap.delete("".concat(n,"_","main")),i.hasAuxiliary||this._remoteVideoConfigMap.delete("".concat(n,"_","sub")),r!==s&&this.emit(s?OM.REMOTE_AUDIO_AVAILABLE:OM.REMOTE_AUDIO_UNAVAILABLE,{userId:n}),o!==a&&this.emit(a?OM.REMOTE_VIDEO_AVAILABLE:OM.REMOTE_VIDEO_UNAVAILABLE,{userId:n,streamType:"main"}),t.hasAuxiliary!==i.hasAuxiliary&&this.emit(i.hasAuxiliary?OM.REMOTE_VIDEO_AVAILABLE:OM.REMOTE_VIDEO_UNAVAILABLE,{userId:n,streamType:"sub"})})).add("firewall-restriction",(()=>{this.emit(OM.ERROR,new uM({code:sM.OPERATION_FAILED,extraCode:5501}))})).add("sei-message",(e=>{this.emit(OM.SEI_MESSAGE,e)})),this._handleReceiveMode(),yield this._room.join(a,n,zM.frameWorkType),this._checkTrackToPublish()}))}exitRoom(){return _b(this,null,(function*(){return yield this._exitRoom()}))}switchRole(e){return _b(this,null,(function*(){yield this._room.switchRole(e),"anchor"===e&&this._checkTrackToPublish()}))}destroy(){OL(ZL),this.removeAllListeners(),this._room.destroy(),KM.delete(this),this._localAudioTrack&&this.stopLocalAudio(),this._localVideoTrack&&this.stopLocalVideo(),this._localScreenTrack&&this.stopScreenShare()}startLocalAudio(){return _b(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{publish:!0};return function*(){if(e._localAudioTrack)return void e._log.warn("local audio is already started");let{publish:i=!0,option:n}=t,r=new mw,o={},s={muted:!0};n&&(dO(n.microphoneId)?dO(n.audioTrack)||(o.customSource=n.audioTrack):o.deviceId=n.microphoneId,dO(n.captureVolume),dO(n.profile)||(uO(n.profile)?xD[n.profile]&&r.setProfile(xD[n.profile]):r.setProfile(n.profile)),hO(n.earMonitorVolume)&&(s.muted=!(n.earMonitorVolume>0),s.volume=n.earMonitorVolume),dO(n.echoCancellation)||(r.profile.echoCancellation=n.echoCancellation),dO(n.noiseSuppression)||(r.profile.noiseSuppression=n.noiseSuppression),dO(n.autoGainControl)||(r.profile.autoGainControl=n.autoGainControl)),r.on("5",(t=>{e.emit(OM.ERROR,new uM({code:sM.DEVICE_ERROR,extraCode:5309,messageParams:{error:t}}))})),r.on("2",(t=>{e.emit(OM.DEVICE_CHANGED,{type:"microphone",action:"active",device:t})})),r.on("4",(t=>{let i;t.error&&(i=uM.convertFrom(t.error)),e.emit(OM.PUBLISH_STATE_CHANGED,ab(sb({},t),{error:i}))})),yield r.capture(o),NL(r,r).add("player-state-changed",(t=>{e.emit(OM.AUDIO_PLAY_STATE_CHANGED,ab(sb({},t),{userId:""}))})),yield e._updateAudioPlayOption({playOption:s,track:r}),i&&e._room.isJoined&&e._room.publish(r).catch((()=>{})),e._localAudioTrack=r,e._localAudioConfig=ab(sb({},t),{publish:i})}()}))}updateLocalAudio(e){return _b(this,null,(function*(){if(!this._localAudioTrack||!this._localAudioConfig)return;let{publish:t,mute:i,option:n}=e,r={};n&&(n.microphoneId?yield this._localAudioTrack.switchDevice(n.microphoneId):dO(n.audioTrack)||(this._localAudioTrack.setMediaStreamTrack(n.audioTrack),yield this._room.replaceTrack(this._localAudioTrack)),dO(n.captureVolume),dO(n.earMonitorVolume)||(r.muted=!(n.earMonitorVolume>0),r.volume=n.earMonitorVolume)),yield this._updateAudioPlayOption({playOption:r,track:this._localAudioTrack,prevConfig:this._localAudioConfig}),this._room.isJoined&&!dO(t)&&(t&&!this._localAudioConfig.publish&&this._room.publish(this._localAudioTrack).catch((()=>{})),this._localAudioConfig.publish&&!t&&this._room.unpublish(this._localAudioTrack).catch((()=>{}))),dO(i)||this._localAudioTrack.setMute(i),LO(this._localAudioConfig,e)}))}stopLocalAudio(){return _b(this,null,(function*(){!this._localAudioTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localAudioTrack).catch((()=>{}))),this._localAudioTrack.stop(),this._localAudioTrack.close(),OL(this._localAudioTrack),this._localAudioTrack=null,this._localAudioConfig=null)}))}startLocalVideo(){return _b(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{publish:!0,view:null};return function*(){if(e._localVideoTrack)return void e._log.warn("local video is already started");let{view:i,publish:n=!0,option:r}=t,o=new fw,s={},a={};if(r&&(r.cameraId?s.deviceId=r.cameraId:dO(r.useFrontCamera)?dO(r.videoTrack)||(s.customSource=r.videoTrack):s.facingMode=r.useFrontCamera?HD.FACING_MODE_USER:HD.FACING_MODE_ENVIRONMENT,dO(r.profile)||(uO(r.profile)?FD[r.profile]&&o.setProfile(FD[r.profile]):o.setProfile(r.profile)),dO(r.fillMode)||(a.objectFit=r.fillMode),dO(r.mirror)||(a.mirror=r.mirror),dO(r.small)||(RP()?uO(r.small)?o.small=FD[r.small]:o.small=r.small:e._log.warn("small stream is not supported"))),o.on("5",(t=>{e.emit(OM.ERROR,new uM({code:sM.DEVICE_ERROR,extraCode:5308,messageParams:{error:t}}))})),o.on("2",(t=>{e.emit(OM.DEVICE_CHANGED,{type:"camera",action:"active",device:t})})),o.on("4",(t=>{let i;t.error&&(i=uM.convertFrom(t.error)),e.emit(OM.PUBLISH_STATE_CHANGED,ab(sb({},t),{error:i}))})),yield o.capture(s),(null==r?void 0:r.qosPreference)&&o.mediaTrack){let e=PM(r.qosPreference);o.mediaTrack.contentHint=e}NL(o,o).add("player-state-changed",(t=>{e.emit(OM.VIDEO_PLAY_STATE_CHANGED,ab(sb({},t),{userId:"",streamType:"main"}))})),yield e._updateVideoPlayOption({view:i,playOption:a,track:o}),n&&e._room.isJoined&&e._room.publish(o).catch((()=>{})),e._localVideoTrack=o,e._localVideoConfig=ab(sb({},t),{view:i,publish:n})}()}))}updateLocalVideo(e){return _b(this,null,(function*(){if(!this._localVideoTrack||!this._localVideoConfig)return;let{view:t,publish:i,mute:n,option:r}=e,o={};if(r&&(r.cameraId?yield this._localVideoTrack.switchDevice(r.cameraId):dO(r.useFrontCamera)?dO(r.videoTrack)||(this._localVideoTrack.setMediaStreamTrack(r.videoTrack),yield this._room.replaceTrack(this._localVideoTrack)):yield this._localVideoTrack.switchDevice(r.useFrontCamera?HD.FACING_MODE_USER:HD.FACING_MODE_ENVIRONMENT),dO(r.profile)||(uO(r.profile)?FD[r.profile]&&this._localVideoTrack.setProfile(FD[r.profile]):this._localVideoTrack.setProfile(r.profile)),dO(r.fillMode)||(o.objectFit=r.fillMode),dO(r.mirror)||(o.mirror=r.mirror),r.qosPreference&&this._localVideoTrack.mediaTrack)){let e=PM(r.qosPreference);this._localVideoTrack.mediaTrack.contentHint=e}yield this._updateVideoPlayOption({view:t,playOption:o,track:this._localVideoTrack,prevConfig:this._localVideoConfig}),this._room.isJoined&&!dO(i)&&(i&&!this._localVideoConfig.publish&&this._room.publish(this._localVideoTrack).catch((()=>{})),this._localVideoConfig.publish&&!i&&this._room.unpublish(this._localVideoTrack).catch((()=>{}))),dO(n)||this._localVideoTrack.setMute(n),LO(this._localVideoConfig,e)}))}stopLocalVideo(){return _b(this,null,(function*(){!this._localVideoTrack||(this._room.isJoined&&(yield this._room.unpublish(this._localVideoTrack).catch((()=>{}))),this._localVideoTrack.stop(),this._localVideoTrack.close(),OL(this._localVideoTrack),this._localVideoTrack=null,this._localVideoConfig=null)}))}startScreenShare(){return _b(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{publish:!0,view:null};return function*(){if(e._localScreenTrack)return void e._log.warn("screen share is already started");let{view:i=null,publish:n=!0,option:r}=t,o=new Tw;o.on("4",(t=>{let i;t.error&&(i=uM.convertFrom(t.error)),e.emit(OM.PUBLISH_STATE_CHANGED,ab(sb({},t),{error:i}))}));let s=null;o.setMediaType(2);let a={},c={};r&&(dO(r.profile)||(uO(r.profile)?BD[r.profile]&&o.setProfile(BD[r.profile]):o.setProfile(r.profile)),r.systemAudio&&(a.systemAudio=!0,a.echoCancellation=r.echoCancellation,a.noiseSuppression=r.noiseSuppression,a.autoGainControl=r.autoGainControl),dO(r.fillMode)||(c.objectFit=r.fillMode),r.videoTrack&&(a.videoTrack=r.videoTrack),r.audioTrack&&(a.audioTrack=r.audioTrack));let l=yield o.capture(a);if(null!=r&&r.qosPreference){let e=PM(r.qosPreference);o.mediaTrack.contentHint=e}if(o.mediaTrack.addEventListener(HD.ENDED,(()=>{e._stopScreenShare(),e.emit(OM.SCREEN_SHARE_STOPPED)})),l.getAudioTracks()[0]&&(s=new Ew,s.setScreenAudioTrack(l.getAudioTracks()[0],l)),NL(o,o).add("player-state-changed",(t=>{e.emit(OM.VIDEO_PLAY_STATE_CHANGED,ab(sb({},t),{userId:"",streamType:"sub"}))})),yield e._updateVideoPlayOption({view:i,playOption:c,track:o}),n&&e._room.isJoined){let t=[o];s&&t.push(s),e._room.publish(...t).catch((()=>{}))}e._localScreenTrack=o,e._localScreenAudioTrack=s,e._localScreenConfig=ab(sb({},t),{view:i,publish:n})}()}))}updateScreenShare(e){return _b(this,null,(function*(){if(!this._localScreenTrack||!this._localScreenConfig)return;let{view:t,publish:i,option:n}=e,r={};if(n&&(dO(n.fillMode)||(r.objectFit=n.fillMode),n.qosPreference)){let e=PM(n.qosPreference);this._localScreenTrack.mediaTrack.contentHint=e}yield this._updateVideoPlayOption({view:t,playOption:r,track:this._localScreenTrack,prevConfig:this._localScreenConfig}),this._room.isJoined&&!dO(i)&&(i&&!this._localScreenConfig.publish&&this._room.publish(this._localScreenTrack).catch((()=>{})),this._localScreenConfig.publish&&!i&&this._room.unpublish(this._localScreenTrack).catch((()=>{}))),LO(this._localScreenConfig,e)}))}stopScreenShare(){return _b(this,null,(function*(){return yield this._stopScreenShare()}))}startRemoteVideo(e){return _b(this,null,(function*(){let{view:t,userId:i,streamType:n,option:r}=e,o="".concat(i,"_").concat(n);if(this._remoteVideoConfigMap.has(o))return void this._log.warn("remote video has already started. userId:".concat(i,", streamType:").concat(n));let s=this._room.remotePublishedUserMap.get(i);if(!s)return;let a={},c="main"===n?s.remoteVideoTrack:s.remoteAuxiliaryTrack;r&&(dO(r.fillMode)||(a.objectFit=r.fillMode),dO(r.mirror)||(a.mirror=r.mirror),"main"===n&&!dO(r.small)&&this._room.changeType(r.small,c.user)),yield this._room.subscribe(c),yield this._updateVideoPlayOption({view:t,playOption:a,track:c}),this._remoteVideoConfigMap.set(o,e)}))}updateRemoteVideo(e){return _b(this,null,(function*(){let{view:t,userId:i,streamType:n,option:r}=e,o="".concat(i,"_").concat(n);if(!this._remoteVideoConfigMap.has(o)||!this._room.remotePublishedUserMap.has(i))return;let s={};r&&(dO(r.fillMode)||(s.objectFit=r.fillMode),dO(r.mirror)||(s.mirror=r.mirror));let a=null,c=this._room.remotePublishedUserMap.get(i);"main"===n&&(null==c?void 0:c.muteState.hasVideo)&&(a=c.remoteVideoTrack),"sub"===n&&(null==c?void 0:c.muteState.hasAuxiliary)&&(a=c.remoteAuxiliaryTrack);let l=this._remoteVideoConfigMap.get(o);a&&("main"===n&&r&&!dO(r.small)&&this._room.changeType(r.small,a.user),yield this._updateVideoPlayOption({view:t,playOption:s,track:a,prevConfig:l})),LO(l,e)}))}stopRemoteVideo(e){return _b(this,null,(function*(){return this._stopRemoteVideo(e)}))}_stopRemoteVideo(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return _b(this,null,(function*(){let i=[],n=this._room.remotePublishedUserMap.get(e.userId);if(n){let{muteState:t,remoteVideoTrack:r,remoteAuxiliaryTrack:o}=n;"main"===e.streamType&&(r.stop(),t.hasVideo&&i.push(r)),"sub"===e.streamType&&(o.stop(),t.hasAuxiliary&&i.push(o))}for(let e of i)t&&(yield this._room.unsubscribe(e));this._remoteVideoConfigMap.delete("".concat(e.userId,"_").concat(e.streamType))}))}muteRemoteAudio(e,t){return _b(this,null,(function*(){if("*"===e)if(t)yield this._stopRemoteAudio({userId:e});else{let e=[...this._room.remotePublishedUserMap.values()];for(let t of e)t.muteState.hasAudio&&(yield this._startRemoteAudio({userId:t.userId}))}else t?yield this._stopRemoteAudio({userId:e}):yield this._startRemoteAudio({userId:e});this._remoteAudioMuteMap.set(e,t)}))}setRemoteAudioVolume(e,t){if("*"===e){let e=[...this._room.remotePublishedUserMap.values()];for(let i of e)this._updateAudioPlayOption({playOption:{volume:t},track:i.remoteAudioTrack})}else if(e){let i=this._room.remotePublishedUserMap.get(e);i&&this._updateAudioPlayOption({playOption:{volume:t},track:i.remoteAudioTrack})}}startPlugin(e,t){return _b(this,null,(function*(){return e.start(t)}))}updatePlugin(e,t){return _b(this,null,(function*(){return e.update(t)}))}stopPlugin(e,t){return _b(this,null,(function*(){return e.stop(t)}))}enableAudioVolumeEvaluation(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._room.enableAudioVolumeEvaluation(e,t)}on(e,t,i){return super.on(e,t,i),this._eventListened.add(e),this}off(e,t,i){return"*"===e?(this._eventListened.clear(),this.removeAllListeners()):super.off(e,t,i),this}getVideoTrack(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{userId:"",streamType:"main"},{userId:t="",streamType:i="main"}=e;if(""===t){if("main"===i&&this._localVideoTrack)return this._localVideoTrack.mediaTrack;if("sub"===i&&this._localScreenTrack)return this._localScreenTrack.mediaTrack}else{let e=this._room.remotePublishedUserMap.get(t);if(e)return"main"===i?e.remoteVideoTrack.mediaTrack:e.remoteAuxiliaryTrack.mediaTrack}return null}getAudioTrack(e){if(e){let t=this._room.remotePublishedUserMap.get(e);if(t)return t.remoteAudioTrack.mediaTrack}else if(this._localAudioTrack)return this._localAudioTrack.mediaTrack;return null}setCurrentSpeaker(e){var t;null==(t=this._localAudioTrack)||t.setAudioOutput(e),this._room.remotePublishedUserMap.forEach((t=>t.remoteAudioTrack.setAudioOutput(e)))}_startRemoteAudio(e){return _b(this,null,(function*(){let{userId:t,option:i}=e;if(this._remoteAudioConfigMap.has(t))return void this._log.warn("remote audio has already started. userId:".concat(t));let n=this._room.remotePublishedUserMap.get(t);if(!n)return;let r={};i&&(dO(i.volume)||(r.volume=i.volume));let o=n.remoteAudioTrack;yield this._room.subscribe(o),yield this._updateAudioPlayOption({playOption:r,track:o}),this._remoteAudioConfigMap.set(t,e)}))}_stopRemoteAudio(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return _b(this,null,(function*(){let i=this._room.remotePublishedUserMap.get(e.userId);i&&(i.remoteAudioTrack.stop(),i.muteState.hasAudio&&t&&(yield this._room.unsubscribe(i.remoteAudioTrack))),this._remoteAudioConfigMap.delete("".concat(e.userId))}))}_updateVideoPlayOption(e){return _b(this,arguments,(function(e){let{view:t,playOption:i,track:n,prevConfig:r}=e;return function*(){if(dO(t)&&r&&r.view&&!bO(i)){let e;e=mO(r.view)?r.view:wO(r.view),e&&(yield n.play(e,i))}if(!dO(t)){let e;e=mO(t)?t:wO(t),e?yield n.play(e,i):n.stop()}}()}))}_updateAudioPlayOption(e){return _b(this,arguments,(function(e){let{playOption:t={},track:i,prevConfig:n}=e;return function*(){i.isPlayCalled||(yield i.play(null,t)),dO(t.muted)||i.setPlayerMute(t.muted),dO(t.volume)||i.setAudioVolume(t.volume/100)}()}))}_checkTrackToPublish(){var e,t,i;let n=[];if((null==(e=this._localAudioConfig)?void 0:e.publish)&&this._localAudioTrack&&n.push(this._localAudioTrack),(null==(t=this._localVideoConfig)?void 0:t.publish)&&this._localVideoTrack&&n.push(this._localVideoTrack),null!=(i=this._localScreenConfig)&&i.publish&&(this._localScreenTrack&&n.push(this._localScreenTrack),this._localScreenAudioTrack&&n.push(this._localScreenAudioTrack)),0!==n.length)return this._room.publish(...n).catch((()=>{}))}_handleReceiveMode(){this._room.autoReceiveAudio&&NL(this,this).add(OM.REMOTE_AUDIO_AVAILABLE,(e=>_b(this,[e],(function(e){var t=this;let{userId:i}=e;return function*(){if(t._remoteAudioMuteMap.get("*")||t._remoteAudioMuteMap.get(i))return;let e=t._room.remotePublishedUserMap.get(i);e&&(yield t._room.subscribe(e.remoteAudioTrack).catch((()=>{})),yield t._updateAudioPlayOption({track:e.remoteAudioTrack}).catch((()=>{})),t._remoteAudioConfigMap.set(i,{userId:i}))}()})))),this._room.autoReceiveVideo&&NL(this,this).add(OM.REMOTE_VIDEO_AVAILABLE,(e=>{let{userId:t,streamType:i}=e,n=this._room.remotePublishedUserMap.get(t);n&&("main"===i?this._room.subscribe(n.remoteVideoTrack).catch((()=>{})):"sub"===i&&this._room.subscribe(n.remoteAuxiliaryTrack).catch((()=>{})))}))}_exitRoom(){return _b(this,null,(function*(){this._room.isJoined&&(yield this._room.leave()),[...this._remoteAudioConfigMap.keys()].forEach((e=>{this._stopRemoteAudio({userId:e}).catch()})),[...this._remoteVideoConfigMap.keys()].forEach((e=>{let t=e.includes("main")?"main":"sub",i=e.split("_".concat(t))[0];i&&this._stopRemoteVideo({userId:i,streamType:t}).catch()})),this._remoteVideoConfigMap.clear(),this._remoteAudioConfigMap.clear(),this._remoteAudioMuteMap.clear(),this._room.remotePublishedUserMap.forEach((e=>{OL(e.remoteAudioTrack),OL(e.remoteVideoTrack),OL(e.remoteAuxiliaryTrack)})),OL(this)}))}_stopScreenShare(){return _b(this,null,(function*(){var e,t,i;if(this._localScreenTrack){if(this._room.isJoined){let t=[this._localScreenTrack];this._localScreenAudioTrack&&t.push(this._localScreenAudioTrack),yield null==(e=this._room)?void 0:e.unpublish(...t).catch((()=>{}))}this._localScreenTrack.stop(),this._localScreenTrack.close(),null==(t=this._localScreenAudioTrack)||t.stop(),null==(i=this._localScreenAudioTrack)||i.close(),OL(this._localScreenTrack),this._localScreenTrack=null,this._localScreenAudioTrack=null,this._localScreenConfig=null}}))}sendSEIMessage(e,t){this._room.sendSEI(e,t||{seiPayloadType:243})}static setLogLevel(e,t){YO.setLogLevel(e),dO(t)||(t?YO.enableUploadLog():YO.disableUploadLog())}static isSupported(){return fP()}static getCameraList(){return tw()}static getMicrophoneList(){return ew()}static getSpeakerList(){return iw()}static setCurrentSpeaker(e){return _b(this,null,(function*(){(yield iw()).forEach((t=>{t.deviceId===e&&(KM.forEach((i=>{i.setCurrentSpeaker(e),i.emit(OM.DEVICE_CHANGED,{type:"speaker",action:"active",device:t})})),YM=t)}))}))}},qM=zM;hb(qM,"_loggerManager",YO),hb(qM,"EVENT",OM),hb(qM,"ERROR_CODE",sM),hb(qM,"TYPE",oM),hb(qM,"frameWorkType",30),ub([MM(IM.TRTC.enterRoom),kM("room",((e,t)=>{let[i]=e,[n]=t;return(i.roomId||i.strRoomId)===(n.roomId||n.strRoomId)&&i.userId===n.userId&&i.sdkAppId===n.sdkAppId})),hw((e=>function(t){return this._log.setUserId(t.userId),this._log.setSdkAppId(t.sdkAppId),e.call(this,t).catch((e=>{throw OL(this),e}))})),FM()],qM.prototype,"enterRoom",1),ub([FM()],qM.prototype,"exitRoom",1),ub([MM(IM.TRTC.switchRole),DM("room",((e,t)=>t)),FM()],qM.prototype,"switchRole",1),ub([FM()],qM.prototype,"destroy",1),ub([MM(IM.TRTC.startLocalAudio),kM("audio",((e,t)=>{let[i]=e,[n]=t;var r,o;return(null==(r=null==i?void 0:i.option)?void 0:r.microphoneId)===(null==(o=null==n?void 0:n.option)?void 0:o.microphoneId)})),FM()],qM.prototype,"startLocalAudio",1),ub([MM(IM.TRTC.updateLocalAudio),DM("audio"),FM()],qM.prototype,"updateLocalAudio",1),ub([NM("audio"),FM()],qM.prototype,"stopLocalAudio",1),ub([MM(IM.TRTC.startLocalVideo),kM("video",((e,t)=>{let[i]=e,[n]=t;var r,o;return(null==(r=null==i?void 0:i.option)?void 0:r.cameraId)===(null==(o=null==n?void 0:n.option)?void 0:o.cameraId)})),FM()],qM.prototype,"startLocalVideo",1),ub([MM(IM.TRTC.updateLocalVideo),DM("video"),FM()],qM.prototype,"updateLocalVideo",1),ub([NM("video"),FM()],qM.prototype,"stopLocalVideo",1),ub([MM(IM.TRTC.startScreenShare),kM("screen",(()=>!0)),FM()],qM.prototype,"startScreenShare",1),ub([MM(IM.TRTC.updateScreenShare),DM("screen"),FM()],qM.prototype,"updateScreenShare",1),ub([FM()],qM.prototype,"stopScreenShare",1),ub([MM(IM.TRTC.startRemoteVideo),kM((e=>"v".concat(e.userId).concat(e.streamType)),(()=>!0)),FM((e=>"".concat(e.userId,"_").concat(e.streamType)))],qM.prototype,"startRemoteVideo",1),ub([MM(IM.TRTC.updateRemoteVideo),DM((e=>"v".concat(e.userId).concat(e.streamType))),FM((e=>"".concat(e.userId,"_").concat(e.streamType)))],qM.prototype,"updateRemoteVideo",1),ub([MM(IM.TRTC.stopRemoteVideo),hw((e=>function(t){return _b(this,null,(function*(){if("*"===t.userId){let e=[];return this._room.remotePublishedUserMap.forEach((t=>{this._remoteVideoConfigMap.has("".concat(t.userId,"_","main"))&&e.push(this.stopRemoteVideo({streamType:"main",userId:t.userId}).catch((()=>{}))),this._remoteVideoConfigMap.has("".concat(t.userId,"_","sub"))&&e.push(this.stopRemoteVideo({streamType:"sub",userId:t.userId}).catch((()=>{})))})),Promise.all(e)}return e.call(this,t)}))})),FM((e=>"".concat(e.userId,"_").concat(e.streamType)))],qM.prototype,"stopRemoteVideo",1),ub([NM((e=>"v".concat(e.userId).concat(e.streamType)))],qM.prototype,"_stopRemoteVideo",1),ub([MM(...IM.TRTC.muteRemoteAudio),FM((e=>e))],qM.prototype,"muteRemoteAudio",1),ub([VM(...IM.TRTC.setRemoteAudioVolume),function(e,t){return hw(((i,n)=>function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];var s,a;let c=null==(s=wM.get(this))?void 0:s.get(t(...r));c&&c>0&&clearTimeout(c);let l=window.setTimeout((()=>{i.apply(this,r)}),e);wM.has(this)?null==(a=wM.get(this))||a.set(t(...r),l):wM.set(this,new Map([[t(...r),l]]))}))}(200,(e=>e)),FM((e=>e))],qM.prototype,"setRemoteAudioVolume",1),ub([BM("start"),kM(((e,t)=>e.getAlias()+e.getGroup(t)))],qM.prototype,"startPlugin",1),ub([BM("update"),DM(((e,t)=>e.getAlias()+e.getGroup(t)))],qM.prototype,"updatePlugin",1),ub([BM("stop"),NM(((e,t)=>e.getAlias()+e.getGroup(t)))],qM.prototype,"stopPlugin",1),ub([VM(...IM.TRTC.enableAudioVolumeEvaluation)],qM.prototype,"enableAudioVolumeEvaluation",1),ub([kM((e=>"a".concat(e.userId)),(()=>!0))],qM.prototype,"_startRemoteAudio",1),ub([hw((e=>function(t){return _b(this,null,(function*(){return"*"===t.userId?Promise.all([...this._room.remotePublishedUserMap.values()].map((e=>this._stopRemoteAudio(ab(sb({},t),{userId:e.userId})).catch((()=>{}))))):e.call(this,t)}))})),NM((e=>"a".concat(e.userId)))],qM.prototype,"_stopRemoteAudio",1),ub([NM("room")],qM.prototype,"_exitRoom",1),ub([NM("screen")],qM.prototype,"_stopScreenShare",1),ub([MM(IM.TRTC.sendSEIMessage),function(e){let{timesInSecond:t,maxSizeInSecond:i,getSize:n}=e;return hw(((e,r)=>{let o=new Map;return GO.on(JO.ROOM_DESTROY,(e=>{let{room:t}=e;return o.delete(t)})),function(){let s=o.get(this);for(var a=arguments.length,c=new Array(a),l=0;l<a;l++)c[l]=arguments[l];if(s||(s={callCountInSecond:0,timestamp:0,totalSizeInSecond:0},o.set(this,s)),0===s.timestamp?s.timestamp=Date.now():Date.now()-s.timestamp>1e3&&(s.timestamp=Date.now(),s.callCountInSecond=0,s.totalSizeInSecond=0),n&&(s.totalSizeInSecond+=n(...c)),0!==s.timestamp&&Date.now()-s.timestamp<1e3&&(s.callCountInSecond>=t||s.totalSizeInSecond>i))throw new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.CALL_FREQUENCY_LIMIT,data:{isTimes:s.callCountInSecond>=t,isSize:s.totalSizeInSecond>i,name:r,timesInSecond:t,maxSizeInSecond:i}})});s.callCountInSecond++,e.call(this,...c)}}))}({timesInSecond:30,maxSizeInSecond:8e3,getSize:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t[0].byteLength}})],qM.prototype,"sendSEIMessage",1),ub([MM(IM.TRTC.create)],qM,"_create",1);var QM=qM,XM=class{constructor(){this._set=new Set,GO.on(JO.LEAVE_SUCCESS,this.delete,this)}add(e){let{room:t,roomId:i}=e;if("rtc"===t.scene)return;let n=this.getKey(t.userId,i||t.roomId,t.sdkAppId,t.useStringRoomId);this._set.add(n)}delete(e){let{room:t,roomId:i}=e;if("rtc"===t.scene)return;let n=this.getKey(t.userId,t.roomId||i,t.sdkAppId,t.useStringRoomId);this._set.delete(n)}getKey(e,t,i,n){return"".concat(i,"_").concat(t,"_").concat(e,"_").concat(n)}isJoined(e){let{userId:t,roomId:i,sdkAppId:n,room:r}=e;return"rtc"!==r.scene&&this._set.has(this.getKey(t,i,n,r.useStringRoomId))}};function ZM(){return _b(this,null,(function*(){let e,t;try{let t=yield ew();e=t&&t.length}catch(u){}try{let e=yield tw();t=e&&e.length}catch(u){}let i={microphone:e,camera:t},{isH264EncodeSupported:n,isVp8EncodeSupported:r,isH264DecodeSupported:o,isVp8DecodeSupported:s}=this.checkSystemResult.detail,a=QO.basis(),c={webRTC:a.isWebRTCSupported,getUserMedia:a.isGetUserMediaSupported,webSocket:a.isWebSocketsSupported,screenShare:a.isScreenShareSupported,webAudio:a.isWebAudioSupported,h264Encode:n,h264Decode:o,vp8Encode:r,vp8Decode:s},l={browser:a.browser,os:a.os,trtc:c,devices:i},d={isWebCodecSupported:a.isWebCodecSupported,isMediaSessionSupported:a.isMediaSessionSupported,isWebTransportSupported:a.isWebTransportSupported};sL.uploadEvent({log:"trtcstats-".concat(JSON.stringify(l)),userId:this.userId}),this._log.info("TrtcStats-".concat(JSON.stringify(l))),sL.uploadEvent({log:"trtcadvancedstats-".concat(JSON.stringify(d)),userId:this.userId})}))}var $M=db(mb()),eV="1",tV="5",iV="2",nV="3",rV="4",oV="DISCONNECTED",sV="CONNECTING",aV="CONNECTED",cV={CLIENT_BANNED:9,CHANNEL_SETUP_RESULT:19,CHANNEL_RECONNECT_RESULT:514,JOIN_ROOM_RESULT:20,PEER_JOIN:4134,PEER_LEAVE:4135,STREAM_ADDED:16,STREAM_REMOVED:18,UPLINK_NETWORK_STATS:22,UPDATE_REMOTE_MUTE_STAT:23,PUBLISH_RESULT:4098,PUBLISH_STATE_CHANGE_RESULT:4112,UNPUBLISH_RESULT:4100,SUBSCRIBE_RESULT:4102,UNSUBSCRIBE_RESULT:4104,SUBSCRIBE_CHANGE_RESULT:4106,MUTE_RESULT:4108,UPDATE_OFFER_RESULT:4128,START_PUBLISH_TENCENT_CDN_RES:1286,STOP_PUBLISH_TENCENT_CDN_RES:1288,START_PUBLISH_GIVEN_CDN_RES:777,STOP_PUBLISH_GIVEN_CDN_RES:779,START_MIX_TRANSCODE_RES:781,STOP_MIX_TRANSCODE_RES:783,USER_LIST_RES:4137,SWITCH_ROLE_RES:4110,UPDATE_CONSTRAINT_CONFIG_RES:772,REBUILD_PEER_CONNECTION_RES:4150,SPC_PUBLISH_RESULT:4146,SPC_SUBSCRIBE_RESULT:4156},lV=[cV.UPDATE_REMOTE_MUTE_STAT,cV.UPLINK_NETWORK_STATS,cV.USER_LIST_RES,cV.MUTE_RESULT],dV={CLIENT_BANNED:"client-banned",CHANNEL_SETUP_RESULT:"channel-setup-result",CHANNEL_RECONNECT_RESULT:"channel-reconnect-result",JOIN_ROOM_RESULT:"join-room-result",PEER_JOIN:"peer-join",PEER_LEAVE:"peer-leave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",UPLINK_NETWORK_STATS:"uplink-network-stats",UPDATE_REMOTE_MUTE_STAT:"update-remote-mute-stat",PUBLISH_RESULT:"publish-result",PUBLISH_STATE_CHANGE_RESULT:"publish-state-change-result",UNPUBLISH_RESULT:"unpublish-result",SUBSCRIBE_RESULT:"subscribe-result",SUBSCRIBE_CHANGE_RESULT:"subscribe-change-result",UNSUBSCRIBE_RESULT:"unsubscribe-result",UPDATE_OFFER_RESULT:"update-offer-result",START_PUBLISH_TENCENT_CDN_RES:"start-publish-tencent-cdn-res",STOP_PUBLISH_TENCENT_CDN_RES:"stop-publish-tencent-cdn-res",START_PUBLISH_GIVEN_CDN_RES:"start-publish-given-cdn-res",STOP_PUBLISH_GIVEN_CDN_RES:"stop-publish-given-cdn-res",START_MIX_TRANSCODE_RES:"start-mix-transcode-res",STOP_MIX_TRANSCODE_RES:"stop-mix-transcode-res",USER_LIST_RES:"user-list-res",SWITCH_ROLE_RES:"switch_role_res",MUTE_RESULT:"mute-result",UPDATE_CONSTRAINT_CONFIG_RES:"update-contraint-config-res",REBUILD_PEER_CONNECTION_RES:"rebuild-pc-res",SPC_PUBLISH_RESULT:"spc-publish-result",SPC_SUBSCRIBE_RESULT:"spc-subscribe-result"},uV="publish_change",hV="join",pV="leave",_V="quality_report",mV="mute_uplink",fV="publish",gV="publish_state_change",TV="unpublish",EV="subscribe",IV="unsubscribe",SV="subscribe_change",AV="start_publishing",yV="stop_publishing",vV="start_push_user_cdn",RV="stop_push_user_cdn",CV="start_mcu_mix",bV="stop_mcu_mix",kV="get_user_list",DV="change_role",NV="update_constraint_config",OV="rebuild_pc",PV="join/v2",LV="publish/v2",wV="subscribe/v3",MV=class{constructor(e){hb(this,"_room"),hb(this,"_sdkAppId"),hb(this,"_userId"),hb(this,"_userSig"),hb(this,"_url"),hb(this,"_backupUrl"),hb(this,"_urlWithParam"),hb(this,"_backupUrlWithParam"),hb(this,"_socketInUse"),hb(this,"_socket"),hb(this,"_backupSocket"),hb(this,"_backupTimer",-1),hb(this,"_signalInfo",{tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0}),hb(this,"_currentState",oV),hb(this,"_reconnectionCount",0),hb(this,"_reconnectionTimer",-1),hb(this,"_seq",0),hb(this,"_log"),hb(this,"_emitter"),hb(this,"_lastMessageTime",-1),hb(this,"_prevTime",-1),this._room=e.room,this._sdkAppId=e.sdkAppId,this._userId=e.userId,this._userSig=e.userSig,this._url=e.url,this._backupUrl=e.backupUrl;let t="?sdkAppId=".concat(encodeURIComponent(this._sdkAppId),"&userId=").concat(encodeURIComponent(this._userId),"&userSig=").concat(encodeURIComponent(this._userSig));this._urlWithParam="".concat(this._url).concat(t),this._backupUrlWithParam="".concat(this._backupUrl).concat(t),this._seq=0,this._log=YO.createLogger({id:"ws",userId:this._userId,sdkAppId:this._sdkAppId}),this._emitter=new $M.default}get isConnected(){return this._currentState===aV}get isConnecting(){return this._currentState===sV}get isOnline(){return this._currentState===aV&&Date.now()-this._lastMessageTime<12e3}connect(e){return new Promise(((t,i)=>{this._prevTime<0&&(this._prevTime=yO()),this._log.info("connect to ".concat(this._url).concat(e?" timeout: ".concat(e):"")),this.emitConnectionStateChanged(sV),this._socket=new WebSocket(this._urlWithParam),this.bindSocket(this._socket),this._backupTimer=setTimeout((()=>{this.isConnected||(this._log.info("trying to connect to backupUrl"),this.tryConnectBackup())}),5e3);let n=-1;e&&(n=setTimeout((()=>{this.close(),i(new vb({code:Ab.JOIN_ROOM_FAILED,message:"join room timeout"}))}),e)),this.once(nV,(()=>{clearTimeout(n),t()})),this.once(rV,(e=>{clearTimeout(n),i(e)}))}))}tryConnectBackup(){this._backupSocket||(this.unbindAndCloseSocket(HD.MAIN),this._log.debug("try to connect to url: ".concat(this._backupUrlWithParam)),this._backupSocket=new WebSocket(this._backupUrlWithParam),this.bindSocket(this._backupSocket))}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){this.clearBackupTimer(),e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}unbindAndCloseSocket(e){if(e===HD.MAIN){if(this._socket){this.unbindSocket(this._socket);try{this._socket.close(1e3)}catch(pD){}this._socket=null}}else if(this._backupSocket){this.unbindSocket(this._backupSocket);try{this._backupSocket.close(1e3)}catch(pD){}this._backupSocket=null}}clearBackupTimer(){-1!==this._backupTimer&&(clearTimeout(this._backupTimer),this._backupTimer=-1)}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onopen(e){this.isConnected||(this.isReconnecting&&!this._signalInfo.tinyId&&this.stopReconnection(),this.clearBackupTimer(),e.target===this._socket?(this.unbindAndCloseSocket(HD.BACKUP),this._socketInUse=this._socket):(this.unbindAndCloseSocket(HD.MAIN),this._socketInUse=this._backupSocket),this.emitConnectionStateChanged(aV),this._emitter.emit(nV))}onclose(e){let{url:t}=e.target,i=e.target===this._socketInUse;if(this._log.info("websocket[".concat(t," InUse: ").concat(i,"] is closed with code: ").concat(e.code)),i&&(this.emitConnectionStateChanged(oV),!e.wasClean||1e3!==e.code)){this._log.warn("onclose code:".concat(e.code," reason:").concat(e.reason)),this._log.warn("close current websocket and schedule a reconnect timeout"),this._socketInUse.onclose=()=>{},this._socketInUse.close(4011);let t=this._socketInUse===this._socket;this._socket=null,this._backupSocket=null,this._socketInUse=null,this.reconnect(t?HD.BACKUP:HD.MAIN)}}onerror(e){let{url:t}=e.target;if(this._log.error("websocket[".concat(t,"] error observed")),this.isConnected){if(e.target===this._socketInUse){this.unbindAndCloseSocket(HD.MAIN),this.unbindAndCloseSocket(HD.BACKUP);let e=this._socketInUse===this._socket;this._socketInUse=null,this.reconnect(e?HD.BACKUP:HD.MAIN)}}else this.isReconnecting||GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:new Error("ws onerror")}),e.target==this._socket?(this.unbindAndCloseSocket(HD.MAIN),this.reconnect(HD.BACKUP)):(this.unbindAndCloseSocket(HD.BACKUP),this.reconnect(HD.MAIN))}onmessage(e){if(!this.isConnected)return;this._lastMessageTime=Date.now();let t=JSON.parse(e.data),{cmd:i,data:n}=t,r=Object.values(cV),o=Object.keys(cV)[r.indexOf(i)],s=dV[o];switch(lV.includes(i)||(this._log.debug("received msg: ".concat(e.data)),this._log.info("Received event: [ ".concat(s||"unknown cmd: ".concat(i)," ]"))),i){case cV.CHANNEL_SETUP_RESULT:if(0===t.code)this._signalInfo.clientIp=n.clientIp,this._signalInfo.signalIp=n.signalInnerIp,this._signalInfo.tinyId=t.tinyId,n.svrTime&&function(e){Rb=e-(new Date).getTime();let t=new Date;t.setTime(e),YO.info("baseTime from server: ".concat(t," offset: ").concat(Rb))}(n.svrTime),this._log.info("ChannelSetup Success"),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",cost:yO()-this._prevTime}),this._prevTime=-1,this._emitter.emit(eV,{signalInfo:this._signalInfo});else{let e=new vb({code:Ab.SIGNAL_CHANNEL_SETUP_FAILED,extraCode:t.code,message:rP({key:XO.SIGNAL_CHANNEL_SETUP_FAILED,data:{errorCode:t.code,errorMsg:t.message}})});this._log.error("".concat(t.code,", ").concat(t.message)),this.close(),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketConnect",error:e}),this._emitter.emit(tV,e)}break;case cV.JOIN_ROOM_RESULT:0===t.code&&(this._signalInfo.relayIp=n.relayOuterIp,this._signalInfo.relayInnerIp=n.relayInnerIp,this._signalInfo.relayPort=n.relayPort,this._log.info("signalIp:".concat(this._signalInfo.signalIp," clientIp:").concat(this._signalInfo.clientIp," relayIp: ").concat(this._signalInfo.relayIp))),this._emitter.emit(s,{data:t});break;case cV.CHANNEL_RECONNECT_RESULT:0===t.code?(this._log.warn("reconnect success"),this.stopReconnection(),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",cost:yO()-this._prevTime}),this._prevTime=-1,this._room.syncUserList(),this._room.checkConnectionsToReconnect()):(this._log.warn("reconnect failed, ".concat(t.code," ").concat(t.message)),this._room.reJoin());break;default:this._emitter.emit(s,{data:t})}}reconnect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:HD.MAIN;if(this.isReconnecting)return;if(this._reconnectionCount>=_N){this._log.warn("SDK has tried reconnect signal channel for ".concat(_N," times, but all failed. please check your network"));let e=new vb({code:Ab.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:rP({key:XO.SIGNAL_CHANNEL_RECONNECTION_FAILED})});return GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"WebsocketReconnect",error:e}),void this._emitter.emit(rV,e)}this._reconnectionCount++,this._log.warn("reconnect ".concat(e," [").concat(this._reconnectionCount,"/").concat(_N,"]"));let t=this.getReconnectionUrl(e);this.emitConnectionStateChanged(sV),this._prevTime<0&&(this._prevTime=yO()),e===HD.MAIN?(this._socket=new WebSocket(t),this.bindSocket(this._socket)):(this._backupSocket=new WebSocket(t),this.bindSocket(this._backupSocket));let i=aO(this._reconnectionCount);this._reconnectionTimer=setTimeout((()=>{this._log.warn("reconnect ".concat(e," timeout(").concat(i/1e3,"s), try again")),this.clearReconnectionTimer(),this.unbindAndCloseSocket(HD.MAIN),this.unbindAndCloseSocket(HD.BACKUP),this.reconnect(e===HD.MAIN?HD.BACKUP:HD.MAIN)}),i)}get isReconnecting(){return-1!==this._reconnectionTimer}getReconnectionUrl(e){let t=e===HD.MAIN?this._urlWithParam:this._backupUrlWithParam;if(this._signalInfo.tinyId&&-1===t.indexOf("&rc=1")){let{roomId:e,useStringRoomId:i}=this._room;t+="&rc=1&relayInnerIp=".concat(this._signalInfo.relayInnerIp,"&relayOuterIp=").concat(this._signalInfo.relayIp,"&relayPort=").concat(this._signalInfo.relayPort,"&roomId=").concat(e,"&useStringRoomId=").concat(i)}return t}send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.isConnected){let i={cmd:e,data:t,userId:this._userId,tinyId:this._signalInfo.tinyId,seq:++this._seq};return this._socketInUse.send(JSON.stringify(i)),i.seq}}sendWaitForResponse(e){let{command:t,data:i,timeout:n=5e3,responseCommand:r,commandDesc:o,enableLog:s=!0}=e;return new Promise(((e,a)=>{let c=setTimeout((()=>{this.off(r,l);let e=new vb({code:Ab.API_CALL_TIMEOUT,message:rP({key:XO.API_CALL_TIMEOUT,data:{commandDesc:o,command:t}})});s&&this._log.warn(e),a(e)}),n),l=t=>{t.data.seq===d&&(clearTimeout(c),this.off(r,l),e(t))};this.on(r,l);let d=this.send(t,i)}))}sendWaitForResponseWithRetry(e){let{commandDesc:t,command:i,retries:n=0,retryTimeout:r=0}=e;return HO({retryFunction:this.sendWaitForResponse,onRetrying:e=>{this._log.warn("".concat(t||i," timeout observed, retrying [").concat(e,"/").concat(n,"]"))},settings:{retries:n,timeout:r},context:this})(e)}getCurrentState(){return this._currentState}getSignalInfo(){return this._signalInfo}stopReconnection(){this.isReconnecting&&(this._reconnectionCount=0,this.clearReconnectionTimer())}close(){this._log.info("close SignalChannel"),this.clearBackupTimer(),this.stopReconnection(),this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._socketInUse=null,this.unbindAndCloseSocket(HD.MAIN),this.unbindAndCloseSocket(HD.BACKUP),this.emitConnectionStateChanged(oV)}on(e,t,i){this._emitter.on(e,t,i)}removeListener(e,t,i){this._emitter.removeListener(e,t,i)}once(e,t,i){this._emitter.once(e,t,i)}off(e,t,i){this._emitter.off(e,t,i)}emitConnectionStateChanged(e){e!==this._currentState&&(this._log.info("".concat(this._currentState," -> ").concat(e)),this._emitter.emit(iV,{prevState:this._currentState,state:e}),this._currentState=e)}},VV=db(mb()),UV=class{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.dataView=e,this.isSEI&&(t?this.addPreventionByte():this.removePreventionByte())}addPreventionByte(){let e=this.seiPayloadStartIndex,t=this.dataView.byteLength-2,i=[],n=0;for(let o=e;o<=t;o++){let e=this.dataView.getInt8(o);switch(e){case 0:case 1:case 2:case 3:2===n&&(i.push(3),n=0),0==e?n++:n=0,i.push(e);break;default:n=0,i.push(e)}}i.push(this.dataView.getInt8(this.dataView.byteLength-1));let r=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=r}removePreventionByte(){let e=this.seiPayloadStartIndex,t=this.dataView.byteLength-1,i=[],n=0;for(let o=e;o<=t;o++)switch(this.dataView.getInt8(o)){case 0:n++,i.push(this.dataView.getInt8(o));break;case 3:2!==n&&i.push(this.dataView.getInt8(o)),n=0;break;default:i.push(this.dataView.getInt8(o)),n=0}let r=new DataView(new Uint8Array([...new Uint8Array(this.dataView.buffer).slice(0,e),...i]).buffer);this.dataView=r}get isSEI(){return 6===this.dataView.getUint8(4)}get seiPayloadStartIndex(){let e=6;for(let t=6;t<this.dataView.buffer.byteLength&&(e++,255===this.dataView.getUint8(t));t++);return e}get seiPayloadType(){return this.isSEI?this.dataView.getUint8(5):null}get seiPayload(){if(!this.isSEI)return null;let e=0,t=6;for(let r=6;r<this.dataView.buffer.byteLength;r++){let i=this.dataView.getUint8(r);if(t++,255!==i){e+=i;break}e+=255}let i=new ArrayBuffer(e),n=new DataView(i);for(let r=0;r<i.byteLength;r++,t++)n.setInt8(r,this.dataView.getInt8(t));return n}},xV=class{constructor(e,t,i){this._connection=e,this._log=t,this._isUplink=i,hb(this,"_seiMessageList",[]),hb(this,"_seiPayloadType",243),hb(this,"_mainVideoSenderOrReceiver",null),hb(this,"_mainVideoAbortController",null),hb(this,"_abortMap",new Map),hb(this,"onSEIMessage")}get isRunning(){return!!this._mainVideoAbortController}start(e){this._mainVideoSenderOrReceiver=e;let t=e.createEncodedStreams(),i=t.readable,n=t.writable,r=new TransformStream({transform:this._isUplink?this.encodeVideoFrame.bind(this):this.decodeVideoFrame.bind(this)});this._mainVideoAbortController=new AbortController,i.pipeThrough(r).pipeTo(n,this._mainVideoAbortController).catch((()=>{}))}restart(e){this.stop(),this.start(e)}stop(){var e;null==(e=this._mainVideoAbortController)||e.abort(),this._mainVideoAbortController=null}destroy(){this.stop(),this._abortMap.forEach((e=>e.abort())),this._abortMap.clear(),this._log=null,this.onSEIMessage=null,this._mainVideoSenderOrReceiver=null,this._connection=null}handleEncodedStreams(){try{let e=this._connection.getPeerConnection();this.clearUnusedSenderOrReceiver(e),this._isUplink?e.getSenders().forEach(((e,t)=>{if(1===t){if(e===this._mainVideoSenderOrReceiver)return;this.isRunning?this.restart(e):this.start(e)}else{if(this._abortMap.has(e))return;this.pipeSenderOrReceiver(e)}})):e.getReceivers().forEach(((e,t)=>{var i;this._abortMap.has(e)||e===this._mainVideoSenderOrReceiver||(1===t&&(null==(i=e.track)?void 0:i.kind)===HD.VIDEO?this.isRunning?this.restart(e):this.start(e):this.pipeSenderOrReceiver(e))}))}catch(Xw){this._log.warn(Xw)}}pipeSenderOrReceiver(e){let{readable:t,writable:i}=e.createEncodedStreams(),n=new AbortController;this._abortMap.set(e,n),t.pipeTo(i,n).catch((()=>{}))}clearUnusedSenderOrReceiver(e){this._abortMap.forEach(((t,i)=>{(this._isUplink?e.getSenders():e.getReceivers()).find((e=>e===i))||(t.abort(),this._abortMap.delete(i))}))}push(e,t){t&&t.seiPayloadType&&(this._seiPayloadType=t.seiPayloadType),this._seiMessageList.push(e)}hasSEI(e){let t=new DataView(e);return 1===t.getInt32(0)&&6===t.getInt8(4)}isEmptyFrame(e){return"empty"===e.type||0===e.data.byteLength}getNaluCount(e){let t=0,i=0,n=new DataView(e);for(let r=0;r<e.byteLength;r++)switch(n.getUint8(r)){case 0:t++;break;case 1:(2===t||3===t)&&i++,t=0;break;default:t=0}return i}encodeVideoFrame(e,t){try{if(this._connection.isH264&&this._seiMessageList.length>0&&!this.isEmptyFrame(e)){let t=9-this.getNaluCount(e.data);if(t<=0)return;let i=this._seiMessageList.splice(0,t).reverse().map(this.encodeSEINalu.bind(this)),n=i.reduce(((e,t)=>e+t.dataView.byteLength),0),r=new ArrayBuffer(n+e.data.byteLength),o=new DataView(r),s=new DataView(e.data),a=0;for(let e=0;e<i.length;e++)for(let t=0;t<i[e].dataView.byteLength;t++)o.setInt8(a++,i[e].dataView.getInt8(t));for(let c=0;c<e.data.byteLength;c++)o.setInt8(a++,s.getInt8(c));e.data=r,this._log.debug("".concat(i.length," sei sent"))}}catch(pN){this._log.warn(pN)}t.enqueue(e)}decodeVideoFrame(e,t){try{if(this._connection.isH264&&!this.isEmptyFrame(e)&&this.hasSEI(e.data)){let t=[],i=new DataView(e.data),n=0,r=-1,o=-1;for(let s=0;s<e.data.byteLength;s++){let a=i.getUint8(s);if(0===a)n++;else if(1===a){if(2===n||3===n){let a=s-n;if(-1===r?r=a:-1===o&&(o=a,t.push(new UV(new DataView(i.buffer.slice(r,o)))),r=a,o=-1),6!==i.getUint8(s+1)){e.data=new DataView(i.buffer.slice(a)).buffer;break}}n=0}else n=0}this._log.debug("".concat(t.length," sei received")),lO(this.onSEIMessage)&&t.reverse().forEach((e=>{this.onSEIMessage({seiPayloadType:e.seiPayloadType,data:e.seiPayload.buffer})}))}}catch(pN){this._log.warn(pN)}t.enqueue(e)}encodeSEINalu(e){let t=e.byteLength,i=parseInt(t/255),n=t%255,r=[];r.push(0,0,0,1,6,this._seiPayloadType);for(let s=0;s<i;s++)r.push(255);r.push(n);let o=new DataView(e);return r.push(...new Uint8Array(o.buffer)),r.push(128),new UV(new DataView(new Uint8Array(r).buffer),!0)}},FV=0,BV=!1,HV=new Set,jV=!1,GV=class{constructor(e){hb(this,"userId"),hb(this,"tinyId"),hb(this,"_sdpSemantics"),hb(this,"_isUplink"),hb(this,"_room"),hb(this,"_log"),hb(this,"_signalChannel"),hb(this,"_isErrorObserved",!1),hb(this,"_waitForPeerConnectionConnectedPromise"),hb(this,"_waitForPeerConnectionConnectedPromiseReject",null),hb(this,"_peerConnection",null),hb(this,"_emitter",new VV.default),hb(this,"_currentState","DISCONNECTED"),hb(this,"_isReconnecting",!1),hb(this,"_reconnectionCount",0),hb(this,"_reconnectionTimer",-1),hb(this,"_isFirstConnection",!0),hb(this,"_prevTime",-1),hb(this,"_enableSEI"),hb(this,"_sei"),hb(this,"_localAddress"),hb(this,"_remoteAddress"),this.userId=e.userId,this.tinyId=e.tinyId,this._room=e.room,this._sdpSemantics=e.room.sdpSemantics,this._isUplink=e.isUplink,this._log=YO.createLogger({id:"n",userId:this._room.userId,remoteUserId:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=e.signalChannel,this._enableSEI=e.enableSEI,this._enableSEI&&UP&&(this._sei=new xV(this,this._log,this._isUplink))}beforeConnect(){this._prevTime<0&&(this._prevTime=yO())}afterConnect(e){return _b(this,null,(function*(){try{yield e,this._isFirstConnection?(this._isFirstConnection=!1,GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",cost:Math.min(yO()-this._prevTime,3e4)})):this._isReconnecting&&GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",cost:yO()-this._prevTime}),this._prevTime=-1}catch(pD){throw this._isFirstConnection?(this._isFirstConnection=!1,GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionConnect",error:pD})):this._isReconnecting&&this._reconnectionCount>=3&&GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"PeerConnectionReconnect",error:pD}),pD}}))}initialize(){let e={encodedInsertableStreams:this._enableSEI&&UP,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"};this._peerConnection=new RTCPeerConnection(e),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this)}close(e){this._log.info("close connection"),this._emitter.emit("closed",e),this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this._sei&&(this._sei.destroy(),this._sei=null),HV.delete(this)}closePeerConnection(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._peerConnection&&(this._log.info("close pc"),this._peerConnection.onconnectionstatechange=null,this._peerConnection.close(),this._peerConnection=null,e&&this.emitConnectionStateChangedEvent("DISCONNECTED")),this._waitForPeerConnectionConnectedPromiseReject&&this._waitForPeerConnectionConnectedPromiseReject(new vb({code:Ab.API_CALL_ABORTED,message:"connection closed"}))}getDTLSTransportState(){if(!this._peerConnection)return cN;let e=null;if(this._isUplink){if(!kP()||0===this._peerConnection.getSenders().length)return cN;e=this._peerConnection.getSenders()[0].transport}else{if(!bP()||0===this._peerConnection.getReceivers().length)return cN;e=this._peerConnection.getReceivers()[0].transport}return e?e.state:cN}onConnectionStateChange(e){let t=this._peerConnection.iceConnectionState,i=this.getDTLSTransportState();if(this._log.info("connectionState: ".concat(e.target.connectionState,", ICE: ").concat(t,", DTLS: ").concat(i)),e.target.connectionState===lN.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),e.target.connectionState===lN.FAILED||e.target.connectionState===lN.CLOSED){let n="connection ".concat(e.target.connectionState,". ICE Transport state: ").concat(t,", DTLS Transport state: ").concat(i),r=new vb({message:n,code:Ab.ICE_TRANSPORT_ERROR});this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection(),this._isErrorObserved||this._emitter.emit("error",r)}(e.target.connectionState===lN.CONNECTED||e.target.connectionState===lN.COMPLETED)&&(this.logSelectedCandidate(),sL.logSuccessEvent({userId:this._room.userId,eventType:mN.ICE_CONNECTION_STATE}),this.emitConnectionStateChangedEvent("CONNECTED"))}emitConnectionStateChangedEvent(e){return e!==this._currentState&&("CONNECTED"===e?(FV=0,BV=!1,jV=!0,HV.add(this)):HV.delete(this),GO.emit(JO.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:e,remoteUserId:this._isUplink?void 0:this.userId}),this._emitter.emit("connection-state-changed",{prevState:this._currentState,state:e}),this._currentState=e,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}logSelectedCandidate(){return _b(this,null,(function*(){if(!this._peerConnection)return;let e=yield this._peerConnection.getStats();for(let[,t]of e)if(IP(t)){let i=e.get(t.localCandidateId),n=e.get(t.remoteCandidateId);i&&(this._log.info("local candidate: ".concat(i.candidateType," ").concat(i.protocol,":").concat(i.ip||i.address,":").concat(i.port," ").concat(i.networkType||""," ").concat("relay"===i.candidateType?"relayProtocol:".concat(i.relayProtocol):"")),this._localAddress="".concat(i.ip||i.address,":").concat(i.port)),n&&(this._log.info("remote candidate: ".concat(n.candidateType," ").concat(n.protocol,":").concat(n.ip||n.address,":").concat(n.port)),this._remoteAddress="".concat(n.protocol,":").concat(n.ip||n.address));break}}))}getCurrentState(){return this._currentState}waitForPeerConnectionConnected(){return this._waitForPeerConnectionConnectedPromise||(this._waitForPeerConnectionConnectedPromise=new Promise(((e,t)=>{if("CONNECTED"===this._currentState)return e();this._waitForPeerConnectionConnectedPromiseReject=t;let i=t=>{"CONNECTED"===t.state&&(clearTimeout(o),r(),e())},n=e=>{let{room:i}=e;i===this._room&&(clearTimeout(o),r(),t(new vb({code:Ab.API_CALL_ABORTED,message:rP({key:XO.CONNECTION_ABORTED,data:"leave room"})})))},r=()=>{GO.off(JO.LEAVE_SUCCESS,n,this),this._emitter.off("connection-state-changed",i,this)},o=setTimeout((()=>{r();let e=new vb({code:Ab.API_CALL_TIMEOUT,message:"connection timeout"});FV+=1,(e=>FV>2&&!BV&&0===HV.size&&e)(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),BV=!0,this._emitter.emit("firewall-restriction")),t(e)}),bN);GO.on(JO.LEAVE_SUCCESS,n,this),this._emitter.on("connection-state-changed",i,this)})),this._waitForPeerConnectionConnectedPromise=this._waitForPeerConnectionConnectedPromise.finally((()=>{this._waitForPeerConnectionConnectedPromise=null,this._waitForPeerConnectionConnectedPromiseReject=null}))),this._waitForPeerConnectionConnectedPromise}getReconnectionCount(){return this._reconnectionCount}startReconnection(){this._isReconnecting=!0,this.reconnect()}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}stopReconnection(){this._log.info("stop reconnection"),this._isReconnecting=!1,this._reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(nV,this.reconnect,this)}beforeReconnect(){if(-1!==this._reconnectionTimer)return this._log.warn("reconnect() is reconnecting, ignore"),-1;if(this._reconnectionCount>=hN()){this._log.warn("SDK has tried reconnect for ".concat(this._reconnectionCount," times, but all failed, please check your network")),this.stopReconnection();let e=new vb({code:this._isUplink?Ab.UPLINK_RECONNECTION_FAILED:Ab.DOWNLINK_RECONNECTION_FAILED,message:rP({key:this._isUplink?XO.UPLINK_RECONNECTION_FAILED:XO.DOWNLINK_RECONNECTION_FAILED})});return this.emitConnectionStateChangedEvent("DISCONNECTED"),this._emitter.emit("error",e),-1}return this._signalChannel.isConnected?(this._reconnectionCount+=1,this._log.warn("reconnect() trying [".concat(this._reconnectionCount,"]")),1):(this._log.warn("reconnect() signal channel is not connected, suspend reconnection until signal is connected"),this._signalChannel.once(nV,this.reconnect,this),-1)}on(e,t,i){this._emitter.on(e,t,i)}off(e,t,i){this._emitter.off(e,t,i)}getIsReconnecting(){return this._isReconnecting}get isH264(){var e,t;return!(null==(t=null==(e=this._peerConnection)?void 0:e.remoteDescription)||!t.sdp.includes("H264"))}},WV=db(Eb()),JV=function(e){return WV.default.parse(e)},KV=function(e){return WV.default.write(e)};function YV(e){return Object.keys(e).filter((t=>e[t]))}var zV=class extends GV{constructor(e){super(ab(sb({},e),{isUplink:!1})),hb(this,"_flag",0),hb(this,"role","anchor"),hb(this,"remoteAudioTrack"),hb(this,"remoteVideoTrack"),hb(this,"remoteAuxiliaryTrack"),hb(this,"ssrc",{audio:0,video:0,auxiliary:0}),hb(this,"_isSDPExchanging",!1),this.flag=e.flag,this.remoteAudioTrack=e.remoteAudioTrack||new Mw(this._room,this),this.remoteVideoTrack=e.remoteVideoTrack||new Vw(this._room,this),this.remoteAuxiliaryTrack=e.remoteAuxiliaryTrack||new Uw(this._room,this)}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(8&this.remoteVideoTrack.mediaType?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return kO(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var t,i,n;e!==this._flag&&(this._flag=e,null==(t=this.remoteAudioTrack)||t.onFlagChanged(),null==(i=this.remoteVideoTrack)||i.onFlagChanged(),null==(n=this.remoteAuxiliaryTrack)||n.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===HD.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){super.initialize(),this.installEvents(),this._peerConnection.ontrack=this.onTrack.bind(this)}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents()}installEvents(){}uninstallEvents(){this._emitter.removeAllListeners()}emitConnectionStateChangedEvent(e){var t,i;let n=this._currentState,r=super.emitConnectionStateChangedEvent(e);return r&&n!==e&&(null==(t=this.remoteVideoTrack)||t.emit("connection-state-changed",{prevState:n,state:e}),null==(i=this.remoteAuxiliaryTrack)||i.emit("connection-state-changed",{prevState:n,state:e})),r}onTrack(e){let t=e.streams[0],{track:i}=e,n=t.id===XD?HD.MAIN:HD.AUXILIARY;this._log.debug("ontrack ".concat(n," ").concat(i.kind));let r=HD.AUDIO;i.kind===HD.VIDEO&&(r=n===HD.MAIN?HD.VIDEO:HD.AUXILIARY);let o=this.remoteAudioTrack;r===HD.VIDEO?o=this.remoteVideoTrack:r===HD.AUXILIARY&&(o=this.remoteAuxiliaryTrack),o.setMediaStream(t),o.setMediaStreamTrack(i)}addRRTRLine(e){let t=e.split("\r\n"),i=new Map;t.forEach(((e,n)=>{/^a=rtcp-fb:/.test(e)&&t[n+1]&&!/^a=rtcp-fb:/.test(t[n+1])&&i.set(n+1,"".concat(e.match(/^a=rtcp-fb:\d+/)[0]," rrtr"))}));let n=[...i];for(let r=0;r<n.length;r++){let[e,i]=n[r];t.splice(e+r,0,i)}return t.join("\r\n")}addSPSDescription(e){let t=JV(e);return t.media.forEach((e=>{e.type===HD.VIDEO&&e.fmtp.forEach((e=>{e.config+=";sps-pps-idr-in-keyframe=1"}))})),KV(t)}removeSDESDescription(e){let t=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"],i=JV(e);return i.media.forEach((e=>{!e.ext||(e.ext=e.ext.filter((e=>!t.includes(e.uri))))})),KV(i)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,t){return _b(this,null,(function*(){var i,n;try{if(((null==(i=this._peerConnection)?void 0:i.connectionState)===lN.NEW||(null==(n=this._peerConnection)?void 0:n.connectionState)===lN.CONNECTING)&&(yield this.waitForPeerConnectionConnected()),this.isSubscriptionStateNotChanged(e))return void(this._peerConnection||(this.initialize(),yield this.connect(e)));if(this._log.info("subscribe ".concat(t," ").concat(JSON.stringify(e))),this._peerConnection||this._isSDPExchanging){let t="subscribe_change";Object.values(e).find((e=>!0===e))||(t="unsubscribe"),yield this.sendSubscription(t,e)}else this.initialize(),yield this.connect(e)}catch(mD){throw this._room.isJoined&&this.isStreamUnpublished(t)?(this._log.warn("".concat(mD.message," ").concat(JSON.stringify(this.muteState))),new vb({code:Ab.REMOTE_STREAM_NOT_EXIST,message:"remote user ".concat(this.userId," unpublished stream")})):mD}}))}unsubscribe(e){return _b(this,arguments,(function(e){var t=this;let{remoteTracks:i,streamType:n}=e;return function*(){if("CONNECTED"===t._currentState&&("main"===n&&!t.isMainStreamSubscribed||"auxiliary"===n&&!t.isAuxStreamSubscribed))return void t._log.info("".concat(n," stream already unsubscribed"));let e=sb({},t.subscribeState);i.forEach((t=>{switch(t.mediaType){case 1:e.audio=!1;break;case 4:e.video=!1;break;case 8:e.smallVideo=!1;break;case 2:e.auxiliary=!1}}));let r="subscribe_change";Object.values(e).find((e=>!0===e))||(r="unsubscribe"),t._log.info("".concat("unsubscribe"===r?r:"subscribe"," ").concat(n," [").concat(YV(e),"]")),yield t.sendSubscription(r,e),"unsubscribe"===r&&(t.remoteAudioTrack.setMediaStreamTrack(null),t.remoteVideoTrack.setMediaStreamTrack(null),t.remoteAuxiliaryTrack.setMediaStreamTrack(null),t.closePeerConnection(),t.emitConnectionStateChangedEvent("DISCONNECTED"))}()}))}sendSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscribeState,i={srcTinyId:this.tinyId,srcUserId:this.userId},n=IV,r=dV.UNSUBSCRIBE_RESULT;return"subscribe_change"===e&&(i={audio:t.audio,bigVideo:t.video,auxVideo:t.auxiliary,smallVideo:t.smallVideo,srcTinyId:this.tinyId},n=SV,r=dV.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:n,data:i,responseCommand:r,timeout:1e4}).then((t=>{let{data:i}=t;if(0!==i.code){let t=new vb({code:i.code,message:rP({key:XO.ERROR_MESSAGE,data:{type:e,message:i.message}})});throw this._log.error(t),t}}))}connect(){return _b(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.subscribeState;return function*(){try{yield e.exchangeSDP(t),yield e.waitForPeerConnectionConnected()}catch(pN){throw e.closePeerConnection(!0),pN}}()}))}exchangeSDP(e){return _b(this,null,(function*(){try{this._isSDPExchanging=!0,yield this.createOffer(),this._log.info("createOffer success, sending offer");let{type:t,sdp:i}=this._peerConnection.localDescription,n={type:t,sdp:i,srcUserId:this.userId,srcTinyId:this.tinyId,audio:e.audio,bigVideo:e.video,auxVideo:e.auxiliary,smallVideo:e.smallVideo},r=yield this._signalChannel.sendWaitForResponse({command:EV,commandDesc:"exchange sdp",data:n,responseCommand:dV.SUBSCRIBE_RESULT,timeout:TN});if(!this._peerConnection){let e=new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.CONNECTION_CLOSED})});throw this._log.warn(e),e}yield this.onSubscribeResult(r),this._isSDPExchanging=!1}catch(pN){throw this._isSDPExchanging=!1,pN}}))}createOffer(){return _b(this,null,(function*(){let e={voiceActivityDetection:!1};NP()&&this._sdpSemantics===EN?(this._peerConnection.addTransceiver(HD.AUDIO,{direction:jD.RECVONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:jD.RECVONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:jD.RECVONLY})):(e.offerToReceiveAudio=!0,e.offerToReceiveVideo=!0);let t=yield this._peerConnection.createOffer(e);if(t.sdp){let{isH264DecodeSupported:e}=yield mP();e||(this._log.warn("remove h264 desc from sdp"),t.sdp=function(e){let t=JV(e);return t.media.forEach((e=>{var t,i;if(e.type===HD.VIDEO){let n=new Set;e.rtp.forEach((e=>{let{payload:t,codec:i}=e;return"H264"===i&&n.add(t)})),e.fmtp.forEach((e=>{let{payload:t,config:i}=e,r=i.match(/apt=(\d+)/);r&&r[1]&&n.has(Number(r[1]))&&n.add(t)}));let r=e=>{let{payload:t}=e;return!n.has(t)};e.rtp=e.rtp.filter(r),e.rtcpFb=null==(t=e.rtcpFb)?void 0:t.filter(r),e.fmtp=e.fmtp.filter(r),e.payloads=null==(i=e.payloads)?void 0:i.split(" ").filter((e=>!n.has(Number(e)))).join(" ")}})),KV(t)}(t.sdp)),t.sdp=this.addRRTRLine(t.sdp),t.sdp=this.addSPSDescription(t.sdp),t.sdp=function(e){let t=JV(e);return t.media.forEach((e=>{e.type===HD.AUDIO&&e.fmtp.forEach((e=>{e.config+=";sprop-stereo=1;stereo=1"}))})),KV(t)}(t.sdp),this._sdpSemantics===EN&&(t.sdp=this.removeSDESDescription(t.sdp))}yield this._peerConnection.setLocalDescription(t)}))}onSubscribeResult(e){return _b(this,null,(function*(){let{code:t,message:i=""}=e&&e.data||{},{type:n,sdp:r}=e&&e.data&&e.data.data||{};if(t===SN)throw new vb({code:Ab.NOT_SUPPORTED_H264,message:rP({key:XO.NOT_SUPPORTED_H264DECODE})});try{if(0!==t)throw new vb({code:t,message:rP({key:XO.EXCHANGE_SDP_FAILED,data:{errMsg:i}})});this._log.debug("accept remote answer: ".concat(r)),yield this._peerConnection.setRemoteDescription({type:n,sdp:r}),this._sei&&(this._sei.handleEncodedStreams(),this._sei.onSEIMessage=e=>{this._emitter.emit("sei-message",ab(sb({},e),{userId:this.userId}))}),this.updateSSRC(r)}catch(BU){throw this._log.error(BU),BU}}))}updateSSRC(e){try{JV(e).media.forEach((e=>{if(e.ssrcs)if(e.type===HD.AUDIO){let t=e.ssrcs.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(XD)}));t&&(this.ssrc.audio=Number(t.id))}else{let t=e.ssrcs.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(XD)})),i=e.ssrcs.find((e=>{var t;return null==(t=e.value)?void 0:t.includes(ZD)}));t&&(this.ssrc.video=Number(t.id)),i&&(this.ssrc.auxiliary=Number(i.id))}}))}catch(pN){}}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}reconnect(){return _b(this,null,(function*(){if(!(pb(zV.prototype,this,"beforeReconnect").call(this)<0))try{this.closePeerConnection(),this.initialize(),yield this.connect(),this.stopReconnection(),this._log.warn("reconnect() success")}catch(pN){let t=aO(this._reconnectionCount);this._log.warn("reconnect() timeout, try again after ".concat(t/1e3,"s")),this._reconnectionTimer=setTimeout((()=>{this.clearReconnectionTimer(),this.reconnect()}),t)}}))}getIsReconnecting(){return this._isReconnecting}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}getCurrentState(){return this._currentState}setDelay(e){let{audioDelay:t,videoDelay:i}=e;this.remoteAudioTrack.stat.end2EndDelay=t,this.remoteVideoTrack.stat.end2EndDelay=i}},qV=zV;ub([hw((e=>function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return new Promise(((t,n)=>{let r=e=>{this._emitter.off("closed",r),n(new vb({code:Ab.API_CALL_ABORTED,message:rP({key:XO.CONNECTION_ABORTED,data:e})}))};this._emitter.on("closed",r),e.apply(this,i).then(t,n).finally((()=>{this._emitter.off("closed",r)}))}))}))],qV.prototype,"subscribe",1),ub([uw(GV.prototype.afterConnect),dw(GV.prototype.beforeConnect)],qV.prototype,"connect",1);var QV=qV,XV=new Blob(["let width,height,offscreen,ctx;onmessage=function(e){const{action,data}=e.data;switch(action){case'render':offscreen=data.canvas;width=offscreen.width;height=offscreen.height;ctx=offscreen.getContext('2d');draw(data.readable,data.writable);break}};function draw(readable,writable){const transformer=new TransformStream({async transform(cameraFrame,controller){ctx.drawImage(cameraFrame,0,0,width,height);const frame=new VideoFrame(offscreen,{timestamp:cameraFrame.timestamp});cameraFrame.close();controller.enqueue(frame)}});readable.pipeThrough(transformer).pipeTo(writable)}"],{type:"application/javascript"}),ZV=class{constructor(e){hb(this,"width"),hb(this,"height"),hb(this,"canvas"),hb(this,"offscreen"),hb(this,"smallGenerator"),hb(this,"smallWritable"),hb(this,"bigProcessor"),hb(this,"bigReadable"),hb(this,"worker");let{videoTrack:t}=e;this.width=void 0,this.height=void 0,this.canvas=null,this.offscreen=null,this.smallGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.smallWritable=this.smallGenerator.writable,this.bigProcessor=new MediaStreamTrackProcessor({track:t}),this.bigReadable=this.bigProcessor.readable,this.initWorker()}initWorker(){try{this.worker=new Worker(URL.createObjectURL(XV)),YO.info("init worker processor success")}catch(Xw){YO.warn("init worker processor failed. ".concat(Xw.error))}}setCanvasRect(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.offscreen=this.canvas.transferControlToOffscreen(),this.worker.postMessage({action:"render",data:{canvas:this.offscreen,readable:this.bigReadable,writable:this.smallWritable}},[this.offscreen,this.bigReadable,this.smallWritable])}generateVideoTrack(){let e=new MediaStream([this.smallGenerator]);return null==e?void 0:e.getTracks()[0]}destroy(){this.worker.terminate()}},$V=class{constructor(e){hb(this,"_player"),hb(this,"_canvas"),hb(this,"_canvasCtx"),this._player=e,this._canvas=document.createElement("canvas"),this._canvasCtx=this._canvas.getContext("2d")}setCanvasRect(e,t){!this._canvas||(this._canvas.width=e,this._canvas.height=t)}drawVideoToCanvas(){let e=this._player.getElement();this._canvas&&this._canvasCtx&&e&&this._canvasCtx.drawImage(e,0,0,this._canvas.width,this._canvas.height)}generateVideoTrack(e){return this._canvas.captureStream(e).getVideoTracks()[0]}generateStreamFromTrack(e){let t=new MediaStream;return t.addTrack(e),t}destroy(){var e;null==(e=this._player)||e.stop(),this._canvas&&(this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._canvasCtx=null)}get canvas(){return this._canvas}get canvasCtx(){return this._canvasCtx}get canDrawVideoToCanvas(){if(this._player){let e=this._player.getElement();if(e)return e.readyState===e.HAVE_ENOUGH_DATA}return!1}},eU=class{constructor(e){hb(this,"_player"),hb(this,"_processor"),hb(this,"_initOffscreenSuccess"),hb(this,"_localVideoTrack"),hb(this,"_interval"),this._localVideoTrack=e,this._player=e.player,this._processor=null,this._initOffscreenSuccess=!1}initialize(){return _b(this,null,(function*(){if(pP()&&(null==navigator?void 0:navigator.hardwareConcurrency)>=6)try{yield this.initOffscreen(),this._initOffscreenSuccess=!0,YO.info("Initialize VideoGenerator successfully!")}catch(Xw){this.initCanvas()}else this.initCanvas()}))}generateSmallVideoTrack(e){let t,i=this.getSmallVideoProfile(e);return this._initOffscreenSuccess?(this._processor.setCanvasRect(i.width,i.height),t=this._processor.generateVideoTrack(i.frameRate)):(this._processor.setCanvasRect(i.width,i.height),this._player.setRect(i.width,i.height),t=this._processor.generateVideoTrack(i.frameRate),this._interval=nL.run(BN,this.render.bind(this),{fps:i.frameRate})),t}render(){this._processor instanceof $V&&this._processor.drawVideoToCanvas()}destroy(){nL.clearTask(this._interval),this._processor&&this._processor.destroy()}initOffscreen(){this._processor=new ZV({videoTrack:this._localVideoTrack.mediaTrack})}initCanvas(){this._player=new LL({track:this._localVideoTrack.mediaTrack,muted:!0,objectFit:"cover",mirror:!1,container:null,id:"video-player",log:this._localVideoTrack.log}),this._player.play().then((()=>{YO.info("VideoGenerator: play local video success")})).catch((()=>{YO.error("VideoGenerator: Failed to play local video")})),this._processor=new $V(this._player)}getSmallVideoProfile(e){let t=this._localVideoTrack.mediaTrack,i=this._localVideoTrack.profile;if(MP){let e=t.getSettings();e&&e.width&&e.height&&(i.width=e.width,i.height=e.height)}let n,r=i.width*i.height,o=e.width*e.height;return YO.info("big res: ".concat(i.width,"*").concat(i.height," small res: ").concat(e.width,"*").concat(e.height," ")),r>o?n=r/o:(YO.warn("Small stream resolution is larger than big stream, which is invalid. big: ".concat(i.width," * ").concat(i.height," small: ").concat(e.width," * ").concat(e.height)),n=r/19200),{width:i.width/Math.sqrt(n),height:i.height/Math.sqrt(n),frameRate:e.frameRate}}},tU={voiceActivityDetection:!1},iU=class extends GV{constructor(e){super(ab(sb({},e),{isUplink:!0})),hb(this,"localMainAudioTrack",null),hb(this,"localMainVideoTrack",null),hb(this,"localAuxAudioTrack",null),hb(this,"localAuxVideoTrack",null),hb(this,"ssrc",{audio:0,video:0,small:0,auxiliary:0}),hb(this,"_isPublishingAux",!1),hb(this,"_publishingLocalAudioTrack"),hb(this,"_publishingLocalVideoTrack"),hb(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0}),hb(this,"_smallGenerator"),hb(this,"_audioManager"),this._audioManager=e.audioManager,this._smallGenerator=null}get isMainStreamPublished(){return!(!this.localMainAudioTrack&&!this.localMainVideoTrack)}get isAuxStreamPublished(){return!(!this.localAuxVideoTrack&&!this.localAuxAudioTrack)}get publishState(){var e,t,i,n;let r={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let o=this._peerConnection.getSenders();o&&(DP()?(r.audio=!(null==(e=o[0])||!e.track),r.bigVideo=!(null==(t=o[1])||!t.track),r.smallVideo=!(null==(i=o[2])||!i.track),r.auxVideo=!(null==(n=o[3])||!n.track)):o.forEach((e=>{e.track&&(e.track.kind===HD.AUDIO?r.audio=!0:(r.bigVideo=!0,this._smallGenerator&&(r.smallVideo=!0)))})))}return r}initialize(){super.initialize(),this.installEvents()}reset(){this._isReconnecting&&this.stopReconnection(),this.closePeerConnection(),this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){this._emitter.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this._emitter.on("connection-state-changed",this.handleConnectionStateChange,this)}uninstallEvents(){this._emitter.off("connection-state-changed",this.handleConnectionStateChange,this)}emitConnectionStateChangedEvent(e,t){var i,n,r;let o=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&o!==e&&(t?t.emit("connection-state-changed",{prevState:o,state:e}):(null==(i=this.localMainVideoTrack)||i.emit("connection-state-changed",{prevState:o,state:e}),null==(n=this.localAuxVideoTrack)||n.emit("connection-state-changed",{prevState:o,state:e}),null==(r=this._publishingLocalVideoTrack)||r.emit("connection-state-changed",{prevState:o,state:e}))),s}publish(e){return _b(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:n,isAuxiliary:r}=e;return function*(){var e;let o;t._peerConnection||t.initialize(),i&&(t._publishingLocalAudioTrack=i),n&&(t._publishingLocalVideoTrack=n),t._isPublishingAux=r,n&&!r&&n.small&&(t._smallGenerator=new eU(n),yield t._smallGenerator.initialize(),o=t._smallGenerator.generateSmallVideoTrack(n.small)),t.sendMediaSettings(),NP()?yield t.publishByTransceiver({localAudioTrack:i,localVideoTrack:n,smallTrack:o,isAuxiliary:r}):yield t.publishByAddTrack({localAudioTrack:i,localVideoTrack:n,smallTrack:o}),t._publishingLocalAudioTrack=null,t._publishingLocalVideoTrack=null,t._isPublishingAux=!1,r?(n&&(t.localAuxVideoTrack=n),i&&(t.localAuxAudioTrack=i)):(n&&(t.localMainVideoTrack=n),i&&(t.localMainAudioTrack=i)),null==(e=t._sei)||e.handleEncodedStreams(),t.installTrackMuteEvents(i,n),t.sendMutedFlag()}()}))}publishByTransceiver(e){return _b(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:n,smallTrack:r,isAuxiliary:o}=e;return function*(){t._log.info("publish by transceiver");let e=new MediaStream;n&&Zk&&Xk&&n.genCanvasTrack();let s=(null==n?void 0:n.canvasTrack)||(null==n?void 0:n.mediaTrack),a=t._audioManager.mediaStreamTrack;a&&e.addTrack(a),s&&e.addTrack(s);let c=t._peerConnection.getTransceivers();if(0===c.length)t._peerConnection.addTransceiver(a||HD.AUDIO,{direction:jD.SENDONLY,streams:[e]}),t._peerConnection.addTransceiver(o?HD.VIDEO:s||HD.VIDEO,{direction:jD.SENDONLY,streams:[e]}),t._peerConnection.addTransceiver(r||HD.VIDEO,{direction:jD.SENDONLY,streams:[e]}),t._peerConnection.addTransceiver(o&&s||HD.VIDEO,{direction:jD.SENDONLY,streams:[e]}),yield t.connect();else{let e=[];if(a&&(c[0].sender.track||e.push(0),yield c[0].sender.replaceTrack(a),yield t.setBandwidth({bandwidth:(null==i?void 0:i.profile.bitrate)||40,type:HD.AUDIO})),s){let i=o?3:1;yield c[i].sender.replaceTrack(s),yield t.setBandwidth({bandwidth:n.profile.bitrate,type:HD.VIDEO,videoType:o?HD.AUXILIARY:HD.BIG}),e.push(i),r&&(yield c[2].sender.replaceTrack(r),yield t.setBandwidth({bandwidth:n.small.bitrate,type:HD.VIDEO,videoType:HD.SMALL}),e.push(2))}yield t.setTransceiverDirection(jD.SENDONLY,e),yield t.doPublishChange(),null==n||n.emit("connection-state-changed",{prevState:"DISCONNECTED",state:"CONNECTING"}),null==n||n.emit("connection-state-changed",{prevState:"CONNECTING",state:"CONNECTED"})}}()}))}publishByAddTrack(e){return _b(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:n,smallTrack:r}=e;return function*(){t._log.info("publish by addtrack");let e=null==n?void 0:n.mediaTrack,o=null!=i&&i.mediaTrack?t._audioManager.mediaStreamTrack:null;if(t._peerConnection&&"new"!==t._peerConnection.connectionState)return o&&(yield t.addTrack(i)),void(e&&(yield t.addTrack(n)));let s=new MediaStream;if(o&&s.addTrack(o),e&&s.addTrack(e),o&&t._peerConnection.addTrack(o,s),e&&(t._peerConnection.addTrack(e,s),r)){let e=new MediaStream;e.addTrack(r),t._peerConnection.addTrack(r,e)}yield t.connect()}()}))}installTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.on("mute",this.sendMutedFlag,this),null==e||e.on("unmute",this.sendMutedFlag,this))}))}uninstallTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.off("mute",this.sendMutedFlag,this),null==e||e.off("unmute",this.sendMutedFlag,this))}))}unpublish(e){return _b(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:n}=e;return function*(){if(!DP())return i&&i.mediaTrack&&!n&&t.localMainVideoTrack?(yield t.removeTrack(i),void(t.localMainAudioTrack=null)):n&&n.mediaTrack&&!i&&t.localMainAudioTrack?(yield t.removeTrack(n),void(t.localMainVideoTrack=null)):(yield t.doUnpublish(),t.uninstallTrackMuteEvents(i,n),void t.emitConnectionStateChangedEvent("DISCONNECTED",n));let e=n&&n===t.localAuxVideoTrack,r=null==i?void 0:i.mediaTrack,o=null==n?void 0:n.mediaTrack,s=t._peerConnection.getSenders(),a=[];r&&(t._audioManager.removeAudioTrack(i),t._audioManager.isMixed||(yield s[0].replaceTrack(null),a.push(0)),e?t.localAuxAudioTrack=null:t.localMainAudioTrack=null),o&&(e?(yield s[3].replaceTrack(null),t.localAuxVideoTrack=null,t._mediaSettings=ab(sb({},t._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),a.push(3)):(yield s[1].replaceTrack(null),yield s[2].replaceTrack(null),t.localMainVideoTrack=null,t._mediaSettings=ab(sb({},t._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),a.push(1,2))),t.isMainStreamPublished||t.isAuxStreamPublished?(yield t.setTransceiverDirection(jD.INACTIVE,a),yield t.doPublishChange(!1)):yield t.doUnpublish(),t.uninstallTrackMuteEvents(i,n),null==n||n.emit("connection-state-changed",{prevState:t._currentState,state:"DISCONNECTED"})}()}))}doPublishChange(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return _b(this,null,(function*(){let t={state:this.publishState,constraintConfig:this._mediaSettings},i=yield this._signalChannel.sendWaitForResponse({command:gV,data:t,responseCommand:dV.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(i.data.code,i.data.message)}))}doUnpublish(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._signalChannel.sendWaitForResponse({command:TV,commandDesc:"unpublish",responseCommand:dV.UNPUBLISH_RESULT,enableLog:e}).catch((e=>{if(e.getCode()===Ab.API_CALL_TIMEOUT)return Promise.resolve();throw e}))}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:t}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":t&&(this._mediaSettings.videoCodec="VP8");let i=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:n,localAuxVideoTrack:r}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?r=this._publishingLocalVideoTrack:n=this._publishingLocalVideoTrack),MP){if(i&&i.mediaTrack){let e=i.mediaTrack.getSettings();this._mediaSettings.audioChannel=e.channelCount||1,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=e.sampleRate||0}if(n&&n.mediaTrack){let e=n.mediaTrack.getSettings();this._mediaSettings.videoWidth=e.width||0,this._mediaSettings.videoHeight=e.height||0,this._mediaSettings.videoFps=e.frameRate||0,this._mediaSettings.videoBps=1e3*n.profile.bitrate,n.small&&(this._mediaSettings.smallVideoWidth=n.small.width,this._mediaSettings.smallVideoHeight=n.small.height,this._mediaSettings.smallVideoFps=n.small.frameRate,this._mediaSettings.smallVideoBps=1e3*n.small.bitrate)}if(r&&r.mediaTrack){let e=r.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=e.width||0,this._mediaSettings.auxVideoHeight=e.height||0,this._mediaSettings.auxVideoFps=e.frameRate||0,this._mediaSettings.auxVideoBps=1e3*r.profile.bitrate}}else i&&i.mediaTrack&&(this._mediaSettings.audioChannel=i.profile.channelCount,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=i.profile.sampleRate),n&&n.mediaTrack&&(this._mediaSettings.videoWidth=n.profile.width,this._mediaSettings.videoHeight=n.profile.height,this._mediaSettings.videoFps=n.profile.frameRate,this._mediaSettings.videoBps=1e3*n.profile.bitrate);this._log.info("updateMediaSettings: ".concat(JSON.stringify(this._mediaSettings)))}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:NV,data:this._mediaSettings,responseCommand:dV.UPDATE_CONSTRAINT_CONFIG_RES}).then((e=>{0!==e.data.code&&this._log.warn(e.data.message)})).catch((()=>{}))}addTrack(e){return _b(this,null,(function*(){var t;if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is adding ".concat(e.kind," track to current published local ").concat(i?HD.AUXILIARY:HD.MAIN," stream")),null==(t=this._sei)||t.handleEncodedStreams(),NP()?yield this.addTrackByTransceiver(e,i):yield this.addTrackBySender(e)}))}addTrackByTransceiver(e,t){return _b(this,null,(function*(){var i;if(!e.mediaTrack)return;let n=this._peerConnection.getTransceivers(),r=e.mediaTrack;if(e.kind===HD.AUDIO)this._audioManager.addAudioTrack(e),r=this._audioManager.mediaStreamTrack,yield n[0].sender.replaceTrack(r);else{let e=t?3:1;if(yield n[e].sender.replaceTrack(r),1===e&&(null==(i=this.localMainVideoTrack)?void 0:i.small)){this._smallGenerator=new eU(this.localMainVideoTrack),yield this._smallGenerator.initialize();let e=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield n[2].sender.replaceTrack(e)}n[e].direction===jD.INACTIVE&&(yield this.setTransceiverDirection(jD.SENDONLY,[e]))}this.updateMediaSettings(),yield this.doPublishChange()}))}addTrackBySender(e){return _b(this,null,(function*(){if(!e.mediaTrack)return;let t=e.mediaTrack;DP()&&this._peerConnection.getTransceivers().findIndex((e=>"stopped"===e.direction))>=0&&(this._log.warn("transceiver is stopping, negotiate sdp first"),yield this.updateOffer("remove",t));let i=this._peerConnection.getSenders().find((e=>e.track&&e.track.kind===t.kind));if(i&&i.track){this._log.warn("sender already exists, remove sender first");let e=i.track;this.removeSender(i),yield this.updateOffer("remove",e)}let{mediaStream:n}=e;if(this._peerConnection.addTrack(t,n),t.kind===HD.VIDEO&&e instanceof fw&&e.small){this._smallGenerator=new eU(e),yield this._smallGenerator.initialize();let t=this._smallGenerator.generateSmallVideoTrack(e.small),i=new MediaStream;i.addTrack(t),this._peerConnection.addTrack(t,i)}yield this.updateOffer("add",t)}))}isNeedToResetOfferOrder(){if(this._sdpSemantics===IN||!this._peerConnection||!this._peerConnection.localDescription)return!1;let{sdp:e}=this._peerConnection.localDescription,t=JV(e);for(let i=0;i<t.media.length;i++)if(0===Number(t.media[i].mid)&&t.media[i].type===HD.VIDEO)return!0;return!1}removeSender(e){let t=null;DP()&&(t=this._peerConnection.getTransceivers().find((t=>t.sender&&t.sender.track===e.track))),this._peerConnection.removeTrack(e),t&&lO(t.stop)&&(this._log.info("stop transceiver"),t.stop())}removeTrack(e){return _b(this,null,(function*(){if(!this._peerConnection)return;let t=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is removing ".concat(e.kind," track from current published local ").concat(t?HD.AUXILIARY:HD.MAIN," stream")),NP()?yield this.removeTrackByTransceiver(e,t):yield this.removeTrackBySender(e)}))}removeTrackByTransceiver(e,t){return _b(this,null,(function*(){if(!e.mediaTrack)return;let i=this._peerConnection.getTransceivers();if(e.kind===HD.AUDIO)this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield i[0].sender.replaceTrack(null));else{let e=t?3:1;yield i[e].sender.replaceTrack(null),1===e&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield i[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(jD.INACTIVE,[e])}this.updateMediaSettings(),yield this.doPublishChange()}))}setTransceiverDirection(e,t){return _b(this,null,(function*(){if(!Jb)return;let i=!1,n=!1;this._log.info("setting transceiver ".concat(t.join(",")," direction to ").concat(e));let r=this._peerConnection.getTransceivers();if(t.forEach((t=>{r[t].direction!==e&&(r[t].direction=e,i=!0)})),i){this._log.info("updating offer");let e=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(e)}let o=-1,s=this._peerConnection.remoteDescription.sdp.split("\r\n").map((i=>{if(i.match(new RegExp("a=(".concat(jD.INACTIVE,"|").concat(jD.RECVONLY,"|").concat(jD.SENDONLY,")")))&&o++,t.includes(o)){if(e===jD.INACTIVE&&i.includes("a=".concat(jD.RECVONLY)))return n=!0,"a=".concat(e);if(e===jD.SENDONLY&&i.includes("a=".concat(jD.INACTIVE)))return n=!0,"a=".concat(jD.RECVONLY)}return i})).join("\r\n");n&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:s}))}))}removeTrackBySender(e){return _b(this,null,(function*(){var t,i;if(!e.mediaTrack)return;if(e.kind===HD.VIDEO&&this.isNeedToResetOfferOrder()&&this.localMainAudioTrack)return this.reset(),this.initialize(),null==(i=null==(t=this.localMainVideoTrack)?void 0:t.mediaStream)||i.removeTrack(e.mediaTrack),void(yield this.publish({localAudioTrack:this.localMainAudioTrack,isAuxiliary:!1}));let n=this._peerConnection.getSenders().find((t=>t.track===e.mediaTrack));n&&(this.removeSender(n),e.kind===HD.VIDEO&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,this._peerConnection.getSenders().forEach((e=>{e.track&&e.track.kind===HD.VIDEO&&this.removeSender(e)})))),yield this.updateOffer("remove",e.mediaTrack)}))}replaceTrack(e){return _b(this,null,(function*(){var t,i;let n=null==(t=this._peerConnection)?void 0:t.getSenders();if(!n||0===n.length||!e.mediaTrack)return;let r,o=e.mediaTrack;if(r=NP()?o.kind===HD.AUDIO?n[0]:n[1]:n.find((e=>e.track&&e.track.kind===o.kind)),!r)return;let s=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;if(this._log.info("is replacing ".concat(o.kind," track on ").concat(s?HD.AUXILIARY:HD.MAIN," stream")),o.kind===HD.AUDIO)this._audioManager.addAudioTrack(e),this._audioManager.isMixed&&(o=this._audioManager.mediaStreamTrack),yield r.replaceTrack(o);else if(o.kind===HD.VIDEO)if(s)n[3]&&(yield n[3].replaceTrack(o));else if(yield r.replaceTrack(o),this._smallGenerator&&n[2]){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new eU(this.localMainVideoTrack),yield this._smallGenerator.initialize();let e=this._smallGenerator.generateSmallVideoTrack((null==(i=this.localMainVideoTrack)?void 0:i.small)||this._room.smallStreamConfig);yield n[2].replaceTrack(e)}}))}updateOffer(e,t){return _b(this,null,(function*(){try{let i=yield this._peerConnection.createOffer(tU);Jb&&i.sdp&&(i.sdp=this.setSDPDirection(i.sdp,"sendrecv")),yield this._peerConnection.setLocalDescription(i);let n=this.updateMediaSettings(),r={action:e,trackId:t.id,kind:t.kind===HD.VIDEO?"bigVideo":t.kind,type:"offer",sdp:this._peerConnection.localDescription.sdp,constraintConfig:n,state:this.publishState};this._log.info("createOffer success, sending updated offer to remote server"),this._log.debug("updatedOffer: ".concat(r.sdp));let o=yield this._signalChannel.sendWaitForResponse({command:uV,data:r,responseCommand:dV.UPDATE_OFFER_RESULT,timeout:gN,commandDesc:"update offer"}),{code:s,message:a}=o.data;0!==s&&this.checkPublishResultCode(s,a),yield this.acceptAnswer(o.data.data),i.sdp&&this.updateSSRC(i.sdp)}catch(_D){throw this._log.error(_D),_D}}))}setBandwidth(e){return _b(this,arguments,(function(e){var t=this;let{bandwidth:i,type:n,videoType:r,sdp:o}=e;return function*(){if(!wP())return o?n===HD.VIDEO?t.updateVideoBandwidthRestriction(o,i,r):t.updateAudioBandwidthRestriction(o,i):void 0;let e=0;n===HD.VIDEO&&(e=r===HD.SMALL?2:r===HD.AUXILIARY?3:1);let s=t._peerConnection.getSenders()[e];if(s){let e=s.getParameters();(!e.encodings||0===e.encodings.length)&&(e.encodings=[{}]),e.encodings[0].maxBitrate=1e3*i;try{return yield s.setParameters(e),t._log.info("".concat(r||"").concat(n," bandwidth ").concat(i," kbps")),o}catch(a){if(t._log.info("failed to set bandwidth by setting maxBitrate: ".concat(a)),o)return n===HD.VIDEO?t.updateVideoBandwidthRestriction(o,i,r):t.updateAudioBandwidthRestriction(o,i)}}return o}()}))}updateVideoBandwidthRestriction(e,t,i){let n="AS";Jb&&(n="TIAS",t*=1e3);let r=0,o=-1;return i===HD.SMALL?r=1:i===HD.AUXILIARY&&(r=2),e=e.replace(/m=video (.*)\r\nc=IN (.*)\r\n/g,(e=>(o+=1,o===r?"".concat(e,"b=").concat(n,":").concat(t,"\r\n"):e)))}updateAudioBandwidthRestriction(e,t){let i="AS";return Jb&&(i="TIAS",t*=1e3),e=e.replace(/m=audio (.*)\r\nc=IN (.*)\r\n/,"m=audio $1\r\nc=IN $2\r\nb=".concat(i,":").concat(t,"\r\n"))}removeBandwidthRestriction(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")}removeVideoOrientation(e){return e.replace(/urn:3gpp:video-orientation/,"")}connect(){return _b(this,null,(function*(){try{yield this.exchangeSDP(),yield this.waitForPeerConnectionConnected()}catch(pD){throw this.closePeerConnection(!0),this.uninstallEvents(),pD}}))}exchangeSDP(){return _b(this,null,(function*(){try{yield this.createOffer(),this._log.info("createOffer success, sending offer to remote server"),yield this.doExchangeSDP()}catch(pD){throw pD}}))}createOffer(){return _b(this,null,(function*(){try{let e=yield this._peerConnection.createOffer(tU);yield this._peerConnection.setLocalDescription(e),e.sdp&&this.updateSSRC(e.sdp)}catch(pD){throw pD}}))}doExchangeSDP(){let e={command:fV,responseCommand:dV.PUBLISH_RESULT,data:{type:this._peerConnection.localDescription.type,sdp:this.removeVideoOrientation(this._peerConnection.localDescription.sdp),screen:this.localMainVideoTrack instanceof Tw||this.localAuxVideoTrack instanceof Tw,state:this.publishState,constraintConfig:this._mediaSettings},enableLog:!1};return this._log.debug("sending sdp offer: ".concat(e.data.sdp)),this._signalChannel.sendWaitForResponse(e).then((e=>{let{code:t,message:i,data:n}=e.data;return 0===t?this.acceptAnswer(n):this.checkPublishResultCode(t,i)}))}setSDPDirection(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all",n=JV(e);return n.media.forEach((e=>{("all"===i||e.type===i)&&(e.direction=t)})),KV(n)}acceptAnswer(e){return _b(this,null,(function*(){var t,i,n,r,o;try{let s;if(this._publishingLocalAudioTrack||this._publishingLocalVideoTrack||this.isMainStreamPublished){let e=(null==(t=this._publishingLocalVideoTrack)?void 0:t.profile.bitrate)||(null==(i=this.localMainVideoTrack)?void 0:i.profile.bitrate),o=(null==(n=this._publishingLocalAudioTrack)?void 0:n.profile.bitrate)||(null==(r=this.localMainAudioTrack)?void 0:r.profile.bitrate);if(e){let t=this._isPublishingAux?HD.AUXILIARY:HD.BIG;s=yield this.setBandwidth({bandwidth:e,type:HD.VIDEO,sdp:s,videoType:t})}o&&(s=yield this.setBandwidth({bandwidth:o,type:HD.AUDIO,sdp:s}))}if(s=this.removeVideoOrientation(e.sdp),null!=(o=this._publishingLocalVideoTrack)&&o.small){let{smallStreamConfig:e}=this._room;s=yield this.setBandwidth({bandwidth:this._publishingLocalVideoTrack.small.bitrate||e.bitrate,type:HD.VIDEO,videoType:HD.SMALL,sdp:s})}let a={type:e.type,sdp:s};yield this._peerConnection.setRemoteDescription(a),this._log.debug("accepted answer: ".concat(s))}catch(s){throw this._log.error("failed to accept remote answer ".concat(s)),s}}))}sendMutedFlag(e){var t,i,n;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let r={audio:!(null==(t=this.localMainAudioTrack)||!t.muted),bigVideo:!(null==(i=this.localMainVideoTrack)||!i.muted),auxVideo:!(null==(n=this.localAuxVideoTrack)||!n.muted)};this._log.info("send muted state: ".concat(JSON.stringify(r))),this._signalChannel.send(mV,r)}getIsReconnecting(){return this._isReconnecting}reconnect(){return _b(this,null,(function*(){if(!(pb(iU.prototype,this,"beforeReconnect").call(this)<0))try{yield this._signalChannel.sendWaitForResponse({command:TV,responseCommand:dV.UNPUBLISH_RESULT,enableLog:!1}),this.closePeerConnection(),this.initialize(),this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0})),this._log.warn("reconnect() uplink reconnect successfully"),this.stopReconnection()}catch(pN){let t=aO(this._reconnectionCount);this._log.warn("reconnect() timeout, try again after ".concat(t/1e3,"s")),this._reconnectionTimer=setTimeout((()=>{this.clearReconnectionTimer(),this.reconnect()}),t)}}))}handleConnectionStateChange(e){"CONNECTED"===e.state&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&GO.emit(JO.SEND_FIRST_VIDEO_FRAME,{room:this._room})}updateSSRC(e){try{JV(e).media.forEach(((e,t)=>{if(e.type===HD.AUDIO){let t=e.ssrcs&&e.ssrcs[0];t&&(this.ssrc.audio=Number(t.id))}else{if(this._sdpSemantics===IN&&e.ssrcGroups)return void e.ssrcGroups.forEach(((e,t)=>{let i=Number(e.ssrcs.split(" ")[0]);0===t?this.ssrc.video=i:1===t&&(this.ssrc.small=i)}));let i=e.ssrcs&&e.ssrcs[0];if(!i)return;switch(t){case 1:this.ssrc.video=Number(i.id);break;case 2:this.ssrc.small=Number(i.id);break;case 3:this.ssrc.auxiliary=Number(i.id)}}}))}catch(pN){}}getVideoTrackId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:HD.VIDEO;if(this._peerConnection){let t=this._peerConnection.getSenders();if(e===HD.AUXILIARY&&t[3]&&t[3].track)return t[3].track.id;if(e===HD.VIDEO&&t[1]&&t[1].track)return t[1].track.id}if(this.localMainVideoTrack&&e===HD.VIDEO){let e=this.localMainVideoTrack.mediaTrack;if(e)return e.id}if(this.localAuxVideoTrack&&e===HD.AUXILIARY){let e=this.localAuxVideoTrack.mediaTrack;if(e)return e.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,t){if(0!==e)throw e===SN?(this._log.error(ZO.NOT_SUPPORTED_H264ENCODE),new vb({code:Ab.NOT_SUPPORTED_H264,message:rP({key:XO.NOT_SUPPORTED_H264ENCODE})})):new vb({code:Ab.UNKNOWN,message:rP({key:XO.SIGNAL_RESPONSE_FAILED,data:{signalResponse:dV.PUBLISH_RESULT,code:e,message:t}})})}sendSEI(e,t){var i;null==(i=this._sei)||i.push(e,t)}},nU=iU;ub([hw((e=>function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return new Promise(((t,n)=>{let r=e=>{this._emitter.off("closed",r),n(new vb({code:Ab.API_CALL_ABORTED,message:rP({key:XO.CONNECTION_ABORTED,data:e})}))};this._emitter.on("closed",r),e.apply(this,i).then(t,n).finally((()=>{this._emitter.off("closed",r)}))}))}))],nU.prototype,"publish",1),ub([uw(GV.prototype.afterConnect),dw(GV.prototype.beforeConnect)],nU.prototype,"connect",1);var rU=nU,oU=class{constructor(e,t){this.room=e,hb(this,"_log"),hb(this,"_prevReportTime"),hb(this,"_prevReport",{}),hb(this,"_prevEncoderImplementation"),hb(this,"_prevQualityLimitationReason"),hb(this,"_prevAuxQualityLimitationReason"),hb(this,"_prevDecoderImplementationMap",new Map),hb(this,"_spcStats",null),this._log=t,this._prevReportTime=0,this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevAuxQualityLimitationReason=""}get statInterval(){return 0===this._prevReportTime?2:(Date.now()-this._prevReportTime)/1e3}getSenderStats(e){return _b(this,null,(function*(){let t={audio:{bytesSent:0,packetsSent:0,audioLevel:0,totalAudioEnergy:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},small:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},auxiliary:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,fpsCapture:0},rtt:0},i=e.getPeerConnection(),n=e.getSSRC();if(i)try{if((this._spcStats||(yield i.getStats())).forEach((i=>{if("outbound-rtp"===i.type)if(i.mediaType===HD.VIDEO){let r,o;if(i.ssrc===n.video?(r=HD.VIDEO,o=e.localMainVideoTrack):i.ssrc===n.small?r=HD.SMALL:i.ssrc===n.auxiliary&&(o=e.localAuxVideoTrack,r=HD.AUXILIARY),!r)return;t[r].bytesSent=i.bytesSent,t[r].packetsSent=i.packetsSent,t[r].framesEncoded=i.framesEncoded,dO(i.keyFramesEncoded)||(t[r].keyFramesEncoded=i.keyFramesEncoded),dO(i.nackCount)||(t[r].nackCount=i.nackCount),dO(i.pliCount)||(t[r].pliCount=i.pliCount),dO(i.retransmittedPacketsSent)||(t[r].retransmittedPacketsSent=i.retransmittedPacketsSent),dO(i.totalEncodeTime)||(t[r].totalEncodeTime=i.totalEncodeTime),dO(i.totalPacketSendDelay)||(t[r].totalPacketSendDelay=i.totalPacketSendDelay),i.ssrc===n.video?(!dO(i.encoderImplementation)&&this._prevEncoderImplementation!==i.encoderImplementation&&(this._log.info("encoderImplementation change to ".concat(i.encoderImplementation)),this._prevEncoderImplementation=i.encoderImplementation),!dO(i.qualityLimitationReason)&&0!==i.bytesSent&&this._prevQualityLimitationReason!==i.qualityLimitationReason&&(this._log.info("qualityLimitationReason change to ".concat(i.qualityLimitationReason)),this._prevQualityLimitationReason=i.qualityLimitationReason)):i.ssrc===n.auxiliary&&!dO(i.qualityLimitationReason)&&0!==i.bytesSent&&this._prevAuxQualityLimitationReason!==i.qualityLimitationReason&&(this._log.info("aux qualityLimitationReason change to ".concat(i.qualityLimitationReason)),this._prevAuxQualityLimitationReason=i.qualityLimitationReason)}else i.mediaType===HD.AUDIO&&(t.audio.bytesSent=i.bytesSent,t.audio.packetsSent=i.packetsSent);else"candidate-pair"===i.type?IP(i)&&hO(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime)):"media-source"===i.type&&(i.kind===HD.AUDIO?(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0):i.kind===HD.VIDEO&&(i.trackIdentifier===e.getVideoTrackId(HD.VIDEO)?t.video.fpsCapture=i.framesPerSecond:i.trackIdentifier===e.getVideoTrackId(HD.AUXILIARY)?t.auxiliary.fpsCapture=i.framesPerSecond:t.small.fpsCapture=i.framesPerSecond));if(dO(i.audioLevel)||(t.audio.audioLevel=i.audioLevel||0),!dO(i.frameWidth)){let r=HD.SMALL;i.trackIdentifier===e.getVideoTrackId(HD.VIDEO)||i.ssrc===n.video?r=HD.VIDEO:(i.trackIdentifier===e.getVideoTrackId(HD.AUXILIARY)||i.ssrc===n.auxiliary)&&(r=HD.AUXILIARY),t[r].frameWidth=i.frameWidth,t[r].frameHeight=i.frameHeight,t[r].framesSent=i.framesSent}})),e.localMainAudioTrack){let i=e.localMainAudioTrack.getInternalAudioLevel();t.audio.micAudioLevel=i,0===t.audio.audioLevel&&(t.audio.audioLevel=i)}}catch(r){this._log.warn("failed to getStats on sender connection ".concat(r))}return t}))}getReceiverStats(e){return _b(this,null,(function*(){let t={tinyId:e.tinyId,userId:e.userId,rtt:0,hasAudio:!1,hasVideo:!1,hasAuxiliary:!1,audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,jitter:0,audioLevel:0,totalAudioEnergy:0,insertedSamplesForDeceleration:0,removedSamplesForAcceleration:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0},auxiliary:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesReceived:0,framesDecoded:0,frameWidth:0,frameHeight:0,fpsDecoded:0}},i=e.getPeerConnection();if(i)try{let{ssrc:n}=e,{muteState:r}=e;(this._spcStats||(yield i.getStats())).forEach((i=>{if("inbound-rtp"===i.type){if(i.mediaType===HD.AUDIO&&i.ssrc===n.audio&&r.hasAudio){t.audio.packetsReceived=i.packetsReceived,t.audio.bytesReceived=i.bytesReceived,t.audio.packetsLost=i.packetsLost,i.insertedSamplesForDeceleration&&(t.audio.insertedSamplesForDeceleration=i.insertedSamplesForDeceleration),i.removedSamplesForAcceleration&&(t.audio.removedSamplesForAcceleration=i.removedSamplesForAcceleration);let{remoteAudioTrack:n}=e;n.stat.packetsReceived=i.packetsReceived,n.stat.bytesReceived=i.bytesReceived,n.stat.packetsLost=i.packetsLost,i.jitterBufferDelay&&(n.stat.jitterBufferDelay=Math.floor(i.jitterBufferDelay/i.jitterBufferEmittedCount*1e3)),t.hasAudio=!0}else if(i.mediaType===HD.VIDEO){if(Jb&&0===i.bytesReceived)return;let o;i.ssrc===n.video&&r.hasVideo&&(t.video.packetsReceived=i.packetsReceived,t.video.bytesReceived=i.bytesReceived,t.video.packetsLost=i.packetsLost,t.video.framesReceived=i.framesReceived,t.video.framesDecoded=i.framesDecoded,t.video.fpsDecoded=i.framesPerSecond,t.hasVideo=!0,o=e.remoteVideoTrack,i.decoderImplementation&&(!this._prevDecoderImplementationMap.has(t.userId)||this._prevDecoderImplementationMap.get(t.userId)!==i.decoderImplementation)&&(this._log.info("".concat(t.userId," decoderImplementation change to ").concat(i.decoderImplementation)),this._prevDecoderImplementationMap.set(t.userId,i.decoderImplementation))),i.ssrc===n.auxiliary&&r.hasAuxiliary&&(t.auxiliary.packetsReceived=i.packetsReceived,t.auxiliary.bytesReceived=i.bytesReceived,t.auxiliary.packetsLost=i.packetsLost,t.auxiliary.framesReceived=i.framesReceived,t.auxiliary.framesDecoded=i.framesDecoded,t.auxiliary.fpsDecoded=i.framesPerSecond,o=e.remoteAuxiliaryTrack,t.hasAuxiliary=!0),o&&(o.stat.packetsReceived=i.packetsReceived,o.stat.bytesReceived=i.bytesReceived,o.stat.packetsLost=i.packetsLost,o.stat.framesReceived=i.framesReceived,o.stat.framesDecoded=i.framesDecoded,i.jitterBufferDelay&&(o.stat.jitterBufferDelay=Math.floor(i.jitterBufferDelay/i.jitterBufferEmittedCount*1e3)))}}else"candidate-pair"===i.type&&IP(i)&&hO(i.currentRoundTripTime)&&(t.rtt=Math.floor(1e3*i.currentRoundTripTime));dO(i.frameWidth)||((i.trackIdentifier===e.getMainStreamVideoTrackId()||i.ssrc===n.video)&&(t.video.frameWidth=i.frameWidth,t.video.frameHeight=i.frameHeight,e.remoteVideoTrack.stat.frameWidth=i.frameWidth,e.remoteVideoTrack.stat.frameHeight=i.frameHeight),(i.trackIdentifier===e.getAuxStreamVideoTrackId()||i.ssrc===n.auxiliary)&&(t.auxiliary.frameWidth=i.frameWidth,t.auxiliary.frameHeight=i.frameHeight,e.remoteAuxiliaryTrack.stat.frameWidth=i.frameWidth,e.remoteAuxiliaryTrack.stat.frameHeight=i.frameHeight)),dO(i.audioLevel)||(t.audio.audioLevel=i.audioLevel||0,t.audio.totalAudioEnergy=i.totalAudioEnergy||0)})),0===t.audio.audioLevel&&(t.audio.audioLevel=e.remoteAudioTrack.getInternalAudioLevel()||0)}catch(_D){this._log.warn("failed to getStats on receiver connection ".concat(_D))}return t}))}getStats(e,t){return _b(this,null,(function*(){let i={},n=[];if(this.room.singlePC){let e=this.room.singlePC.getPeerConnection();if(!e)return{senderStats:i,receiverStats:n};let t=yield e.getStats(),r=[],o=new Set(["inbound-rtp","outbound-rtp","track","candidate-pair","media-source"]);t.forEach((e=>o.has(e.type)&&r.push(e))),this._spcStats=r}e&&(i=yield this.getSenderStats(e));for(let[e,r]of t){let e=yield this.getReceiverStats(r);n.push(e)}return{senderStats:i,receiverStats:n}}))}getDifferenceValue(e,t){if(YL(e))return t;let i=t-e;return i<0?0:i}prepareReport(e){let{stats:t,report:i,freezeMap:n}=e;if(!YL(t.senderStats)){let e={uint32_audio_level:t.senderStats.audio.audioLevel*WN,uint32_audio_energy:1e6*t.senderStats.audio.totalAudioEnergy,uint32_audio_codec_bitrate:t.senderStats.audio.bytesSent};t.senderStats.audio.micAudioLevel&&(e.uint32_mic_audio_level=t.senderStats.audio.micAudioLevel*WN);let n=[],r={uint32_video_stream_type:2,uint32_video_codec_fps:t.senderStats.video.framesSent,uint32_video_capture_fps:t.senderStats.video.fpsCapture,uint32_video_width:t.senderStats.video.frameWidth,uint32_video_height:t.senderStats.video.frameHeight,uint32_video_codec_bitrate:t.senderStats.video.bytesSent,uint32_video_enc_fps:t.senderStats.video.framesEncoded,uint32_key_frame_count:t.senderStats.video.keyFramesEncoded,uint32_nack_count:t.senderStats.video.nackCount,uint32_pli_count:t.senderStats.video.pliCount,uint32_encode_cost:1e3*(t.senderStats.video.totalEncodeTime||0),uint32_send_packet_cost:1e3*(t.senderStats.video.totalPacketSendDelay||0),uint32_video_arq_packets:t.senderStats.video.retransmittedPacketsSent};if(n.push(r),t.senderStats.small.bytesSent){let e={uint32_video_stream_type:3,uint32_video_codec_fps:t.senderStats.small.framesSent||0,uint32_video_capture_fps:t.senderStats.small.fpsCapture||0,uint32_video_width:t.senderStats.small.frameWidth||0,uint32_video_height:t.senderStats.small.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.small.bytesSent,uint32_video_enc_fps:t.senderStats.small.framesEncoded||0,uint32_key_frame_count:t.senderStats.small.keyFramesEncoded,uint32_nack_count:t.senderStats.small.nackCount,uint32_pli_count:t.senderStats.small.pliCount,uint32_encode_cost:1e3*(t.senderStats.small.totalEncodeTime||0),uint32_send_packet_cost:1e3*(t.senderStats.small.totalPacketSendDelay||0),uint32_video_arq_packets:t.senderStats.small.retransmittedPacketsSent};n.push(e)}if(t.senderStats.auxiliary.bytesSent){let e={uint32_video_stream_type:7,uint32_video_codec_fps:t.senderStats.auxiliary.framesSent||0,uint32_video_capture_fps:t.senderStats.auxiliary.fpsCapture||0,uint32_video_width:t.senderStats.auxiliary.frameWidth||0,uint32_video_height:t.senderStats.auxiliary.frameHeight||0,uint32_video_codec_bitrate:t.senderStats.auxiliary.bytesSent,uint32_video_enc_fps:t.senderStats.auxiliary.framesEncoded||0,uint32_key_frame_count:t.senderStats.auxiliary.keyFramesEncoded,uint32_nack_count:t.senderStats.auxiliary.nackCount,uint32_pli_count:t.senderStats.auxiliary.pliCount,uint32_encode_cost:1e3*(t.senderStats.auxiliary.totalEncodeTime||0),uint32_send_packet_cost:1e3*(t.senderStats.auxiliary.totalPacketSendDelay||0),uint32_video_arq_packets:t.senderStats.auxiliary.retransmittedPacketsSent};n.push(e)}let o={uint32_bitrate:0,uint32_lost:0,uint32_rtt:t.senderStats.rtt};i.msg_up_stream_info={msg_audio_status:e,msg_video_status:n,msg_network_status:o}}let{statInterval:r}=this;i.msg_down_stream_info=[],t.receiverStats.forEach((e=>{let t={msg_user_info:{str_identifier:e.userId,uint64_tinyid:e.tinyId},msg_network_status:{uint32_rtt:e.rtt,uint32_bitrate:0,uint32_lost:0},msg_audio_status:{},msg_video_status:[]};if(e.hasAudio){let i={uint32_audio_codec_bitrate:e.audio.bytesReceived,uint32_audio_total_bitrate:e.audio.bytesReceived,uint32_audio_level:1e8*e.audio.audioLevel,uint32_audio_energy:1e6*e.audio.totalAudioEnergy,uint32_audio_receive:e.audio.packetsReceived,uint32_audio_origin_lost:e.audio.packetsLost};t.msg_audio_status=i}if(e.hasVideo){let i=n.get("".concat(e.userId,"_").concat($D)),r=i?i.duration:0,o={uint32_video_stream_type:2,uint32_video_receive_fps:e.video.framesReceived,uint32_video_width:e.video.frameWidth,uint32_video_height:e.video.frameHeight,uint32_video_codec_bitrate:e.video.bytesReceived,uint32_video_receive:e.video.packetsReceived,uint32_video_origin_lost:e.video.packetsLost,uint32_video_block_time:r,uint32_video_dec_fps:e.video.framesDecoded};t.msg_video_status.push(o)}if(e.hasAuxiliary){let i=n.get("".concat(e.userId,"_").concat(eN)),r=i?i.duration:0,o={uint32_video_stream_type:7,uint32_video_receive_fps:e.auxiliary.framesReceived,uint32_video_width:e.auxiliary.frameWidth,uint32_video_height:e.auxiliary.frameHeight,uint32_video_codec_bitrate:e.auxiliary.bytesReceived,uint32_video_receive:e.auxiliary.packetsReceived+e.auxiliary.packetsLost,uint32_video_origin_lost:e.auxiliary.packetsLost,uint32_video_block_time:r,uint32_video_dec_fps:e.auxiliary.framesDecoded};t.msg_video_status.push(o)}i.msg_down_stream_info.push(t)}));let o=this._prevReport;if(this._prevReport=JSON.parse(JSON.stringify(i)),i.msg_up_stream_info.msg_audio_status&&o.msg_up_stream_info.msg_audio_status){let e=o.msg_up_stream_info.msg_audio_status,t=i.msg_up_stream_info.msg_audio_status;if(0===e.uint32_audio_codec_bitrate)t.uint32_audio_codec_bitrate=0;else{let n=this.getDifferenceValue(e.uint32_audio_codec_bitrate,t.uint32_audio_codec_bitrate);t.uint32_audio_codec_bitrate=Math.round(8*n/r),i.msg_up_stream_info.msg_network_status.uint32_bitrate+=t.uint32_audio_codec_bitrate}}let s=o.msg_up_stream_info.msg_video_status;i.msg_up_stream_info.msg_video_status.forEach((e=>{let t=s.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type));if(!t||0===t.uint32_video_codec_bitrate)return e.uint32_video_codec_bitrate=0,e.uint32_video_enc_fps=0,void(e.uint32_video_codec_fps=0);let n=0,o=0,a=0;t&&e.uint32_video_codec_bitrate>=t.uint32_video_codec_bitrate&&(n=t.uint32_video_codec_bitrate,o=t.uint32_video_enc_fps,a=t.uint32_video_codec_fps);let c=this.getDifferenceValue(n,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*c/r),i.msg_up_stream_info.msg_network_status.uint32_bitrate+=e.uint32_video_codec_bitrate,e.uint32_video_enc_fps=Math.round(this.getDifferenceValue(o,e.uint32_video_enc_fps)/r),e.uint32_video_codec_fps=Math.round(this.getDifferenceValue(a,e.uint32_video_codec_fps)/r),Sk&&115===Fk()&&0===t.uint32_video_width&&0===t.uint32_video_height&&0===t.uint32_video_codec_fps&&(e.uint32_video_codec_fps=e.uint32_video_enc_fps),dO(t.uint32_key_frame_count)||(e.uint32_key_frame_count=Math.round(this.getDifferenceValue(t.uint32_key_frame_count,e.uint32_key_frame_count))),dO(t.uint32_nack_count)||(e.uint32_nack_count=Math.round(this.getDifferenceValue(t.uint32_nack_count,e.uint32_nack_count))),dO(t.uint32_pli_count)||(e.uint32_pli_count=Math.round(this.getDifferenceValue(t.uint32_pli_count,e.uint32_pli_count))),dO(t.uint32_video_arq_packets)||(e.uint32_video_arq_packets=Math.round(this.getDifferenceValue(t.uint32_video_arq_packets,e.uint32_video_arq_packets))),dO(t.uint32_encode_cost)||(e.uint32_encode_cost=Math.round(this.getDifferenceValue(t.uint32_encode_cost,e.uint32_encode_cost)/r)),dO(t.uint32_send_packet_cost)||(e.uint32_send_packet_cost=Math.round(this.getDifferenceValue(t.uint32_send_packet_cost,e.uint32_send_packet_cost)/r))}));let a=i.msg_down_stream_info,c=o.msg_down_stream_info;return a.forEach((e=>{let t=c.find((t=>t.msg_user_info.uint64_tinyid===e.msg_user_info.uint64_tinyid));if(t){if(YL(e.msg_audio_status)||YL(t.msg_audio_status))e.msg_audio_status={};else{let i=e.msg_audio_status,n=t.msg_audio_status;i.uint32_audio_origin_lost=this.getDifferenceValue(n.uint32_audio_origin_lost,i.uint32_audio_origin_lost),i.uint32_audio_receive=this.getDifferenceValue(n.uint32_audio_receive,i.uint32_audio_receive),i.uint32_audio_receive+=i.uint32_audio_origin_lost;let o=this.getDifferenceValue(n.uint32_audio_codec_bitrate,i.uint32_audio_codec_bitrate);i.uint32_audio_codec_bitrate=Math.round(8*o/r),i.uint32_audio_total_bitrate=Math.round(8*o/r)}if(e.msg_video_status&&t.msg_video_status){let i=t.msg_video_status;e.msg_video_status=e.msg_video_status.filter((e=>i.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type)))),e.msg_video_status.forEach((e=>{let t=i.find((t=>t.uint32_video_stream_type===e.uint32_video_stream_type)),n=t.uint32_video_receive,o=t.uint32_video_origin_lost,s=t.uint32_video_codec_bitrate,a=t.uint32_video_receive_fps,c=t.uint32_video_dec_fps;e.uint32_video_origin_lost=this.getDifferenceValue(o,e.uint32_video_origin_lost),e.uint32_video_receive=this.getDifferenceValue(n,e.uint32_video_receive)+e.uint32_video_origin_lost;let l=this.getDifferenceValue(s,e.uint32_video_codec_bitrate);e.uint32_video_codec_bitrate=Math.round(8*l/r);let d=this.getDifferenceValue(a,e.uint32_video_receive_fps);e.uint32_video_receive_fps=Math.round(d/r),e.uint32_video_dec_fps=Math.round(this.getDifferenceValue(c,e.uint32_video_dec_fps)/r)}))}}})),i}getStatsReport(e){return _b(this,arguments,(function(e){var t=this;let{uplinkConnection:i,downlinkConnections:n,freezeMap:r}=e;return function*(){let e={msg_up_stream_info:{msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_level:0,uint32_audio_energy:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_codec_fps:0,uint32_video_capture_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_final_lost:0,uint32_video_enc_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}},msg_down_stream_info:[{msg_user_info:{str_identifier:"",uint64_tinyid:0},msg_audio_status:{uint32_audio_format:0,uint32_audio_sample_rate:0,uint32_audio_codec_bitrate:0,uint32_audio_total_bitrate:0,uint32_audio_level:0,uint32_audio_energy:0,uint32_audio_receive:0,uint32_audio_origin_lost:0,uint32_audio_final_lost:0},msg_video_status:[{uint32_video_stream_type:0,uint32_video_receive_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_codec_bitrate:0,uint32_video_receive:0,uint32_video_origin_lost:0,uint32_video_block_time:0,uint32_video_dec_fps:0}],msg_network_status:{uint32_bitrate:0,uint32_rtt:0,uint32_lost:0}}]},o=yield t.getStats(i,n);return"{}"===JSON.stringify(t._prevReport)&&(t._prevReport=JSON.parse(JSON.stringify(e))),t.prepareReport({stats:o,report:e,freezeMap:r}),t._prevReportTime=Date.now(),e}()}))}reset(){this._prevReportTime=0,this._prevReport={},this._prevEncoderImplementation="",this._prevQualityLimitationReason="",this._prevDecoderImplementationMap=new Map}},sU=db(mb()),aU=class extends sU.default{constructor(e){let{signalChannel:t,room:i}=e;super(),hb(this,"_room"),hb(this,"_signalChannel"),hb(this,"_log"),hb(this,"_uplinkRTT",0),hb(this,"_uplinkLoss",0),hb(this,"_downlinkRTT",0),hb(this,"_downlinkLoss",0),hb(this,"_downlinkPrevStatMap",new Map),hb(this,"_downlinkLossAndRTTMap",new Map),hb(this,"_interval",-1),hb(this,"_uplinkNetworkQuality",0),hb(this,"_downlinkNetworkQuality",0),this._room=i,this._signalChannel=t,this._log=YO.createLogger({id:"q",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),this.initialize()}get uplinkNetworkQuality(){return this._uplinkNetworkQuality}set uplinkNetworkQuality(e){e!==this._uplinkNetworkQuality&&this._log.info("uplink network quality change ".concat(this.uplinkNetworkQuality," -> ").concat(e,", rtt: ").concat(this._uplinkRTT,", loss: ").concat(this._uplinkLoss)),this._uplinkNetworkQuality=e}get downlinkNetworkQuality(){return this._downlinkNetworkQuality}set downlinkNetworkQuality(e){if(e!==this._downlinkNetworkQuality){let{rtt:t,loss:i}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._log.info("downlink network quality change ".concat(this.downlinkNetworkQuality," -> ").concat(e,", rtt: ").concat(t,", loss: ").concat(i))}this._downlinkNetworkQuality=e}initialize(){this._signalChannel.on(dV.UPLINK_NETWORK_STATS,(e=>{this.handleUplinkNetworkQuality(e)})),this._signalChannel.on(iV,this.handleSignalConnectionStateChange.bind(this)),this.start()}handleUplinkNetworkQuality(e){var t,i;if(0!==e.data.code)return;let n=e.data.data;if(n.delay&&this.updateDelay(n.delay),!this._room.uplinkConnection)return this.uplinkNetworkQuality=0,this._uplinkLoss=0,void(this._uplinkRTT=0);let r=null==(i=null==(t=this._room)?void 0:t.uplinkConnection)?void 0:i.getPeerConnection();if(r&&this.isPeerConnectionDisconnected(r))return this.uplinkNetworkQuality=6,this._uplinkLoss=0,void(this._uplinkRTT=0);let o=n.expectAudPkg+n.expectVidPkg,s=n.recvAudPkg+n.recvVidPkg,a=o-s;0===o&&0===s||(this._uplinkLoss=a<=0?0:Math.round(a/o*100),this._uplinkRTT=n.rtt,this.uplinkNetworkQuality=this.getNetworkQuality(this._uplinkLoss,this._uplinkRTT))}handleDownlinkNetworkQuality(){return _b(this,null,(function*(){if(0===this._room.remotePublishedUserMap.size)return void(this.downlinkNetworkQuality=0);let e=[...this._room.remotePublishedUserMap.values()],t=e.filter((e=>{var t;return(null==(t=e.getPeerConnection())?void 0:t.connectionState)===lN.CONNECTED}));if(e.filter((e=>this.isPeerConnectionDisconnected(e.getPeerConnection()))).length===e.length)return void(this.downlinkNetworkQuality=6);for(let r=0;r<t.length;r++){let e=t[r].getPeerConnection();if(!e)return;let{rtt:i,totalPacketsLost:n,totalPacketsReceived:o}=yield this.getStat(e);if(!this._downlinkPrevStatMap.has(e)){this._downlinkPrevStatMap.set(e,{totalPacketsLost:n,totalPacketsReceived:o});continue}let s=0,a=this._downlinkPrevStatMap.get(e),c=n-a.totalPacketsLost,l=o-a.totalPacketsReceived;s=c<=0||l<0?0:Math.round(c/(c+l)*100),this._downlinkPrevStatMap.set(e,{totalPacketsLost:n,totalPacketsReceived:o}),this._downlinkLossAndRTTMap.set(e,{rtt:i,loss:s,userId:t[r].getUserId(),audioDelay:t[r].remoteAudioTrack.stat.end2EndDelay,videoDelay:t[r].remoteVideoTrack.stat.end2EndDelay})}if([...this._downlinkPrevStatMap.keys()].forEach((e=>{this.isPeerConnectionDisconnected(e)&&(this._downlinkPrevStatMap.delete(e),this._downlinkLossAndRTTMap.delete(e))})),0===this._downlinkLossAndRTTMap.size)return;let{rtt:i,loss:n}=this.getAverageLossAndRTT([...this._downlinkLossAndRTTMap.values()]);this._downlinkRTT=i,this._downlinkLoss=n,this.downlinkNetworkQuality=this.getNetworkQuality(n,i)}))}getStat(e){return _b(this,null,(function*(){let t={rtt:0,totalPacketsLost:0,totalPacketsReceived:0};if(!e||!bP())return t;let i=e.getReceivers();try{for(let e=0;e<i.length;e++)(yield i[e].getStats()).forEach((e=>{"candidate-pair"===e.type&&hO(e.currentRoundTripTime)&&(t.rtt=Math.round(1e3*e.currentRoundTripTime)),"inbound-rtp"===e.type&&(e.mediaType===HD.AUDIO||e.mediaType===HD.VIDEO)&&(t.totalPacketsLost+=e.packetsLost,t.totalPacketsReceived+=e.packetsReceived)}));return t}catch(n){return t}}))}getAverageLossAndRTT(e){let t={rtt:0,loss:0};return Array.isArray(e)&&e.length>0&&(e.forEach((e=>{t.rtt+=e.rtt,t.loss+=e.loss})),Object.keys(t).forEach((i=>{t[i]=Math.round(t[i]/e.length)}))),t}getNetworkQuality(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}handleSignalConnectionStateChange(e){e.state===oV?(this._uplinkRTT=0,this._uplinkLoss=0,this.uplinkNetworkQuality=6):e.state===aV&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}handleUplinkConnectionStateChange(e){let{state:t}=e;"DISCONNECTED"===t?(this._uplinkLoss=0,this._uplinkRTT=0,this.uplinkNetworkQuality=6):"CONNECTED"===t&&6===this.uplinkNetworkQuality&&(this.uplinkNetworkQuality=5)}isPeerConnectionDisconnected(e){return!(!e||e.connectionState!==lN.DISCONNECTED&&e.connectionState!==lN.FAILED&&e.connectionState!==lN.CLOSED)}setUplinkConnection(e){this._room.uplinkConnection=e,this._room.uplinkConnection?this._room.uplinkConnection.on(rL,this.handleUplinkConnectionStateChange.bind(this)):(this.uplinkNetworkQuality=0,this._uplinkRTT=0,this._uplinkLoss=0)}start(){-1===this._interval?(this._log.debug("start network quality calculating"),this._interval=nL.run(FN,(()=>{this.handleDownlinkNetworkQuality();let e=[...this._downlinkLossAndRTTMap.values()];GO.emit(JO.NETWORK_QUALITY,{room:this._room,uplink:{rtt:this._uplinkRTT,loss:this._uplinkLoss},downlinks:e}),this.emit(aU.EVENT_NETWORK_QUALITY,{uplinkNetworkQuality:this.uplinkNetworkQuality,downlinkNetworkQuality:this.downlinkNetworkQuality,uplinkRTT:this._uplinkRTT,uplinkLoss:this._uplinkLoss,downlinkRTT:this._downlinkRTT,downlinkLoss:this._downlinkLoss,downlinkInfo:e})}),{delay:2e3})):this._log.info("network quality calculating is already started")}stop(){this._log.info("stop network quality calculating"),-1!==this._interval&&(nL.clearTask(this._interval),this._interval=-1),this._downlinkLossAndRTTMap.clear(),this._downlinkPrevStatMap.clear()}updateDelay(e){let{tinyIdToUserIdMap:t}=this._room;e.forEach((e=>{let{srcTinyId:i,videoDelay:n,audioDelay:r}=e,o=t.get(i);if(o){let e=this._room.remotePublishedUserMap.get(o);null==e||e.setDelay({videoDelay:n,audioDelay:r})}}))}},cU=aU;hb(cU,"EVENT_NETWORK_QUALITY","0");var lU=new WeakMap;function dU(e){let{settings:t={retries:5,timeout:2e3},onError:i,onRetrying:n,onRetryFailed:r}=e;return function(e,o,s){let a=HO({retryFunction:s.value,settings:t,onError(t,n,r,s){i&&i.call(this,t,(()=>{var i;null!=(i=lU.get(e))&&i.has(o)?n():r(t)}),r,s)},onRetrying:(t,i)=>{var r;lO(n)&&n(t,i),null!=(r=lU.get(e))&&r.has(o)&&(lU.get(e).get(o).stopRetry=i)},onRetryFailed:r});return s.value=function(){let t=lU.get(e);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t?t.set(o,{args:n}):lU.set(e,new Map([[o,{args:n}]])),a.apply(this,n).finally((()=>{var t;return null==(t=lU.get(e))?void 0:t.delete(o)}))},s}}function uU(e){let{fnName:t,callback:i,validateArgs:n=!0}=e;return function(e,r,o){let s=o.value;return o.value=function(){for(var r,o,a=arguments.length,c=new Array(a),l=0;l<a;l++)c[l]=arguments[l];if(null!=(r=lU.get(e))&&r.has(t)){let{stopRetry:r,args:s}=lU.get(e).get(t),a=!0;if(n)for(let e of s)if(!c.find((t=>t===e))){a=!1;break}a&&(i&&i.apply(this,c),r&&r(),null==(o=lU.get(e))||o.delete(t))}return s.apply(this,c)},o}}var hU=class{constructor(e){this._signalInfo={tinyId:void 0,clientIp:"",signalIp:"",relayIp:"",relayInnerIp:"",relayPort:0},this._apiSuccessRateMap=new Map,this._eventMap=new Map,this._frameWorkType=e.frameWorkType||30,this._component=e.component||0,this.connectionType=e.connectionType||1,this._language=e.language||0,this._room=e.room,this._keyPrefix="key_point",this._log=YO.createLogger({id:"kpm",userId:this._room.userId,sdkAppId:this._room.sdkAppId}),Object.getOwnPropertyNames(this.__proto__).forEach((e=>{e.startsWith("handle")&&lO(this[e])&&(this[e]=function(e){let{fn:t,context:i}=e;return function(){try{for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];let o=t.apply(i||this,n);return TO(o)?o.catch((e=>YO.error("".concat(t.name,"() error observed ").concat(e)))):o}catch(pN){YO.error("".concat(t.name,"() error observed ").concat(pN))}}}({fn:this[e],context:this}))})),this.initData(),this.installEvents(),this._intervalId=nL.run(FN,this.setStorage.bind(this),{delay:2e4})}get _storageKey(){return"".concat(this._keyPrefix,"_").concat(this._room.userId)}initData(){this._firstPublishedUserList=[],this._networkQuality={totalUplinkRTT:0,totalUplinkLoss:0,count:0,totalDownlinkRTTAndLossMap:new Map},this._basicInfo={string_sdk_version:uD,uint32_os_type:15,string_device_name:"",string_http_user_agent:navigator.userAgent,string_os_version:"",uint32_avg_rtt:0,uint32_avg_up_loss:0,uint32_scene:"live"===this._room.scene?1:0,uint32_joining_duration:0,uint32_networkType:MD[QN()],uint32_framework:this._frameWorkType,uint32_component:this._component,uint32_connection_type:this.connectionType,uint32_caller_coding_language:this._language,string_domain:location.hostname},this._pathJoinRoom={uint64_start_time:0,uint64_send_request_acc_ip_cmd_start_time:0,uint64_send_request_acc_ip_cmd_end_time:0,uint64_send_request_enter_room_cmd_start_time:0,uint64_send_request_enter_room_cmd_end_time:0,uint64_send_first_video_frame_time:0,uint64_recv_userlist_time:0,uint64_end_time:0,int32_send_request_acc_ip_cmd_ret:0,int32_send_request_enter_room_cmd_ret:0,int32_end_ret:0},this._pathLeaveRoom={uint64_start_time:0,uint64_send_request_exit_room_cmd_start_time:0,uint64_send_request_exit_room_cmd_end_time:0,uint64_end_time:0,int32_send_request_exit_room_cmd_ret:0,int32_end_ret:0},this._localStreamStat={totalVideoBitrate:0,totalVideoFPS:0,totalVideoHeight:0,totalVideoWidth:0,totalAudioLevel:0,videoCount:0,audioLevelCount:0,publishStartTime:0,statsToReport:{uint32_audio_capture_db:0,uint32_video_big_capture_fps:0,uint32_video_big_bitrate:0,uint32_video_big_resolution:0}},this._pathMainVideoMap=new Map,this._pathMainAudioMap=new Map,this._pathAuxiliaryMap=new Map,this._remoteStreamStatMap=new Map,this._apiSuccessRateMap.clear(),oD().then((e=>{this._basicInfo.string_os_version=cD(),e&&(this._basicInfo.string_device_name=e.model)}))}addEvent(e,t){return this._eventMap.set(e,t),GO.on(e,t),this}installEvents(){this.handleUnload=this.handleUnload.bind(this),window.addEventListener("unload",this.handleUnload),this._room.once("banned",(()=>this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId}))),this.addEvent(JO.JOIN_START,this.handleJoinStart).addEvent(JO.JOIN_SIGNAL_CONNECTION_START,this.handleSignalConnectionStart).addEvent(JO.JOIN_SIGNAL_CONNECTION_END,this.handleSignalConnectionEnd).addEvent(JO.JOIN_SEND_CMD,this.handleJoinSendCMD).addEvent(JO.JOIN_RECEIVED_CMD_RES,this.handleJoinReceivedCMDResponce).addEvent(JO.JOIN_SUCCESS,this.handleJoinSuccess).addEvent(JO.JOIN_FAILED,this.handleJoinFailed).addEvent(JO.LEAVE_START,this.handleLeaveStart).addEvent(JO.LEAVE_SUCCESS,this.handleLeaveSuccess).addEvent(JO.LEAVE_SEND_CMD,this.handleLeaveSendCMD).addEvent(JO.LOCAL_TRACK_CAPTURE_START,this.handleTrackCaptureStart).addEvent(JO.LOCAL_TRACK_CAPTURE_SUCCESS,this.handleTrackCaptureSuccess).addEvent(JO.LOCAL_TRACK_CAPTURE_FAILED,this.handleTrackCaptureFailed).addEvent(JO.PUBLISH_START,this.handlePublishStart).addEvent(JO.SEND_FIRST_VIDEO_FRAME,this.handleSendFirstVideoFrame).addEvent(JO.SUBSCRIBE_START,this.handleSubscribeStart).addEvent(JO.SUBSCRIBE_SUCCESS,this.handleSubscribed).addEvent(JO.PLAY_TRACK_START,this.handlePlayStart).addEvent(JO.VIDEO_LOADED_DATA,this.handleVideoLoadedData).addEvent(JO.PLAYER_STATE_CHANGED,(e=>{let{track:t,state:i,type:n}=e;!gO(t)||!this.hitTest(t.room)||"PLAYING"===i&&(n===HD.AUDIO?this.handleAudioPlaying(t):this.handleVideoPlaying(t))})).addEvent(JO.NETWORK_QUALITY,this.handleNetworkQuality).addEvent(JO.HEARTBEAT_REPORT,this.handleHeartbeatStats).addEvent(JO.RECEIVED_PUBLISHED_USER_LIST,this.handleReceivedPublishUserList).addEvent(JO.REMOTE_PUBLISH_STATE_CHANGED,(e=>{let{room:t,prevMuteState:i,muteState:n}=e;if(!this.hitTest(t))return;let r=i.hasAudio||i.hasVideo||i.hasSmall,o=i.hasAuxiliary,s=n.hasAudio||n.hasVideo||n.hasSmall,a=n.hasAuxiliary;!r&&s&&this.handleRemoteStreamAdded(n.userId,"main"),!o&&a&&this.handleRemoteStreamAdded(n.userId,"auxiliary")})).addEvent(JO.API_SUCCESS_RATE,this.handleAPISuccessRate)}uninstallEvents(){window.removeEventListener("unload",this.handleUnload),this._eventMap.forEach(((e,t)=>GO.off(t,e))),this._eventMap.clear()}destroy(){this.uninstallEvents(),nL.clearTask(this._intervalId)}handleUnload(){this._room.isJoined&&this.handleLeaveSuccess({room:this._room,roomId:this._room.roomId})}handleJoinStart(e){this.hitTest(e.room)&&(0===this._pathJoinRoom.uint64_start_time&&(this._pathJoinRoom.uint64_start_time=Date.now(),this.checkStorage()),e.params&&(dO(e.params.frameWorkType)||(this._frameWorkType=e.params.frameWorkType,this._basicInfo.uint32_framework=this._frameWorkType),dO(e.params.component)||(this._component=e.params.component,this._basicInfo.uint32_component=this._component),dO(e.params.language)||(this._language=e.params.language,this._basicInfo.uint32_caller_coding_language=this._language)))}handleSignalConnectionStart(e){let{room:t}=e;this.hitTest(t)&&0===this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_start_time=Date.now())}handleSignalConnectionEnd(e){let{room:t,error:i}=e;this.hitTest(t)&&0===this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time&&(this._pathJoinRoom.uint64_send_request_acc_ip_cmd_end_time=Date.now(),i&&(this._pathJoinRoom.int32_send_request_acc_ip_cmd_ret=i instanceof vb?Number(i.getExtraCode()||i.getCode()):Ab.UNKNOWN,this._pathJoinRoom.int32_end_ret=2))}handleJoinSendCMD(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_start_time=Date.now())}handleJoinReceivedCMDResponce(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time&&(this._pathJoinRoom.uint64_send_request_enter_room_cmd_end_time=Date.now(),this._pathJoinRoom.int32_send_request_enter_room_cmd_ret=e.code,0!==e.code&&(this._pathJoinRoom.int32_end_ret=3))}handleJoinSuccess(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_end_time&&(this._pathJoinRoom.uint64_end_time=Date.now(),this._pathJoinRoom.int32_end_ret=0,this._signalInfo=e.room.getSignalInfo())}handleJoinFailed(e){let{room:t}=e;this.hitTest(t)&&(this._pathJoinRoom.uint64_end_time=Date.now(),0===this._pathJoinRoom.int32_end_ret&&(this._pathJoinRoom.int32_end_ret=3),setTimeout((()=>{this.report()})))}handleReceivedPublishUserList(e){this.hitTest(e.room)&&0===this._pathJoinRoom.uint64_recv_userlist_time&&(this._pathJoinRoom.uint64_recv_userlist_time=Date.now(),this._firstPublishedUserList=e.publishedUserList||[])}handleSendFirstVideoFrame(e){let{room:t}=e;!this.hitTest(t)||0===this._pathJoinRoom.uint64_send_first_video_frame_time&&0!==this._pathJoinRoom.uint64_start_time&&(this._pathJoinRoom.uint64_send_first_video_frame_time=Date.now())}handleLeaveStart(e){this.hitTest(e.room)&&(this._pathLeaveRoom.uint64_start_time=Date.now())}handleLeaveSuccess(e){this.hitTest(e.room)&&0===this._pathLeaveRoom.uint64_end_time&&(this._pathLeaveRoom.uint64_end_time=Date.now(),0!==this._pathJoinRoom.uint64_end_time?this._basicInfo.uint32_joining_duration=this._pathLeaveRoom.uint64_end_time-this._pathJoinRoom.uint64_end_time:this._log.warn("pathJoinRoom endTime is 0"),this.report())}handleLeaveSendCMD(e){this.hitTest(e.room)&&(this._pathLeaveRoom.uint64_send_request_exit_room_cmd_start_time=Date.now(),this._pathLeaveRoom.uint64_send_request_exit_room_cmd_end_time=Date.now())}handleRemoteStreamAdded(e,t){var i;let n="".concat(e,"_").concat(t);if(!this._remoteStreamStatMap.has(n)){let r={userId:e,totalVideoFPS:0,totalVideoBitrate:0,totalAudioLevel:0,totalAudioBitrate:0,totalLoss:0,audioCount:0,audioLevelCount:0,videoCount:0,networkQualityCount:0,streamAddedTime:Date.now(),subscribeStartTime:0,subscribedTime:0,playStreamTime:0,statsToReport:ab(sb({},mU),{msg_user_info:new fU({userId:e,tinyId:null==(i=this._room.remotePublishedUserMap.get(e))?void 0:i.tinyId,role:20})})};r.statsToReport.uint32_stream_type="main"===t?2:7,this._remoteStreamStatMap.set(n,r)}}handleSubscribeStart(e){let{room:t,remotePublishedUser:i,streamType:n,subscribeState:r}=e;if(!this.hitTest(t))return;let{userId:o,tinyId:s,role:a}=i,c=new fU({userId:o,tinyId:s,role:"anchor"===a?20:21}),l=Date.now(),d="".concat(o,"_").concat(n),u=this._remoteStreamStatMap.get(d);u&&0===u.subscribeStartTime&&(u.subscribeStartTime=l),"main"===n?(i.muteState.hasVideo&&(r.video||r.smallVideo)&&!this._pathMainVideoMap.has(d)&&this._pathMainVideoMap.set(d,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_render_first_frame_time:0,uint64_combine_first_frame_time:0},userId:o,sendSubscribeCMDTime:l}),i.muteState.hasAudio&&r.audio&&!this._pathMainAudioMap.has(d)&&this._pathMainAudioMap.set(d,{statsToReport:{msg_user_info:c,uint64_start_enter_time:this._pathJoinRoom.uint64_start_time,uint64_play_first_frame_time:0},userId:o,sendSubscribeCMDTime:l})):i.muteState.hasAuxiliary&&r.auxiliary&&!this._pathAuxiliaryMap.has(d)&&this._pathAuxiliaryMap.set(d,{sendSubscribeCMDTime:l})}handleSubscribed(e){let{room:t,remotePublishedUser:i,streamType:n}=e;if(this.hitTest(t)){let e="".concat(i.userId,"_").concat(n),t=this._remoteStreamStatMap.get(e);t&&0===t.subscribedTime&&(t.subscribedTime=Date.now())}}handlePlayStart(e){let{track:t}=e;if(!gO(t)||!this.hitTest(t.room))return;let i="".concat(t.userId,"_").concat(t.streamType),n=this._remoteStreamStatMap.get(i);0===(null==n?void 0:n.playStreamTime)&&(n.playStreamTime=Date.now())}handleVideoLoadedData(e){let{track:t}=e;if(!gO(t)||!this.hitTest(t.room))return;let i="".concat(t.userId,"_").concat(t.streamType),n=this._pathMainVideoMap.get(i);n&&0===n.statsToReport.uint64_combine_first_frame_time&&(n.statsToReport.uint64_combine_first_frame_time=Date.now())}handleVideoPlaying(e){let t="".concat(e.userId,"_").concat(e.streamType),i=Date.now(),n=this._pathMainVideoMap.get(t),r=this._remoteStreamStatMap.get(t);if(n&&(0===n.statsToReport.uint64_render_first_frame_time&&(n.statsToReport.uint64_render_first_frame_time=i),r)){let{statsToReport:e,playStreamTime:t,subscribedTime:o}=r;0===e.uint32_video_render_first&&t-o<=100&&(e.uint32_video_render_first=i-n.sendSubscribeCMDTime)}let o=this._pathAuxiliaryMap.get(t);if(o&&r){let{statsToReport:e,playStreamTime:t,subscribedTime:n}=r;0===e.uint32_video_render_first&&t-n<=100&&(e.uint32_video_render_first=i-o.sendSubscribeCMDTime)}}handleAudioPlaying(e){let t="".concat(e.userId,"_").concat(e.streamType),i=this._pathMainAudioMap.get(t);i&&0===i.statsToReport.uint64_play_first_frame_time&&(i.statsToReport.uint64_play_first_frame_time=Date.now())}handleNetworkQuality(e){this.hitTest(e.room)&&(this._networkQuality.totalUplinkLoss+=e.uplink.loss,this._networkQuality.totalUplinkRTT+=e.uplink.rtt,this._networkQuality.count++,e.downlinks.forEach((e=>{let{rtt:t,loss:i,userId:n,videoDelay:r,audioDelay:o}=e,s=this._networkQuality.totalDownlinkRTTAndLossMap.get(n);if(s)s.totalRTT+=t,s.totalLoss+=i,r&&(s.totalVideoDelay=(s.totalVideoDelay||0)+r,s.videoDelayCount=(s.videoDelayCount||0)+1),o&&(s.totalAudioDelay=(s.totalAudioDelay||0)+o,s.audioDelayCount=(s.audioDelayCount||0)+1),s.count++;else{let e,s,a,c;r&&(s=r,a=1),o&&(e=o,c=1),this._networkQuality.totalDownlinkRTTAndLossMap.set(n,{totalRTT:t,totalLoss:i,count:1,totalAudioDelay:e,totalVideoDelay:s,audioDelayCount:c,videoDelayCount:a})}})))}handleHeartbeatStats(e){if(this.hitTest(e.room)){let{msg_up_stream_info:t,msg_down_stream_info:i}=e.report;if(t.msg_video_status[0]){let{uint32_video_codec_bitrate:e,uint32_video_enc_fps:i,uint32_video_width:n,uint32_video_height:r}=t.msg_video_status[0];this._localStreamStat.totalVideoBitrate+=e,this._localStreamStat.totalVideoFPS+=i,this._localStreamStat.totalVideoWidth+=n,this._localStreamStat.totalVideoHeight+=r,this._localStreamStat.videoCount++}if(t.msg_audio_status){let{uint32_audio_level:e}=t.msg_audio_status;Math.floor(e/WN*100)>0&&(this._localStreamStat.totalAudioLevel+=e/WN,this._localStreamStat.audioLevelCount++)}i.forEach((e=>{let{msg_user_info:t,msg_audio_status:i,msg_video_status:n}=e,r=t.str_identifier,o=this._room.remotePublishedUserMap.get(r);if(n.forEach((e=>{let t=2===e.uint32_video_stream_type,i=7===e.uint32_video_stream_type,n="".concat(r,"_").concat(t?"main":"auxiliary"),s=this._remoteStreamStatMap.get(n);if(s&&(t&&(null==o?void 0:o.remoteVideoTrack.isSubscribed)||i&&(null==o?void 0:o.remoteAuxiliaryTrack))){s.totalVideoFPS+=e.uint32_video_receive_fps,s.totalVideoBitrate+=e.uint32_video_codec_bitrate,s.videoCount++,0===s.statsToReport.uint32_video_width&&(s.statsToReport.uint32_video_width=e.uint32_video_width),0===s.statsToReport.uint32_video_height&&(s.statsToReport.uint32_video_height=e.uint32_video_height);let i=t?o.remoteVideoTrack:o.remoteAuxiliaryTrack;i.stat.jitterBufferDelay&&(s.videoJitterBufferDelay=i.stat.jitterBufferDelay),i.stat.framesReceived&&(s.statsToReport.uint32_video_consume_render_rate=Math.floor(i.stat.framesDecoded/i.stat.framesReceived*rb(10,6)))}})),i){let e="".concat(r,"_","main"),t=this._remoteStreamStatMap.get(e);this._remoteStreamStatMap.has(e)&&t&&(null==o?void 0:o.remoteAudioTrack.isSubscribed)&&(t.totalAudioBitrate+=i.uint32_audio_codec_bitrate,t.audioCount++,o.remoteAudioTrack.stat.jitterBufferDelay&&(t.audioJitterBufferDelay=o.remoteAudioTrack.stat.jitterBufferDelay),Math.floor(i.uint32_audio_level/WN*100)>0&&(t.totalAudioLevel+=i.uint32_audio_level/WN,t.audioLevelCount++))}}))}}handlePublishStart(e){let{room:t}=e;this.hitTest(t)&&0===this._localStreamStat.publishStartTime&&(this._localStreamStat.publishStartTime=Date.now())}handleTrackCaptureStart(e){let{track:t}=e;1===t.mediaType&&!this._pathJoinRoom.uint64_init_audio_start_time&&(this._pathJoinRoom.uint64_init_audio_start_time=Date.now()),4===t.mediaType&&!this._pathJoinRoom.uint64_init_camera_start_time&&(this._pathJoinRoom.uint64_init_camera_start_time=Date.now())}handleTrackCaptureSuccess(e){let{track:t}=e;1===t.mediaType&&!this._pathJoinRoom.uint64_init_audio_end_time&&(this._pathJoinRoom.int32_init_audio_ret=0,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),4===t.mediaType&&!this._pathJoinRoom.uint64_init_camera_end_time&&(this._pathJoinRoom.int32_init_camera_ret=0,this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleTrackCaptureFailed(e){let{track:t,error:i}=e,n={NotFoundError:1,NotAllowedError:2,NotReadableError:3,OverConstrainedError:4,AbortError:5,InvalidStateError:6,SecurityError:7,TypeError:8}[i.name]||(i instanceof vb?i.getExtraCode()||i.getCode():Ab.UNKNOWN);1===t.mediaType&&!this._pathJoinRoom.uint64_init_audio_end_time&&(this._pathJoinRoom.int32_init_audio_ret=n,this._pathJoinRoom.uint64_init_audio_end_time=Date.now()),4===t.mediaType&&!this._pathJoinRoom.uint64_init_camera_end_time&&(this._pathJoinRoom.int32_init_camera_ret=n,this._pathJoinRoom.uint64_init_camera_end_time=Date.now())}handleAPISuccessRate(e){let{room:t,apiName:i,error:n,cost:r}=e;if(!this.hitTest(t))return;let o=gU[i],s={uint32_function_request_type:o,uint32_avg_value:0,uint32_max_value:0,uint32_request_count:1,uint32_success_count:0,msg_error_code:[]};if(n){let e=n.extraCode||n.code||Ab.UNKNOWN;sL.logFailedEvent({eventType:i,code:e,userId:this._room.userId,error:n});let t={int32_error_code:e,error_count:1};s.msg_error_code.push(t)}else hO(r)&&(sL.logSuccessEvent({eventType:i,userId:this._room.userId}),s.uint32_avg_value=r,s.uint32_max_value=r,s.uint32_success_count=1);let a=this._apiSuccessRateMap.get(o);a?(a.uint32_success_count+s.uint32_success_count>0&&(a.uint32_avg_value=(a.uint32_avg_value*a.uint32_success_count+s.uint32_avg_value)/(a.uint32_success_count+s.uint32_success_count)),a.uint32_max_value=Math.max(a.uint32_max_value,s.uint32_max_value),a.uint32_request_count+=1,a.uint32_success_count=a.uint32_success_count+s.uint32_success_count,s.msg_error_code.forEach((e=>{let t=a.msg_error_code.find((t=>t.int32_error_code===e.int32_error_code));t?t.error_count+=1:a.msg_error_code.push(e)}))):this._apiSuccessRateMap.set(o,s)}hasVideoFlag(e){return this._firstPublishedUserList.findIndex((t=>t.userId===e&&t.flag&JD))>=0}hasAudioFlag(e){return this._firstPublishedUserList.findIndex((t=>t.userId===e&&t.flag&zD))>=0}hasAuxFlag(e){return this._firstPublishedUserList.findIndex((t=>t.userId===e&&t.flag&YD))>=0}hitTest(e){return e===this._room}checkStorage(){return _b(this,null,(function*(){try{let e=qO.getItem(this._storageKey);e&&(yield this.upload(e),qO.deleteItem(this._storageKey))}catch(Xw){this._log.warn(Xw)}}))}setStorage(){this.prepareReport();let e=this.getReportData();0!==e.msg_path_enter_room.uint64_start_time&&qO.setItem(this._storageKey,e)}prepareReport(){if(this._networkQuality.count>0&&(this._basicInfo.uint32_avg_rtt=Math.floor(this._networkQuality.totalUplinkRTT/this._networkQuality.count),this._basicInfo.uint32_avg_up_loss=Math.floor(this._networkQuality.totalUplinkLoss/this._networkQuality.count)),this._localStreamStat.videoCount>0){this._localStreamStat.statsToReport.uint32_video_big_capture_fps=Math.floor(this._localStreamStat.totalVideoFPS/this._localStreamStat.videoCount),this._localStreamStat.statsToReport.uint32_video_big_bitrate=Math.floor(this._localStreamStat.totalVideoBitrate/this._localStreamStat.videoCount);let e=Math.floor(this._localStreamStat.totalVideoWidth/this._localStreamStat.videoCount),t=Math.floor(this._localStreamStat.totalVideoHeight/this._localStreamStat.videoCount);this._localStreamStat.statsToReport.uint32_video_big_resolution=e<<16|t}this._localStreamStat.audioLevelCount>0&&(this._localStreamStat.statsToReport.uint32_audio_capture_db=Math.floor(this._localStreamStat.totalAudioLevel/this._localStreamStat.audioLevelCount*100)),this._remoteStreamStatMap.forEach(((e,t)=>{let{userId:i}=e,n=this._networkQuality.totalDownlinkRTTAndLossMap.get(i);if(n){let{totalLoss:t,count:i,audioDelayCount:r,videoDelayCount:o,totalAudioDelay:s,totalVideoDelay:a}=n;e.statsToReport.uint32_avg_down_loss=Math.floor(t/i),r&&s&&(e.statsToReport.uint32_audio_network_p2p_delay=Math.floor(s/r),e.audioJitterBufferDelay&&(e.statsToReport.uint32_p2p_delay=Math.floor(e.statsToReport.uint32_audio_network_p2p_delay+e.audioJitterBufferDelay))),o&&a&&(e.statsToReport.uint32_video_network_p2p_delay=Math.floor(a/o))}e.videoCount>0&&(e.statsToReport.uint32_video_avg_fps=Math.floor(e.totalVideoFPS/e.videoCount),e.statsToReport.uint32_video_avg_bitrate=Math.floor(e.totalVideoBitrate/e.videoCount)),e.audioCount>0&&(e.statsToReport.uint32_audio_recv_bitrate=e.statsToReport.uint32_audio_bitrate=Math.floor(e.totalAudioBitrate/e.audioCount)),e.audioLevelCount>0&&(e.statsToReport.uint32_audio_play_db=Math.floor(e.totalAudioLevel/e.audioLevelCount*100));let{callDurationCalculator:r}=this._room;r&&(e.statsToReport.uint32_audio_play_time=r.getDuration(t,HD.AUDIO),e.statsToReport.uint32_video_play_time=r.getDuration(t,HD.VIDEO)),e.statsToReport.uint32_video_render_first=Math.min(e.statsToReport.uint32_video_render_first,_U);let{badCaseDetector:o}=this._room,{dataFreeze:s,count:a}=o.getDataFreezeDuration(t),{renderFreeze:c}=o.getRenderFreezeDuration(t);e.statsToReport.uint32_video_block_count=a,e.statsToReport.uint32_video_block_time=Math.min(s,e.statsToReport.uint32_video_play_time),e.statsToReport.uint32_video_external_block_time=Math.min(c,e.statsToReport.uint32_video_play_time),o.isBlackStream(t)&&0===e.statsToReport.uint32_video_avg_fps?e.statsToReport.uint32_video_black_screen_subjective=1:e.statsToReport.uint32_video_black_screen_subjective=0,(0===e.subscribeStartTime||e.subscribeStartTime-e.streamAddedTime>100||0===e.playStreamTime)&&(this._pathMainAudioMap.delete(t),this._pathMainVideoMap.delete(t),e.statsToReport.uint32_video_render_first=0)})),this._pathMainAudioMap.forEach(((e,t)=>{this.hasAudioFlag(e.userId)?e.statsToReport.uint64_play_first_frame_time-e.statsToReport.uint64_start_enter_time>_U&&(e.statsToReport.uint64_play_first_frame_time=e.statsToReport.uint64_start_enter_time+_U):this._pathMainAudioMap.delete(t)})),this._pathMainVideoMap.forEach(((e,t)=>{this.hasVideoFlag(e.userId)?e.statsToReport.uint64_render_first_frame_time-e.statsToReport.uint64_start_enter_time>_U&&(e.statsToReport.uint64_render_first_frame_time=e.statsToReport.uint64_start_enter_time+_U):this._pathMainVideoMap.delete(t)})),this._pathJoinRoom.uint64_end_time-this._pathJoinRoom.uint64_start_time>_U&&(this._pathJoinRoom.uint64_end_time=this._pathJoinRoom.uint64_start_time+_U)}getReportData(){return{uint32_sdk_app_id:Number(this._room.sdkAppId),msg_user_info:new fU({userId:this._room.userId,tinyId:this._room.tinyId,role:"anchor"===this._room.role?20:21}),msg_basic_info:this._basicInfo,uint32_acc_ip:OO(this._signalInfo.relayIp),uint32_client_ip:OO(this._signalInfo.clientIp,!1),uint32_acc_port:this._signalInfo.relayPort||0,uint64_timestamp:Date.now(),uint32_seq:Math.floor(2147483648*Math.random()),msg_path_enter_room:this._pathJoinRoom,msg_path_exit_room:this._pathLeaveRoom,msg_path_recv_video:[...this._pathMainVideoMap.values()].map((e=>e.statsToReport)),msg_quality_statistics:[...this._remoteStreamStatMap.values()].map((e=>e.statsToReport)),str_room_name:String(this._room.roomId||0),msg_path_recv_audio:[...this._pathMainAudioMap.values()].map((e=>e.statsToReport)),uint32_info_client_ip:OO(this._signalInfo.clientIp,!1),error_code:[],msg_local_statistics:this._localStreamStat.statsToReport,msg_function_request_stats:[...this._apiSuccessRateMap.values()]}}report(){try{this.prepareReport();let e=this.getReportData();this.upload(e),qO.deleteItem(this._storageKey),this.initData()}catch(Xw){this._log.warn(Xw)}}upload(e){if(eD||0===e.msg_path_enter_room.uint64_start_time||[SD,AD,yD].findIndex((e=>e===location.host))>=0)return;let t=Number(this._room.sdkAppId),i=YN(t,ND.KEY_POINT),n=!1;navigator.sendBeacon&&(n=navigator.sendBeacon(i,JSON.stringify(e))),n||FO({url:i,body:JSON.stringify(e)})}setConnectionType(e){this.connectionType=e,this._basicInfo.uint32_connection_type=e}};ub([dU({settings:{timeout:500,retries:3}})],hU.prototype,"upload",1);var pU,_U=5e3,mU={msg_user_info:null,uint32_video_avg_fps:0,uint32_video_width:0,uint32_video_height:0,uint32_video_avg_bitrate:0,uint32_video_block_time:0,uint32_video_play_time:0,uint32_audio_block_time:0,uint32_audio_play_time:0,uint32_audio_play_db:0,uint32_avg_down_loss:0,uint32_stream_type:0,uint32_video_render_first:0,uint32_video_block_count:0,uint32_audio_block_count:0,uint32_audio_bitrate:0,uint32_video_black_screen_subjective:0,uint32_audio_recv_bitrate:0,uint32_video_external_block_time:0,uint32_video_consume_render_rate:0},fU=class{constructor(e){this.str_identifier=String(e.userId),this.str_tinyid=String(e.tinyId||0),this.uint32_role=e.role}},gU=((pU=gU||{})[pU.enterRoom=50001]="enterRoom",pU[pU.exitRoom=50002]="exitRoom",pU[pU.switchRole=50003]="switchRole",pU[pU.destroy=50004]="destroy",pU[pU.startLocalAudio=50005]="startLocalAudio",pU[pU.updateLocalAudio=50006]="updateLocalAudio",pU[pU.stopLocalAudio=50007]="stopLocalAudio",pU[pU.startLocalVideo=50008]="startLocalVideo",pU[pU.updateLocalVideo=50009]="updateLocalVideo",pU[pU.stopLocalVideo=50010]="stopLocalVideo",pU[pU.startScreenShare=50011]="startScreenShare",pU[pU.updateScreenShare=50012]="updateScreenShare",pU[pU.stopScreenShare=50013]="stopScreenShare",pU[pU.enableAudioVolumeEvaluation=50014]="enableAudioVolumeEvaluation",pU[pU.startRemoteVideo=50015]="startRemoteVideo",pU[pU.updateRemoteVideo=50016]="updateRemoteVideo",pU[pU.stopRemoteVideo=50017]="stopRemoteVideo",pU[pU.muteRemoteAudio=50018]="muteRemoteAudio",pU[pU.setRemoteAudioVolume=50019]="setRemoteAudioVolume",pU[pU.startMixTranscode=50020]="startMixTranscode",pU[pU.stopMixTranscode=50021]="stopMixTranscode",pU[pU.startPublishCDNStream=50022]="startPublishCDNStream",pU[pU.stopPublishCDNStream=50023]="stopPublishCDNStream",pU[pU.PeerConnectionConnect=50024]="PeerConnectionConnect",pU[pU.PeerConnectionReconnect=50025]="PeerConnectionReconnect",pU[pU.WebsocketConnect=50026]="WebsocketConnect",pU[pU.WebsocketReconnect=50027]="WebsocketReconnect",pU[pU.schedule=50028]="schedule",pU[pU.SPCConnect=50029]="SPCConnect",pU[pU.SPCReconnect=50030]="SPCReconnect",pU),TU=hU,EU=class{constructor(){hb(this,"_startTime"),hb(this,"_endTime"),this._startTime=0,this._endTime=0,this.start()}start(){0===this._startTime&&(this._startTime=yO())}stop(){0===this._endTime&&(this._endTime=yO())}getDuration(){return 0===this._endTime?yO()-this._startTime:this._endTime-this._startTime}get endTime(){return this._endTime}},IU=class{constructor(e){hb(this,"_room",null),hb(this,"_durationMap"),hb(this,"_eventMap",new Map),this._room=e.room,this._durationMap=new Map,this.installEvents()}installEvents(){this._eventMap.set(JO.SUBSCRIBE_SUCCESS,this.handleSubscribed).set(JO.UNSUBSCRIBE_SUCCESS,this.handleStreamStopped).set(JO.REMOTE_PUBLISH_STATE_CHANGED,(e=>{let{room:t,prevMuteState:i,muteState:n}=e;var r;let{userId:o}=n;if(!this.hitTest(t))return;i.hasAudio&&!n.hasAudio&&this.stopDurationItem("".concat(o,"_","main"),HD.AUDIO),i.hasVideo&&!n.hasVideo&&this.stopDurationItem("".concat(o,"_","main"),HD.VIDEO),i.hasAuxiliary&&!n.hasAuxiliary&&this.stopDurationItem("".concat(o,"_","auxiliary"),HD.VIDEO);let s=null==(r=this._room)?void 0:r.remotePublishedUserMap.get(o);!s||(!i.hasAudio&&n.hasAudio&&s.remoteAudioTrack.isSubscribed&&this.addDuractionItem(o,HD.AUDIO,"main"),!i.hasVideo&&n.hasVideo&&s.remoteVideoTrack.isSubscribed&&this.addDuractionItem(o,HD.VIDEO,"main"),!i.hasAuxiliary&&n.hasAuxiliary&&s.remoteAuxiliaryTrack.isSubscribed&&this.addDuractionItem(o,HD.VIDEO,"auxiliary"))})),this._eventMap.forEach(((e,t)=>GO.on(t,e,this)))}uninstallEvents(){this._eventMap.forEach(((e,t)=>GO.off(t,e,this))),this._eventMap.clear()}handleSubscribed(e){let{room:t,streamType:i,remotePublishedUser:n}=e;if(!this.hitTest(t))return;let{userId:r}=n,o="".concat(r,"_").concat(i);if(n.muteState.hasAudio&&"main"===i)if(n.remoteAudioTrack.isSubscribed){let e=new EU,t=this._durationMap.get(o);t?this.isRecording(t.audio)||t.audio.push(e):this._durationMap.set(o,{userId:r,type:i,audio:[e],video:[]})}else this.stopDurationItem(o,HD.AUDIO);if(n.muteState.hasVideo||n.muteState.hasAuxiliary)if(n.remoteVideoTrack.isSubscribed||n.remoteAuxiliaryTrack.isSubscribed){let e=new EU,t=this._durationMap.get(o);t?this.isRecording(t.video)||t.video.push(e):this._durationMap.set(o,{userId:r,type:i,audio:[],video:[e]})}else this.stopDurationItem(o,HD.VIDEO)}handleStreamStopped(e){let{room:t,streamType:i,remotePublishedUser:n}=e;if(!this.hitTest(t))return;let{userId:r}=n,o="".concat(r,"_").concat(i);this.stopDurationItem(o,HD.AUDIO),this.stopDurationItem(o,HD.VIDEO)}isRecording(e){return e.findIndex((e=>0===e.endTime))>=0}addDuractionItem(e,t,i){let n="".concat(e,"_").concat(i),r=new EU,o=this._durationMap.get(n);o?this.isRecording(o[t])||o[t].push(r):this._durationMap.set(n,{userId:e,type:i,audio:t===HD.AUDIO?[r]:[],video:t===HD.AUDIO?[]:[r]})}stopDurationItem(e,t){if(this._durationMap.has(e)){let i=this._durationMap.get(e)[t].find((e=>0===e.endTime));i&&i.stop()}}hitTest(e){return this._room===e}getDuration(e,t){return this._durationMap.has(e)?this._durationMap.get(e)[t].reduce(((e,t)=>e+t.getDuration()),0):0}getDurationMap(){return this._durationMap}reset(){this._durationMap.clear()}destroy(){this._room=null,this.uninstallEvents()}},SU=class{constructor(e){hb(this,"_room"),hb(this,"_renderFreezeMap",new Map),hb(this,"_isVideoPlayingEventFiredMap",new Map),hb(this,"_dataFreezeMap",new Map),hb(this,"_monitorFreezeData",new Map),hb(this,"_eventMap",new Map),this._room=e.room,this.installEvents()}installEvents(){this._eventMap.set(JO.LEAVE_SUCCESS,(e=>{let{room:t}=e;this.hitTest(t)&&this.stop()})).set(JO.PLAY_TRACK_START,this.onPlayTrackStart).set(JO.UNSUBSCRIBE_SUCCESS,(e=>{let{room:t,streamType:i,remotePublishedUser:n}=e;if(!this.hitTest(t))return;let{userId:r}=n,o="".concat(r,"_").concat(i);this.stopDataFreeze({key:o,userId:r,type:i})})).set(JO.REMOTE_PUBLISH_STATE_CHANGED,(e=>{let{room:t,prevMuteState:i,muteState:n}=e;if(!this.hitTest(t))return;let{userId:r}=n;if(i.hasVideo&&!n.hasVideo){let e="main",t="".concat(n.userId,"_").concat(e);this.stopDataFreeze({key:t,userId:r,type:e})}if(i.hasAuxiliary&&!n.hasAuxiliary){let e="auxiliary",t="".concat(n.userId,"_").concat(e);this.stopDataFreeze({key:t,userId:r,type:e})}})).set(JO.PLAYER_STATE_CHANGED,(e=>{let{track:t,state:i,reason:n,type:r}=e;if(gO(t)&&this.hitTest(t.room)&&r===HD.VIDEO){if("PLAYING"===i){let e="".concat(t.userId,"_").concat(t.streamType);this._isVideoPlayingEventFiredMap.set(e,!0)}n===HD.MUTE?this.onVideoTrackMuted(t):n===HD.UNMUTE&&this.onVideoTrackUnmuted(t)}})).set(JO.HEARTBEAT_REPORT,this.onHearBeatReport),this._eventMap.forEach(((e,t)=>GO.on(t,e,this)))}uninstallEvents(){this._eventMap.forEach(((e,t)=>GO.off(t,e,this))),this._eventMap.clear()}stop(){this._renderFreezeMap.clear(),this._dataFreezeMap.clear(),this._isVideoPlayingEventFiredMap.clear()}onVideoTrackMuted(e){if(!e.isSubscribed)return;let{userId:t,streamType:i}=e,n="".concat(t,"_").concat(i),r=this._dataFreezeMap.get(n),o=new EU;r?r.durationItemList.push(o):this._dataFreezeMap.set(n,{userId:t,type:i,durationItemList:[o],isFreezing(){let e=this.durationItemList[this.durationItemList.length-1];return e&&0===e.endTime}})}onVideoTrackUnmuted(e){if(!e.isSubscribed)return;let{userId:t,streamType:i}=e,n="".concat(t,"_").concat(i);this.stopDataFreeze({key:n,userId:t,type:i})}onHearBeatReport(e){let{room:t,report:i}=e;!this.hitTest(t)||i.msg_down_stream_info.forEach((e=>{let t=this._room.remotePublishedUserMap.get(e.msg_user_info.str_identifier);if(!t)return;let{userId:i,muteState:n}=t;e.msg_video_status.forEach((e=>{2===e.uint32_video_stream_type&&n.hasVideo&&!n.videoMuted&&t.remoteVideoTrack.isSubscribed&&this.handleRenderFreeze({userId:i,fps:e.uint32_video_dec_fps,type:"main"}),7===e.uint32_video_stream_type&&n.hasAuxiliary&&t.remoteAuxiliaryTrack.isSubscribed&&this.handleRenderFreeze({userId:i,fps:e.uint32_video_dec_fps,type:"auxiliary"})}))}))}stopDataFreeze(e){let{key:t,userId:i,type:n}=e,r=this._dataFreezeMap.get(t);if(!r||!r.isFreezing())return;let o=r.durationItemList[r.durationItemList.length-1];o.stop();let s=o.getDuration();s>yN?this._monitorFreezeData.set(t,{userId:i,type:n,duration:s}):r.durationItemList.pop()}getTotalDuration(e){return e.reduce(((e,t)=>{let i=t.getDuration();return e+Math.min(i,5e3)}),0)}handleRenderFreeze(e){return _b(this,arguments,(function(e){var t=this;let{userId:i,fps:n,type:r}=e;return function*(){let e="".concat(i,"_").concat(r),o=t._renderFreezeMap.get(e);if(n<=2){let n=yO();o&&!o.isFreeze&&(o.freezeTimeline.push({startTime:n,endTime:0}),o.isFreeze=!0),o||t._renderFreezeMap.set(e,{userId:i,type:r,isFreeze:!0,freezeTimeline:[{startTime:n,endTime:0}],renderFreezeTotal:0})}else if(o&&o.isFreeze){o.isFreeze=!1;let e=o.freezeTimeline.pop();if(e){e.endTime=yO();let t=e.endTime-e.startTime;o.freezeTimeline.push(e),o.renderFreezeTotal+=Math.min(5e3,t)}}}()}))}onPlayTrackStart(e){let{track:t}=e;if(!gO(t)||!this.hitTest(t.room)||t.kind!==HD.VIDEO||t.hasFlag)return;let i="".concat(t.userId,"_").concat(t.streamType);this._isVideoPlayingEventFiredMap.has(i)||this._isVideoPlayingEventFiredMap.set(i,!1)}getDataFreezeDuration(e){let t={dataFreeze:0,count:0},i=this._dataFreezeMap.get(e);if(i){if(i.isFreezing()){let e=i.durationItemList[i.durationItemList.length-1];e.stop(),e.getDuration()<yN&&i.durationItemList.pop()}t.dataFreeze=this.getTotalDuration(i.durationItemList),t.count=i.durationItemList.length}return t}getRenderFreezeDuration(e){let t=this._renderFreezeMap.get(e),i=0,n=0;if(t)if(t.isFreeze){let e=yO()-t.freezeTimeline[t.freezeTimeline.length-1].startTime;i=t.renderFreezeTotal+Math.min(e,5e3),n=t.freezeTimeline.length}else i=t.renderFreezeTotal;return{renderFreeze:i,count:n}}getMonitorFreeze(){return this._monitorFreezeData}isBlackStream(e){return!!this._isVideoPlayingEventFiredMap.has(e)&&!this._isVideoPlayingEventFiredMap.get(e)}resetMonitor(){this._monitorFreezeData.clear()}hitTest(e){return e===this._room}destroy(){this.uninstallEvents()}},AU=null,yU=!0;function vU(e){pO(e)&&e!==yU&&(yU=e,YO.info("setIsNeedToSchedule ".concat(e)))}function RU(e){return _b(this,arguments,(function(e){let{userId:t,sdkAppId:i,useStringRoomId:n,roomId:r,userSig:o,version:s,frameWorkType:a}=e;return function*(){if(!yU&&AU)return{isCached:!0,result:AU};let e={delta:0,count:[1,1],msg:[]};try{let c=new FormData;c.append("userId",String(t)),c.append("sdkAppId",String(i)),c.append("isStrGroupId",String(n)),c.append("groupId",String(r)),c.append("sdkVersion",s),c.append("userSig",String(o)),c.append("frameWorkType",String(a));let l=yO(),d=yield function(e,t,i){return new Promise(((n,r)=>{let o=null;AO([kU((e=>t.count[0]=e+1),((e,i)=>{t.msg[0]=e.message,o||i()}))(CU(i,HD.MAIN),e,{get timeout(){return 1e3*sO(2+t.count[0])}}),kU((e=>t.count[1]=e+1),((e,i)=>{t.msg[1]=e.message,o||i()}))(CU(i,HD.BACKUP),e,{get timeout(){return 1e3*sO(2+t.count[1])}})]).then((e=>{o=e,n(o)})).catch(r)}))}(c,e,i);return d.config&&(d.config.loggerDomain&&ID(d.config.loggerDomain),pO(d.config.scheduleCache)&&vU(!d.config.scheduleCache)),e.delta=yO()-l,AU=d,{isCached:!1,result:d}}catch(c){let e=mO(c)?c[0]:c,t=hO(e.code)?e.code:0,i="schedule failed".concat(e.message?": ".concat(e.message):""),n=new vb({code:Ab.SCHEDULE_FAILED,extraCode:t,message:rP({key:XO.JOIN_ROOM_FAILED,data:{error:i,code:t}})});throw YO.error(n),n}}()}))}function CU(e){let t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:HD.MAIN;return t=KN(e)?i===HD.MAIN?kN.MAIN_OVERSEA:kN.BACKUP_OVERSEA:i===HD.MAIN?kN.MAIN:kN.BACKUP,"https://".concat(t,"/api/v1/config")}function bU(e,t,i){return new Promise(((n,r)=>{FO({url:e,body:t,timeout:i.timeout}).then((e=>{0===e.data.code?n(e.data.data):r({code:e.data.code,message:e.data.msg})})).catch(r)}))}GO.on("28",(()=>vU(!0))),GO.on("63",(()=>vU(!0))),GO.on("84",(()=>vU(!0))),GO.on("201",(e=>{"RECONNECTING"===e.state&&vU(!0)})),GO.on("202",(e=>{"RECONNECTING"===e.state&&vU(!0)}));var kU=(e,t)=>HO({retryFunction:bU,settings:{retries:3,timeout:0},onError:t,onRetrying:e});var DU=0,NU=class extends ZP{constructor(e){super("room"),this.seq=++DU,this.role="anchor",this.localTracks=new Set,this.enableAutoPlayDialog=!0,this.autoReceiveAudio=!0,this.autoReceiveVideo=!0,this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null},this._isUsingCachedSchedule=!1,this._log=YO.createLogger({id:"r".concat(this.seq)}),this._joinedTimestamp=0,this._isDestroyed=!1,this.useStringRoomId=!!e.useStringRoomId,pO(e.autoReceiveAudio)&&(this.autoReceiveAudio=e.autoReceiveAudio),pO(e.autoReceiveVideo)&&(this.autoReceiveVideo=e.autoReceiveVideo),pO(e.enableAutoPlayDialog)&&(this.enableAutoPlayDialog=e.enableAutoPlayDialog),this.keyPointManager=new TU({room:this,frameWorkType:e.frameWorkType,component:e.component,language:e.language}),this.callDurationCalculator=new IU({room:this}),this.badCaseDetector=new SU({room:this}),this.audioManager=new Pw({room:this})}get isMainStreamPublished(){for(let e of this.localTracks)if(4&e.mediaType)return!0;return!1}get isAuxStreamPublished(){for(let e of this.localTracks)if(2&e.mediaType)return!0;return!1}get hasAuxStream(){for(let e of this.remotePublishedUserMap.values())if(e.muteState.hasAuxiliary)return!0;return this.isAuxStreamPublished}getLogger(){return this._log}get isJoined(){return"joined"===this.state}addTrack(e){return _b(this,null,(function*(){return this.publish(e)}))}removeTrack(e){return _b(this,null,(function*(){return this.unpublish(e)}))}replaceTrack(e){return _b(this,null,(function*(){}))}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAIVoice(e){throw new Error("Method not implemented.")}getRemoteAudioStats(){return _b(this,null,(function*(){let e={};return this.remotePublishedUserMap.forEach((t=>{e[t.userId]=t.remoteAudioTrack.stat})),e}))}getTransportStats(){return _b(this,null,(function*(){var e;let t={rtt:(null==(e=this.quality)?void 0:e.uplinkRTT)||0,downlinksRTT:{}};if(this.quality)for(let i of this.quality.downlinkInfo)t.downlinksRTT[i.userId]=i.rtt;return t}))}getRemoteVideoStats(){return _b(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"main";return function*(){let i={};return e.remotePublishedUserMap.forEach((e=>{let n="auxiliary"===t?e.remoteAuxiliaryTrack:e.remoteVideoTrack;i[e.userId]=n.stat})),i}()}))}checkDestroy(){if(this._isDestroyed)throw new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.CLIENT_DESTROYED,data:{funName:"join"}})})}destroy(){if(this.isJoined)throw this._log.warn(ZO.INVALID_DESTROY),new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.INVALID_DESTROY})});this._log.info("destroy room"),this.keyPointManager.destroy(),this.callDurationCalculator.destroy(),this.badCaseDetector.destroy(),this._isDestroyed=!0,GO.emit(JO.ROOM_DESTROY,{room:this})}schedule(e,t,i){return _b(this,null,(function*(){var n,r;let o=yO();try{let{isCached:s,result:a}=yield RU({userId:this.userId,sdkAppId:this.sdkAppId,roomId:e,useStringRoomId:this.useStringRoomId,version:i,userSig:this.userSig,frameWorkType:t});this._isUsingCachedSchedule=s,this._log.info("schedule cache: ".concat(s," : ").concat(JSON.stringify(a))),this.scheduleResult=sb(sb({},this.scheduleResult),a),hO(null==(n=a.config)?void 0:n.retryCount)&&uN(a.config.retryCount),uO(null==(r=a.config)?void 0:r.loggerDomain)&&ID(a.config.loggerDomain),GO.emit(JO.JOIN_SCHEDULE_SUCCESS,{room:this,schedule:this.scheduleResult}),GO.emit(JO.API_SUCCESS_RATE,{room:this,apiName:"schedule",cost:yO()-o})}catch(s){throw GO.emit(JO.API_SUCCESS_RATE,{room:this,apiName:"schedule",error:s}),s}}))}},OU=new WeakMap,PU=new WeakMap;function LU(){return function(e,t,i){let n=i.value,r=e=>{let{fn:t,args:i,context:n,resolve:r,reject:o}=e;t.apply(n,i).then(r,o)};return i.value=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return new Promise(((e,i)=>{if(OU.has(this)){let o=OU.get(this),{length:s}=o;o.push({fn:n,args:t,context:this,resolve:e,reject:i}),0===s&&r({fn:n,args:t,context:this,resolve:e,reject:i})}else OU.set(this,[{fn:n,args:t,context:this,resolve:e,reject:i}]),r({fn:n,args:t,context:this,resolve:e,reject:i})})).finally((()=>{let e=OU.get(this);e&&(e.shift(),e[0]&&r(sb({},e[0])))}))},i}}function wU(e){return function(t,i,n){let r=n.value,o=t=>hO(e)?t[e]:e(...t),s=e=>{let{fn:t,args:i,context:n,resolve:r,reject:a}=e;t.apply(n,i).then(r,a).finally((()=>{if(PU.has(n)&&PU.get(n).has(o(i))){let e=PU.get(n).get(o(i));e&&(e.shift(),e[0]&&s(sb({},e[0])))}}))};return n.value=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return new Promise(((e,i)=>{if(PU.has(this))if(PU.get(this).has(o(t))){let n=PU.get(this).get(o(t));if(n){let{length:o}=n;n.push({fn:r,args:t,context:this,resolve:e,reject:i}),0===o&&s({fn:r,args:t,context:this,resolve:e,reject:i})}}else PU.get(this).set(o(t),[{fn:r,args:t,context:this,resolve:e,reject:i}]),s({fn:r,args:t,context:this,resolve:e,reject:i});else{let n=new Map;n.set(o(t),[{fn:r,args:t,context:this,resolve:e,reject:i}]),PU.set(this,n),s({fn:r,args:t,context:this,resolve:e,reject:i})}}))},n}}var MU=db(mb()),VU=db(Eb()),UU=e=>{let{serverAbility:t,clientAbility:i,offerSDP:n,enableCustomMessage:r}=e,o=JV(n),s={extmapAllowMixed:"extmap-allow-mixed",groups:o.groups,icelite:"ice-lite",media:[],msidSemantic:{semantic:"",token:"WMS"},name:"-",origin:{address:"127.0.0.1",username:"-",sessionId:String(Date.now()),sessionVersion:1,netType:"IN",ipVer:4},timing:{start:0,stop:0},version:0},a={candidates:t.candidates.map((e=>({component:1,foundation:"1",generation:0,ip:e.ip,port:e.port,priority:e.priority,transport:e.foundation,type:e.type}))),connection:{version:4,ip:"0.0.0.0"},direction:HD.TRANSCEIVER_DIRECTION_RECVONLY,ext:t.audio.extensions.map((e=>({value:e.id,uri:e.uri}))),fingerprint:{type:t.dtls.hash,hash:t.dtls.fingerprint},fmtp:[{payload:t.audio.codecs[0].payload,config:t.audio.codecs[0].fmtp}],icePwd:t.ice.password,iceUfrag:t.ice.ufrag,mid:"0",payloads:String(t.audio.codecs[0].payload),port:o.media[0].port,protocol:o.media[0].protocol,type:HD.AUDIO,setup:t.dtls.setup,rtcpFb:t.audio.codecs[0].rtcpfb.map((e=>({payload:t.audio.codecs[0].payload,type:e.id,subtype:e.params[0]}))),rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[{payload:t.audio.codecs[0].payload,codec:t.audio.codecs[0].codec,rate:t.audio.codecs[0].rate,encoding:t.audio.codecs[0].channels}]};return s.media.push(a),[1,2,3].forEach((e=>{s.media.push(xU({mid:e,serverAbility:t,clientAbility:i,parsedOffer:o}))})),r&&s.media.push(o.media.find((e=>"dc"===e.mid))),KV(s)},xU=e=>{let{mid:t,serverAbility:i,clientAbility:n,parsedOffer:r,useAllCodec:o=!1}=e,s={candidates:i.candidates.map((e=>({component:1,foundation:"1",generation:0,ip:e.ip,port:e.port,priority:e.priority,transport:e.foundation,type:e.type}))),connection:{version:4,ip:"0.0.0.0"},direction:HD.TRANSCEIVER_DIRECTION_RECVONLY,ext:i.video.extensions.map((e=>({value:e.id,uri:e.uri}))),fingerprint:{type:i.dtls.hash,hash:i.dtls.fingerprint},fmtp:[],icePwd:i.ice.password,iceUfrag:i.ice.ufrag,mid:String(t),payloads:"",port:r.media[0].port,protocol:r.media[0].protocol,type:HD.VIDEO,setup:i.dtls.setup,rtcpFb:[],rtcpMux:"rtcp-mux",rtcpRsize:"rtcp-rsize",rtp:[]};if(i.video.codecs.length>0)if(o)for(let a=0;a<i.video.codecs.length;a++)FU(s,i.video.codecs[a]);else{let e=i.video.codecs.findIndex((e=>e.codec.toLowerCase()===(i.useVp8?"vp8":"h264")));FU(s,i.video.codecs[e])}else if(o)for(let a=0;a<n.video.codecs.length;a++)FU(s,n.video.codecs[a]);else FU(s,n.video.codecs[0]);return s.payloads=s.payloads.trim(),s},FU=(e,t)=>{e.payloads="".concat(e.payloads," ").concat(t.payload),e.fmtp.push({payload:t.payload,config:t.fmtp}),e.rtcpFb=[...e.rtcpFb||[],...(t.rtcpfb||t.rtcpFb).map((e=>({payload:t.payload,type:e.id,subtype:e.params[0]})))],e.rtp.push({payload:t.payload,codec:t.codec.toUpperCase(),rate:t.rate}),t.rtx&&(e.payloads="".concat(e.payloads," ").concat(t.rtx),e.fmtp.push({payload:t.rtx,config:"apt=".concat(t.payload)}),e.rtp.push({payload:t.rtx,codec:"rtx",rate:t.rate}))};var BU,HU=e=>{let t=VU.default.parse(e);return t.media.forEach((e=>{var i;(e.type===HD.AUDIO||e.type===HD.VIDEO)&&(function(e){if(!e.rtcpFb)return;let t=[];e.rtcpFb.forEach(((i,n)=>{var r;t.push(i),e.rtcpFb&&(null==(r=e.rtcpFb[n+1])?void 0:r.payload)!==i.payload&&"rrtr"!==i.type&&t.push({payload:i.payload,type:"rrtr"})})),e.rtcpFb=t}(e),function(e){e.type===HD.VIDEO&&e.fmtp&&e.fmtp.forEach((e=>{e.config.includes("apt")||(e.config+=";sps-pps-idr-in-keyframe=1")}))}(e),function(e){e.type===HD.AUDIO&&e.fmtp&&e.fmtp.forEach((e=>{e.config+=";sprop-stereo=1;stereo=1"}))}(e),function(e){let t=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);e.ext&&(e.ext=e.ext.filter((e=>!t.has(e.uri))))}(e)),(null==(i=e.payloads)?void 0:i.includes("datachannel"))&&t.groups&&e.mid&&(t.groups[0].mids=t.groups[0].mids.replace(e.mid,"dc"),e.mid="dc")})),VU.default.write(t)},jU=((BU=jU||{}).TRACK="track",BU.DATA_CHANNEL_MESSAGE="data_channel_msg",BU[BU.CONNECTION_STATE_CHANGED="connection-state-changed"]="CONNECTION_STATE_CHANGED",BU[BU.FIREWALL_RESTRICTION="firewall-restriction"]="FIREWALL_RESTRICTION",BU.RECONNECTED="spc-reconnected",BU.RECONNECT_FAILED="spc-reconnect-failed",BU.ERROR="error",BU),GU=0,WU=!1,JU=new Set,KU=1,YU=class extends MU.default{constructor(e){let{signalChannel:t,room:i,enableCustomMessage:n}=e;super(),hb(this,"currentState","DISCONNECTED"),hb(this,"_room"),hb(this,"_signalChannel"),hb(this,"_peerConnection",null),hb(this,"_datachannel",null),hb(this,"_enableCustomMessage"),hb(this,"_log"),hb(this,"_downlinkMIDMap",new Map),hb(this,"_reconnectionTimer",-1),hb(this,"reconnectionCount",0),hb(this,"_clientAbility",null),hb(this,"_serverAbility",null),hb(this,"addDownlinkQueue",new Set),hb(this,"removeDownlinkQueue",new Set),hb(this,"_parsedAnswer",null),hb(this,"_updateSDPPromise",null),hb(this,"_waitForPCConnectedPromise"),hb(this,"_waitForPCConnectedPromiseReject",null),hb(this,"_isSDPLogged",!1),this._room=i,this._enableCustomMessage=n,this._signalChannel=t,this._log=YO.createLogger({id:"spc".concat(KU++),userId:this._room.userId,sdkAppId:this._room.sdkAppId})}get isH264EncodeSupported(){let e=this._room.checkSystemResult.detail.isH264EncodeSupported;return this._serverAbility&&(e=e&&!!this._serverAbility.video.codecs.find((e=>"h264"===e.codec.toLowerCase()))),e}get isVP8EncodeSupported(){let e=this._room.checkSystemResult.detail.isVp8EncodeSupported;return this._serverAbility&&(e=e&&this._serverAbility.useVp8),e}get uplinkSSRC(){return this._peerConnection&&this._peerConnection.localDescription?(e=>{let t=JV(e),i={audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0};return t.media.forEach(((e,t)=>{var n;if(e.ssrcs&&!dO(e.ssrcs[0].id)){let r=Number(e.ssrcs[0].id),o=Number(null==(n=e.ssrcs.filter((e=>"cname"===e.attribute))[1])?void 0:n.id);switch(t){case 0:i.audioSsrc=r;break;case 1:i.bigVideoSsrc=r,i.bigVideoRtxSsrc=o;break;case 2:i.smallVideoSsrc=r,i.smallVideoRtxSsrc=o;break;case 3:i.auxVideoSsrc=r,i.auxVideoRtxSsrc=o}}})),i})(this._peerConnection.localDescription.sdp):{audioSsrc:0,audioRtxSsrc:0,bigVideoSsrc:0,bigVideoRtxSsrc:0,smallVideoSsrc:0,smallVideoRtxSsrc:0,auxVideoSsrc:0,auxVideoRtxSsrc:0}}get isReconnecting(){return"RECONNECTING"===this.currentState||this._reconnectionTimer>0||this.reconnectionCount>0}initialize(){return _b(this,null,(function*(){try{this._peerConnection=new RTCPeerConnection({offerExtmapAllowMixed:!0,iceServers:this._room.getIceServers(),iceTransportPolicy:this._room.getIceTransportPolicy(),sdpSemantics:this._room.sdpSemantics,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"}),this._peerConnection.onconnectionstatechange=this.onConnectionStateChange.bind(this),this._peerConnection.ontrack=e=>this.emit("track",e),this._enableCustomMessage&&(this._datachannel=this._peerConnection.createDataChannel("".concat(this._room.userId,"dc")),this._datachannel.binaryType="arraybuffer",this._datachannel.onopen=()=>{this._log.info("datachannel open")},this._datachannel.onclose=()=>{this._log.warn("datachannel close")},this._datachannel.onmessage=e=>{let t=new qU(e.data);this.emit("data_channel_msg",{data:t})},this._datachannel.onerror=e=>{this._log.warn("datachannel error",e)}),this._peerConnection.addTransceiver(HD.AUDIO,{direction:HD.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:HD.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:HD.TRANSCEIVER_DIRECTION_SENDONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:HD.TRANSCEIVER_DIRECTION_SENDONLY});let e=yield this._peerConnection.createOffer();return yield this.setOffer(e),this._clientAbility=((e,t)=>{var i,n;let r=JV(e),o={ice:{ufrag:"",password:""},dtls:{hash:"",fingerprint:"",setup:""},audio:{codecs:[],extensions:[]},video:{codecs:[],extensions:[]},useDataChannel:t};o.ice.ufrag=String(r.media[0].iceUfrag),o.ice.password=r.media[0].icePwd||"",r.fingerprint&&(o.dtls.hash=r.fingerprint.type,o.dtls.fingerprint=r.fingerprint.hash,o.dtls.setup=r.setup||""),r.media[0].fingerprint&&(o.dtls.hash=r.media[0].fingerprint.type,o.dtls.fingerprint=r.media[0].fingerprint.hash),o.dtls.setup=r.media[0].setup||"";let s=r.media[0],a=r.media[1];s.ext&&(o.audio.extensions=s.ext.map((e=>({id:e.value,uri:e.uri})))),a.ext&&(o.video.extensions=a.ext.map((e=>({id:e.value,uri:e.uri}))));let c={codec:s.rtp[0].codec,fmtp:s.fmtp[0].config,payload:s.fmtp[0].payload,rate:s.rtp[0].rate,channel:s.rtp[0].encoding,rtcpFb:[],rtx:0};null==(i=s.rtcpFb)||i.forEach((e=>{let{payload:t,type:i,subtype:n}=e;if(t===c.payload){let e={id:i,params:[]};n&&e.params.push(n),c.rtcpFb.push(e)}})),o.audio.codecs.push(c);for(let l=0;l<a.rtp.length;l++){if(["rtx","red","ulpfec"].includes(a.rtp[l].codec))continue;let e=a.fmtp.filter((e=>e.payload===a.rtp[l].payload))[0];o.video.codecs.push({payload:a.rtp[l].payload,codec:a.rtp[l].codec,fmtp:e?e.config:"",rate:a.rtp[l].rate,rtx:"rtx"===(null==(n=a.rtp[l+1])?void 0:n.codec)?a.rtp[l+1].payload:0,rtcpFb:((null==a?void 0:a.rtcpFb)||[]).filter((e=>e.payload===a.rtp[l].payload)).map((e=>{let{type:t,subtype:i}=e;return{id:t,params:i?[i]:[]}}))})}return o})(e.sdp,this._enableCustomMessage),this._clientAbility}catch(pD){throw this._log.error("initialize failed ".concat(pD)),pD}}))}connect(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return _b(this,null,(function*(){try{if("CONNECTED"===this.currentState)return;let i=yO(),n={type:"answer",sdp:UU({serverAbility:e,clientAbility:this._clientAbility,offerSDP:this._peerConnection.localDescription.sdp,enableCustomMessage:this._enableCustomMessage})};this._serverAbility=e,yield this.setAnswer(n),yield this.waitForPeerConnectionConnected(),t||GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"SPCConnect",cost:Math.min(yO()-i,3e4)})}catch(_D){let i=_D instanceof vb&&_D.code===Ab.API_CALL_ABORTED;throw i||this._log.error("connect failed: ".concat(_D," ").concat(e)),this.reset(),!i&&!this.isReconnecting&&(GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"SPCConnect",error:_D}),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()),_D}}))}reconnect(){return _b(this,null,(function*(){if(-1===this._reconnectionTimer){if(!this._signalChannel.isConnected)return this._log.warn("reconnect() wait signal channel is connected"),void this._signalChannel.once(nV,this.reconnect,this);try{this.reconnectionCount++,this._log.warn("reconnect() trying [".concat(this.reconnectionCount,"]")),this.reset();let e=yield this.initialize(),t=yield this._signalChannel.sendWaitForResponse({command:OV,responseCommand:dV.REBUILD_PEER_CONNECTION_RES,data:{ability:e},enableLog:!1});yield this.connect(t.data.data.ability,!0),this._log.warn("reconnect() successfully"),this.stopReconnection(),this.emit("spc-reconnected")}catch(pD){if(!this.isReconnecting)return;if(null!=pD&&pD.message.includes("timeout")){let e=aO(this.reconnectionCount);this._log.warn("reconnect() timeout, try again after ".concat(e/1e3,"s")),this._reconnectionTimer=window.setTimeout((()=>{this.clearReconnectionTimer(),this.reconnect()}),e)}else this._log.error("reconnect() failed ".concat(pD)),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"SPCReconnect",error:pD}),this.reconnectionCount>=hN()&&this._log.warn("SDK has tried reconnect for ".concat(hN()," times, but all failed, please check your network")),this.stopReconnection(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.emit("error")}}else this._log.warn("reconnect() is reconnecting, ignore current reconnection")}))}getPeerConnection(){return this._peerConnection}startReconnection(){return _b(this,null,(function*(){this._log.warn("start reconnect"),this.emitConnectionStateChangedEvent("RECONNECTING");let e=yO();yield this.reconnect(),GO.emit(JO.API_SUCCESS_RATE,{room:this._room,apiName:"SPCReconnect",cost:Math.min(yO()-e,3e4)})}))}stopReconnection(){this.isReconnecting&&(this._log.info("stop reconnect"),this.reconnectionCount=0,this.clearReconnectionTimer(),this._signalChannel.off(nV,this.reconnect,this))}checkPeerConnectionToReconnect(){var e;!this.isReconnecting&&(null==(e=this._peerConnection)?void 0:e.connectionState)===lN.CLOSED&&this.startReconnection()}clearReconnectionTimer(){-1!==this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=-1)}onConnectionStateChange(e){let t=this._peerConnection.iceConnectionState,i=this.getDTLSTransportState();if(this._log.info("connectionState: ".concat(e.target.connectionState,", ICE: ").concat(t,", DTLS: ").concat(i)),e.target.connectionState===lN.CONNECTING&&this.emitConnectionStateChangedEvent("CONNECTING"),e.target.connectionState===lN.FAILED||e.target.connectionState===lN.CLOSED){let n="ICE/DTLS Transport connection ".concat(e.target.connectionState,". ICE Transport state: ").concat(t,", DTLS Transport state: ").concat(i);new vb({message:n,code:Ab.ICE_TRANSPORT_ERROR}),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.startReconnection()}(e.target.connectionState===lN.CONNECTED||e.target.connectionState===lN.COMPLETED)&&(this.logSelectedCandidate(),this.emitConnectionStateChangedEvent("CONNECTED"))}getDTLSTransportState(){if(!this._peerConnection)return cN;let e=null;return kP()&&0!==this._peerConnection.getSenders().length?(e=this._peerConnection.getSenders()[0].transport,bP()&&0!==this._peerConnection.getReceivers().length&&e?e.state:cN):cN}emitConnectionStateChangedEvent(e){e!==this.currentState&&("RECONNECTING"===this.currentState&&"CONNECTING"===e||(this.emit(jU.CONNECTION_STATE_CHANGED,{prevState:this.currentState,state:e}),this.currentState=e))}logSelectedCandidate(){return _b(this,null,(function*(){if(!this._peerConnection)return;let e=yield this._peerConnection.getStats();for(let[t,i]of e)if(IP(i)){let t=e.get(i.localCandidateId),n=e.get(i.remoteCandidateId);t&&this._log.info("local candidate: ".concat(t.candidateType," ").concat(t.protocol,":").concat(t.ip||t.address,":").concat(t.port," ").concat(t.networkType||""," ").concat("relay"===t.candidateType?"relayProtocol:".concat(t.relayProtocol):"")),n&&this._log.info("remote candidate: ".concat(n.candidateType," ").concat(n.protocol,":").concat(n.ip||n.address,":").concat(n.port));break}}))}waitForPeerConnectionConnected(){return this._waitForPCConnectedPromise||(this._waitForPCConnectedPromise=new Promise(((e,t)=>{if("CONNECTED"===this.currentState)return e();this._waitForPCConnectedPromiseReject=t;let i=t=>{"CONNECTED"===t.state&&(clearTimeout(o),r(),e())},n=e=>{let{room:i}=e;i===this._room&&(clearTimeout(o),r(),t(new vb({code:Ab.API_CALL_ABORTED,message:rP({key:XO.CONNECTION_ABORTED,data:"leave room"})})))},r=()=>{GO.off(JO.LEAVE_SUCCESS,n,this),this.off(jU.CONNECTION_STATE_CHANGED,i,this)},o=setTimeout((()=>{r();let e=new vb({code:Ab.API_CALL_TIMEOUT,message:"connection timeout"});GU+=1,(e=>GU>2&&!WU&&0===JU.size&&e)(this._signalChannel.isConnected)&&(this._log.warn("firewall restrition"),WU=!0,this.emit(jU.FIREWALL_RESTRICTION)),t(e)}),bN);GO.on(JO.LEAVE_SUCCESS,n,this),this.on(jU.CONNECTION_STATE_CHANGED,i,this)})),this._waitForPCConnectedPromise=this._waitForPCConnectedPromise.finally((()=>{this._waitForPCConnectedPromise=null,this._waitForPCConnectedPromiseReject=null}))),this._waitForPCConnectedPromise}waitForReconnected(){return this.isReconnecting?new Promise(((e,t)=>{this.once("spc-reconnected",e),this.once("error",t)})):Promise.resolve()}addDownlink(e){return _b(this,null,(function*(){if(this._log.info("addDownlink(".concat(e.userId,") trying")),this.isReconnecting&&(yield this.waitForReconnected()),this.updateLocalAndRemoteSDPConfig(e),0===this.addDownlinkQueue.size)try{yield this.updateSDP({isNeedToCreateOffer:!0}),this._log.info("addDownlink(".concat(e.userId,") done"))}catch(pN){this._log.info("addDownlink(".concat(e.userId,") failed")),yield this.startReconnection()}}))}updateLocalAndRemoteSDPConfig(e){let{ssrc:t,userId:i,tinyId:n}=e;if(!this._peerConnection)return;this._log.info("updateLocalAndRemoteSDPConfig ".concat(i," ").concat(JSON.stringify(t)));let r,o,s,a=this._peerConnection.getTransceivers().filter((e=>"inactive"===e.direction)).slice(0,3).map((e=>(e.direction=HD.TRANSCEIVER_DIRECTION_RECVONLY,Number(e.mid))));if(0===a.length&&(this._peerConnection.addTransceiver(HD.AUDIO,{direction:HD.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:HD.TRANSCEIVER_DIRECTION_RECVONLY}),this._peerConnection.addTransceiver(HD.VIDEO,{direction:HD.TRANSCEIVER_DIRECTION_RECVONLY})),this._parsedAnswer||(this._parsedAnswer=JV(this._peerConnection.remoteDescription.sdp)),3===a.length)r=this._parsedAnswer.media.find((e=>Number(e.mid)===Number(a[0]))),o=this._parsedAnswer.media.find((e=>Number(e.mid)===Number(a[1]))),s=this._parsedAnswer.media.find((e=>Number(e.mid)===Number(a[2])));else{r=JSON.parse(JSON.stringify(this._parsedAnswer.media[0]));let e=xU({mid:1,serverAbility:this._serverAbility,clientAbility:this._clientAbility,parsedOffer:JV(this._peerConnection.localDescription.sdp),useAllCodec:!0});o=JSON.parse(JSON.stringify(e)),s=JSON.parse(JSON.stringify(e)),r.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(r),o.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(o),s.mid=this._parsedAnswer.media.length,this._parsedAnswer.media.push(s)}r.direction=HD.TRANSCEIVER_DIRECTION_SENDONLY,r.ssrcs=[{id:t.audio,attribute:"cname",value:"".concat(n)},{id:t.audio,attribute:"msid",value:"".concat(n,"-").concat(HD.MAIN," ").concat(n,"-audio")}],o.direction=HD.TRANSCEIVER_DIRECTION_SENDONLY,o.ssrcs=[{id:t.video,attribute:"cname",value:"".concat(n)},{id:t.video,attribute:"msid",value:"".concat(n,"-").concat(HD.MAIN," ").concat(n,"-bigvideo")},{id:t.videoRtx,attribute:"cname",value:"".concat(n)},{id:t.videoRtx,attribute:"msid",value:"".concat(n,"-").concat(HD.MAIN," ").concat(n,"-bigvideo")}],o.ssrcGroups=[{semantics:"FID",ssrcs:"".concat(t.video," ").concat(t.videoRtx)}],s.direction=HD.TRANSCEIVER_DIRECTION_SENDONLY;let c="".concat(n,"-aux");s.ssrcs=[{id:t.auxiliary,attribute:"cname",value:c},{id:t.auxiliary,attribute:"msid",value:"".concat(c," ").concat(n,"-aux").concat(HD.VIDEO)},{id:t.auxiliaryRtx,attribute:"cname",value:"".concat(c," ").concat(n,"-aux").concat(HD.VIDEO)},{id:t.auxiliaryRtx,attribute:"msid",value:"".concat(c," ").concat(n,"-aux").concat(HD.VIDEO)}],s.ssrcGroups=[{semantics:"FID",ssrcs:"".concat(t.auxiliary," ").concat(t.auxiliaryRtx)}],this._parsedAnswer.groups&&(this._parsedAnswer.groups[0].mids=this._parsedAnswer.media.map((e=>e.mid)).join(" ")),this._downlinkMIDMap.set(n,[r.mid,o.mid,s.mid])}removeDownlink(e,t){return _b(this,null,(function*(){if(!this._downlinkMIDMap.has(e)||!this._peerConnection)return;this._log.info("removeDownlink(".concat(t,") trying")),this.isReconnecting&&(yield this.waitForReconnected());let i=this._downlinkMIDMap.get(e),n=!1;this._peerConnection.getTransceivers().forEach((e=>{null!=i&&i.includes(Number(e.mid))&&(n=!0,e.direction="inactive")})),this._parsedAnswer||(this._parsedAnswer=JV(this._peerConnection.remoteDescription.sdp)),this._parsedAnswer.media.forEach((e=>{null!=i&&i.includes(Number(e.mid))&&(n=!0,e.direction="inactive",e.ssrcs=[],e.ssrcGroups=[])})),0===this.removeDownlinkQueue.size&&n&&(yield this.updateSDP({isNeedToCreateOffer:!0,tinyIdRemoving:e})),this._downlinkMIDMap.delete(e),this._log.info("removeDownlink(".concat(t,") done"))}))}getDownlinkMids(e){return this._downlinkMIDMap.get(e)}setBandwidth(e){return _b(this,null,(function*(){if(!this._peerConnection)return;let{audio:t,bigVideo:i,smallVideo:n,auxVideo:r}=e;try{if(wP()){let e=this._peerConnection.getSenders().slice(0,4);for(let o=0;o<e.length;o++){let s,a=e[o];0===o&&t?s=t:1===o&&i?s=i:2===o&&n?s=n:3===o&&r&&(s=r),s&&(yield this.setSenderMaxBitrate(a,s))}}else yield this.setBandwidthBySDP(e);Object.keys(e).forEach((t=>{e[t]&&this._log.info("".concat(t," bandwidth was set to ").concat(e[t]," kbps"))}))}catch(BU){this._log.error("failed to set bandwidth".concat(BU))}}))}setSenderMaxBitrate(e,t){let i=e.getParameters();return(!i.encodings||0===i.encodings.length)&&(i.encodings=[{}]),"unlimited"===t?delete i.encodings[0].maxBitrate:i.encodings[0].maxBitrate=1e3*t,e.setParameters(i)}setBandwidthBySDP(e){let{audio:t,bigVideo:i,smallVideo:n,auxVideo:r}=e;if(!this._peerConnection||!this._peerConnection.localDescription)return;let o=JV(this._peerConnection.localDescription.sdp);this._parsedAnswer||(this._parsedAnswer=JV(this._peerConnection.remoteDescription.sdp));let s=Jb?"TIAS":"AS";t&&(o.media[0].bandwidth=[{type:s,limit:Jb?1e3*t:t}],this._parsedAnswer.media[0].bandwidth=[{type:s,limit:Jb?1e3*t:t}]),i&&(o.media[1].bandwidth=[{type:s,limit:Jb?1e3*i:i}],this._parsedAnswer.media[1].bandwidth=[{type:s,limit:Jb?1e3*i:i}]),n&&(o.media[2].bandwidth=[{type:s,limit:Jb?1e3*n:n}],this._parsedAnswer.media[2].bandwidth=[{type:s,limit:Jb?1e3*n:n}]),r&&(o.media[3].bandwidth=[{type:s,limit:Jb?1e3*r:r}],this._parsedAnswer.media[3].bandwidth=[{type:s,limit:Jb?1e3*r:r}]);let a={type:"offer",sdp:KV(o)};return this.updateSDP({localDescription:a})}updateSDP(e){let{isNeedToCreateOffer:t=!1,localDescription:i,tinyIdRemoving:n}=e;if(!this._parsedAnswer)return;let r=KV(this._parsedAnswer);return this._updateSDPPromise=new Promise(((e,n)=>_b(this,null,(function*(){var o,s;try{t&&this._peerConnection&&(this._log.info("creating offer"),i=yield this._peerConnection.createOffer()),i&&(yield this.setOffer(i)),yield this.setAnswer({type:"answer",sdp:r}),this._updateSDPPromise=null,e()}catch(a){this._log.error(a),!this._isSDPLogged&&this._peerConnection&&(this._log.warn("transceivers: ".concat(JSON.stringify(this._peerConnection.getTransceivers().map((e=>{let{mid:t,currentDirection:i,direction:n,stopped:r}=e;return{mid:t,currentDirection:i,direction:n,stopped:r}}))))),this._log.warn("parsedAnswer: ".concat(JSON.stringify(this._parsedAnswer))),this._log.warn("local sdp: ".concat(null==i?void 0:i.sdp)||(null==(o=this._peerConnection.localDescription)?void 0:o.sdp)),this._log.warn("remote sdp: ".concat(r)||(null==(s=this._peerConnection.remoteDescription)?void 0:s.sdp)),this._isSDPLogged=!0),this._updateSDPPromise=null,n(a)}})))),this._updateSDPPromise}setOffer(e){return this._log.info("setting offer"),this._peerConnection.setLocalDescription({type:"offer",sdp:HU(e.sdp)})}setAnswer(e){return this._log.info("setting answer"),this._room.enableHWEncoder&&e.sdp&&(e.sdp=e.sdp.replaceAll("42e01f","42001f")),this._peerConnection.setRemoteDescription(e)}sendDataChannelMessage(e){var t;null==(t=this._datachannel)||t.send(e)}reset(){var e;null==(e=this._peerConnection)||e.close(),this._waitForPCConnectedPromise=null,this._parsedAnswer=null}close(){this._log.info("close pc"),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._downlinkMIDMap.clear(),this.stopReconnection(),this.removeAllListeners()}};ub([LU()],YU.prototype,"updateSDP",1);var zU=class{constructor(e){hb(this,"tag"),hb(this,"len"),hb(this,"data");let t=new DataView(e);this.tag=t.getUint16(),this.len=t.getUint16(2),this.data=new Uint8Array(e).slice(4,4+this.len).buffer}},qU=class{constructor(e){hb(this,"tinyId"),hb(this,"data");let t=new DataView(e),i=0,n=[];for(;i<t.byteLength;){let r=t.getUint16(i+2),o=new zU(new Uint8Array(e).slice(i,i+2+2+r).buffer);n.push(o),i+=4+r}n.forEach((e=>{1===e.tag?this.tinyId=(new TextDecoder).decode(e.data):2===e.tag&&(this.data=e.data)}))}},QU=new Set;function XU(){let e=Math.floor(4294967296*Math.random());return QU.has(e)?XU():(QU.add(e),e)}var ZU=db(mb()),$U=class extends ZU.default{constructor(e){super(),hb(this,"userId"),hb(this,"tinyId"),hb(this,"_sdpSemantics"),hb(this,"_isUplink"),hb(this,"_room"),hb(this,"_log"),hb(this,"_signalChannel"),hb(this,"_currentState","DISCONNECTED"),hb(this,"_prevTime",-1),hb(this,"_enableSEI"),hb(this,"_sei"),this.userId=e.userId,this.tinyId=e.tinyId,this._room=e.room,this._sdpSemantics=e.room.sdpSemantics,this._isUplink=e.isUplink,this._log=YO.createLogger({id:"n",userId:this._room.userId,remoteUserId:this._isUplink?void 0:this.userId,sdkAppId:this._room.sdkAppId,isLocal:this._isUplink}),this._signalChannel=e.signalChannel,this._enableSEI=e.enableSEI,this._enableSEI&&UP&&(this._sei=new xV(this,this._log,this._isUplink))}get _peerConnection(){var e;return(null==(e=this.singlePC)?void 0:e.getPeerConnection())||null}get singlePC(){return this._room.singlePC}close(e){this._log.info("close connection"),this.emit("closed",e),this._sei&&(this._sei.destroy(),this._sei=null)}emitConnectionStateChangedEvent(e){return e!==this._currentState&&(GO.emit(JO.PEER_CONNECTION_STATE_CHANGED,{room:this._room,prevState:this._currentState,state:e,remoteUserId:this._isUplink?void 0:this.userId}),this.emit("connection-state-changed",{prevState:this._currentState,state:e}),this._currentState=e,!0)}getPeerConnection(){return this._peerConnection}getRoom(){return this._room}getUserId(){return this.userId}getTinyId(){return this.tinyId}getCurrentState(){return this._currentState}get isH264(){var e,t;return!(null==(t=null==(e=this._peerConnection)?void 0:e.remoteDescription)||!t.sdp.includes("H264"))}},ex=class extends $U{constructor(e){super(ab(sb({},e),{isUplink:!0})),hb(this,"localMainAudioTrack",null),hb(this,"localMainVideoTrack",null),hb(this,"localAuxAudioTrack",null),hb(this,"localAuxVideoTrack",null),hb(this,"_isPublishingAux",!1),hb(this,"_publishingLocalAudioTrack"),hb(this,"_publishingLocalVideoTrack"),hb(this,"_mediaSettings",{videoCodec:"",videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioCodec:"opus",audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0,auxVideoWidth:0,auxVideoHeight:0,auxVideoFps:0,auxVideoBps:0}),hb(this,"_smallGenerator"),hb(this,"_audioManager"),this._audioManager=e.audioManager,this._smallGenerator=null,this.initialize()}get ssrc(){if(!this.singlePC)return{audio:0,video:0,videoRtx:0,small:0,smallRtx:0,auxiliary:0,auxiliaryRtx:0};let{audioSsrc:e,bigVideoSsrc:t,bigVideoRtxSsrc:i,smallVideoSsrc:n,smallVideoRtxSsrc:r,auxVideoSsrc:o,auxVideoRtxSsrc:s}=this.singlePC.uplinkSSRC;return{audio:e||0,video:t||0,videoRtx:i||0,small:n||0,smallRtx:r||0,auxiliary:o||0,auxiliaryRtx:s||0}}get isMainStreamPublished(){return!(!this.localMainAudioTrack&&!this.localMainVideoTrack)}get isAuxStreamPublished(){return!(!this.localAuxVideoTrack&&!this.localAuxAudioTrack)}get publishState(){var e,t,i,n;let r={audio:!1,bigVideo:!1,smallVideo:!1,auxVideo:!1};if(this._peerConnection){let o=this._peerConnection.getSenders();o&&(DP()?(r.audio=!(null==(e=o[0])||!e.track),r.bigVideo=!(null==(t=o[1])||!t.track),r.smallVideo=!(null==(i=o[2])||!i.track),r.auxVideo=!(null==(n=o[3])||!n.track)):o.forEach((e=>{e.track&&(e.track.kind===HD.AUDIO?r.audio=!0:(r.bigVideo=!0,this._smallGenerator&&(r.smallVideo=!0)))})))}return r}initialize(){this.installEvents()}reset(){this.uninstallEvents(),this.localMainVideoTrack&&this.localMainVideoTrack.canvasTrack&&this.localMainVideoTrack.destoryCanvasTrack()}close(e){super.close(e),this.reset(),this.emitConnectionStateChangedEvent("DISCONNECTED"),this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null)}installEvents(){var e;this.listeners("connection-state-changed").includes(this.handleConnectionStateChange)||this.on("connection-state-changed",this.handleConnectionStateChange,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||null==(e=this.singlePC)||e.on("spc-reconnected",this.onSinglePCReconnected,this)}uninstallEvents(){var e;this.off("connection-state-changed",this.handleConnectionStateChange,this),null==(e=this.singlePC)||e.off("spc-reconnected",this.onSinglePCReconnected,this)}emitConnectionStateChangedEvent(e,t){var i,n,r;let o=this._currentState,s=super.emitConnectionStateChangedEvent(e);return s&&o!==e&&(t?t.emit("connection-state-changed",{prevState:o,state:e}):(null==(i=this.localMainVideoTrack)||i.emit("connection-state-changed",{prevState:o,state:e}),null==(n=this.localAuxVideoTrack)||n.emit("connection-state-changed",{prevState:o,state:e}),null==(r=this._publishingLocalVideoTrack)||r.emit("connection-state-changed",{prevState:o,state:e}))),s}publish(e){return _b(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:n,isAuxiliary:r}=e;return function*(){var e,o,s,a,c,l;if(!t.singlePC)return;if(yield t.singlePC.waitForPeerConnectionConnected(),i&&(t._publishingLocalAudioTrack=i),n){if(!t.singlePC.isH264EncodeSupported&&!t.singlePC.isVP8EncodeSupported)throw new vb({code:Ab.NOT_SUPPORTED_H264,message:rP({key:XO.NOT_SUPPORTED_H264ENCODE})});Hb&&115===Fk()&&n.profile.width*n.profile.height<=230400&&(t._log.warn("fallback video to 480p"),yield n.setProfile(FD["480p_2"])),t._publishingLocalVideoTrack=n}let d;t._isPublishingAux=r,n&&!r&&n.small&&(t._smallGenerator=new eU(n),yield t._smallGenerator.initialize(),d=t._smallGenerator.generateSmallVideoTrack(n.small)),NP()&&(yield t.publishByTransceiver({localAudioTrack:i,localVideoTrack:n,smallTrack:d,isAuxiliary:r})),t._publishingLocalAudioTrack=null,t._publishingLocalVideoTrack=null,t._isPublishingAux=!1,r?(n&&(t.localAuxVideoTrack=n),i&&(t.localAuxAudioTrack=i)):(n&&(t.localMainVideoTrack=n),i&&(t.localMainAudioTrack=i)),yield t.singlePC.setBandwidth({audio:(null==(e=t.localMainAudioTrack)?void 0:e.profile.bitrate)||(null==(o=t.localAuxAudioTrack)?void 0:o.profile.bitrate),bigVideo:null==(s=t.localMainVideoTrack)?void 0:s.profile.bitrate,smallVideo:null==(c=null==(a=t.localMainVideoTrack)?void 0:a.small)?void 0:c.bitrate,auxVideo:null==(l=t.localAuxVideoTrack)?void 0:l.profile.bitrate}),yield t._signalChannel.sendWaitForResponse({command:LV,responseCommand:dV.SPC_PUBLISH_RESULT,data:ab(sb({},t.singlePC.uplinkSSRC),{state:t.publishState})}),t.sendMediaSettings(),t.installTrackMuteEvents(i,n),t.sendMutedFlag()}()}))}publishByTransceiver(e){let{localAudioTrack:t,localVideoTrack:i,smallTrack:n,isAuxiliary:r}=e;this._log.info("publish by transceiver"),i&&Zk&&Xk&&i.genCanvasTrack();let o=(null==i?void 0:i.canvasTrack)||(null==i?void 0:i.mediaTrack),s=this._audioManager.mediaStreamTrack,a=this._peerConnection.getTransceivers(),c=[],l=[];if(s){let e=a[0].sender.replaceTrack(s);l.push(0),c.push(e)}if(o)if(r){let e=a[3].sender.replaceTrack(o);l.push(3),c.push(e)}else{let e=a[1].sender.replaceTrack(o);l.push(1),c.push(e)}if(n){let e=a[2].sender.replaceTrack(n);l.push(2),c.push(e)}let d=this.setTransceiverDirection(jD.SENDONLY,l);return c.push(d),Promise.all(c)}installTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.on("mute",this.sendMutedFlag,this),null==e||e.on("unmute",this.sendMutedFlag,this))}))}uninstallTrackMuteEvents(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>{e&&(null==e||e.off("mute",this.sendMutedFlag,this),null==e||e.off("unmute",this.sendMutedFlag,this))}))}unpublish(e){return _b(this,arguments,(function(e){var t=this;let{localAudioTrack:i,localVideoTrack:n}=e;return function*(){let e=n&&n===t.localAuxVideoTrack,r=null==i?void 0:i.mediaTrack,o=null==n?void 0:n.mediaTrack,s=t._peerConnection.getSenders(),a=[];r&&(t._audioManager.removeAudioTrack(i),t._audioManager.isMixed||(yield s[0].replaceTrack(null),a.push(0)),e?t.localAuxAudioTrack=null:t.localMainAudioTrack=null),o&&(e?(yield s[3].replaceTrack(null),t.localAuxVideoTrack=null,t._mediaSettings=ab(sb({},t._mediaSettings),{auxVideoBps:0,auxVideoFps:0,auxVideoWidth:0,auxVideoHeight:0}),a.push(3)):(yield s[1].replaceTrack(null),yield s[2].replaceTrack(null),t.localMainVideoTrack=null,t._mediaSettings=ab(sb({},t._mediaSettings),{videoWidth:0,videoHeight:0,videoBps:0,videoFps:0,audioFs:0,audioChannel:0,audioBps:0,smallVideoWidth:0,smallVideoHeight:0,smallVideoFps:0,smallVideoBps:0}),a.push(1,2))),t.isMainStreamPublished||t.isAuxStreamPublished?(yield t.setTransceiverDirection(jD.INACTIVE,a),yield t.doPublishChange(!1)):yield t.doUnpublish(),t.uninstallTrackMuteEvents(i,n),null==n||n.emit("connection-state-changed",{prevState:t._currentState,state:"DISCONNECTED"})}()}))}doPublishChange(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return _b(this,null,(function*(){let t={state:this.publishState,constraintConfig:this._mediaSettings},i=yield this._signalChannel.sendWaitForResponse({command:gV,data:t,responseCommand:dV.PUBLISH_STATE_CHANGE_RESULT,enableLog:e});this.checkPublishResultCode(i.data.code,i.data.message)}))}doUnpublish(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._signalChannel.sendWaitForResponse({command:TV,commandDesc:"unpublish",responseCommand:dV.UNPUBLISH_RESULT,enableLog:e}).catch((e=>{if(e.getCode()===Ab.API_CALL_TIMEOUT)return Promise.resolve();throw e}))}updateMediaSettings(){let{detail:{isH264EncodeSupported:e,isVp8EncodeSupported:t}}=this._room.checkSystemResult;e?this._mediaSettings.videoCodec="H264":t&&(this._mediaSettings.videoCodec="VP8");let i=this._publishingLocalAudioTrack||this.localMainAudioTrack||this.localAuxAudioTrack,{localMainVideoTrack:n,localAuxVideoTrack:r}=this;if(this._publishingLocalVideoTrack&&(this._isPublishingAux?r=this._publishingLocalVideoTrack:n=this._publishingLocalVideoTrack),MP){if(i&&i.mediaTrack){let e=i.mediaTrack.getSettings();this._mediaSettings.audioChannel=e.channelCount||1,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=e.sampleRate||0}if(n&&n.mediaTrack){let e=n.mediaTrack.getSettings();this._mediaSettings.videoWidth=e.width||0,this._mediaSettings.videoHeight=e.height||0,this._mediaSettings.videoFps=e.frameRate||0,this._mediaSettings.videoBps=1e3*n.profile.bitrate,n.small&&(this._mediaSettings.smallVideoWidth=n.small.width,this._mediaSettings.smallVideoHeight=n.small.height,this._mediaSettings.smallVideoFps=n.small.frameRate,this._mediaSettings.smallVideoBps=1e3*n.small.bitrate)}if(r&&r.mediaTrack){let e=r.mediaTrack.getSettings();this._mediaSettings.auxVideoWidth=e.width||0,this._mediaSettings.auxVideoHeight=e.height||0,this._mediaSettings.auxVideoFps=e.frameRate||0,this._mediaSettings.auxVideoBps=1e3*r.profile.bitrate}}else i&&i.mediaTrack&&(this._mediaSettings.audioChannel=i.profile.channelCount,this._mediaSettings.audioBps=1e3*i.profile.bitrate,this._mediaSettings.audioFs=i.profile.sampleRate),n&&n.mediaTrack&&(this._mediaSettings.videoWidth=n.profile.width,this._mediaSettings.videoHeight=n.profile.height,this._mediaSettings.videoFps=n.profile.frameRate,this._mediaSettings.videoBps=1e3*n.profile.bitrate);this._log.info("updateMediaSettings: ".concat(JSON.stringify(this._mediaSettings)))}sendMediaSettings(){this.updateMediaSettings(),this._signalChannel.sendWaitForResponse({command:NV,data:this._mediaSettings,responseCommand:dV.UPDATE_CONSTRAINT_CONFIG_RES}).then((e=>{0!==e.data.code&&this._log.warn(e.data.message)})).catch((()=>{}))}addTrack(e){return _b(this,null,(function*(){var t;if(!this._peerConnection)return;let i=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is adding ".concat(e.kind," track to current published local ").concat(i?HD.AUXILIARY:HD.MAIN," stream")),null==(t=this._sei)||t.handleEncodedStreams(),DP()&&(yield this.addTrackByTransceiver(e,i))}))}addTrackByTransceiver(e,t){return _b(this,null,(function*(){var i;if(!e.mediaTrack)return;let n=this._peerConnection.getTransceivers(),r=e.mediaTrack;if(e.kind===HD.AUDIO)this._audioManager.addAudioTrack(e),r=this._audioManager.mediaStreamTrack,yield n[0].sender.replaceTrack(r);else{let o=t?3:1;if(yield n[o].sender.replaceTrack(e.canvasTrack||r),1===o&&(null==(i=this.localMainVideoTrack)?void 0:i.small)){this._smallGenerator=new eU(this.localMainVideoTrack),yield this._smallGenerator.initialize();let e=this._smallGenerator.generateSmallVideoTrack(this.localMainVideoTrack.small);yield n[2].sender.replaceTrack(e)}n[o].direction===jD.INACTIVE&&(yield this.setTransceiverDirection(jD.SENDONLY,[o]))}this.updateMediaSettings(),yield this.doPublishChange()}))}removeTrack(e){return _b(this,null,(function*(){if(!this._peerConnection)return;let t=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;this._log.info("is removing ".concat(e.kind," track from current published local ").concat(t?HD.AUXILIARY:HD.MAIN," stream")),DP()&&(yield this.removeTrackByTransceiver(e,t))}))}removeTrackByTransceiver(e,t){return _b(this,null,(function*(){if(!e.mediaTrack)return;let i=this._peerConnection.getTransceivers();if(e.kind===HD.AUDIO)this._audioManager.removeAudioTrack(e),this._audioManager.isMixed||(yield i[0].sender.replaceTrack(null));else{let e=t?3:1;yield i[e].sender.replaceTrack(null),1===e&&this._smallGenerator&&(this._smallGenerator.destroy(),this._smallGenerator=null,yield i[2].sender.replaceTrack(null)),yield this.setTransceiverDirection(jD.INACTIVE,[e])}this.updateMediaSettings(),yield this.doPublishChange()}))}setTransceiverDirection(e,t){return _b(this,null,(function*(){if(!Jb)return;let i=!1,n=!1;this._log.info("setting transceiver ".concat(t.join(",")," direction to ").concat(e));let r=this._peerConnection.getTransceivers();if(t.forEach((t=>{r[t].direction!==e&&(r[t].direction=e,i=!0)})),i){this._log.info("updating offer");let e=yield this._peerConnection.createOffer();yield this._peerConnection.setLocalDescription(e)}let o=-1,s=this._peerConnection.remoteDescription.sdp.split("\r\n").map((i=>{if(i.match(new RegExp("a=(".concat(jD.INACTIVE,"|").concat(jD.RECVONLY,"|").concat(jD.SENDONLY,")")))&&o++,t.includes(o)){if(e===jD.INACTIVE&&i.includes("a=".concat(jD.RECVONLY)))return n=!0,"a=".concat(e);if(e===jD.SENDONLY&&i.includes("a=".concat(jD.INACTIVE)))return n=!0,"a=".concat(jD.RECVONLY)}return i})).join("\r\n");n&&(this._log.info("updating answer"),yield this._peerConnection.setRemoteDescription({type:"answer",sdp:s}))}))}replaceTrack(e){return _b(this,null,(function*(){var t;let i=null==(t=this._peerConnection)?void 0:t.getSenders();if(!i||0===i.length||!e.mediaTrack)return;let n=e.mediaTrack,r=e===this.localAuxAudioTrack||e===this.localAuxVideoTrack;if(this._log.info("is replacing ".concat(n.kind," track on ").concat(r?HD.AUXILIARY:HD.MAIN," stream")),n.kind===HD.AUDIO&&i[0]&&(this._audioManager.addAudioTrack(e),this._audioManager.isMixed&&(n=this._audioManager.mediaStreamTrack),yield i[0].replaceTrack(n)),n.kind===HD.VIDEO){if(!r&&i[1]&&(yield i[1].replaceTrack(e.canvasTrack||n),this._smallGenerator&&i[2])){this._log.info("replacing smallVideo"),this._smallGenerator.destroy(),this._smallGenerator=new eU(this.localMainVideoTrack),yield this._smallGenerator.initialize();let e=this._smallGenerator.generateSmallVideoTrack(this._room.smallStreamConfig);yield i[2].replaceTrack(e)}r&&i[3]&&(yield i[3].replaceTrack(n))}}))}setBandwidth(e){return _b(this,arguments,(function(e){var t=this;let{bandwidth:i,type:n,videoType:r}=e;return function*(){if(t.singlePC){let e={};n===HD.AUDIO?e.audio=i:"big"===r?e.bigVideo=i:"small"===r?e.smallVideo=i:e.auxVideo=i,yield t.singlePC.setBandwidth(e)}}()}))}sendMutedFlag(e){var t,i,n;if(e===this.localAuxAudioTrack||e===this.localAuxVideoTrack)return;let r={audio:!(null==(t=this.localMainAudioTrack)||!t.muted),bigVideo:!(null==(i=this.localMainVideoTrack)||!i.muted),auxVideo:!(null==(n=this.localAuxVideoTrack)||!n.muted)};this._log.info("send muted state: ".concat(JSON.stringify(r))),this._signalChannel.send(mV,r)}handleConnectionStateChange(e){"CONNECTED"===e.state&&(this.localMainVideoTrack||this._publishingLocalVideoTrack&&!this._isPublishingAux)&&GO.emit(JO.SEND_FIRST_VIDEO_FRAME,{room:this._room})}getVideoTrackId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:HD.VIDEO;if(this._peerConnection){let t=this._peerConnection.getSenders();if(e===HD.AUXILIARY&&t[3]&&t[3].track)return t[3].track.id;if(e===HD.VIDEO&&t[1]&&t[1].track)return t[1].track.id}if(this.localMainVideoTrack&&e===HD.VIDEO){let e=this.localMainVideoTrack.mediaTrack;if(e)return e.id}if(this.localAuxVideoTrack&&e===HD.AUXILIARY){let e=this.localAuxVideoTrack.mediaTrack;if(e)return e.id}return""}getSSRC(){return this.ssrc}checkPublishResultCode(e,t){if(0!==e)throw e===SN?(this._log.error(ZO.NOT_SUPPORTED_H264ENCODE),new vb({code:Ab.NOT_SUPPORTED_H264,message:rP({key:XO.NOT_SUPPORTED_H264ENCODE})})):new vb({code:Ab.UNKNOWN,message:rP({key:XO.SIGNAL_RESPONSE_FAILED,data:{signalResponse:dV.PUBLISH_RESULT,code:e,message:t}})})}sendSEI(e,t){var i;null==(i=this._sei)||i.push(e,t)}onSinglePCReconnected(){return _b(this,null,(function*(){this.isMainStreamPublished&&(yield this.publish({localAudioTrack:this.localMainAudioTrack,localVideoTrack:this.localMainVideoTrack,isAuxiliary:!1})),this.isAuxStreamPublished&&(yield this.publish({localAudioTrack:this.localAuxAudioTrack,localVideoTrack:this.localAuxVideoTrack,isAuxiliary:!0}))}))}};function tx(e){return Object.keys(e).filter((t=>e[t]))}var ix=class extends $U{constructor(e){super(ab(sb({},e),{isUplink:!1})),hb(this,"_flag",0),hb(this,"role","anchor"),hb(this,"remoteAudioTrack"),hb(this,"remoteVideoTrack"),hb(this,"remoteAuxiliaryTrack"),hb(this,"ssrc",{audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0}),this.flag=e.flag,this.remoteAudioTrack=new Mw(this._room,this),this.remoteVideoTrack=new Vw(this._room,this),this.remoteAuxiliaryTrack=new Uw(this._room,this),this.initialize()}get subscribeState(){let e={audio:!1,video:!1,auxiliary:!1,smallVideo:!1};return this.remoteVideoTrack.isSubscribed&&(8&this.remoteVideoTrack.mediaType?e.smallVideo=!0:e.video=!0),this.remoteAudioTrack.isSubscribed&&(e.audio=!0),this.remoteAuxiliaryTrack.isSubscribed&&(e.auxiliary=!0),e}get muteState(){return kO(this.flag,this.userId)}get flag(){return this._flag}set flag(e){var t,i,n;e!==this._flag&&(this._flag=e,null==(t=this.remoteAudioTrack)||t.onFlagChanged(),null==(i=this.remoteVideoTrack)||i.onFlagChanged(),null==(n=this.remoteAuxiliaryTrack)||n.onFlagChanged())}get hasMainStream(){return this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall}get hasAuxStream(){return this.muteState.hasAuxiliary}get isMainStreamSubscribed(){return(this.subscribeState.audio||this.subscribeState.video||this.subscribeState.smallVideo)&&(this.muteState.hasAudio||this.muteState.hasVideo||this.muteState.hasSmall)}get isAuxStreamSubscribed(){return this.subscribeState.auxiliary&&this.muteState.hasAuxiliary}get isSmallStreamSubscribed(){return this.subscribeState.smallVideo&&this.muteState.hasSmall}get isBigStreamSubscribed(){return this.subscribeState.video&&this.muteState.hasVideo}isStreamUnpublished(e){return e===HD.MAIN?!this.muteState.hasAudio&&!this.muteState.hasVideo:!this.muteState.hasAuxiliary}initialize(){this.installEvents()}close(e){super.close(e),this.emitConnectionStateChangedEvent("DISCONNECTED"),this.remoteAudioTrack.close(),this.remoteVideoTrack.close(),this.remoteAuxiliaryTrack.close(),this.uninstallEvents(),this.removeDownlink()}installEvents(){!this.singlePC||(this.listeners("track").includes(this.onTrack)||this.singlePC.on("track",this.onTrack,this),this.listeners("spc-reconnected").includes(this.onSinglePCReconnected)||this.singlePC.on("spc-reconnected",this.onSinglePCReconnected,this))}uninstallEvents(){!this.singlePC||(this.singlePC.off("track",this.onTrack,this),this.singlePC.off("spc-reconnected",this.onSinglePCReconnected,this))}emitConnectionStateChangedEvent(e){var t,i;let n=this._currentState,r=super.emitConnectionStateChangedEvent(e);return r&&n!==e&&(null==(t=this.remoteVideoTrack)||t.emit("connection-state-changed",{prevState:n,state:e}),null==(i=this.remoteAuxiliaryTrack)||i.emit("connection-state-changed",{prevState:n,state:e})),r}onTrack(e){let t=e.streams[0],{track:i}=e;if(t.id.split("-")[0]!==this.tinyId)return;let n=t.id.includes("aux")?"auxiliary":"main";this._log.debug("ontrack ".concat(n," ").concat(i.kind));let r=HD.AUDIO;i.kind===HD.VIDEO&&(r=n===HD.MAIN?HD.VIDEO:HD.AUXILIARY);let o=this.remoteAudioTrack;r===HD.VIDEO?o=this.remoteVideoTrack:r===HD.AUXILIARY&&(o=this.remoteAuxiliaryTrack),o.setMediaStream(t),o.setMediaStreamTrack(i)}isSubscriptionStateNotChanged(e){return JSON.stringify(e)===JSON.stringify(this.subscribeState)}subscribe(e,t){return _b(this,null,(function*(){try{if(this.isSubscriptionStateNotChanged(e))return;if(this._log.info("subscribe ".concat(t," ").concat(tx(e))),this.hasSSRC){let t="subscribe_change";Object.values(e).find((e=>!0===e))||(t="unsubscribe"),yield this.sendSubscription(t,e)}else yield this.doSubscribe(e)}catch(_D){throw this._room.isJoined&&this.isStreamUnpublished(t)?(this._log.warn("".concat(_D.message," ").concat(JSON.stringify(this.muteState))),new vb({code:Ab.REMOTE_STREAM_NOT_EXIST,message:"remote user ".concat(this.userId," unpublished stream")})):_D}}))}unsubscribe(e){return _b(this,arguments,(function(e){var t=this;let{remoteTracks:i,streamType:n}=e;return function*(){var e;if("main"===n&&!t.isMainStreamSubscribed||"auxiliary"===n&&!t.isAuxStreamSubscribed)return void t._log.info("".concat(n," stream already unsubscribed"));let r=sb({},t.subscribeState);i.forEach((e=>{switch(e.mediaType){case 1:r.audio=!1;break;case 4:r.video=!1;break;case 8:r.smallVideo=!1;break;case 2:r.auxiliary=!1}}));let o="subscribe_change";Object.values(r).find((e=>!0===e))||(o="unsubscribe"),t._log.info("".concat("unsubscribe"===o?o:"subscribe"," ").concat(n," [").concat(tx(r),"]")),"unsubscribe"===o&&(null==(e=t.singlePC)||e.removeDownlinkQueue.add(t.tinyId)),yield t.sendSubscription(o,r),"unsubscribe"===o&&(yield t.removeDownlink())}()}))}sendSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscribeState,i={srcTinyId:this.tinyId,srcUserId:this.userId},n=IV,r=dV.UNSUBSCRIBE_RESULT;return"subscribe_change"===e&&(i={audio:t.audio,bigVideo:t.video,auxVideo:t.auxiliary,smallVideo:t.smallVideo,srcTinyId:this.tinyId},n=SV,r=dV.SUBSCRIBE_CHANGE_RESULT),this._signalChannel.sendWaitForResponse({command:n,data:i,responseCommand:r,timeout:1e4}).then((t=>{let{data:i}=t;if(0!==i.code){let t=new vb({code:i.code,message:rP({key:XO.ERROR_MESSAGE,data:{type:e,message:i.message}})});throw this._log.error(t),t}}))}getMainStreamVideoTrackId(){return this.remoteVideoTrack&&this.remoteVideoTrack.mediaTrack?this.remoteVideoTrack.mediaTrack.id:""}getAuxStreamVideoTrackId(){return this.remoteAuxiliaryTrack&&this.remoteAuxiliaryTrack.mediaTrack?this.remoteAuxiliaryTrack.mediaTrack.id:""}setDelay(e){let{audioDelay:t,videoDelay:i}=e;this.remoteAudioTrack.stat.end2EndDelay=t,this.remoteVideoTrack.stat.end2EndDelay=i}onSinglePCReconnected(){(this.ssrc.audio||this.ssrc.video||this.ssrc.auxiliary)&&this.doSubscribe(this.subscribeState,!1)}get hasSSRC(){return this.ssrc.audio&&this.ssrc.video&&this.ssrc.auxiliary}doSubscribe(){return _b(this,arguments,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.subscribeState,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){if(e.singlePC){if(e.singlePC.addDownlinkQueue.add(e.tinyId),yield e.singlePC.waitForPeerConnectionConnected(),i||!e.hasSSRC){let i={audioSsrc:XU(),bigVideoSsrc:XU(),bigVideoRtxSsrc:XU(),auxVideoSsrc:XU(),auxVideoRtxSsrc:XU()},{audioSsrc:n,bigVideoSsrc:r,bigVideoRtxSsrc:o,auxVideoSsrc:s,auxVideoRtxSsrc:a}=i;e.ssrc={audio:n,video:r,videoRtx:o,auxiliary:s,auxiliaryRtx:a},e.singlePC.addDownlinkQueue.delete(e.tinyId),yield e.singlePC.addDownlink({userId:e.userId,tinyId:e.tinyId,ssrc:e.ssrc});let c=yield e._signalChannel.sendWaitForResponse({command:wV,responseCommand:dV.SPC_SUBSCRIBE_RESULT,data:{srcUserId:e.userId,srcTinyId:e.tinyId,audio:t.audio,bigVideo:t.video,auxVideo:t.auxiliary,smallVideo:t.smallVideo,customData:!0,ssrc:i}});if(0!==c.data.code)throw yield e.removeDownlink(),new vb({code:c.data.code,message:c.data.message});return}e.singlePC.addDownlinkQueue.delete(e.tinyId),yield e.singlePC.addDownlink({userId:e.userId,tinyId:e.tinyId,ssrc:e.ssrc})}}()}))}removeDownlink(){return _b(this,null,(function*(){!this.singlePC||(this.ssrc={audio:0,video:0,videoRtx:0,auxiliary:0,auxiliaryRtx:0},this.singlePC.removeDownlinkQueue.delete(this.tinyId),yield this.singlePC.removeDownlink(this.tinyId,this.userId))}))}};ub([hw((e=>function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return new Promise(((t,n)=>{let r=e=>{this.off("closed",r),n(new vb({code:Ab.API_CALL_ABORTED,message:rP({key:XO.CONNECTION_ABORTED,data:e})}))};this.on("closed",r),e.apply(this,i).then(t,n).finally((()=>{this.off("closed",r)}))}))}))],ix.prototype,"subscribe",1);var nx=ix,{isString:rx,isPlainObject:ox,isUndefined:sx,getNetworkType:ax,getTerminalType:cx,isEmpty:lx}=kb,dx=class extends NU{constructor(e){super(e),this.privateMapKey="",this._heartbeat=-1,this._lastHeartBeatTime=-1,this._joinTimeout=-1,this._firstPublishedList=null,this._joinReject=null,this._isPublishing=!1,this._isRelayChanged=!1,this.uplinkConnection=null,this.singlePC=null,this._enableSPC=OP,this._changeBigSmallRecords=new Map,this._networkQuality=null,this._networkType=ax(),this._turnServers=[],this._syncUserListInterval=-1,this._smallStreamConfig={bitrate:100,frameRate:15,height:120,width:160},this.enableSEI=!1,this._enableAudioVolumeEvaluation=!1,this._audioVolumeIntervalId=null,this._enableMultiAuxStream=!1,this._pureAudioPushMode=!1,this.enableHWEncoder=!1,this._stats=new oU(this,this._log),this.userManager=new iM(this.userId,this._log),this._version=uD,this.sdpSemantics=IN,sx(e.sdpSemantics)?QO.isUnifiedPlanDefault()&&(this.sdpSemantics=EN):this.sdpSemantics=e.sdpSemantics,this._log.info("sdpSemantics: ".concat(this.sdpSemantics,", netType: ").concat(this._networkType)),e.iceTransportPolicy&&(this._iceTransportPolicy=e.iceTransportPolicy),this._enableMultiAuxStream=!sx(e.enableMultiAuxStream)&&e.enableMultiAuxStream,this.enableSEI=e.enableSEI,!sx(e.enableSPC)&&OP&&(this._enableSPC=e.enableSPC),this.enableHWEncoder=e.enableHWEncoder||!1,this._initBusinessInfo(e)}get isMainStreamPublished(){var e;return!(null==(e=this.uplinkConnection)||!e.isMainStreamPublished)}get isMainAudioPublished(){var e;return!(null==(e=this.uplinkConnection)||!e.localMainAudioTrack)}get isAuxStreamPublished(){var e;return!(null==(e=this.uplinkConnection)||!e.isAuxStreamPublished)}get hasAuxStream(){return[...this.remotePublishedUserMap.values()].findIndex((e=>e.muteState.hasAuxiliary))>=0}get userMap(){return this.userManager.userMap}get remotePublishedUserMap(){return this.userManager.remotePublishedUserMap}get tinyIdToUserIdMap(){return new Map([...this.remotePublishedUserMap.values()].map((e=>[e.tinyId,e.userId])))}join(e,t,i){return _b(this,null,(function*(){return this.userManager.mySelfId=this.userId,this.userManager.on("1",(e=>{this.emit("peer-join",e)})),this.userManager.on("2",(e=>{this.closeDownLinkConnection(e,"remote user exitRoom"),this.emit("peer-leave",e)})),this.userManager.on("3",this.createDownlinkConnection,this),this.userManager.on("5",this.closeDownLinkConnection,this),this.userManager.on("6",(e=>{var t=((e,t)=>{var i={};for(var n in e)tb.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&$C)for(var n of $C(e))t.indexOf(n)<0&&ib.call(e,n)&&(i[n]=e[n]);return i})(e,[]);GO.emit(JO.REMOTE_PUBLISH_STATE_CHANGED,sb({room:this},t)),this.emit("remote-publish-state-changed",sb({},t))})),this._joinOptions=e,new Promise(((t,i)=>_b(this,null,(function*(){this._joinReject=i;try{this.checkDestroy(),yield this.initialize(),yield this.doJoin(e),t(),this._firstPublishedList&&this.onPublishedUserList({data:{userList:this._firstPublishedList}})}catch(BU){i(BU)}this._joinReject=null}))))}))}doJoin(e){return new Promise(((t,i)=>_b(this,null,(function*(){var n,r,o;let s;if(sx(e.role)||(this.role=20===e.role?"anchor":"audience"),sx(e.privateMapKey)||(this.privateMapKey=e.privateMapKey),this._signalChannel.once(tV,(e=>{this.clearJoinTimeout(),GO.emit(JO.JOIN_SIGNAL_CONNECTION_END,{room:this,error:e}),i(e)})),pO(null==(r=null==(n=this.scheduleResult)?void 0:n.config)?void 0:r.singlePC)&&OP&&(this._enableSPC=this.scheduleResult.config.singlePC),this._enableSPC&&!this.singlePC){this.singlePC=new YU({signalChannel:this._signalChannel,room:this,enableCustomMessage:!1}),this.singlePC.once("error",(()=>this.fallbackToMPC()));try{s=yield this.singlePC.initialize()}catch(l){this.fallbackToMPC()}}this.keyPointManager.setConnectionType(this.singlePC?1:2);let a={roomId:String(e.roomId||e.strRoomId),useStringRoomId:this.useStringRoomId,privateMapKey:this.privateMapKey,trtcRole:"anchor"===this.role?20:21,trtcScene:"live"===this.scene?2:1,sdpSemantics:this.sdpSemantics,version:this._version,ua:navigator&&navigator.userAgent||"",terminalType:cx(),netType:MD[this._networkType],bussinessInfo:this._businessInfo,ability:s};this._log.debug("join room signal data: ".concat(JSON.stringify(a)));let c=5e3;(null==(o=this.scheduleResult.config)?void 0:o.enterRoomTimeout)&&this.scheduleResult.config.enterRoomTimeout>=1&&(c=1e3*this.scheduleResult.config.enterRoomTimeout),this._joinTimeout=window.setTimeout((()=>{i(new vb({code:Ab.JOIN_ROOM_FAILED,message:rP({key:XO.JOIN_ROOM_TIMEOUT})}))}),c),GO.emit(JO.JOIN_SEND_CMD,{room:this}),this._signalChannel.send(this.singlePC?PV:hV,a),this._signalChannel.once(dV.JOIN_ROOM_RESULT,(e=>{this.clearJoinTimeout();let{code:n,message:r,data:o}=e.data;GO.emit(JO.JOIN_RECEIVED_CMD_RES,{room:this,code:n}),0===n?(this._log.info("Join room success, start heartbeat"),this.startHeartbeat(),this.syncUserList(),this.startSyncUserListInterval(),this._firstPublishedList=o.publishers,this.singlePC&&this.singlePC.connect(o.ability).catch((()=>{})),t()):(this._log.error("Join room failed result: ".concat(n," error: ").concat(r)),i(new vb({code:Ab.JOIN_ROOM_FAILED,extraCode:n,message:rP({key:XO.JOIN_ROOM_FAILED,data:{error:r,code:n}})})))}))}))))}reJoin(){return _b(this,null,(function*(){if(this.isJoined)try{this._log.warn("reJoin pending: ".concat(this._joinOptions.roomId)),this.singlePC&&(this.singlePC.close(),this.singlePC=null),this._signalChannel.close(),yield this._signalChannel.connect(),yield this.doJoin(ab(sb({},this._joinOptions),{role:"anchor"===this.role?20:21,privateMapKey:this.privateMapKey})),this._log.warn("reJoin success"),sL.logSuccessEvent({userId:this.userId,eventType:mN.REJOIN}),this.singlePC?(yield this.singlePC.waitForPeerConnectionConnected(),this.uplinkConnection instanceof ex&&this.uplinkConnection.onSinglePCReconnected(),this.remotePublishedUserMap.forEach((e=>{e.installEvents(),e.doSubscribe()}))):(this.checkConnectionsToReconnect(),this.uplinkConnection instanceof rU&&!this.uplinkConnection.getIsReconnecting()&&this.uplinkConnection.startReconnection())}catch(pD){this._log.warn("reJoin fail ".concat(pD)),this.reset(),sL.logFailedEvent({userId:this.userId,eventType:mN.REJOIN,error:pD}),this.emit("error",new vb({code:Ab.JOIN_ROOM_FAILED,message:rP({key:XO.REJOIN_ROOM_FAILED,data:{roomId:this._joinOptions.roomId}})}))}else this._log.warn("reJoin abort")}))}initialize(){this._log.info("setup signal channel");let{mainUrl:e,backupUrl:t}=this.getSignalChannelUrl();return this._signalChannel=new MV({sdkAppId:this.sdkAppId,userId:this.userId,userSig:this.userSig,url:e,backupUrl:t,room:this}),this._networkQuality||(this._networkQuality=new cU({signalChannel:this._signalChannel,room:this}),this._networkQuality.on(cU.EVENT_NETWORK_QUALITY,(e=>{this.emit("network-quality",e)}))),this._signalChannel.on(iV,(e=>{GO.emit(JO.SIGNAL_CONNECTION_STATE_CHANGED,sb({room:this},e)),this.emit("signal-connection-state-changed",e)})),this._signalChannel.on(rV,(e=>{this.reset(),this.emit("error",e)})),this._signalChannel.once(eV,(e=>{this.tinyId=e.signalInfo.tinyId,GO.emit(JO.JOIN_SIGNAL_CONNECTION_END,{room:this})})),this._signalChannel.on(dV.PEER_JOIN,(e=>{let{srcTinyId:t,userId:i,role:n}=e.data.data;this.userManager.addUser({userId:i,tinyId:t,role:n})})),this._signalChannel.on(dV.PEER_LEAVE,(e=>{let{userId:t,reason:i=0}=e.data.data;this.userManager.deleteUser(t,i)})),this._signalChannel.on(dV.UPDATE_REMOTE_MUTE_STAT,(e=>{this._lastHeartBeatTime>0&&Date.now()-this._lastHeartBeatTime>=1e4&&this.doHeartbeat(),this.onPublishedUserList(e.data)})),this._signalChannel.on(dV.CLIENT_BANNED,(e=>{let t=e.data.data,{reason:i}=t;if(sL.uploadEvent({log:"stat-banned:".concat(i),userId:this.userId}),"user_time_out"===i)return this._log.warn("".concat(i," last heart beat time: ").concat(this._lastHeartBeatTime," interval: ").concat(Date.now()-this._lastHeartBeatTime,", visibility: ").concat(document.visibilityState)),void this.reJoin();this._log["kick"===i?"error":"info"]("user was banned because of [".concat(i,"]")),this.reset(),this.emit("banned",{reason:i})})),GO.emit(JO.JOIN_SIGNAL_CONNECTION_START,{room:this}),this._signalChannel.connect(this._isUsingCachedSchedule?1e4:void 0)}leave(){return _b(this,null,(function*(){try{yield this.doHeartbeat()}catch(pD){}GO.emit(JO.LEAVE_SEND_CMD,{room:this}),this._log.info("leave() => leaving room"),this._signalChannel.send(pV),this.reset()}))}clearNetworkQuality(){this._networkQuality&&(this._networkQuality.stop(),this._networkQuality=null)}closeConnections(){this.remotePublishedUserMap.forEach((e=>{this.closeDownLinkConnection(e.userId,"you exitRoom")}))}clearJoinTimeout(){clearTimeout(this._joinTimeout),this._joinTimeout=-1}startHeartbeat(){-1===this._heartbeat&&(this._heartbeat=nL.run(FN,this.doHeartbeat.bind(this),{delay:2e3}))}stopHeartbeat(){-1!==this._heartbeat&&(this._log.info("stopHeartbeat"),nL.clearTask(this._heartbeat),this._heartbeat=-1,this._lastHeartBeatTime=-1)}doHeartbeat(){return _b(this,null,(function*(){var e;let t=this.badCaseDetector.getMonitorFreeze(),i=yield this._stats.getStatsReport({uplinkConnection:this.uplinkConnection,downlinkConnections:this.remotePublishedUserMap,freezeMap:t});if(this.badCaseDetector.resetMonitor(),null==(e=this._signalChannel)||!e.isConnected)return;let n=this._signalChannel.isConnected?function(e){if($w.has(e)){let t=$w.get(e).map((e=>({uint32_event_id:e.eventId,uint64_date:e.timestamp,str_userid:e.remoteUserId,str_event_json:e.eventDesc})));return $w.delete(e),t}return[]}(this.userId):[],r=sb({str_sdk_version:dD,uint64_datetime:(new Date).getTime(),msg_user_info:{str_identifier:this.userId,uint64_tinyid:this.tinyId},msg_device_info:{uint32_terminal_type:15,str_device_name:navigator.platform,str_os_version:"",uint32_net_type:MD[this._networkType]},msg_event_msg:n,str_acc_ip:this.getSignalInfo().relayIp,str_client_ip:this.getSignalInfo().clientIp},i);GO.emit(JO.HEARTBEAT_REPORT,{room:this,report:r}),this._signalChannel.send(_V,r);let o=Date.now();this._lastHeartBeatTime>0&&o-this._lastHeartBeatTime>1e4&&this._log.warn("heartbeat took ".concat(o-this._lastHeartBeatTime)),this._signalChannel.isConnected&&(this._lastHeartBeatTime=o),!this._isRelayChanged&&this.isRelayMaybeFailed()&&(this.reJoin(),this._isRelayChanged=!0)}))}onPublishedUserList(e){if(!this.isJoined)return;let t=e.data.userList.map((e=>{let{userId:t,srcTinyId:i,flag:n}=e,r=this.remotePublishedUserMap.get(t);return r&&this._changeBigSmallRecords.has(t)&&this.checkSubscribeBigSmallVideo(r),{userId:t,tinyId:i,flag:n}}));GO.emit(JO.RECEIVED_PUBLISHED_USER_LIST,{room:this,publishedUserList:t}),this.userManager.setRemotePublishedUserList(t)}closeUplink(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"you unpublished";this.uplinkConnection&&(this.localTracks.size>0&&this.uplinkConnection.doUnpublish(),this.uplinkConnection.close(e),this.uplinkConnection=null),this.localTracks.forEach((e=>e.unpublish())),this.localTracks.clear()}createDownlinkConnection(e){let{userId:t,tinyId:i,flag:n}=e,r=new(this.singlePC?nx:QV)({userId:t,tinyId:i,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:n});this.userManager.addRemotePublishedUser(r),this.installDownlinkEvents(r,t),this.emit("remote-published",r)}closeDownLinkConnection(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"remote user unpublished",i=this.remotePublishedUserMap.get(e);i&&(i.close(t),this.emit("remote-unpublished",i))}installDownlinkEvents(e,t){e.on("sei-message",(e=>{this.emit("sei-message",e)})),e.on("error",(e=>{let i=e.getCode();i!==Ab.ICE_TRANSPORT_ERROR&&(i===Ab.DOWNLINK_RECONNECTION_FAILED&&this.closeDownLinkConnection(t),this.emit("error",e))})),e.on("connection-state-changed",(t=>{this.emit("media-connection-state-changed",ab(sb({},t),{userId:e.userId}))})),e.on("firewall-restriction",(()=>{this.emit("firewall-restriction")}))}startSyncUserListInterval(){-1===this._syncUserListInterval&&(this._syncUserListInterval=nL.run(FN,this.syncUserList.bind(this)))}stopSyncUserListInterval(){nL.clearTask(this._syncUserListInterval),this._syncUserListInterval=-1}syncUserList(){return this.getUserList().then((e=>{this.userManager.setUserList(e)})).catch((e=>{this._log.debug("sync user list failed: ".concat(e))}))}getUserList(){var e;return null!=(e=this._signalChannel)&&e.isConnected?this._signalChannel.sendWaitForResponse({command:kV,responseCommand:dV.USER_LIST_RES,enableLog:!1,timeout:2e3}).then((e=>{let{data:t}=e,{code:i,message:n}=t;if(0===i)return(t.data&&t.data.userList||[]).map((e=>{let{userId:t,srcTinyId:i,role:n}=e;return{userId:t,tinyId:i,role:n}}));throw rP({key:XO.SIGNAL_RESPONSE_FAILED,data:{signalResponse:dV.USER_LIST_RES,code:i,message:n}})})):Promise.reject("not connected")}getAllConnections(){let e=[...this.remotePublishedUserMap.values()];return this.uplinkConnection&&e.push(this.uplinkConnection),e}isRelayMaybeFailed(){if(!this._signalChannel.isOnline||!jV)return!1;if(this.singlePC)return this.singlePC.reconnectionCount>6;let e=this.getAllConnections();if(0===e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].getReconnectionCount()<6)return!1;return!0}checkConnectionsToReconnect(){this.singlePC||this.getAllConnections().forEach((e=>{if(e instanceof GV&&!e.getIsReconnecting()){let t=e.getPeerConnection();t&&t.connectionState===lN.CLOSED&&(this._log.warn("[".concat(e.getUserId(),"] pc is closed but not reconnect")),e.startReconnection())}}))}fallbackToMPC(){return _b(this,null,(function*(){var e;if(this._log.warn("fallback to multi pc"),sL.uploadEvent({log:"stat-fallback",userId:this.userId}),this._enableSPC=!1,null==(e=this.singlePC)||e.close(),this.singlePC=null,yield this.reJoin(),this.uplinkConnection){let e=this.uplinkConnection;this.uplinkConnection=new rU({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),e.isMainStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:e.localMainAudioTrack,localVideoTrack:e.localMainVideoTrack,isAuxiliary:!1})),e.isAuxStreamPublished&&(yield this.uplinkConnection.publish({localAudioTrack:e.localAuxAudioTrack,localVideoTrack:e.localAuxVideoTrack,isAuxiliary:!0}))}this.remotePublishedUserMap.forEach((e=>{let t=new QV({userId:e.userId,tinyId:e.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,flag:e.flag,remoteAudioTrack:e.remoteAudioTrack,remoteVideoTrack:e.remoteVideoTrack,remoteAuxiliaryTrack:e.remoteAuxiliaryTrack});this.installDownlinkEvents(t,e.userId),this.remotePublishedUserMap.set(e.userId,t),e.isMainStreamSubscribed&&t.subscribe(e.subscribeState,"main"),e.isAuxStreamSubscribed&&t.subscribe(e.subscribeState,"auxiliary")}))}))}destroy(){this._isDestroyed||(super.destroy(),this._joinReject&&(this._joinReject(new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.CLIENT_DESTROYED,data:{funName:"join"}})})),this.clearJoinTimeout(),this.reset()),this.removeAllListeners())}switchRole(e){return _b(this,null,(function*(){this.role!==e&&("audience"===e&&this.uplinkConnection&&this.closeUplink("you switch role to audience"),yield this.doSwitchRole(e))}))}doSwitchRole(e){let t={command:DV,data:{role:"anchor"===e?20:21,privateMapKey:this.privateMapKey},responseCommand:dV.SWITCH_ROLE_RES,retries:1};return this._log.info("switchRole signal data: ".concat(JSON.stringify(t.data))),this._signalChannel.sendWaitForResponseWithRetry(t).then((t=>{let{code:i,message:n}=t.data;if(0!==i)throw new vb({code:Ab.SWITCH_ROLE_FAILED,message:rP({key:XO.SWITCH_ROLE_FAILED,data:{message:n,code:i}})});this.role=e})).catch((e=>{throw e instanceof vb&&e.getCode()===Ab.API_CALL_TIMEOUT&&(e=new vb({code:Ab.SWITCH_ROLE_FAILED,message:rP({key:XO.SWITCH_ROLE_TIMEOUT})})),this._log.error(e),e}))}publish(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return _b(this,null,(function*(){if("live"===this.scene&&"anchor"!==this.role)return;GO.emit(JO.PUBLISH_START,{room:this});let e={},i={};this._isPublishing=!0,t.forEach((t=>{!t.mediaTrack||(t instanceof mw&&(t instanceof Ew?(i.audio=t,this.audioManager.addScreenAudioTrack(t)):(e.audio=t,this.audioManager.addAudioTrack(t))),t instanceof fw&&(t instanceof Tw&&2===t.mediaType?i.video=t:e.video=t),t.setPublishStarting(this))}));try{let n=lx(e),r=lx(i);(!n||!r)&&!this.uplinkConnection&&(this.singlePC?this.uplinkConnection=new ex({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}):this.uplinkConnection=new rU({userId:this.userId,tinyId:this.tinyId,room:this,signalChannel:this._signalChannel,enableSEI:this.enableSEI,audioManager:this.audioManager}),this.uplinkConnection.on("connection-state-changed",(e=>{this.emit("media-connection-state-changed",ab(sb({},e),{userId:this.userId}))})),this.uplinkConnection.on("firewall-restriction",(()=>{this.emit("firewall-restriction")})),this.uplinkConnection.on("error",(e=>{let t=e.getCode();t!==Ab.ICE_TRANSPORT_ERROR&&(t===Ab.UPLINK_RECONNECTION_FAILED&&this.closeUplink(),this.emit("error",e))})));let o=t.map((e=>e.kind)).join(",");n||(this._log.info("publish() => main ".concat(o)),yield this.uplinkConnection.publish({localAudioTrack:e.audio,localVideoTrack:e.video,isAuxiliary:!1}),this._log.info("main is published")),r||(this._log.info("publish() => aux ".concat(o)),yield this.uplinkConnection.publish({localAudioTrack:i.audio,localVideoTrack:i.video,isAuxiliary:!0}),this._log.info("aux is published")),this._isPublishing=!1,t.forEach((e=>{!e.mediaTrack||(this.localTracks.add(e),e.publish(this))}))}catch(n){throw t.forEach((e=>{let t="error";n.message.includes("timeout")?t="timeout":n.code===Ab.API_CALL_ABORTED&&(t="api-call"),e.setPublishStopped(t,"error"===t?n:void 0)})),this._isPublishing=!1,n}}))}unpublish(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return _b(this,null,(function*(){if("live"===this.scene&&"anchor"!==this.role||!this.isMainStreamPublished&&!this.isAuxStreamPublished||!this.uplinkConnection)return;let e={},i={};t.forEach((t=>{!t.mediaTrack||(t instanceof mw&&(t instanceof Ew?i.audio=t:e.audio=t),t instanceof fw&&(t instanceof Tw&&2===t.mediaType?i.video=t:e.video=t))}));try{let n=t.map((e=>e.kind)).join(",");lx(e)||(this._log.info("unpublish() => main ".concat(n)),yield this.uplinkConnection.unpublish({localAudioTrack:e.audio,localVideoTrack:e.video})),lx(i)||(this._log.info("unpublish() => aux ".concat(n)),yield this.uplinkConnection.unpublish({localAudioTrack:i.audio,localVideoTrack:i.video}))}catch(n){}t.forEach((e=>{!e.mediaTrack||(e.unpublish(),this.localTracks.delete(e))})),0===this.localTracks.size&&!this.audioManager.isMixed&&this.closeUplink("you unpublished")}))}addTrack(e){return this.uplinkConnection&&e.mediaTrack?(e.setPublishStarting(this),this.uplinkConnection.addTrack(e).then((t=>(e.publish(this),t)))):Promise.resolve()}removeTrack(e){return this.uplinkConnection&&e.mediaTrack?this.uplinkConnection.removeTrack(e).then((t=>(e.unpublish(),t))):Promise.resolve()}replaceTrack(e){return this.uplinkConnection&&e.mediaTrack?this.uplinkConnection.replaceTrack(e).then((t=>{GO.emit(JO.LOCAL_TRACK_REPLACED,{track:e})})):Promise.resolve()}setBandWidth(e){return _b(this,null,(function*(){!this.uplinkConnection||(yield this.uplinkConnection.setBandwidth(e),yield this.uplinkConnection.sendMediaSettings())}))}subscribe(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return _b(this,null,(function*(){if(t=t.filter((e=>!e.isSubscribed)),0===t.length)return;let{userId:e}=t[0],i=this.remotePublishedUserMap.get(e);if(!i)return;let n=t.find((e=>2===e.mediaType))?"auxiliary":"main";try{let r=sb({},i.subscribeState);t.forEach((e=>{switch(e.mediaType){case 1:r.audio=!0;break;case 4:r.video=!0;break;case 2:r.auxiliary=!0}}));let o=this._changeBigSmallRecords.get(e);o&&o.options.smallVideo&&i.muteState.hasSmall&&r.video&&(r.video=!1,r.smallVideo=!0),GO.emit(JO.SUBSCRIBE_START,{room:this,streamType:n,remotePublishedUser:i,subscribeState:r}),this._log.info("subscribe() => ".concat(e," ").concat(n," [").concat(YV(r),"] prev: [").concat(YV(i.subscribeState),"]")),yield i.subscribe(r,n),i.remoteVideoTrack.setMediaType(r.smallVideo?8:4),GO.emit(JO.SUBSCRIBE_SUCCESS,{room:this,streamType:n,remotePublishedUser:i})}catch(mD){let i=mD instanceof vb?mD.getCode():Ab.UNKNOWN,r=mD;throw mD instanceof vb?i===Ab.REMOTE_STREAM_NOT_EXIST&&(r=new vb({code:Ab.API_CALL_ABORTED,message:rP({key:XO.API_CALL_ABORTED,data:{message:mD.message,userId:e,streamType:n}})}),this._log.warn(r)):(r=new vb({code:i,message:rP({key:XO.SUBSCRIBE_FAILED,data:{message:mD.message,userId:e,streamType:n}})}),this._log.error(r)),r}}))}unsubscribe(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return _b(this,null,(function*(){let{userId:e}=t[0],i=this.remotePublishedUserMap.get(e);if(!i)return;let n=t.find((e=>2===e.mediaType))?"auxiliary":"main";this._log.info("unsubscribe() => ".concat(e," ").concat(n));try{yield i.unsubscribe({remoteTracks:t,streamType:n})}catch(mD){this._log.warn("unsubscribe() => failed ".concat(mD))}t.forEach((e=>{e.unsubscribe(),8===e.mediaType&&e.setMediaType(4)})),GO.emit(JO.UNSUBSCRIBE_SUCCESS,{room:this,streamType:n,remotePublishedUser:i})}))}setEncodedDataProcessingListener(e){throw new Error("Method not implemented.")}enableAudioVolumeEvaluation(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3,t=arguments.length>1?arguments[1]:void 0;if(e<=0)return this._enableAudioVolumeEvaluation=!1,nL.clearTask(this._audioVolumeIntervalId),void(this._audioVolumeIntervalId=null);e=Math.floor(Math.max(e,100)),GO.emit(JO.AUDIO_LEVEL_INTERVAL,{interval:e}),this._audioVolumeIntervalId&&(nL.clearTask(this._audioVolumeIntervalId),this._audioVolumeIntervalId=null),this._enableAudioVolumeEvaluation=!0,this._audioVolumeIntervalId=nL.run(BN,(()=>{var e,t;let i=[];if(null!=(e=this.uplinkConnection)&&e.localMainAudioTrack){let e=Math.floor(100*this.uplinkConnection.localMainAudioTrack.getAudioLevel());i.push({userId:"",volume:e})}null==(t=this.remotePublishedUserMap)||t.forEach((e=>{if(e.muteState.hasAudio){let t=Math.floor(100*e.remoteAudioTrack.getAudioLevel());i.push({userId:e.userId,volume:t})}})),this.emit("audio-volume",i)}),{fps:1e3/e,backgroundTask:t})}getLocalAudioStats(){return _b(this,null,(function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0},this.uplinkConnection){let t=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:t.audio.bytesSent,packetsSent:t.audio.packetsSent}}return e}))}getLocalVideoStats(){return _b(this,null,(function*(){let e={};if(e[this.userId]={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0},this.uplinkConnection){let{video:{bytesSent:t,packetsSent:i,framesEncoded:n,framesSent:r,frameWidth:o,frameHeight:s}}=yield this._stats.getSenderStats(this.uplinkConnection);e[this.userId]={bytesSent:t,packetsSent:i,framesEncoded:n,framesSent:r,frameWidth:o,frameHeight:s}}return e}))}getTransportStats(){return _b(this,null,(function*(){let e={rtt:0,downlinksRTT:{}};if(this.uplinkConnection){let t=yield this._stats.getSenderStats(this.uplinkConnection);e.rtt=t.rtt}for(let[,t]of this.remotePublishedUserMap){let i=yield this._stats.getReceiverStats(t);e.downlinksRTT[i.userId]=i.rtt}return e}))}getRemoteVideoStats(e){return _b(this,null,(function*(){let t={};for(let[i,n]of this.remotePublishedUserMap)"main"===e&&n.muteState.hasVideo&&(t[i]=n.remoteVideoTrack.stat),"auxiliary"===e&&n.muteState.hasAuxiliary&&(t[i]=n.remoteAuxiliaryTrack.stat);return t}))}getRemoteAudioStats(){return _b(this,null,(function*(){let e={};for(let[t,i]of this.remotePublishedUserMap)i.muteState.hasAudio&&(e[t]=i.remoteAudioTrack.stat);return e}))}setProxyServer(e){if(rx(e)){if(!e.startsWith("wss://"))throw new vb({code:Ab.INVALID_PARAMETER,message:"invalid websocket url"});this.proxy_ws=e}else if(ox(e)){let{websocketProxy:t,loggerProxy:i}=e;t&&(this.proxy_ws=t),i&&ID(i)}}setTurnServer(e,t){this._log.info("set turn server: ".concat(JSON.stringify(e)," ").concat(t||""));let i=[];Array.isArray(e)?e.forEach((e=>i.push(kb.getTurnServer(e)))):kb.isPlainObject(e)&&i.push(kb.getTurnServer(e)),this._turnServers=i,t&&(this._iceTransportPolicy=t)}sendStartMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:CV,data:e,timeout:5e3,responseCommand:dV.START_MIX_TRANSCODE_RES,commandDesc:"startMixTranscode"})}sendStopMixTranscode(e){return this._signalChannel.sendWaitForResponse({command:bV,data:e,timeout:5e3,responseCommand:dV.STOP_MIX_TRANSCODE_RES,commandDesc:"stopMixTranscode"})}sendStartPublishCDN(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._signalChannel.sendWaitForResponse({command:t?AV:vV,data:e,timeout:5e3,responseCommand:t?dV.START_PUBLISH_TENCENT_CDN_RES:dV.START_PUBLISH_GIVEN_CDN_RES,commandDesc:"startPublishCDN"})}sendStopPublishCDN(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._signalChannel.sendWaitForResponse({command:t?yV:RV,data:e,timeout:5e3,responseCommand:t?dV.STOP_PUBLISH_TENCENT_CDN_RES:dV.STOP_PUBLISH_GIVEN_CDN_RES,commandDesc:"stopPublishCDN"})}getIceServers(){return 0===this._turnServers.length&&this.scheduleResult.iceServers?this.scheduleResult.iceServers:this._turnServers}getIceTransportPolicy(){return this._iceTransportPolicy||this.scheduleResult.iceTransportPolicy||"all"}getLogger(){return this._log}enableAIVoice(){throw new Error("Method not implemented.")}getSignalChannelUrl(){let e={mainUrl:"",backupUrl:""},t=kb.getEnv();return t?(e.mainUrl="wss://".concat(t,".rtc.qq.com"),e.backupUrl=e.mainUrl):this.proxy_ws?(e.mainUrl=this.proxy_ws,e.backupUrl=e.mainUrl):Array.isArray(this.scheduleResult.domains)&&this.scheduleResult.domains.length>0&&(e.mainUrl="wss://".concat(this.scheduleResult.domains[0]),e.backupUrl=e.mainUrl,this.scheduleResult.domains[1]&&(e.backupUrl="wss://".concat(this.scheduleResult.domains[1]))),e}getSignalInfo(){var e;return(null==(e=this._signalChannel)?void 0:e.getSignalInfo())||{}}reset(){this.stopSyncUserListInterval(),this.stopHeartbeat(),this.closeConnections(),this.clearNetworkQuality(),this.closeUplink("you exitRoom"),this._signalChannel&&(this._log.info("destroying SignalChannel"),this._signalChannel.close()),this._stats.reset(),this.userManager.clear(),this.userManager.removeAllListeners(),this.singlePC&&(this.singlePC.close(),this.singlePC=null),this.scheduleResult={domains:null,iceServers:null,iceTransportPolicy:null,trtcAutoConf:null}}checkSubscribeBigSmallVideo(e){return _b(this,null,(function*(){let t=null==e?void 0:e.muteState.hasSmall,i=null==e?void 0:e.muteState.hasVideo;if(!t&&!i||!e.isBigStreamSubscribed&&!e.isSmallStreamSubscribed)return;let n=e.getUserId(),r=this._changeBigSmallRecords.get(n)||{},{subscribeState:o}=e,{options:s,isSubscribing:a,reSubscribeCount:c}=r;if(s.video&&o.video||s.smallVideo&&o.smallVideo&&t||a)return;let l={audio:e.remoteAudioTrack.isSubscribed||e.remoteAudioTrack.isSubscribing,auxiliary:e.remoteAuxiliaryTrack.isSubscribed||e.remoteAuxiliaryTrack.isSubscribing,video:s.video,smallVideo:s.smallVideo};if(t&&e.isBigStreamSubscribed||e.isSmallStreamSubscribed)try{s&&!a&&c>=1&&(r.isSubscribing=!0,r.reSubscribeCount=c-1,!t&&e.isSmallStreamSubscribed&&(l.video=!0,l.smallVideo=!1),yield null==e?void 0:e.subscribe(l,"main"),e.remoteVideoTrack.setMediaType(l.smallVideo?8:4),this._log.info("change [".concat(n,"] to ").concat(l.smallVideo?"small":"big"," video successfully. count ").concat(UN-r.reSubscribeCount,".")),r.isSubscribing=!1,r.reSubscribeCount=UN)}catch(d){this._log.info("change [".concat(n,"] to ").concat(l.smallVideo?"small":"big"," video failed. count ").concat(UN-r.reSubscribeCount,".")),r.isSubscribing=!1,0===c&&this._changeBigSmallRecords.delete(n)}}))}changeType(e,t){let i={options:{video:!e,smallVideo:e},isSubscribing:!1,reSubscribeCount:UN};this._changeBigSmallRecords.set(t.userId,i),this._log.info("set [".concat(t.userId,"] video prefer type: ").concat(e?"small":"big"))}get smallStreamConfig(){return this._smallStreamConfig}_initBusinessInfo(e){this._businessInfo=e.businessInfo;let t={};if(rx(e.businessInfo)&&(t=JSON.parse(e.businessInfo)),!sx(e.pureAudioPushMode)){if(!Number.isInteger(Number(e.pureAudioPushMode)))throw new vb({code:Ab.INVALID_PARAMETER,message:rP({key:XO.INVALID_PURE_AUDIO})});this._pureAudioPushMode=e.pureAudioPushMode,t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.pure_audio_push_mod=this._pureAudioPushMode}if(!sx(e.userDefineRecordId)){let i=/^[A-Za-z0-9_-]{1,64}$/gi;if(null===e.userDefineRecordId.match(i))throw new vb({code:Ab.INVALID_PARAMETER,message:rP({key:XO.INVALID_USER_DEFINE_RECORDID})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_record_id=e.userDefineRecordId}if(!sx(e.userDefinePushArgs)){if(!(rx(e.userDefinePushArgs)&&String(e.userDefinePushArgs)&&String(e.userDefinePushArgs).length<=256))throw new vb({code:Ab.INVALID_PARAMETER,message:rP({key:XO.INVALID_USER_DEFINE_PUSH_ARGS})});t.Str_uc_params||(t.Str_uc_params={}),t.Str_uc_params.userdefine_push_args=e.userDefinePushArgs}lx(t)||(this._businessInfo=JSON.stringify(t))}sendSEI(e,t){var i;null==(i=this.uplinkConnection)||i.sendSEI(e,t)}};return ub([qP(["left",ZP.INIT],"joined"),dU({settings:{retries:1,timeout:0},onError(e,t,i){this._isUsingCachedSchedule&&!this._isDestroyed?(this._log.warn("is using cached schedule, retry join"),vU(!0),this.reset(),t()):(this.reset(),this._log.error(e),i(e))}}),hw((e=>{let t=new XM;return function(i,n,r){return _b(this,null,(function*(){let o=String(i.roomId||i.strRoomId);if(this.userId=i.userId,this.sdkAppId=i.sdkAppId,this.userSig=i.userSig,this._log.setSdkAppId(this.sdkAppId),this._log.setUserId(this.userId),this.scene=n,i.privateMapKey=i.privateMapKey||"",this.isJoined)throw new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.INVALID_JOIN})});if(this.checkDestroy(),t.isJoined({userId:this.userId,roomId:o,sdkAppId:this.sdkAppId,room:this}))throw new vb({code:Ab.INVALID_OPERATION,message:rP({key:XO.REPEAT_JOIN,data:this.userId})});t.add({room:this,roomId:o}),this._log.info("Join() => joining room: ".concat(o," useStringRoomId: ").concat(this.useStringRoomId," scene: ").concat(this.scene," role: ").concat(this.role)),this.role=21===i.role?"audience":"anchor",GO.emit(JO.JOIN_START,{room:this,roomId:o,params:i}),this.checkSystemResult=yield QO.checkSystemRequirementsInternal(),this.checkDestroy();let s=kb.getEnv();s||(s=OD.QCLOUD,this.proxy_ws&&(this.proxy_ws.startsWith(GD.OLD_CLOUD_LADDER)?s=OD.OLD_CLOUD_LADDER:this.proxy_ws.startsWith(GD.WEBRTC)&&(s=OD.WEBRTC))),sL.setConfig({env:s,sdkAppId:String(this.sdkAppId),userId:this.userId,roomId:o}),ZM.call(this);let{isH264EncodeSupported:a,isVp8EncodeSupported:c}=this.checkSystemResult.detail;if(!QO.isWebRTCSupported()||!a&&!c)throw new vb({code:Ab.NOT_SUPPORTED,message:rP({key:XO.NOT_SUPPORTED_WEBRTC})});try{!this.proxy_ws&&!this.proxy_wt&&!this.scheduleResult.domains&&!kb.getEnv()&&(yield this.schedule(o,r,uD));let t=yield e.call(this,i,n,r);return this.roomId=o,this._joinedTimestamp=kb.performanceNow(),GO.emit(JO.JOIN_SUCCESS,{room:this}),sL.uploadEvent({log:"stat-conv-".concat(Number(eD),"-").concat(location.hostname),userId:this.userId}),t}catch(l){throw t.delete({room:this,roomId:o}),GO.emit(JO.JOIN_FAILED,{room:this,error:l}),l}}))}}))],dx.prototype,"join",1),ub([qP("joined","left",{ignoreError:!0}),hw((e=>function(){return _b(this,null,(function*(){GO.emit(JO.LEAVE_START,{room:this}),yield e.call(this),GO.emit(JO.LEAVE_SUCCESS,{room:this,roomId:this.roomId})}))})),function(e){return function(t,i,n){let r=n.value;return n.value=function(){var t,i;let n=[];for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return null==(t=OU.get(this))||t.forEach((e=>n.push(e))),null==(i=PU.get(this))||i.forEach((e=>e.forEach((e=>n.push(e))))),n.forEach((t=>{t.reject(new vb({code:Ab.API_CALL_ABORTED,message:e}))})),OU.delete(this),PU.delete(this),r.apply(this,s)},n}}("leave room"),uU({fnName:"publish",validateArgs:!1}),uU({fnName:"unsubscribe",validateArgs:!1})],dx.prototype,"leave",1),ub([LU(),dU({settings:{retries:hN,timeout:e=>aO(e)},onError(e,t,i){var n;null!=(n=e.message)&&n.includes("timeout")?(this._log.warn("publish timeout"),t()):(this._log.error("publish failed: ".concat(e)),i(e),GO.emit(JO.PUBLISH_FAILED,{room:this}))}})],dx.prototype,"publish",1),ub([uU({fnName:"publish",callback(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];0===this.localTracks.size&&(null==(e=this.uplinkConnection)||e.close("you unpublished"),this.uplinkConnection=null,i.forEach((e=>e.setPublishStopped("api-call"))))}}),function(e){return function(t,i,n){let r=n.value;return n.value=function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];let o=OU.get(this);if(o){let t=o.filter(((t,n)=>{if(0===n)return!0;let r=!0;return t.args.forEach((e=>{i.find((t=>t===e))||(r=!1)})),!r||(t.reject(new vb({code:Ab.API_CALL_ABORTED,message:e})),!1)}));OU.set(this,t)}return r.apply(this,i)},n}}("api-call"),LU()],dx.prototype,"unpublish",1),ub([wU((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t[0].userId})),hw((e=>function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];let r=e.apply(this,i);return i.forEach((e=>!e.isSubscribed&&e.subscribe(r))),r})),dU({settings:{retries:hN,timeout:e=>aO(e)},onError(e,t,i,n){e.message.includes("timeout")?(this._log.warn("subscribe timeout"),t()):(this._log.error("subscribe failed: ".concat(e)),i(e),GO.emit(JO.SUBSCRIBE_FAILED,{room:this,remoteTracks:n}))}})],dx.prototype,"subscribe",1),ub([uU({fnName:"subscribe",callback(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.singlePC||t.forEach((e=>{let t=this.remotePublishedUserMap.get(e.userId);t&&!t.isMainStreamSubscribed&&!t.isAuxStreamSubscribed&&t.close("you unsubscribed")}))}}),wU((function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return t[0].userId}))],dx.prototype,"unsubscribe",1),QM.create=QM._create.bind(QM,dx),QM}));
