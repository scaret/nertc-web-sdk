<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <link rel="icon" href="data:,">
  <title>多实例测试</title>
</head>
<body>
<label><input type="checkbox" id="defaultOpenMic">打开麦克风</label>
<label><input type="checkbox" id="defaultOpenCamera" checked>打开摄像头</label>
<label id="segmentStatus" style="display: none;"></label>
<label id="advancedBeautyStatus" style="display: none;"></label>
<div id="views">
  
</div>
<script>
  var searchParams = new URLSearchParams(location.search);
  const COUNT = parseInt(searchParams.get("count"))
  if (!COUNT){
    searchParams.set("count", 4)
    window.location.href = `${window.location.pathname}?${searchParams.toString()}`
  }
</script>
<script src="./js/nim/NIM_Web_NERTC.js"></script>
<script src="./js/lib/jquery.min.js"></script>
<script>
  window.clients = {}
  const channelName = Math.floor(Math.random() * 9000) + 1000
  const main = ()=>{
    for (let i = 0; i < COUNT; i++){
      const wrapper = document.createElement('div')
      const panel = document.createElement('div')
      const localContainer = document.createElement('div')
      const remoteContainer = document.createElement('div')
      $(wrapper).appendTo("views")
      $(panel).appendTo(wrapper)
      $(localContainer).appendTo(wrapper)
      $(remoteContainer).appendTo(wrapper)

      wrapper.style.clear = "both"
      localContainer.style.width = "200px"
      localContainer.style.height = "200px"
      localContainer.style.float = "left"
      remoteContainer.style.width = "800px"
      remoteContainer.style.height = "200px"
      remoteContainer.style.float = "left"
      
      $(`<span>频道号: </span>`).appendTo(panel)
      const channelInput = document.createElement('input')
      channelInput.value = channelName
      $(channelInput).appendTo(panel)

      $(`<span>uid: </span>`).appendTo(panel)
      const uidInput = document.createElement('input')
      uidInput.value = channelName * 100 + i
      $(uidInput).appendTo(panel)

      const joinButton = document.createElement('button')
      joinButton.innerText = "加入频道"
      $(joinButton).appendTo(panel)
      
      const leaveButton = document.createElement('button')
      leaveButton.innerText = "离开频道"
      $(leaveButton).appendTo(panel)

      const destroyButton = document.createElement('button')
      destroyButton.innerText = "销毁"
      $(destroyButton).appendTo(panel)

      $("<span> </span>").appendTo(panel)

      const openAudioInput = document.createElement("button")
      openAudioInput.innerText = "打开音频"
      $(openAudioInput).appendTo(panel)

      const closeAudioInput = document.createElement("button")
      closeAudioInput.innerText = "关闭音频"
      $(closeAudioInput).appendTo(panel)


      const openVideoInput = document.createElement("button")
      openVideoInput.innerText = "打开视频"
      $(openVideoInput).appendTo(panel)

      const closeVideoInput = document.createElement("button")
      closeVideoInput.innerText = "关闭视频"
      $(closeVideoInput).appendTo(panel)

      const openBeautyInput = document.createElement("button")
      openBeautyInput.innerText = "开启美颜"
      $(openBeautyInput).appendTo(panel)

      const openLutInput = document.createElement("button")
      openLutInput.innerText = "蓝调滤镜"
      $(openLutInput).appendTo(panel)

      const closeBeautyInput = document.createElement("button")
      closeBeautyInput.innerText = "关闭美颜"
      $(closeBeautyInput).appendTo(panel)

<<<<<<< HEAD
=======
      $("<br>").appendTo(panel)
      $("<br>").appendTo(panel)
      $("<span>高级美颜:</span>").appendTo(panel)

      const registerAdvBeautyInput = document.createElement("button")
      registerAdvBeautyInput.innerText = "注册"
      $(registerAdvBeautyInput).appendTo(panel)

      const openAdvBeautyInput = document.createElement("button")
      openAdvBeautyInput.innerText = "打开"
      $(openAdvBeautyInput).appendTo(panel)

      const closeAdvBeautyInput = document.createElement("button")
      closeAdvBeautyInput.innerText = "关闭"
      $(closeAdvBeautyInput).appendTo(panel)

      const resetAdvBeautyInput = document.createElement("button")
      resetAdvBeautyInput.innerText = "重置"
      $(resetAdvBeautyInput).appendTo(panel)

      const destroyAdvBeautyInput = document.createElement("button")
      destroyAdvBeautyInput.innerText = "销毁"
      $(destroyAdvBeautyInput).appendTo(panel)

      $("<br>").appendTo(panel)
      $("<br>").appendTo(panel)
      $("<span>背景分割:</span>").appendTo(panel)
      
      const registerVitrualBackgroundInput = document.createElement("button")
      registerVitrualBackgroundInput.innerText = "注册"
      $(registerVitrualBackgroundInput).appendTo(panel)

      const openVitrualBackgroundInput = document.createElement("button")
      openVitrualBackgroundInput.innerText = "打开"
      $(openVitrualBackgroundInput).appendTo(panel)

      const closeVitrualBackgroundInput = document.createElement("button")
      closeVitrualBackgroundInput.innerText = "关闭"
      $(closeVitrualBackgroundInput).appendTo(panel)

      const destroyVitrualBackgroundInput = document.createElement("button")
      destroyVitrualBackgroundInput.innerText = "销毁"
      $(destroyVitrualBackgroundInput).appendTo(panel)

>>>>>>> 6126526b (fix: adv demo)
      const localStreamInfo = document.createElement("div")
      $(localStreamInfo).appendTo(panel)

      document.getElementById('views').appendChild(wrapper)
      const client = NERTC.createClient({
        appkey: "eca23f68c66d4acfceee77c200200359",
        debug: true
      })
      NERTC.Logger.enableLogUpload();
      window.clients[i] = client
      client.on('stream-added', (evt)=>{
        client.subscribe(evt.stream)
      })
      client.on('stream-subscribed', (evt)=>{
        console.log(`${channelName} ${evt.stream.streamID}`)
        evt.stream.setRemoteRenderMode({
          width: 200,
          height: 200,
          cut: false
        })
        evt.stream.play(remoteContainer)
      })
      
      NERTC.getParameters().allowEmptyMedia = true
      let localStream = null
      const getLocalStream = ()=>{
        if (!localStream || localStream.destroyed){
          localStream = NERTC.createStream({
            audio: false,
            video: false,
            client: client,
          })
          localStreamInfo.innerText = "localstream_" + localStream.localStreamId
          localStream.init()
          localStream.setLocalRenderMode({
            width: 200,
            height: 200,
            cut: false
          })
        }
        return localStream
      }
      
      joinButton.onclick = async ()=>{
        const channelName = channelInput.value
        const uid = uidInput.value
        await client.join({
          channelName,
          uid,
        })
        getLocalStream()
        await client.publish(localStream)
        if (document.getElementById("defaultOpenMic").checked){
          await localStream.open({type: "audio"})
          localStream.play(localContainer, {audio: true})
        }
        if (document.getElementById("defaultOpenCamera").checked){
          const cameras = await NERTC.getCameras()
          let deviceId = ""
          if (cameras.length){
            deviceId = cameras[i % cameras.length].deviceId
          }
          await localStream.open({type: "video", deviceId})
          await localStream.play(localContainer, {video: true})
        }
      }

      leaveButton.onclick = async ()=>{
        client.leave()
      }
      
      destroyButton.onclick = async ()=>{
        client.destroy()
      }
      
      openAudioInput.onclick = async ()=>{
        getLocalStream().open({type: "audio"})
        getLocalStream().play(localContainer, {audio: true})
      }
      
      closeAudioInput.onclick = async ()=>{
        getLocalStream().close({type: "audio"})
      }
      
      openVideoInput.onclick = async ()=>{
        await getLocalStream().open({type: "video"})
        await getLocalStream().play(localContainer, {video: true})
      }

      closeVideoInput.onclick = async ()=>{
        getLocalStream().close({type: "video"})
      }

      openBeautyInput.onclick = async () => {
        await getLocalStream().setBeautyEffect(true);
      }

      openLutInput.onclick = () => {
        getLocalStream().setFilter('landiao', 1);
      }

      closeBeautyInput.onclick = async () => {
        await getLocalStream().setBeautyEffect(false);
      }

      //背景分割
        const virtualBackgroundPluginConfig = {
        development: {
            key: 'VirtualBackground',
            pluginUrl: './js/nim/NIM_Web_VirtualBackground.js',
            wasmUrl: 'https://yx-web-nosdn.netease.im/sdk-release/nn_segment_normal.wasm' + `?time=${Math.random()}`,
        }, 
        production: {
            key: 'VirtualBackground',
            pluginUrl: `./js/nim/NIM_Web_VirtualBackground_v${NERTC.VERSION}.js`,
            wasmUrl: 'https://yx-web-nosdn.netease.im/sdk-release/nn_segment_normal.wasm' + `?time=${Math.random()}`,
        },
        test: {
            key: 'VirtualBackground',
            pluginUrl: `./js/nim/NIM_Web_VirtualBackground_v${NERTC.VERSION}_test.js`,
            wasmUrl: 'https://yx-web-nosdn.netease.im/sdk-release/nn_segment_normal.wasm' + `?time=${Math.random()}`,
        } 
        };
        const segment_config = virtualBackgroundPluginConfig[NERTC.ENV];

        //高级美颜
        const advancedBeautyPluginConfig = {
        development: {
            key: 'AdvancedBeauty',
            pluginUrl: './js/nim/NIM_Web_AdvancedBeauty.js',
            wasmUrl: 'https://yx-web-nosdn.netease.im/sdk-release/ne_face_points.wasm' + `?time=${Math.random()}`,
        }, 
        production: {
            key: 'AdvancedBeauty',
            pluginUrl: `./js/nim/NIM_Web_AdvancedBeauty_v${NERTC.VERSION}.js`,
            wasmUrl: 'https://yx-web-nosdn.netease.im/sdk-release/ne_face_points.wasm' + `?time=${Math.random()}`,
        },
        test: {
            key: 'AdvancedBeauty',
            pluginUrl: `./js/nim/NIM_Web_AdvancedBeauty_v${NERTC.VERSION}_test.js`,
            wasmUrl: 'https://yx-web-nosdn.netease.im/sdk-release/ne_face_points.wasm' + `?time=${Math.random()}`,
        } 
        };
        const beauty_config = advancedBeautyPluginConfig[NERTC.ENV];
        //高级美颜
        registerAdvBeautyInput.onclick = async () => {
            $('#advancedBeautyStatus').html('高级美颜loading').show();
            await getLocalStream().registerPlugin(beauty_config);
            getLocalStream().on('plugin-load', onPluginLoaded);
        }

        openAdvBeautyInput.onclick = async () => {
            await getLocalStream().enableAdvancedBeauty(1);
            await getLocalStream().setAdvBeautyEffect('vShapedFace', 1);
            await getLocalStream().setAdvBeautyEffect('shrinkFace', 1);
        }

        closeAdvBeautyInput.onclick = async () => {
            await getLocalStream().disableAdvancedBeauty(false);
            $('#advancedBeautyStatus').hide();
        }

        resetAdvBeautyInput.onclick = async () => {
            await getLocalStream().setAdvBeautyEffect('reset');
            $('#advancedBeautyStatus').hide();
        }

        destroyAdvBeautyInput.onclick = async () => {
            await getLocalStream().unregisterPlugin(beauty_config.key);
            $('#advancedBeautyStatus').hide();
        }
        // 背景分割
        registerVitrualBackgroundInput.onclick = async () => {
            $('#segmentStatus').html('背景分割loading').show();
            await getLocalStream().registerPlugin(segment_config);
            getLocalStream().on('plugin-load', onPluginLoaded);
        }

        openVitrualBackgroundInput.onclick = async () => {
            await getLocalStream().enableBodySegment();
        }

        closeVitrualBackgroundInput.onclick = async () => {
            await getLocalStream().disableBodySegment();
            $('#segmentStatus').hide();
        }

        destroyVitrualBackgroundInput.onclick = async () => {
            await getLocalStream().unregisterPlugin(segment_config.key);
            $('#segmentStatus').hide();
        }

        function onPluginLoaded(name) {
            console.log('onPluginLoaded: ', name)
            if (name == 'VirtualBackground') {
                $('#segmentStatus').html(`${localStreamInfo.innerText} 背景分割loaded`).show();
            } else if (name == 'AdvancedBeauty') {
                $('#advancedBeautyStatus').html(`${localStreamInfo.innerText} 高级美颜loaded`).show();
            }
        }

    }
  }
  main()
</script>
<script ></script>
</body>
</html>
