<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <link rel="icon" href="data:,">
  <title>多实例测试</title>
</head>
<body>
<label><input type="checkbox" id="defaultOpenMic">打开麦克风</label>
<label><input type="checkbox" id="defaultOpenCamera" checked>打开摄像头</label>
<label><input type="checkbox" id="defaultOpenScreen">打开屏幕共享</label>
<label><input type="checkbox" id="dualStreamVideo">主流小流</label>
<label><input type="checkbox" id="dualStreamScreen">辅流小流</label>
<label id="segmentStatus" style="display: none;"></label>
<label id="advancedBeautyStatus" style="display: none;"></label>
<label id="audioEffectStatus" style="display: none;"></label>
<label id="AIhowlingStatus" style="display: none;"></label>
<div id="howling-content" style="height: 200px;overflow: scroll;display: none;">
</div>
<div id="views">

</div>
<script>
  var searchParams = new URLSearchParams(location.search);
  const COUNT = parseInt(searchParams.get("count"))
  if (!COUNT){
    searchParams.set("count", 4)
    window.location.href = `${window.location.pathname}?${searchParams.toString()}`
  }
</script>
<script src="./js/nim/NIM_Web_NERTC.js"></script>
<script src="./js/lib/jquery.min.js"></script>
<script src="./js//lib/wasmFeatureDetect.js"></script>
<script>
  window.clients = {}
  const channelName = Math.floor(Math.random() * 9000) + 1000

  //AI音效
  const aiAudioEffectsPluginConfig = {
  development: {
    simd: {
      key: 'AIAudioEffects',
      pluginUrl: './js/nim/NIM_Web_AIAudioEffects.js',
      wasmUrl: './js/nim/wasm/NIM_Web_AIAudioEffects_simd.wasm' + `?time=${Math.random()}`,
    },
    nosimd: {
      key: 'AIAudioEffects',
      pluginUrl: './js/nim/NIM_Web_AIAudioEffects.js',
      wasmUrl: './js/nim/wasm/NIM_Web_AIAudioEffects_nosimd.wasm' + `?time=${Math.random()}`
    }
  },
  production: {
    simd: {
      key: 'AIAudioEffects',
      pluginUrl: `./js/nim/NIM_Web_AIAudioEffects_v${NERTC.VERSION}.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIAudioEffects_simd_v${NERTC.VERSION}.wasm`
    },
    nosimd: {
      key: 'AIAudioEffects',
      pluginUrl: `./js/nim/NIM_Web_AIAudioEffects_v${NERTC.VERSION}.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIAudioEffects_nosimd_v${NERTC.VERSION}.wasm`
    }
  },
  test: {
    simd: {
      key: 'AIAudioEffects',
      pluginUrl: `./js/nim/NIM_Web_AIAudioEffects_v${NERTC.VERSION}_test.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIAudioEffects_simd_v${NERTC.VERSION}_test.wasm`
    },
    nosimd: {
      key: 'AIAudioEffects',
      pluginUrl: `./js/nim/NIM_Web_AIAudioEffects_v${NERTC.VERSION}_test.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIAudioEffects_nosimd_v${NERTC.VERSION}_test.wasm`
    }
  }
}

//啸叫检测
const aiHowlingPluginConfig = {
  development: {
    simd: {
      key: 'AIhowling',
      pluginUrl: './js/nim/NIM_Web_AIhowling.js',
      wasmUrl: './js/nim/wasm/NIM_Web_AIhowling_simd.wasm' + `?time=${Math.random()}`
    },
    nosimd: {
      key: 'AIhowling',
      pluginUrl: './js/nim/NIM_Web_AIhowling.js',
      wasmUrl: './js/nim/wasm/NIM_Web_AIhowling_nosimd.wasm' + `?time=${Math.random()}`
    }
  },
  production: {
    simd: {
      key: 'AIhowling',
      pluginUrl: `./js/nim/NIM_Web_AIhowling_v${NERTC.VERSION}.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIhowling_simd_v${NERTC.VERSION}.wasm`
    },
    nosimd: {
      key: 'AIhowling',
      pluginUrl: `./js/nim/NIM_Web_AIhowling_v${NERTC.VERSION}.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIhowling_nosimd_v${NERTC.VERSION}.wasm`
    }
  },
  test: {
    simd: {
      key: 'AIhowling',
      pluginUrl: `./js/nim/NIM_Web_AIhowling_v${NERTC.VERSION}_test.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIhowling_simd_v${NERTC.VERSION}_test.wasm`
    },
    nosimd: {
      key: 'AIhowling',
      pluginUrl: `./js/nim/NIM_Web_AIhowling_v${NERTC.VERSION}_test.js`,
      wasmUrl: `./js/nim/wasm/NIM_Web_AIhowling_nosimd_v${NERTC.VERSION}_test.wasm`
    }
  }
}

  const main = async ()=>{
    for (let i = 0; i < COUNT; i++){
      const wrapper = document.createElement('div')
      
      const channelPanel = document.createElement('div')
      const audioPanel = document.createElement('div')
      const videoPanel = document.createElement('div')
      const screenPanel = document.createElement('div')
      const screenAudioPanel = document.createElement('div')
      const beautyPanel = document.createElement('div')
      const audioProcessingPanel = document.createElement('div')
      const statsPanel = document.createElement('div')
      
      const localContainer = document.createElement('div')
      const remoteContainer = document.createElement('div')
      const statsContainer = document.createElement('pre')
      $(wrapper).appendTo("views")
      $(channelPanel).appendTo(wrapper)
      $(audioPanel).appendTo(wrapper)
      $(videoPanel).appendTo(wrapper)
      $(screenPanel).appendTo(wrapper)
      $(screenAudioPanel).appendTo(wrapper)
      $(beautyPanel).appendTo(wrapper)
      $(audioProcessingPanel).appendTo(wrapper)
      $(statsPanel).appendTo(wrapper)
      $(localContainer).appendTo(wrapper)
      $(remoteContainer).appendTo(wrapper)
      $(statsContainer).appendTo(wrapper)

      wrapper.style.clear = "both"
      localContainer.style.width = "400px"
      localContainer.style.height = "200px"
      localContainer.style.float = "left"
      remoteContainer.style.width = "800px"
      remoteContainer.style.height = "200px"
      remoteContainer.style.float = "left"
      
      
      $(`<span>频道号: </span>`).appendTo(channelPanel)
      const channelInput = document.createElement('input')
      channelInput.value = channelName
      $(channelInput).appendTo(channelPanel)

      $(`<span>uid: </span>`).appendTo(channelPanel)
      const uidInput = document.createElement('input')
      uidInput.value = channelName * 100 + i
      $(uidInput).appendTo(channelPanel)

      const joinButton = document.createElement('button')
      joinButton.innerText = "加入频道"
      $(joinButton).appendTo(channelPanel)
      
      const leaveButton = document.createElement('button')
      leaveButton.innerText = "离开频道"
      $(leaveButton).appendTo(channelPanel)

      const destroyButton = document.createElement('button')
      destroyButton.innerText = "销毁"
      $(destroyButton).appendTo(channelPanel)

      $("<span> </span>").appendTo(channelPanel)

      const openAudioInput = document.createElement("button")
      openAudioInput.innerText = "打开音频"
      $(openAudioInput).appendTo(audioPanel)

      const closeAudioInput = document.createElement("button")
      closeAudioInput.innerText = "关闭音频"
      $(closeAudioInput).appendTo(audioPanel)

      const $muteAudio = $(`<button>muteAudio</button>`)
      $muteAudio.appendTo(audioPanel)

      const $unmuteAudio = $(`<button>unmuteAudio</button>`)
      $unmuteAudio.appendTo(audioPanel)

      $(`<span>音量: </span>`).appendTo(audioPanel)
      const $volumeInput = $(`<input type="number" value="100" step="10">`)
      $volumeInput.appendTo(audioPanel)
      const $setVolumeBtn = $(`<button>设置音量</button>`)
      $setVolumeBtn.appendTo(audioPanel)
      
      const openVideoInput = document.createElement("button")
      openVideoInput.innerText = "打开视频"
      $(openVideoInput).appendTo(videoPanel)

      const closeVideoInput = document.createElement("button")
      closeVideoInput.innerText = "关闭视频"
      $(closeVideoInput).appendTo(videoPanel)
      
      const $muteVideo = $(`<button>muteVideo</button>`)
      $muteVideo.appendTo(videoPanel)

      const $unmuteVideo = $(`<button>unmuteVideo</button>`)
      $unmuteVideo.appendTo(videoPanel)

      const $takeVideoSnapshot = $(`<button>$takeVideoSnapshot</button>`)
      $takeVideoSnapshot.appendTo(videoPanel)

      const $takeVideoSnapshotBase64 = $(`<button>$takeVideoSnapshotBase64</button>`)
      $takeVideoSnapshotBase64.appendTo(videoPanel)
      
      const openScreenInput = document.createElement("button")
      openScreenInput.innerText = "打开屏幕共享"
      $(openScreenInput).appendTo(screenPanel)

      const closeScreenInput = document.createElement("button")
      closeScreenInput.innerText = "关闭屏幕共享"
      $(closeScreenInput).appendTo(screenPanel)

      const $muteScreen = $(`<button>muteScreen</button>`)
      $muteScreen.appendTo(screenPanel)
      
      const $unmuteScreen = $(`<button>unmuteScreen</button>`)
      $unmuteScreen.appendTo(screenPanel)


      const $takeScreenSnapshot = $(`<button>$takeScreenSnapshot</button>`)
      $takeScreenSnapshot.appendTo(screenPanel)

      const $takeScreenSnapshotBase64 = $(`<button>$takeScreenSnapshotBase64</button>`)
      $takeScreenSnapshotBase64.appendTo(screenPanel)

      const closeScreenAudioInput = document.createElement("button")
      closeScreenAudioInput.innerText = "关闭辅流音频"
      $(closeScreenAudioInput).appendTo(screenAudioPanel)

      const $muteAudioSlave = $(`<button>muteAudioSlave</button>`)
      $muteAudioSlave.appendTo(screenAudioPanel)

      const $unmuteAudioSlave = $(`<button>unmuteAudioSlave</button>`)
      $unmuteAudioSlave.appendTo(screenAudioPanel)
      
      /////////////////////////////// 美颜
      $("<span>美颜：</span>").appendTo(beautyPanel)
      
      const openBeautyInput = document.createElement("button")
      openBeautyInput.innerText = "开启美颜"
      $(openBeautyInput).appendTo(beautyPanel)

      const openLutInput = document.createElement("button")
      openLutInput.innerText = "蓝调滤镜"
      $(openLutInput).appendTo(beautyPanel)

      const closeBeautyInput = document.createElement("button")
      closeBeautyInput.innerText = "关闭美颜"
      $(closeBeautyInput).appendTo(beautyPanel)

      $("<span>高级美颜:</span>").appendTo(beautyPanel)

      const registerAdvBeautyInput = document.createElement("button")
      registerAdvBeautyInput.innerText = "注册"
      $(registerAdvBeautyInput).appendTo(beautyPanel)

      const openAdvBeautyInput = document.createElement("button")
      openAdvBeautyInput.innerText = "打开"
      $(openAdvBeautyInput).appendTo(beautyPanel)

      const closeAdvBeautyInput = document.createElement("button")
      closeAdvBeautyInput.innerText = "关闭"
      $(closeAdvBeautyInput).appendTo(beautyPanel)

      const resetAdvBeautyInput = document.createElement("button")
      resetAdvBeautyInput.innerText = "重置"
      $(resetAdvBeautyInput).appendTo(beautyPanel)

      const destroyAdvBeautyInput = document.createElement("button")
      destroyAdvBeautyInput.innerText = "销毁"
      $(destroyAdvBeautyInput).appendTo(beautyPanel)

      $("<span>背景分割:</span>").appendTo(beautyPanel)
      
      const registerVitrualBackgroundInput = document.createElement("button")
      registerVitrualBackgroundInput.innerText = "注册"
      $(registerVitrualBackgroundInput).appendTo(beautyPanel)

      const openVitrualBackgroundInput = document.createElement("button")
      openVitrualBackgroundInput.innerText = "打开"
      $(openVitrualBackgroundInput).appendTo(beautyPanel)

      const closeVitrualBackgroundInput = document.createElement("button")
      closeVitrualBackgroundInput.innerText = "关闭"
      $(closeVitrualBackgroundInput).appendTo(beautyPanel)

      const destroyVitrualBackgroundInput = document.createElement("button")
      destroyVitrualBackgroundInput.innerText = "销毁"
      $(destroyVitrualBackgroundInput).appendTo(beautyPanel)

      /////////////////////// AI音效
      $("<span>AI音效:</span>").appendTo(audioProcessingPanel)

      const registerAIAudioEffects = document.createElement("button")
      registerAIAudioEffects.innerText = "注册"
      $(registerAIAudioEffects).appendTo(audioProcessingPanel)

      const unregisterAIAudioEffects = document.createElement("button")
      unregisterAIAudioEffects.innerText = "销毁"
      $(unregisterAIAudioEffects).appendTo(audioProcessingPanel)

      $("<span>美声变声:</span>").appendTo(audioProcessingPanel)

      const enableAudioEffect = document.createElement("button")
      enableAudioEffect.innerText = "打开"
      $(enableAudioEffect).appendTo(audioProcessingPanel)

      const disableAudioEffect = document.createElement("button")
      disableAudioEffect.innerText = "关闭"
      $(disableAudioEffect).appendTo(audioProcessingPanel)

      $("<span>AI降噪:</span>").appendTo(audioProcessingPanel)

      const enableAIDenoiseInput = document.createElement("button")
      enableAIDenoiseInput.innerText = "打开"
      $(enableAIDenoiseInput).appendTo(audioProcessingPanel)

      const disableAIDenoiseInput = document.createElement("button")
      disableAIDenoiseInput.innerText = "关闭"
      $(disableAIDenoiseInput).appendTo(audioProcessingPanel)

      ////////////////////// 啸叫检测
      $("<span>啸叫检测:</span>").appendTo(audioProcessingPanel)

      const registerAIhowling = document.createElement("button")
      registerAIhowling.innerText = "注册"
      $(registerAIhowling).appendTo(audioProcessingPanel)

      const unregisterAIhowling = document.createElement("button")
      unregisterAIhowling.innerText = "销毁"
      $(unregisterAIhowling).appendTo(audioProcessingPanel)

      const enableAIhowling = document.createElement("button")
      enableAIhowling.innerText = "打开"
      $(enableAIhowling).appendTo(audioProcessingPanel)

      const disableAIhowling = document.createElement("button")
      disableAIhowling.innerText = "关闭"
      $(disableAIhowling).appendTo(audioProcessingPanel)

      /////////////////////// Stats

      $("<span>Stats</span>").appendTo(statsPanel)
      const getSessionStatsBtn = document.createElement("button")
      getSessionStatsBtn.innerText = "getSessionStats"
      $(getSessionStatsBtn).appendTo(statsPanel)
      const getSystemStatsBtn = document.createElement("button")
      getSystemStatsBtn.innerText = "getSystemStats"
      $(getSystemStatsBtn).appendTo(statsPanel)
      const getTransportStatsBtn = document.createElement("button")
      getTransportStatsBtn.innerText = "getTransportStats"
      $(getTransportStatsBtn).appendTo(statsPanel)
      const getStatsOffBtn = document.createElement("button")
      getStatsOffBtn.innerText = "关闭"
      $(getStatsOffBtn).appendTo(statsPanel)
      
      const localStreamInfo = document.createElement("div")
      $(localStreamInfo).appendTo(statsPanel)

      document.getElementById('views').appendChild(wrapper)
      const client = NERTC.createClient({
        appkey: "eca23f68c66d4acfceee77c200200359",
        debug: true
      })
      NERTC.Logger.enableLogUpload();
      window.clients[i] = client
      client.on('stream-added', (evt)=>{
        client.subscribe(evt.stream)
      })
      client.on('stream-subscribed', (evt)=>{
        console.log(`${channelName} ${evt.stream.streamID}`)
        evt.stream.setRemoteRenderMode({
          width: 200,
          height: 200,
          cut: false
        })
        evt.stream.play(remoteContainer)
      })
      
      NERTC.getParameters().allowEmptyMedia = true
      let localStream = null
      const getLocalStream = ()=>{
        if (!localStream || localStream.destroyed){
          localStream = NERTC.createStream({
            audio: false,
            video: false,
            client: client,
          })
          localStreamInfo.innerText = "localstream_" + localStream.localStreamId
          localStream.init()
          localStream.setLocalRenderMode({
            width: 200,
            height: 200,
            cut: false
          })
        }
        return localStream
      }
      
      joinButton.onclick = async ()=>{
        const channelName = channelInput.value
        const uid = uidInput.value
        await client.join({
          channelName,
          uid,
        })
        getLocalStream()
        const dualStreamVideo = document.getElementById('dualStreamVideo').checked
        const dualStreamScreen = document.getElementById('dualStreamScreen').checked
        console.log('主流小流是否开启：', dualStreamVideo, '辅流小流是否开启：', dualStreamVideo)
        client.enableDualStream({
          video: dualStreamVideo,
          screen: dualStreamScreen
        })
        await client.publish(localStream)
        if (document.getElementById("defaultOpenMic").checked){
          await localStream.open({type: "audio"})
        }
        if (document.getElementById("defaultOpenCamera").checked){
          const cameras = await NERTC.getCameras()
          let deviceId = ""
          if (cameras.length){
            deviceId = cameras[i % cameras.length].deviceId
          }
          await localStream.open({type: "video", deviceId})
          await localStream.play(localContainer, {video: true})
        }
        if (document.getElementById("defaultOpenScreen").checked){
          await localStream.open({type: "screen", screenAudio: true})
          await localStream.play(localContainer, {screen: true})
        }
      }

      leaveButton.onclick = async ()=>{
        client.leave()
      }
      
      destroyButton.onclick = async ()=>{
        client.destroy()
      }
      
      openAudioInput.onclick = async ()=>{
        getLocalStream().open({type: "audio"})
        getLocalStream().play(localContainer, {audio: true})
      }
      
      closeAudioInput.onclick = async ()=>{
        getLocalStream().close({type: "audio"})
      }
      
      openVideoInput.onclick = async ()=>{
        await getLocalStream().open({type: "video"})
        await getLocalStream().play(localContainer, {video: true})
      }

      closeVideoInput.onclick = async ()=>{
        getLocalStream().close({type: "video"})
      }

      openScreenInput.onclick = async ()=>{
        await getLocalStream().open({type: "screen", screenAudio: true})
        await getLocalStream().play(localContainer, {screen: true})
      }

      closeScreenInput.onclick = async ()=>{
        getLocalStream().close({type: "screen"})
      }

      closeScreenAudioInput.onclick = async ()=>{
        getLocalStream().close({type: "screenAudio"})
      }

      openBeautyInput.onclick = async () => {
        await getLocalStream().setBeautyEffect(true);
      }

      registerAIAudioEffects.onclick = async () =>{
        const type = (await wasmFeatureDetect.simd()) ? 'simd' : 'nosimd'
        audioEffects_config = aiAudioEffectsPluginConfig[NERTC.ENV][type]
        $('#audioEffectStatus').html('AI音效loading').show()
        await getLocalStream().registerPlugin(audioEffects_config)

        getLocalStream().on('plugin-load', onPluginLoaded);
        getLocalStream().on('audio-effect-enabled', () => {
          console.warn('AI音效已开启')
          getLocalStream().setAudioEffect(0, 2)
        })
      }

      enableAudioEffect.onclick = async () => {
        getLocalStream().enableAudioEffect()
        console.log('打开美声变声')
      }

      disableAudioEffect.onclick = async () => {
        getLocalStream().disableAudioEffect()
        console.log('关闭美声变声')
        $('#audioEffectStatus').hide()
      }

      enableAIDenoiseInput.onclick = async () =>{
        getLocalStream().enableAIDenoise()
        console.log('打开AI降噪')
      }

      disableAIDenoiseInput.onclick = async () =>{
        getLocalStream().disableAIDenoise()
        console.log('关闭AI降噪')
        $('#audioEffectStatus').hide()
      }

      unregisterAIAudioEffects.onclick = async ()=>{
        getLocalStream().unregisterPlugin('AIAudioEffects')
        getLocalStream().off('audio-effect-enabled')
        $('#audioEffectStatus').hide()
      }

      registerAIhowling.onclick = async () =>{
        const type = (await wasmFeatureDetect.simd()) ? 'simd' : 'nosimd'
        aiHowling_config = aiHowlingPluginConfig[NERTC.ENV][type]
        $('#AIhowlingStatus').html('啸叫检测loading').show()
        await getLocalStream().registerPlugin(aiHowling_config)

        getLocalStream().on('plugin-load', onPluginLoaded);
      }

      enableAIhowling.onclick = async () => {
        function addHowlingStatus(info) {
          console.warn('info')
          const howlingContent = $('#howling-content').show().get(0)
          if(info) {
            console.warn('啸叫状态：', info)
            howlingContent.innerHTML = howlingContent.innerHTML +`<p style="color:#ff0000">${localStreamInfo.innerText} 啸叫状态： ${info}</p>`
          } else {
            howlingContent.innerHTML = howlingContent.innerHTML +`<p>${localStreamInfo.innerText} 啸叫状态： ${info}</p>`
          }
        }
        getLocalStream().onAudioHasHowling(addHowlingStatus)
        getLocalStream().enableAIhowling()

        console.log('打开啸叫检测')
      }

      disableAIhowling.onclick = async () => {
        getLocalStream().disableAIhowling()
        console.log('关闭啸叫检测')
        $('#AIhowlingStatus').hide()
        $('#howling-content').hide()
      }

      unregisterAIhowling.onclick = async ()=>{
        getLocalStream().unregisterPlugin('AIhowling')
        $('#AIhowlingStatus').hide()
        $('#howling-content').hide()
      }

      openLutInput.onclick = () => {
        getLocalStream().setFilter('landiao', 1);
      }

      closeBeautyInput.onclick = async () => {
        await getLocalStream().setBeautyEffect(false);
      }
      
      $setVolumeBtn.on('click', ()=>{
        const captureVolume = $volumeInput.val()
        console.log("设置音量", captureVolume)
        getLocalStream().setCaptureVolume(captureVolume)
      })

      $muteAudio[0].onclick = async ()=>{
        console.log('muteAudio')
        getLocalStream().muteAudio()
      }

      $unmuteAudio[0].onclick = async ()=>{
        console.log('unmuteAudio')
        getLocalStream().unmuteAudio()
      }

      $muteVideo[0].onclick = async ()=>{
        console.log('muteVideo')
        getLocalStream().muteVideo()
      }

      $unmuteVideo[0].onclick = async ()=>{
        console.log('unmuteVideo')
        getLocalStream().unmuteVideo()
      }

      $muteScreen[0].onclick = async ()=>{
        console.log('muteScreen')
        getLocalStream().muteScreen()
      }

      $unmuteScreen[0].onclick = async ()=>{
        console.log('unmuteScreen')
        getLocalStream().unmuteScreen()
      }

      $muteAudioSlave[0].onclick = async ()=>{
        getLocalStream().muteAudioSlave()
      }

      $unmuteAudioSlave[0].onclick = async ()=>{
        getLocalStream().unmuteAudioSlave()
      }

      $takeVideoSnapshot[0].onclick = async ()=>{
        getLocalStream().takeSnapshot({
          mediaType: 'video',
        })
      }
      
      $takeVideoSnapshotBase64[0].onclick = async ()=>{
        const base64 = getLocalStream().takeSnapshotBase64({
          mediaType: 'video',
        })
        console.log(base64)
        console.log(`%c `, `padding: 200px 200px; background-image: url(${base64})`)
      }
      
      $takeScreenSnapshot[0].onclick = async ()=>{
        getLocalStream().takeSnapshot({
          mediaType: 'screen',
        })
      }

      $takeScreenSnapshotBase64[0].onclick = async ()=>{
        const base64 = getLocalStream().takeSnapshotBase64({
          mediaType: 'screen',
        })
        console.log(base64)
        console.log(`%c `, `padding: 200px 200px; background-image: url(${base64})`)
      }

      let statsStatus = "getStatsOff"
      let statsTimer = setInterval(async ()=>{
        let text = ""
        if (statsStatus === "getSessionStats"){
          const sessionStats = await client.getSessionStats()
          text = JSON.stringify(sessionStats, null, 2)
        } else if (statsStatus === "getSystemStats"){
          const systemStats = await client.getSystemStats()
          text = JSON.stringify(systemStats, null, 2)
        } else if (statsStatus === "getTransportStats"){
          const transportStats = await client.getTransportStats()
          text = JSON.stringify(transportStats, null, 2)
        }
        if (statsContainer.innerText !== text){
          statsContainer.innerText = text
        }
      }, 2000)
      getSessionStatsBtn.onclick = ()=>{
        statsStatus = "getSessionStats"
      }
      getSystemStatsBtn.onclick = ()=>{
        statsStatus = "getSystemStats"
      }
      getTransportStatsBtn.onclick = ()=>{
        statsStatus = "getTransportStats"
      }
      getStatsOffBtn.onclick = ()=>{
        statsStatus = "getStatsOff"
      }
      //背景分割
      const virtualBackgroundPluginConfig = {
        development: {
          simd: {
            key: "VirtualBackground",
            pluginUrl: "./js/nim/NIM_Web_VirtualBackground.js",
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_segment_normal.wasm" +
              `?time=${Math.random()}`,
          },
          nosimd: {
            key: "VirtualBackground",
            pluginUrl: "./js/nim/NIM_Web_VirtualBackground.js",
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_segment_normal_nosimd.wasm" +
              `?time=${Math.random()}`,
          },
        },
        production: {
          simd: {
            key: "VirtualBackground",
            pluginUrl: `./js/nim/NIM_Web_VirtualBackground_v${NERTC.VERSION}.js`,
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_segment_normal.wasm" +
              `?time=${Math.random()}`,
          },
          nosimd: {
            key: "VirtualBackground",
            pluginUrl: `./js/nim/NIM_Web_VirtualBackground_v${NERTC.VERSION}.js`,
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_segment_normal_nosimd.wasm" +
              `?time=${Math.random()}`,
          },
        },
        test: {
          simd: {
            key: "VirtualBackground",
            pluginUrl: `./js/nim/NIM_Web_VirtualBackground_v${NERTC.VERSION}_test.js`,
             wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_segment_normal.wasm" +
              `?time=${Math.random()}`,
          },
          nosimd: {
            key: "VirtualBackground",
            pluginUrl: `./js/nim/NIM_Web_VirtualBackground_v${NERTC.VERSION}_test.js`,
             wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_segment_normal_nosimd.wasm" +
              `?time=${Math.random()}`,
          },
        },
      };
      const type = (await wasmFeatureDetect.simd()) ? "simd" : "nosimd";
      const segment_config = virtualBackgroundPluginConfig[NERTC.ENV][type];

      //高级美颜
      const advancedBeautyPluginConfig = {
        development: {
          simd: {
            key: "AdvancedBeauty",
            pluginUrl: "./js/nim/NIM_Web_AdvancedBeauty.js",
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_face_points.wasm" +
              `?time=${Math.random()}`,
          },
          nosimd: {
            key: "AdvancedBeauty",
            pluginUrl: "./js/nim/NIM_Web_AdvancedBeauty.js",
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_face_points_nosimd.wasm" +
              `?time=${Math.random()}`,
          },
        },
        production: {
          simd: {
            key: "AdvancedBeauty",
            pluginUrl: `./js/nim/NIM_Web_AdvancedBeauty_v${NERTC.VERSION}.js`,
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_face_points.wasm" +
              `?time=${Math.random()}`,
          },
          nosimd: {
            key: "AdvancedBeauty",
            pluginUrl: `./js/nim/NIM_Web_AdvancedBeauty_v${NERTC.VERSION}.js`,
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_face_points_nosimd.wasm" +
              `?time=${Math.random()}`,
          },
        },
        test: {
          simd: {
            key: "AdvancedBeauty",
            pluginUrl: `./js/nim/NIM_Web_AdvancedBeauty_v${NERTC.VERSION}_test.js`,
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_face_points.wasm" +
              `?time=${Math.random()}`,
          },
          nosimd: {
            key: "AdvancedBeauty",
            pluginUrl: `./js/nim/NIM_Web_AdvancedBeauty_v${NERTC.VERSION}_test.js`,
            wasmUrl:
              "https://yx-web-nosdn.netease.im/sdk-release/ne_face_points_nosimd.wasm" +
              `?time=${Math.random()}`,
          },
        },
      };
      const beauty_config = advancedBeautyPluginConfig[NERTC.ENV][type];

        //高级美颜
        registerAdvBeautyInput.onclick = async () => {
            $('#advancedBeautyStatus').html('高级美颜loading').show();
            await getLocalStream().registerPlugin(beauty_config);
            getLocalStream().on('plugin-load', onPluginLoaded);
        }

        openAdvBeautyInput.onclick = async () => {
            await getLocalStream().enableAdvancedBeauty(1);
            await getLocalStream().setAdvBeautyEffect('vShapedFace', 1);
            await getLocalStream().setAdvBeautyEffect('shrinkFace', 1);
        }

        closeAdvBeautyInput.onclick = async () => {
            await getLocalStream().disableAdvancedBeauty(false);
            $('#advancedBeautyStatus').hide();
        }

        resetAdvBeautyInput.onclick = async () => {
            await getLocalStream().setAdvBeautyEffect('reset');
            $('#advancedBeautyStatus').hide();
        }

        destroyAdvBeautyInput.onclick = async () => {
            await getLocalStream().unregisterPlugin(beauty_config.key);
            $('#advancedBeautyStatus').hide();
        }
        // 背景分割
        registerVitrualBackgroundInput.onclick = async () => {
            $('#segmentStatus').html('背景分割loading').show();
            await getLocalStream().registerPlugin(segment_config);
            getLocalStream().on('plugin-load', onPluginLoaded);
        }

        openVitrualBackgroundInput.onclick = async () => {
            await getLocalStream().enableBodySegment();
        }

        closeVitrualBackgroundInput.onclick = async () => {
            await getLocalStream().disableBodySegment();
            $('#segmentStatus').hide();
        }

        destroyVitrualBackgroundInput.onclick = async () => {
            await getLocalStream().unregisterPlugin(segment_config.key);
            $('#segmentStatus').hide();
        }

        function onPluginLoaded(name) {
            console.log('onPluginLoaded: ', name)
            if (name == 'VirtualBackground') {
                $('#segmentStatus').html(`${localStreamInfo.innerText} 背景分割loaded`).show();
            } else if (name == 'AdvancedBeauty') {
                $('#advancedBeautyStatus').html(`${localStreamInfo.innerText} 高级美颜loaded`).show();
            } else if (name == 'AIAudioEffects') {
                $('#audioEffectStatus').html(`${localStreamInfo.innerText} AI音效loaded`).show()
            } else if (name == 'AIhowling') {
              $('#AIhowlingStatus').html(`${localStreamInfo.innerText} 啸叫检测loaded`).show()
            }
        }

    }
  }
  main()
</script>
<script ></script>
</body>
</html>
