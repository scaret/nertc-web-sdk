<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
</head>

<body>

<h1>1. 一些常用链接</h1>
<ol>
  <li><a href="./webrtc2.html">大白页</a></li>
  <li><a href="./webrtc2.html?joinFirstTimeout=30000&reconnectionFirstTimeout=30000">joinFirstTimeout=30000&reconnectionFirstTimeout=30000 - 媒体服务器建连及重连超时由2秒改到30秒</a></li>
  <li><a href="./webrtc2.html?enableUdpCandidate=false">enableUdpCandidate=false - 只允许TCP传输</a></li>
  <li><a href="./webrtc2.html?enableTcpCandidate=false">enableTcpCandidate=false - 只允许UDP传输</a></li>
  <li><a href="./webrtc2.html?enableAlerter=nolistener">enableAlerter=nolistener - 没有监听指定事件时弹窗</a></li>
  <li><a href="./webrtc2.html?enableAlerter=always">enableAlerter=always - 总是弹窗（chrome版本过低时、意外退出频道时、自动播放被阻止时）</a></li>

</ol>

<h1>2. 改进日志上传查看体验</h1>
<pre>
      1. 将这个超链接拖拽到书签栏： <a id="logBookmark" href="javascript: alert('Hi')">日志上传打印</a>
      2. 用Chrome打开一个 Kibana 日志页面，按【option+Command+I】打开Console。
      3. 点击刚刚拖拽上去的书签。点击后，Kibana 日志会转化到Chrome的Console内。
</pre>

  <h1>3. 如何测试Electron</h1>
  <pre>
  0. 参考文章：https://www.electronjs.org/docs/tutorial/application-distribution#with-an-app-source-code-archive
  1. 下载对应版本的Electron Release：https://www.electronjs.org/docs/tutorial/application-distribution
  2. 下载对应构建的electronApp.zip文件，例如 https://ip-10-246-152-16.wrtc.dev:4000/by-build/v4.2.0-dev-73-ge9ce789/electronApp.zip
  3. 将electronApp解压到对应路径，如 electron/Electron.app/Contents/Resources/app/
  4. 双击图标
</pre>

<h1>4. 如何生成主分支的最新build</h1>
<pre>
  1. 打开 http://yunxin-jenkins.netease.im:8080/view/WebSDK/job/nertc-web-sdk-daily-build/
  2. 按一下 Build Now
</pre>
  
<script id="printLogScript" type="text">
var logIndex = 0;
var logHeadStart = 0;
var lostLogCnt = 0;

async function scrollBottom(){
  let scrollTopHistory = document.body.parentElement.scrollTop;
  let scrollNotChangedCnt = 0;
  for (let i = 0; i < 100; i++){
    document.body.parentElement.scrollTop = 500000;
    await new Promise((res)=>{
      setTimeout(res, 50);
    });
    if (document.body.parentElement.scrollTop - scrollTopHistory < 10){
      scrollNotChangedCnt ++;
    }else{
      console.log("滚动成功", scrollTopHistory, "=>", document.body.parentElement.scrollTop);
      scrollNotChangedCnt = 0;
      scrollTopHistory = document.body.parentElement.scrollTop;
    }
    
    if (scrollNotChangedCnt > 20){
      console.log("已滚动到底");
      break;
    }
  }
};

function printLog(){
  $(".kbnDocTableCell__dataField").each(function(){
    const $elem = $(this);
    const text = $elem.text();
    let textArr;
    try{
      textArr = JSON.parse(text);
      const matches = textArr[0].match(/NERTC:([A-Z]+):(\d+)/);
      if (!matches){
        console.log.apply(console, textArr);
      }else{
        const currentIndex = parseInt(matches[2]);
        const type = matches[1].toLowerCase();
        if (logIndex === 0){
          logHeadStart = currentIndex;
        }
        else if (logIndex + 1 !== currentIndex){
          console.error(`缺失日志条数：`, currentIndex - logIndex - 1);
          lostLogCnt += Math.max(currentIndex - logIndex - 1, 1);
        }
        logIndex = currentIndex;
        console[type].apply(console, textArr);
      }
    }catch(e){
      if("" + parseInt(text) === text){
        return;
      }else{
        console.error("无法识别的日志格式：", text);
      }
    }
  });
  console.log(`========== 本页日志起始序号：${logHeadStart} 日志条数： ${logIndex - logHeadStart + 1}  共缺少日志条数：${lostLogCnt} ===========`);
  console.log(`下一页：${getNextPageUrl()}`);
};

function getNextPageUrl(){
  const txt = $(".eui-textNoWrap:last").text().replace("th ", " ");
  const ts = Date.parse(txt);
  const date = new Date(ts);
  let hash = location.hash.replace("1=1&", "").replace(/from:(.*),mode:/, `from:'${date.toISOString()}',mode:`);
  if (hash.indexOf("1=1") === -1){
    hash += "&1=1";
  }
  let url = `${location.protocol}//${location.host}${location.pathname}?_t=${Date.now()}${hash}`;
  return url;
}

scrollBottom().then(printLog)

</script>
<script>
  const scriptText = document.getElementById("printLogScript").innerHTML.replace(/\n/g, "")
  document.getElementById("logBookmark").href = `javascript: ` + scriptText
  console.log(scriptText)
</script>

</body>

</html>